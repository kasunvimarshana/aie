import { isIOS } from '../utils';
var cloneTouch = function (touch, boundingRect) {
    return {
        identifier: touch.identifier,
        clientX: touch.clientX - boundingRect.left,
        clientY: touch.clientY - boundingRect.top,
        screenX: touch.screenX,
        screenY: touch.screenY
    };
};
var cloneTouches = function (touches, boundingRect) {
    if (!touches)
        return undefined;
    var touchList = [];
    for (var i = 0; i < touches.length; i++) {
        var touch = touches.item(i);
        touchList[i] = cloneTouch(touch, boundingRect);
    }
    return touchList;
};
export default function createEventForwarder(viewService, callback) {
    var forwardEvent = false;
    var eventData = {
        event: UIEvent = undefined,
        forwardEvent: function () { forwardEvent = true; }
    };
    var uievent = {};
    var handleEvent = function (e) {
        var target = e.target instanceof HTMLElement ? e.target : undefined;
        var width = target && target.clientWidth;
        var height = target && target.clientHeight;
        // prevent undesired default actions over the view element
        if (e.type === 'wheel' ||
            isIOS && e.type === 'touchmove' && e.touches.length === 2)
            e.preventDefault();
        // contain our events within the viewÂ element
        e.stopPropagation();
        // if the target element is the view element or an element of similar size,
        // attempt to forward the event (webvr-polyfill makes the canvas 10px larger
        // in each dimension due to an issue with the iOS safari browser, which is why
        // we forward the event for any target that matches the viewport size up to 15px 
        // larger in either dimension)
        if (e.target === viewService.element ||
            (width && Math.abs(width - viewService.element.clientWidth) < 15 &&
                height && Math.abs(height - viewService.element.clientHeight) < 15)) {
            // If we have a uievent listener attached, then make sure the
            // app explictily asks for events to be forwarded. Otherwise,
            // automatically forward the uievents 
            if (viewService.uiEvent.numberOfListeners > 0) {
                forwardEvent = false;
                eventData.event = e;
                viewService.uiEvent.raiseEvent(eventData);
                if (!forwardEvent) {
                    // if the app doesn't want to forward the event, 
                    // stop the event propogation immediately so that even a locally-running 
                    // reality viewer cannot process the event
                    e.stopImmediatePropagation();
                    return;
                }
            }
            // prevent undesired synthetic click
            if (e.type === 'touchstart')
                e.preventDefault();
            var boundingRect = viewService.element.getBoundingClientRect();
            var touches = cloneTouches(e.touches, boundingRect);
            var changedTouches = cloneTouches(e.changedTouches, boundingRect);
            var targetTouches = cloneTouches(e.targetTouches, boundingRect);
            // Event / UI Event
            uievent.timeStamp = e.timeStamp;
            uievent.type = e.type;
            uievent.bubbles = e.bubbles;
            uievent.cancelable = e.cancelable;
            uievent.which = e.which;
            uievent.detail = e.detail;
            uievent.composed = e['composed'];
            uievent.timeStamp = e.timeStamp;
            // Mouse Event
            uievent.altKey = e.altKey;
            uievent.ctrlKey = e.ctrlKey;
            uievent.metaKey = e.metaKey;
            uievent.button = e.button;
            uievent.buttons = e.buttons;
            uievent.clientX = e.clientX - boundingRect.left;
            uievent.clientY = e.clientY - boundingRect.top;
            uievent.screenX = e.screenX;
            uievent.screenY = e.screenY;
            uievent.movementX = e.movementX;
            uievent.movementY = e.movementY;
            // Wheel Event
            uievent.deltaX = e.deltaX;
            uievent.deltaY = e.deltaY;
            uievent.deltaZ = e.deltaZ;
            uievent.deltaMode = e.deltaMode;
            uievent.wheelDelta = e.wheelDelta;
            uievent.wheelDeltaX = e.wheelDeltaX;
            uievent.wheelDeltaY = e.wheelDeltaY;
            // Touch Event
            uievent.touches = touches;
            uievent.changedTouches = changedTouches;
            uievent.targetTouches = targetTouches;
            // Pointer Events
            uievent.pointerId = e.pointerId;
            uievent.pointerType = e.pointerType;
            uievent.width = e.width;
            uievent.height = e.height;
            uievent.pressure = e.pressure;
            uievent.tiltX = e.tiltX;
            uievent.tiltY = e.tiltY;
            uievent.isPrimary = e.isPrimary;
            callback(uievent);
        }
        else {
            // if this event is not forwardable, stop propogation immediately
            e.stopImmediatePropagation();
        }
    };
    var forwardedEvent = [
        'wheel',
        'click',
        'dblclick',
        'contextmenu'
    ];
    // if (FeatureDetection.supportsPointerEvents()) {
    forwardedEvent.push('pointerenter', 'pointerleave', 'pointerdown', 'pointermove', 'pointerup', 'pointercancel');
    // } else {
    forwardedEvent.push('mouseenter', 'mouseleave', 'mousedown', 'mousemove', 'mouseup', 'touchstart', 'touchend', 'touchmove', 'touchcancel');
    // }
    forwardedEvent.forEach(function (type) {
        viewService.element.addEventListener(type, handleEvent, false);
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidWktZXZlbnQtZm9yd2FyZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidWktZXZlbnQtZm9yd2FyZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUE7QUFFaEMsSUFBTSxVQUFVLEdBQUcsVUFBQyxLQUFXLEVBQUUsWUFBdUI7SUFDcEQsTUFBTSxDQUFDO1FBQ0gsVUFBVSxFQUFFLEtBQUssQ0FBQyxVQUFVO1FBQzVCLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTyxHQUFHLFlBQVksQ0FBQyxJQUFJO1FBQzFDLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTyxHQUFHLFlBQVksQ0FBQyxHQUFHO1FBQ3pDLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTztRQUN0QixPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU87S0FDekIsQ0FBQztBQUNOLENBQUMsQ0FBQTtBQUVELElBQU0sWUFBWSxHQUFHLFVBQUMsT0FBaUIsRUFBRSxZQUF1QjtJQUM1RCxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztRQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUM7SUFDL0IsSUFBTSxTQUFTLEdBQU8sRUFBRSxDQUFDO0lBQ3pCLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3RDLElBQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFFLENBQUM7UUFDL0IsU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxLQUFLLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUNELE1BQU0sQ0FBQyxTQUFTLENBQUM7QUFDckIsQ0FBQyxDQUFBO0FBRUQsTUFBTSxDQUFDLE9BQU8sK0JBQTBDLFdBQXVCLEVBQUUsUUFBZ0M7SUFFN0csSUFBSSxZQUFZLEdBQUcsS0FBSyxDQUFDO0lBRXpCLElBQU0sU0FBUyxHQUFHO1FBQ2QsS0FBSyxFQUFDLE9BQU8sR0FBUSxTQUFTO1FBQzlCLFlBQVksRUFBRSxjQUFRLFlBQVksR0FBRyxJQUFJLENBQUEsQ0FBQyxDQUFDO0tBQzlDLENBQUE7SUFFRCxJQUFNLE9BQU8sR0FBUSxFQUFFLENBQUM7SUFFeEIsSUFBTSxXQUFXLEdBQUcsVUFBQyxDQUErQztRQUNoRSxJQUFNLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBTSxZQUFZLFdBQVcsR0FBRyxDQUFDLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQztRQUN0RSxJQUFNLEtBQUssR0FBRyxNQUFNLElBQUksTUFBTSxDQUFDLFdBQVcsQ0FBQztRQUMzQyxJQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQztRQUU3QywwREFBMEQ7UUFDMUQsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxPQUFPO1lBQ2xCLEtBQUssSUFBSSxDQUFDLENBQUMsSUFBSSxLQUFLLFdBQVcsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUM7WUFDMUQsQ0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBRXZCLDZDQUE2QztRQUM3QyxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUM7UUFFcEIsMkVBQTJFO1FBQzNFLDRFQUE0RTtRQUM1RSw4RUFBOEU7UUFDOUUsaUZBQWlGO1FBQ2pGLDhCQUE4QjtRQUM5QixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxLQUFLLFdBQVcsQ0FBQyxPQUFPO1lBQ2hDLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRTtnQkFDaEUsTUFBTSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXRFLDZEQUE2RDtZQUM3RCw2REFBNkQ7WUFDN0Qsc0NBQXNDO1lBQ3RDLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDNUMsWUFBWSxHQUFHLEtBQUssQ0FBQztnQkFDckIsU0FBUyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7Z0JBQ3BCLFdBQVcsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUMxQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7b0JBQ2hCLGlEQUFpRDtvQkFDakQseUVBQXlFO29CQUN6RSwwQ0FBMEM7b0JBQzFDLENBQUMsQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO29CQUM3QixNQUFNLENBQUM7Z0JBQ1gsQ0FBQztZQUNMLENBQUM7WUFFRCxvQ0FBb0M7WUFDcEMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxZQUFZLENBQUM7Z0JBQ3hCLENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUV2QixJQUFNLFlBQVksR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDLHFCQUFxQixFQUFFLENBQUM7WUFDakUsSUFBTSxPQUFPLEdBQUcsWUFBWSxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDdEQsSUFBTSxjQUFjLEdBQUcsWUFBWSxDQUFDLENBQUMsQ0FBQyxjQUFjLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDcEUsSUFBTSxhQUFhLEdBQUcsWUFBWSxDQUFDLENBQUMsQ0FBQyxhQUFhLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFFbEUsbUJBQW1CO1lBQ25CLE9BQU8sQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQztZQUNoQyxPQUFPLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDdEIsT0FBTyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDO1lBQzVCLE9BQU8sQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDLFVBQVUsQ0FBQztZQUNsQyxPQUFPLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFDeEIsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO1lBQzFCLE9BQU8sQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ2pDLE9BQU8sQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQztZQUVoQyxjQUFjO1lBQ2QsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO1lBQzFCLE9BQU8sQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQztZQUM1QixPQUFPLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUM7WUFDNUIsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO1lBQzFCLE9BQU8sQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQztZQUM1QixPQUFPLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxPQUFPLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQztZQUNoRCxPQUFPLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxPQUFPLEdBQUcsWUFBWSxDQUFDLEdBQUcsQ0FBQztZQUMvQyxPQUFPLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUM7WUFDNUIsT0FBTyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDO1lBQzVCLE9BQU8sQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQztZQUNoQyxPQUFPLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUM7WUFFaEMsY0FBYztZQUNkLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztZQUMxQixPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUM7WUFDMUIsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO1lBQzFCLE9BQU8sQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQztZQUNoQyxPQUFPLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxVQUFVLENBQUM7WUFDbEMsT0FBTyxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUMsV0FBVyxDQUFDO1lBQ3BDLE9BQU8sQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDLFdBQVcsQ0FBQztZQUVwQyxjQUFjO1lBQ2QsT0FBTyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7WUFDMUIsT0FBTyxDQUFDLGNBQWMsR0FBRyxjQUFjLENBQUM7WUFDeEMsT0FBTyxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7WUFFdEMsaUJBQWlCO1lBQ2pCLE9BQU8sQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQztZQUNoQyxPQUFPLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyxXQUFXLENBQUM7WUFDcEMsT0FBTyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQ3hCLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztZQUMxQixPQUFPLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUM7WUFDOUIsT0FBTyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQ3hCLE9BQU8sQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztZQUN4QixPQUFPLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUM7WUFFaEMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3RCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLGlFQUFpRTtZQUNqRSxDQUFDLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztRQUNqQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDO0lBRUYsSUFBTSxjQUFjLEdBQUc7UUFDbkIsT0FBTztRQUNOLE9BQU87UUFDUCxVQUFVO1FBQ1YsYUFBYTtLQUNqQixDQUFDO0lBRUYsa0RBQWtEO0lBQzlDLGNBQWMsQ0FBQyxJQUFJLENBQ2YsY0FBYyxFQUNiLGNBQWMsRUFDZCxhQUFhLEVBQ2IsYUFBYSxFQUNiLFdBQVcsRUFDWCxlQUFlLENBQ25CLENBQUM7SUFDTixXQUFXO0lBQ1AsY0FBYyxDQUFDLElBQUksQ0FDZixZQUFZLEVBQ1gsWUFBWSxFQUNaLFdBQVcsRUFDWCxXQUFXLEVBQ1gsU0FBUyxFQUNULFlBQVksRUFDWixVQUFVLEVBQ1YsV0FBVyxFQUNYLGFBQWEsQ0FDakIsQ0FBQztJQUNOLElBQUk7SUFFSixjQUFjLENBQUMsT0FBTyxDQUFDLFVBQUMsSUFBSTtRQUN4QixXQUFXLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxXQUFXLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDbkUsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gaW1wb3J0IHsgRmVhdHVyZURldGVjdGlvbiB9IGZyb20gJy4uL2Nlc2l1bS9jZXNpdW0taW1wb3J0cydcbmltcG9ydCB7IFZpZXdTZXJ2aWNlIH0gZnJvbSAnLi4vdmlldydcbmltcG9ydCB7IGlzSU9TIH0gZnJvbSAnLi4vdXRpbHMnXG5cbmNvbnN0IGNsb25lVG91Y2ggPSAodG91Y2g6VG91Y2gsIGJvdW5kaW5nUmVjdDpDbGllbnRSZWN0KSA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgaWRlbnRpZmllcjogdG91Y2guaWRlbnRpZmllcixcbiAgICAgICAgY2xpZW50WDogdG91Y2guY2xpZW50WCAtIGJvdW5kaW5nUmVjdC5sZWZ0LFxuICAgICAgICBjbGllbnRZOiB0b3VjaC5jbGllbnRZIC0gYm91bmRpbmdSZWN0LnRvcCxcbiAgICAgICAgc2NyZWVuWDogdG91Y2guc2NyZWVuWCxcbiAgICAgICAgc2NyZWVuWTogdG91Y2guc2NyZWVuWVxuICAgIH07XG59XG5cbmNvbnN0IGNsb25lVG91Y2hlcyA9ICh0b3VjaGVzOlRvdWNoTGlzdCwgYm91bmRpbmdSZWN0OkNsaWVudFJlY3QpID0+IHtcbiAgICBpZiAoIXRvdWNoZXMpIHJldHVybiB1bmRlZmluZWQ7XG4gICAgY29uc3QgdG91Y2hMaXN0OmFueSA9IFtdO1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdG91Y2hlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCB0b3VjaCA9IHRvdWNoZXMuaXRlbShpKSE7XG4gICAgICAgIHRvdWNoTGlzdFtpXSA9IGNsb25lVG91Y2godG91Y2gsIGJvdW5kaW5nUmVjdCk7XG4gICAgfVxuICAgIHJldHVybiB0b3VjaExpc3Q7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGNyZWF0ZUV2ZW50Rm9yd2FyZGVyKHRoaXM6dm9pZCwgdmlld1NlcnZpY2U6Vmlld1NlcnZpY2UsIGNhbGxiYWNrOih1aWV2ZW50OlVJRXZlbnQpPT52b2lkKSB7XG5cbiAgICBsZXQgZm9yd2FyZEV2ZW50ID0gZmFsc2U7XG5cbiAgICBjb25zdCBldmVudERhdGEgPSB7XG4gICAgICAgIGV2ZW50OlVJRXZlbnQgPSA8YW55PnVuZGVmaW5lZCxcbiAgICAgICAgZm9yd2FyZEV2ZW50OiAoKSA9PiB7IGZvcndhcmRFdmVudCA9IHRydWUgfVxuICAgIH1cblxuICAgIGNvbnN0IHVpZXZlbnQgPSA8YW55Pnt9O1xuICAgIFxuICAgIGNvbnN0IGhhbmRsZUV2ZW50ID0gKGU6TW91c2VFdmVudCZXaGVlbEV2ZW50JlRvdWNoRXZlbnQmUG9pbnRlckV2ZW50KT0+e1xuICAgICAgICBjb25zdCB0YXJnZXQgPSBlLnRhcmdldCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ID8gZS50YXJnZXQgOiB1bmRlZmluZWQ7XG4gICAgICAgIGNvbnN0IHdpZHRoID0gdGFyZ2V0ICYmIHRhcmdldC5jbGllbnRXaWR0aDtcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gdGFyZ2V0ICYmIHRhcmdldC5jbGllbnRIZWlnaHQ7XG5cbiAgICAgICAgLy8gcHJldmVudCB1bmRlc2lyZWQgZGVmYXVsdCBhY3Rpb25zIG92ZXIgdGhlIHZpZXcgZWxlbWVudFxuICAgICAgICBpZiAoZS50eXBlID09PSAnd2hlZWwnIHx8IFxuICAgICAgICAgICAgaXNJT1MgJiYgZS50eXBlID09PSAndG91Y2htb3ZlJyAmJiBlLnRvdWNoZXMubGVuZ3RoID09PSAyKSBcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICAvLyBjb250YWluIG91ciBldmVudHMgd2l0aGluIHRoZSB2aWV3wqBlbGVtZW50XG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG5cbiAgICAgICAgLy8gaWYgdGhlIHRhcmdldCBlbGVtZW50IGlzIHRoZSB2aWV3IGVsZW1lbnQgb3IgYW4gZWxlbWVudCBvZiBzaW1pbGFyIHNpemUsXG4gICAgICAgIC8vIGF0dGVtcHQgdG8gZm9yd2FyZCB0aGUgZXZlbnQgKHdlYnZyLXBvbHlmaWxsIG1ha2VzIHRoZSBjYW52YXMgMTBweCBsYXJnZXJcbiAgICAgICAgLy8gaW4gZWFjaCBkaW1lbnNpb24gZHVlIHRvIGFuIGlzc3VlIHdpdGggdGhlIGlPUyBzYWZhcmkgYnJvd3Nlciwgd2hpY2ggaXMgd2h5XG4gICAgICAgIC8vIHdlIGZvcndhcmQgdGhlIGV2ZW50IGZvciBhbnkgdGFyZ2V0IHRoYXQgbWF0Y2hlcyB0aGUgdmlld3BvcnQgc2l6ZSB1cCB0byAxNXB4IFxuICAgICAgICAvLyBsYXJnZXIgaW4gZWl0aGVyIGRpbWVuc2lvbilcbiAgICAgICAgaWYgKGUudGFyZ2V0ID09PSB2aWV3U2VydmljZS5lbGVtZW50IHx8XG4gICAgICAgICAgICAod2lkdGggJiYgTWF0aC5hYnMod2lkdGggLSB2aWV3U2VydmljZS5lbGVtZW50LmNsaWVudFdpZHRoKSA8IDE1ICYmXG4gICAgICAgICAgICBoZWlnaHQgJiYgTWF0aC5hYnMoaGVpZ2h0IC0gdmlld1NlcnZpY2UuZWxlbWVudC5jbGllbnRIZWlnaHQpIDwgMTUpKSB7XG5cbiAgICAgICAgICAgIC8vIElmIHdlIGhhdmUgYSB1aWV2ZW50IGxpc3RlbmVyIGF0dGFjaGVkLCB0aGVuIG1ha2Ugc3VyZSB0aGVcbiAgICAgICAgICAgIC8vIGFwcCBleHBsaWN0aWx5IGFza3MgZm9yIGV2ZW50cyB0byBiZSBmb3J3YXJkZWQuIE90aGVyd2lzZSxcbiAgICAgICAgICAgIC8vIGF1dG9tYXRpY2FsbHkgZm9yd2FyZCB0aGUgdWlldmVudHMgXG4gICAgICAgICAgICBpZiAodmlld1NlcnZpY2UudWlFdmVudC5udW1iZXJPZkxpc3RlbmVycyA+IDApIHtcbiAgICAgICAgICAgICAgICBmb3J3YXJkRXZlbnQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBldmVudERhdGEuZXZlbnQgPSBlO1xuICAgICAgICAgICAgICAgIHZpZXdTZXJ2aWNlLnVpRXZlbnQucmFpc2VFdmVudChldmVudERhdGEpO1xuICAgICAgICAgICAgICAgIGlmICghZm9yd2FyZEV2ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBhcHAgZG9lc24ndCB3YW50IHRvIGZvcndhcmQgdGhlIGV2ZW50LCBcbiAgICAgICAgICAgICAgICAgICAgLy8gc3RvcCB0aGUgZXZlbnQgcHJvcG9nYXRpb24gaW1tZWRpYXRlbHkgc28gdGhhdCBldmVuIGEgbG9jYWxseS1ydW5uaW5nIFxuICAgICAgICAgICAgICAgICAgICAvLyByZWFsaXR5IHZpZXdlciBjYW5ub3QgcHJvY2VzcyB0aGUgZXZlbnRcbiAgICAgICAgICAgICAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIHByZXZlbnQgdW5kZXNpcmVkIHN5bnRoZXRpYyBjbGlja1xuICAgICAgICAgICAgaWYgKGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnKSBcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgICAgIGNvbnN0IGJvdW5kaW5nUmVjdCA9IHZpZXdTZXJ2aWNlLmVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICAgICAgICBjb25zdCB0b3VjaGVzID0gY2xvbmVUb3VjaGVzKGUudG91Y2hlcywgYm91bmRpbmdSZWN0KTtcbiAgICAgICAgICAgIGNvbnN0IGNoYW5nZWRUb3VjaGVzID0gY2xvbmVUb3VjaGVzKGUuY2hhbmdlZFRvdWNoZXMsIGJvdW5kaW5nUmVjdCk7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXRUb3VjaGVzID0gY2xvbmVUb3VjaGVzKGUudGFyZ2V0VG91Y2hlcywgYm91bmRpbmdSZWN0KTtcblxuICAgICAgICAgICAgLy8gRXZlbnQgLyBVSSBFdmVudFxuICAgICAgICAgICAgdWlldmVudC50aW1lU3RhbXAgPSBlLnRpbWVTdGFtcDtcbiAgICAgICAgICAgIHVpZXZlbnQudHlwZSA9IGUudHlwZTtcbiAgICAgICAgICAgIHVpZXZlbnQuYnViYmxlcyA9IGUuYnViYmxlcztcbiAgICAgICAgICAgIHVpZXZlbnQuY2FuY2VsYWJsZSA9IGUuY2FuY2VsYWJsZTtcbiAgICAgICAgICAgIHVpZXZlbnQud2hpY2ggPSBlLndoaWNoOyBcbiAgICAgICAgICAgIHVpZXZlbnQuZGV0YWlsID0gZS5kZXRhaWw7XG4gICAgICAgICAgICB1aWV2ZW50LmNvbXBvc2VkID0gZVsnY29tcG9zZWQnXTtcbiAgICAgICAgICAgIHVpZXZlbnQudGltZVN0YW1wID0gZS50aW1lU3RhbXA7XG5cbiAgICAgICAgICAgIC8vIE1vdXNlIEV2ZW50XG4gICAgICAgICAgICB1aWV2ZW50LmFsdEtleSA9IGUuYWx0S2V5O1xuICAgICAgICAgICAgdWlldmVudC5jdHJsS2V5ID0gZS5jdHJsS2V5O1xuICAgICAgICAgICAgdWlldmVudC5tZXRhS2V5ID0gZS5tZXRhS2V5O1xuICAgICAgICAgICAgdWlldmVudC5idXR0b24gPSBlLmJ1dHRvbjtcbiAgICAgICAgICAgIHVpZXZlbnQuYnV0dG9ucyA9IGUuYnV0dG9ucztcbiAgICAgICAgICAgIHVpZXZlbnQuY2xpZW50WCA9IGUuY2xpZW50WCAtIGJvdW5kaW5nUmVjdC5sZWZ0O1xuICAgICAgICAgICAgdWlldmVudC5jbGllbnRZID0gZS5jbGllbnRZIC0gYm91bmRpbmdSZWN0LnRvcDtcbiAgICAgICAgICAgIHVpZXZlbnQuc2NyZWVuWCA9IGUuc2NyZWVuWDtcbiAgICAgICAgICAgIHVpZXZlbnQuc2NyZWVuWSA9IGUuc2NyZWVuWTtcbiAgICAgICAgICAgIHVpZXZlbnQubW92ZW1lbnRYID0gZS5tb3ZlbWVudFg7XG4gICAgICAgICAgICB1aWV2ZW50Lm1vdmVtZW50WSA9IGUubW92ZW1lbnRZO1xuXG4gICAgICAgICAgICAvLyBXaGVlbCBFdmVudFxuICAgICAgICAgICAgdWlldmVudC5kZWx0YVggPSBlLmRlbHRhWDtcbiAgICAgICAgICAgIHVpZXZlbnQuZGVsdGFZID0gZS5kZWx0YVk7XG4gICAgICAgICAgICB1aWV2ZW50LmRlbHRhWiA9IGUuZGVsdGFaO1xuICAgICAgICAgICAgdWlldmVudC5kZWx0YU1vZGUgPSBlLmRlbHRhTW9kZTtcbiAgICAgICAgICAgIHVpZXZlbnQud2hlZWxEZWx0YSA9IGUud2hlZWxEZWx0YTtcbiAgICAgICAgICAgIHVpZXZlbnQud2hlZWxEZWx0YVggPSBlLndoZWVsRGVsdGFYO1xuICAgICAgICAgICAgdWlldmVudC53aGVlbERlbHRhWSA9IGUud2hlZWxEZWx0YVk7XG5cbiAgICAgICAgICAgIC8vIFRvdWNoIEV2ZW50XG4gICAgICAgICAgICB1aWV2ZW50LnRvdWNoZXMgPSB0b3VjaGVzO1xuICAgICAgICAgICAgdWlldmVudC5jaGFuZ2VkVG91Y2hlcyA9IGNoYW5nZWRUb3VjaGVzO1xuICAgICAgICAgICAgdWlldmVudC50YXJnZXRUb3VjaGVzID0gdGFyZ2V0VG91Y2hlcztcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gUG9pbnRlciBFdmVudHNcbiAgICAgICAgICAgIHVpZXZlbnQucG9pbnRlcklkID0gZS5wb2ludGVySWQ7XG4gICAgICAgICAgICB1aWV2ZW50LnBvaW50ZXJUeXBlID0gZS5wb2ludGVyVHlwZTtcbiAgICAgICAgICAgIHVpZXZlbnQud2lkdGggPSBlLndpZHRoO1xuICAgICAgICAgICAgdWlldmVudC5oZWlnaHQgPSBlLmhlaWdodDtcbiAgICAgICAgICAgIHVpZXZlbnQucHJlc3N1cmUgPSBlLnByZXNzdXJlO1xuICAgICAgICAgICAgdWlldmVudC50aWx0WCA9IGUudGlsdFg7XG4gICAgICAgICAgICB1aWV2ZW50LnRpbHRZID0gZS50aWx0WTtcbiAgICAgICAgICAgIHVpZXZlbnQuaXNQcmltYXJ5ID0gZS5pc1ByaW1hcnk7XG5cbiAgICAgICAgICAgIGNhbGxiYWNrKHVpZXZlbnQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gaWYgdGhpcyBldmVudCBpcyBub3QgZm9yd2FyZGFibGUsIHN0b3AgcHJvcG9nYXRpb24gaW1tZWRpYXRlbHlcbiAgICAgICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3QgZm9yd2FyZGVkRXZlbnQgPSBbXG4gICAgICAgICd3aGVlbCdcbiAgICAgICAgLCdjbGljaydcbiAgICAgICAgLCdkYmxjbGljaydcbiAgICAgICAgLCdjb250ZXh0bWVudSdcbiAgICBdO1xuXG4gICAgLy8gaWYgKEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNQb2ludGVyRXZlbnRzKCkpIHtcbiAgICAgICAgZm9yd2FyZGVkRXZlbnQucHVzaChcbiAgICAgICAgICAgICdwb2ludGVyZW50ZXInXG4gICAgICAgICAgICAsJ3BvaW50ZXJsZWF2ZSdcbiAgICAgICAgICAgICwncG9pbnRlcmRvd24nXG4gICAgICAgICAgICAsJ3BvaW50ZXJtb3ZlJ1xuICAgICAgICAgICAgLCdwb2ludGVydXAnXG4gICAgICAgICAgICAsJ3BvaW50ZXJjYW5jZWwnXG4gICAgICAgICk7XG4gICAgLy8gfSBlbHNlIHtcbiAgICAgICAgZm9yd2FyZGVkRXZlbnQucHVzaChcbiAgICAgICAgICAgICdtb3VzZWVudGVyJ1xuICAgICAgICAgICAgLCdtb3VzZWxlYXZlJ1xuICAgICAgICAgICAgLCdtb3VzZWRvd24nXG4gICAgICAgICAgICAsJ21vdXNlbW92ZSdcbiAgICAgICAgICAgICwnbW91c2V1cCdcbiAgICAgICAgICAgICwndG91Y2hzdGFydCdcbiAgICAgICAgICAgICwndG91Y2hlbmQnXG4gICAgICAgICAgICAsJ3RvdWNobW92ZSdcbiAgICAgICAgICAgICwndG91Y2hjYW5jZWwnXG4gICAgICAgICk7XG4gICAgLy8gfVxuXG4gICAgZm9yd2FyZGVkRXZlbnQuZm9yRWFjaCgodHlwZSk9PntcbiAgICAgICAgdmlld1NlcnZpY2UuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGhhbmRsZUV2ZW50LCBmYWxzZSk7XG4gICAgfSk7XG59Il19