/**
 * A MessageChannel pollyfill.
 */
var MessageChannelLike = (function () {
    /**
     * Create a MessageChannelLike instance.
     */
    function MessageChannelLike() {
        var messageChannel = this;
        var _portsOpen = true;
        var _port1ready;
        var _port2ready;
        var _port1onmessage;
        _port1ready = new Promise(function (resolve) {
            messageChannel.port1 = {
                set onmessage(func) {
                    _port1onmessage = func;
                    resolve();
                },
                get onmessage() {
                    return _port1onmessage;
                },
                postMessage: function (data) {
                    if (_portsOpen) {
                        _port2ready.then(function () {
                            if (messageChannel.port2.onmessage)
                                messageChannel.port2.onmessage({ data: data });
                        });
                    }
                },
                close: function () {
                    _portsOpen = false;
                }
            };
        });
        var _port2onmessage;
        _port2ready = new Promise(function (resolve) {
            messageChannel.port2 = {
                set onmessage(func) {
                    _port2onmessage = func;
                    resolve();
                },
                get onmessage() {
                    return _port2onmessage;
                },
                postMessage: function (data) {
                    if (_portsOpen) {
                        _port1ready.then(function () {
                            if (messageChannel.port1.onmessage)
                                messageChannel.port1.onmessage({ data: data });
                        });
                    }
                },
                close: function () {
                    _portsOpen = false;
                }
            };
        });
    }
    return MessageChannelLike;
}());
export { MessageChannelLike };
/**
 * A synchronous MessageChannel.
 */
var SynchronousMessageChannel = (function () {
    /**
     * Create a MessageChannelLike instance.
     */
    function SynchronousMessageChannel() {
        var messageChannel = this;
        var pendingMessagesToPort2 = [];
        var onmessage1 = undefined;
        var port1Event = { data: null };
        var port1Closed = false;
        var tryPendingMessagesToPort2 = function () {
            for (var i = 0; i < pendingMessagesToPort2.length; i++) {
                messageChannel.port2.onmessage(pendingMessagesToPort2[i]);
            }
            pendingMessagesToPort2.length = 0;
        };
        var tryPendingMessagesToPort1 = function () {
            for (var i = 0; i < pendingMessagesToPort1.length; i++) {
                messageChannel.port1.onmessage(pendingMessagesToPort1[i]);
            }
            pendingMessagesToPort1.length = 0;
        };
        messageChannel.port1 = {
            get onmessage() { return onmessage1; },
            set onmessage(func) {
                onmessage1 = func;
                tryPendingMessagesToPort1();
            },
            postMessage: function (data) {
                if (messageChannel.port2.onmessage) {
                    port1Event.data = data;
                    // port1Event.data = typeof data === 'string' ? data : JSON.stringify(data);
                    // console.log(JSON.stringify(port1Event.data));
                    messageChannel.port2.onmessage(port1Event);
                }
                else if (!port1Closed) {
                    pendingMessagesToPort2.push({ data: data });
                }
            },
            close: function () {
                port1Closed = true;
                messageChannel.port1.onmessage = undefined;
            }
        };
        var pendingMessagesToPort1 = [];
        var onmessage2 = undefined;
        var port2Event = { data: null };
        var port2Closed = false;
        messageChannel.port2 = {
            get onmessage() { return onmessage2; },
            set onmessage(func) {
                onmessage2 = func;
                tryPendingMessagesToPort2();
            },
            postMessage: function (data) {
                if (messageChannel.port1.onmessage) {
                    // port2Event.data = typeof data === 'string' ? data : JSON.stringify(data);
                    port2Event.data = data;
                    // console.log(JSON.stringify(data));
                    messageChannel.port1.onmessage(port2Event);
                }
                else if (!port2Closed) {
                    pendingMessagesToPort1.push({ data: data });
                }
            },
            close: function () {
                port2Closed = true;
                messageChannel.port2.onmessage = undefined;
            }
        };
    }
    return SynchronousMessageChannel;
}());
export { SynchronousMessageChannel };
/**
 * A factory which creates MessageChannel or MessageChannelLike instances, depending on
 * wheter or not MessageChannel is avaialble in the execution context.
 */
var MessageChannelFactory = (function () {
    function MessageChannelFactory() {
    }
    /**
     * Create a MessageChannel (or MessageChannelLike) instance.
     */
    MessageChannelFactory.prototype.create = function () {
        if (typeof MessageChannel !== 'undefined')
            return new MessageChannel();
        else
            return new MessageChannelLike();
    };
    /**
     * Create a SynchronousMessageChannel instance.
     */
    MessageChannelFactory.prototype.createSynchronous = function () {
        return new SynchronousMessageChannel();
    };
    return MessageChannelFactory;
}());
export { MessageChannelFactory };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnZS1jaGFubmVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWVzc2FnZS1jaGFubmVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQStCQTs7R0FFRztBQUNIO0lBWUk7O09BRUc7SUFDSDtRQUNJLElBQU0sY0FBYyxHQUFHLElBQUksQ0FBQztRQUM1QixJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUM7UUFFdEIsSUFBSSxXQUF3QixDQUFDO1FBQzdCLElBQUksV0FBd0IsQ0FBQztRQUU3QixJQUFJLGVBQXlELENBQUM7UUFDOUQsV0FBVyxHQUFHLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTztZQUM5QixjQUFjLENBQUMsS0FBSyxHQUFHO2dCQUNuQixJQUFJLFNBQVMsQ0FBQyxJQUFJO29CQUNkLGVBQWUsR0FBRyxJQUFJLENBQUM7b0JBQ3ZCLE9BQU8sRUFBRSxDQUFDO2dCQUNkLENBQUM7Z0JBQ0QsSUFBSSxTQUFTO29CQUNULE1BQU0sQ0FBQyxlQUFlLENBQUM7Z0JBQzNCLENBQUM7Z0JBQ0QsV0FBVyxZQUFDLElBQVM7b0JBQ2pCLEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7d0JBQ2IsV0FBVyxDQUFDLElBQUksQ0FBQzs0QkFDYixFQUFFLENBQUMsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQztnQ0FDL0IsY0FBYyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLE1BQUEsRUFBRSxDQUFDLENBQUM7d0JBQ2pELENBQUMsQ0FBQyxDQUFBO29CQUNOLENBQUM7Z0JBQ0wsQ0FBQztnQkFDRCxLQUFLO29CQUNELFVBQVUsR0FBRyxLQUFLLENBQUM7Z0JBQ3ZCLENBQUM7YUFDSixDQUFBO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLGVBQXlELENBQUM7UUFDOUQsV0FBVyxHQUFHLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTztZQUM5QixjQUFjLENBQUMsS0FBSyxHQUFvQjtn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RUc7SUFDSSxzQ0FBTSxHQUFiO1FBQ0ksRUFBRSxDQUFDLENBQUMsT0FBTyxjQUFjLEtBQUssV0FBVyxDQUFDO1lBQUMsTUFBTSxDQUFDLElBQUksY0FBYyxFQUFFLENBQUE7UUFDdEUsSUFBSTtZQUFDLE1BQU0sQ0FBQyxJQUFJLGtCQUFrQixFQUFFLENBQUM7SUFDekMsQ0FBQztJQUVEOztPQUVHO0lBQ0ksaURBQWlCLEdBQXhCO1FBQ0ksTUFBTSxDQUFDLElBQUkseUJBQXlCLEVBQUUsQ0FBQTtJQUMxQyxDQUFDO0lBQ0wsNEJBQUM7QUFBRCxDQUFDLEFBaEJELElBZ0JDIiwic291cmNlc0NvbnRlbnQiOlsiXG4vKipcbiAqIEEgbWluaW1hbCBNZXNzYWdlRXZlbnQgaW50ZXJmYWNlLlxuICovXG5leHBvcnQgZGVjbGFyZSBjbGFzcyBNZXNzYWdlRXZlbnRMaWtlIHtcbiAgICBjb25zdHJ1Y3RvcihkYXRhOiBhbnkpO1xuICAgIGRhdGE6IGFueTtcbn1cblxuLyoqXG4gKiBBIG1pbmltYWwgTWVzc2FnZVBvcnQgaW50ZXJmYWNlLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIE1lc3NhZ2VQb3J0TGlrZSB7XG5cbiAgICAvKipcbiAgICAgICogQSBjYWxsYmFjayBmb3IgaGFuZGxpbmcgaW5jb21pbmcgbWVzc2FnZXMuXG4gICAgICAqL1xuICAgIG9ubWVzc2FnZT86IChldjogTWVzc2FnZUV2ZW50TGlrZSkgPT4gYW55O1xuXG4gICAgLyoqXG4gICAgICogU2VuZCBhIG1lc3NhZ2UgdGhyb3VnaCB0aGlzIG1lc3NhZ2UgcG9ydC5cbiAgICAgKiBAcGFyYW0gbWVzc2FnZSBUaGUgbWVzc2FnZSBuZWVkZWQgdG8gYmUgcG9zdGVkLlxuICAgICAqL1xuICAgIHBvc3RNZXNzYWdlKG1lc3NhZ2U6IGFueSk6IHZvaWQ7XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSB0aGlzIG1lc3NhZ2UgcG9ydC4gXG4gICAgICovXG4gICAgY2xvc2U/OiAoKSA9PiB2b2lkO1xufVxuXG4vKipcbiAqIEEgTWVzc2FnZUNoYW5uZWwgcG9sbHlmaWxsLiBcbiAqL1xuZXhwb3J0IGNsYXNzIE1lc3NhZ2VDaGFubmVsTGlrZSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgZmlyc3QgcG9ydC5cbiAgICAgKi9cbiAgICBwdWJsaWMgcG9ydDE6IE1lc3NhZ2VQb3J0TGlrZTtcblxuICAgIC8qKlxuICAgICAqIFRoZSBzZWNvbmQgcG9ydC5cbiAgICAgKi9cbiAgICBwdWJsaWMgcG9ydDI6IE1lc3NhZ2VQb3J0TGlrZTtcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIE1lc3NhZ2VDaGFubmVsTGlrZSBpbnN0YW5jZS4gXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2VDaGFubmVsID0gdGhpcztcbiAgICAgICAgbGV0IF9wb3J0c09wZW4gPSB0cnVlO1xuXG4gICAgICAgIGxldCBfcG9ydDFyZWFkeTogUHJvbWlzZTx7fT47XG4gICAgICAgIGxldCBfcG9ydDJyZWFkeTogUHJvbWlzZTx7fT47XG5cbiAgICAgICAgbGV0IF9wb3J0MW9ubWVzc2FnZTogKG1lc3NhZ2VFdmVudDogTWVzc2FnZUV2ZW50TGlrZSkgPT4gdm9pZDtcbiAgICAgICAgX3BvcnQxcmVhZHkgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgbWVzc2FnZUNoYW5uZWwucG9ydDEgPSB7XG4gICAgICAgICAgICAgICAgc2V0IG9ubWVzc2FnZShmdW5jKSB7XG4gICAgICAgICAgICAgICAgICAgIF9wb3J0MW9ubWVzc2FnZSA9IGZ1bmM7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGdldCBvbm1lc3NhZ2UoKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBfcG9ydDFvbm1lc3NhZ2U7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBwb3N0TWVzc2FnZShkYXRhOiBhbnkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKF9wb3J0c09wZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIF9wb3J0MnJlYWR5LnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlQ2hhbm5lbC5wb3J0Mi5vbm1lc3NhZ2UpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VDaGFubmVsLnBvcnQyLm9ubWVzc2FnZSh7IGRhdGEgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBjbG9zZSgpIHtcbiAgICAgICAgICAgICAgICAgICAgX3BvcnRzT3BlbiA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IF9wb3J0Mm9ubWVzc2FnZTogKG1lc3NhZ2VFdmVudDogTWVzc2FnZUV2ZW50TGlrZSkgPT4gdm9pZDtcbiAgICAgICAgX3BvcnQycmVhZHkgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgbWVzc2FnZUNoYW5uZWwucG9ydDIgPSA8TWVzc2FnZVBvcnRMaWtlPntcbiAgICAgICAgICAgICAgICBzZXQgb25tZXNzYWdlKGZ1bmMpIHtcbiAgICAgICAgICAgICAgICAgICAgX3BvcnQyb25tZXNzYWdlID0gZnVuYztcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZ2V0IG9ubWVzc2FnZSgpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9wb3J0Mm9ubWVzc2FnZTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHBvc3RNZXNzYWdlKGRhdGE6IGFueSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoX3BvcnRzT3Blbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgX3BvcnQxcmVhZHkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2VDaGFubmVsLnBvcnQxLm9ubWVzc2FnZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZUNoYW5uZWwucG9ydDEub25tZXNzYWdlKHsgZGF0YSB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGNsb3NlKCkge1xuICAgICAgICAgICAgICAgICAgICBfcG9ydHNPcGVuID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgIH1cbn1cblxuXG4vKipcbiAqIEEgc3luY2hyb25vdXMgTWVzc2FnZUNoYW5uZWwuIFxuICovXG5leHBvcnQgY2xhc3MgU3luY2hyb25vdXNNZXNzYWdlQ2hhbm5lbCB7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgZmlyc3QgcG9ydC5cbiAgICAgKi9cbiAgICBwdWJsaWMgcG9ydDE6IE1lc3NhZ2VQb3J0TGlrZTtcblxuICAgIC8qKlxuICAgICAqIFRoZSBzZWNvbmQgcG9ydC5cbiAgICAgKi9cbiAgICBwdWJsaWMgcG9ydDI6IE1lc3NhZ2VQb3J0TGlrZTtcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIE1lc3NhZ2VDaGFubmVsTGlrZSBpbnN0YW5jZS4gXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2VDaGFubmVsID0gdGhpcztcblxuICAgICAgICBsZXQgcGVuZGluZ01lc3NhZ2VzVG9Qb3J0MjogYW55W10gPSBbXVxuICAgICAgICBsZXQgb25tZXNzYWdlMSA9IHVuZGVmaW5lZDtcblxuICAgICAgICBjb25zdCBwb3J0MUV2ZW50OntkYXRhOmFueX0gPSB7ZGF0YTpudWxsfTtcbiAgICAgICAgbGV0IHBvcnQxQ2xvc2VkID0gZmFsc2U7XG5cbiAgICAgICAgdmFyIHRyeVBlbmRpbmdNZXNzYWdlc1RvUG9ydDIgPSAoKSA9PiB7XG4gICAgICAgICAgICBmb3IgKHZhciBpPTA7IGkgPCBwZW5kaW5nTWVzc2FnZXNUb1BvcnQyLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZUNoYW5uZWwucG9ydDIub25tZXNzYWdlIShwZW5kaW5nTWVzc2FnZXNUb1BvcnQyW2ldKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHBlbmRpbmdNZXNzYWdlc1RvUG9ydDIubGVuZ3RoID0gMDtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciB0cnlQZW5kaW5nTWVzc2FnZXNUb1BvcnQxID0gKCkgPT4ge1xuICAgICAgICAgICAgZm9yICh2YXIgaT0wOyBpIDwgcGVuZGluZ01lc3NhZ2VzVG9Qb3J0MS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2VDaGFubmVsLnBvcnQxLm9ubWVzc2FnZSEocGVuZGluZ01lc3NhZ2VzVG9Qb3J0MVtpXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBwZW5kaW5nTWVzc2FnZXNUb1BvcnQxLmxlbmd0aCA9IDA7XG4gICAgICAgIH1cblxuICAgICAgICBtZXNzYWdlQ2hhbm5lbC5wb3J0MSA9IHtcbiAgICAgICAgICAgIGdldCBvbm1lc3NhZ2UoKSB7IHJldHVybiBvbm1lc3NhZ2UxIH0sXG4gICAgICAgICAgICBzZXQgb25tZXNzYWdlKGZ1bmMpIHtcbiAgICAgICAgICAgICAgICBvbm1lc3NhZ2UxID0gZnVuYztcbiAgICAgICAgICAgICAgICB0cnlQZW5kaW5nTWVzc2FnZXNUb1BvcnQxKCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcG9zdE1lc3NhZ2UoZGF0YTogYW55KSB7XG4gICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2VDaGFubmVsLnBvcnQyLm9ubWVzc2FnZSkge1xuICAgICAgICAgICAgICAgICAgICBwb3J0MUV2ZW50LmRhdGEgPSBkYXRhOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIHBvcnQxRXZlbnQuZGF0YSA9IHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJyA/IGRhdGEgOiBKU09OLnN0cmluZ2lmeShkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocG9ydDFFdmVudC5kYXRhKSk7XG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VDaGFubmVsLnBvcnQyLm9ubWVzc2FnZShwb3J0MUV2ZW50KTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFwb3J0MUNsb3NlZCkge1xuICAgICAgICAgICAgICAgICAgICBwZW5kaW5nTWVzc2FnZXNUb1BvcnQyLnB1c2goe2RhdGE6ZGF0YX0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBjbG9zZSgpIHtcbiAgICAgICAgICAgICAgICBwb3J0MUNsb3NlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgbWVzc2FnZUNoYW5uZWwucG9ydDEub25tZXNzYWdlID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHBlbmRpbmdNZXNzYWdlc1RvUG9ydDE6IGFueVtdID0gW11cbiAgICAgICAgbGV0IG9ubWVzc2FnZTIgPSB1bmRlZmluZWQ7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBwb3J0MkV2ZW50OntkYXRhOmFueX0gPSB7ZGF0YTpudWxsfTtcbiAgICAgICAgbGV0IHBvcnQyQ2xvc2VkID0gZmFsc2U7XG5cbiAgICAgICAgbWVzc2FnZUNoYW5uZWwucG9ydDIgPSA8TWVzc2FnZVBvcnRMaWtlPntcbiAgICAgICAgICAgIGdldCBvbm1lc3NhZ2UoKSB7IHJldHVybiBvbm1lc3NhZ2UyIH0sXG4gICAgICAgICAgICBzZXQgb25tZXNzYWdlKGZ1bmMpIHtcbiAgICAgICAgICAgICAgICBvbm1lc3NhZ2UyID0gZnVuYztcbiAgICAgICAgICAgICAgICB0cnlQZW5kaW5nTWVzc2FnZXNUb1BvcnQyKCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcG9zdE1lc3NhZ2UoZGF0YTogYW55KSB7XG4gICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2VDaGFubmVsLnBvcnQxLm9ubWVzc2FnZSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBwb3J0MkV2ZW50LmRhdGEgPSB0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycgPyBkYXRhIDogSlNPTi5zdHJpbmdpZnkoZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIHBvcnQyRXZlbnQuZGF0YSA9IGRhdGE7XG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZUNoYW5uZWwucG9ydDEub25tZXNzYWdlKHBvcnQyRXZlbnQpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXBvcnQyQ2xvc2VkKSB7XG4gICAgICAgICAgICAgICAgICAgIHBlbmRpbmdNZXNzYWdlc1RvUG9ydDEucHVzaCh7ZGF0YTpkYXRhfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNsb3NlKCkge1xuICAgICAgICAgICAgICAgIHBvcnQyQ2xvc2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBtZXNzYWdlQ2hhbm5lbC5wb3J0Mi5vbm1lc3NhZ2UgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8qKlxuICogQSBmYWN0b3J5IHdoaWNoIGNyZWF0ZXMgTWVzc2FnZUNoYW5uZWwgb3IgTWVzc2FnZUNoYW5uZWxMaWtlIGluc3RhbmNlcywgZGVwZW5kaW5nIG9uXG4gKiB3aGV0ZXIgb3Igbm90IE1lc3NhZ2VDaGFubmVsIGlzIGF2YWlhbGJsZSBpbiB0aGUgZXhlY3V0aW9uIGNvbnRleHQuIFxuICovXG5leHBvcnQgY2xhc3MgTWVzc2FnZUNoYW5uZWxGYWN0b3J5IHtcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIE1lc3NhZ2VDaGFubmVsIChvciBNZXNzYWdlQ2hhbm5lbExpa2UpIGluc3RhbmNlLlxuICAgICAqL1xuICAgIHB1YmxpYyBjcmVhdGUoKTogTWVzc2FnZUNoYW5uZWxMaWtlIHtcbiAgICAgICAgaWYgKHR5cGVvZiBNZXNzYWdlQ2hhbm5lbCAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiBuZXcgTWVzc2FnZUNoYW5uZWwoKVxuICAgICAgICBlbHNlIHJldHVybiBuZXcgTWVzc2FnZUNoYW5uZWxMaWtlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgU3luY2hyb25vdXNNZXNzYWdlQ2hhbm5lbCBpbnN0YW5jZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgY3JlYXRlU3luY2hyb25vdXMoKTogU3luY2hyb25vdXNNZXNzYWdlQ2hhbm5lbCB7XG4gICAgICAgIHJldHVybiBuZXcgU3luY2hyb25vdXNNZXNzYWdlQ2hhbm5lbCgpXG4gICAgfVxufSJdfQ==