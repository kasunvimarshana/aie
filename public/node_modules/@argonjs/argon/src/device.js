var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
import { Entity, DynamicPositionProperty, DynamicProperty, ReferenceFrame, Cartesian3, Matrix3, Matrix4, CesiumMath, Quaternion, JulianDate, PerspectiveFrustum, defined, Cartographic } from './cesium/cesium-imports';
import { autoinject, singleton } from 'aurelia-dependency-injection';
import { EntityService, EntityServiceProvider, PoseStatus } from './entity';
import { SessionService } from './session';
import { ArgonSystem } from './argon';
import { AVERAGE_EYE_HEIGHT, DEFAULT_NEAR_PLANE, DEFAULT_FAR_PLANE, CanvasViewport, Viewport, SerializedSubviewList, SubviewType, SerializedSubview } from './common';
import { deprecated, eastUpSouthToFixedFrame, requestAnimationFrame, cancelAnimationFrame, updateHeightFromTerrain, jsonEquals, Event } from './utils';
import { ViewService, ViewItems } from './view';
import { VisibilityServiceProvider } from './visibility';
import { isAndroid, isIOS } from './utils';
var DeviceStableState = (function () {
    function DeviceStableState() {
        this.suggestedGeolocationSubscription = undefined;
        this.userTracking = 'none';
        this.displayMode = 'other';
        this.isPresentingHMD = false;
        this.isPresentingRealityHMD = false;
        this.strict = false;
    }
    return DeviceStableState;
}());
export { DeviceStableState };
var DeviceFrameState = (function () {
    function DeviceFrameState() {
        this._scratchFrustum = new PerspectiveFrustum();
        this.time = JulianDate.now();
        this.viewport = new CanvasViewport;
        this.subviews = [{
                type: SubviewType.SINGULAR,
                viewport: new Viewport,
                projectionMatrix: (this._scratchFrustum.near = DEFAULT_NEAR_PLANE,
                    this._scratchFrustum.far = DEFAULT_FAR_PLANE,
                    this._scratchFrustum.fov = CesiumMath.PI_OVER_THREE,
                    this._scratchFrustum.aspectRatio = 1,
                    Matrix4.clone(this._scratchFrustum.projectionMatrix))
            }];
        this.userTracking = 'none';
    }
    return DeviceFrameState;
}());
export { DeviceFrameState };
;
var Device = (function () {
    function Device(owner, entityService, viewItems) {
        var _this = this;
        this.owner = owner;
        this.entityService = entityService;
        this.viewItems = viewItems;
        this.userTracking = 'none';
        this.displayMode = isIOS || isAndroid ? 'hand' : 'other';
        this.screenOrientation = 0;
        this.frameState = new DeviceFrameState;
        this.frameStateEvent = new Event();
        this.vrDisplaysUpdatedEvent = new Event();
        this.vrDisplayChangeEvent = new Event();
        this.userTrackingChangeEvent = new Event();
        this.displayModeChangeEvent = new Event();
        this.screenOrientationChangeEvent = new Event();
        this.suggestedGeolocationSubscriptionChangeEvent = new Event();
        this.deviceGeolocation = new Entity({
            id: 'ar.device-geolocation',
            position: new DynamicPositionProperty(undefined, ReferenceFrame.FIXED),
            orientation: new DynamicProperty(undefined)
        });
        this.deviceOrientation = new Entity({
            id: 'ar.device-orientation',
            position: new DynamicPositionProperty(Cartesian3.ZERO, this.deviceGeolocation),
            orientation: new DynamicProperty(undefined)
        });
        this.origin = new Entity({
            id: 'ar.device.origin',
            name: 'Device Origin',
            position: new DynamicPositionProperty(undefined, this.deviceGeolocation),
            orientation: new DynamicProperty(undefined)
        });
        this.stage = new Entity({
            id: 'ar.device.stage',
            name: 'Device Stage',
            position: new DynamicPositionProperty(undefined, this.deviceGeolocation),
            orientation: new DynamicProperty(undefined)
        });
        this.user = new Entity({
            id: 'ar.device.user',
            name: 'Device User',
            position: new DynamicPositionProperty(undefined, this.origin),
            orientation: new DynamicProperty(undefined)
        });
        // for now, only use webvr when not in argon-app
        this._useWebVR = (typeof navigator !== 'undefined' &&
            navigator.getVRDisplays &&
            navigator.userAgent.indexOf('Argon') > 0 === false);
        this._scratchCartesian = new Cartesian3;
        this._scratchFrustum = new PerspectiveFrustum();
        this.naturalUserHeight = AVERAGE_EYE_HEIGHT;
        this._running = false;
        this._previousNumListeners = 0;
        this._handleScreenOrientationChange = function () {
            var end = function (dispatchEvent) {
                clearInterval(interval);
                clearTimeout(timeout);
                _this.screenOrientationChangeEvent.raiseEvent(undefined);
            };
            var lastInnerWidth;
            var lastInnerHeight;
            var noChangeCount;
            var interval = setInterval(function () {
                if (window.innerWidth === lastInnerWidth && window.innerHeight === lastInnerHeight) {
                    noChangeCount++;
                    if (noChangeCount === 100) {
                        end(true);
                    }
                }
                else {
                    lastInnerWidth = window.innerWidth;
                    lastInnerHeight = window.innerHeight;
                    noChangeCount = 0;
                }
            });
            var timeout = setTimeout(function () {
                end(true);
            }, 1000);
        };
        this._handleVRDisplayPresentChange = function (e) {
            var display = e.display || e.detail.vrdisplay || e.detail.display;
            if (display && display === _this.vrDisplay) {
                var newDisplayMode = display.isPresenting ? 'head' :
                    display.capabilities.hasOrientation ? 'hand' : 'other';
                if (newDisplayMode !== _this.displayMode) {
                    _this.displayMode = newDisplayMode;
                    _this.displayModeChangeEvent.raiseEvent(undefined);
                }
            }
        };
        this._onUpdateFrameState = function () {
            var state = _this.frameState;
            JulianDate.now(state.time);
            state['strict'] = _this.strict; // backwards-compat
            try {
                _this.onUpdateFrameState();
                _this.frameStateEvent.raiseEvent(state);
            }
            catch (e) {
                _this.owner.manager.sendError(e);
                _this.owner.errorEvent.raiseEvent(e);
            }
            if (_this.frameStateEvent.numberOfListeners > 0) {
                _this.requestAnimationFrame(_this._onUpdateFrameState);
            }
            else {
                _this._running = false;
                return;
            }
        };
        this._scratchQuaternion = new Quaternion;
        this._scratchQuaternion2 = new Quaternion;
        this._scratchMatrix3 = new Matrix3;
        this._scratchMatrix4 = new Matrix4;
        this._defaultLeftBounds = [0.0, 0.0, 0.5, 1.0];
        this._defaultRightBounds = [0.5, 0.0, 0.5, 1.0];
        this._sittingSpace = new Entity({
            position: new DynamicPositionProperty,
            orientation: new DynamicProperty
        });
        this._negX90 = Quaternion.fromAxisAngle(Cartesian3.UNIT_X, -CesiumMath.PI_OVER_TWO);
        /**
         * Request an animation frame callback
         */
        this.requestAnimationFrame = function (callback) {
            if (_this.vrDisplay && _this.vrDisplay.isPresenting) {
                return _this.vrDisplay.requestAnimationFrame(callback);
            }
            else {
                return requestAnimationFrame(callback);
            }
        };
        /**
         * Cancel an animation frame callback
         */
        this.cancelAnimationFrame = function (id) {
            if (_this.vrDisplay) {
                _this.vrDisplay.cancelAnimationFrame(id);
            }
            else {
                cancelAnimationFrame(id);
            }
        };
        this._scratchGeolocationCartesian = new Cartesian3;
        this._scratchGeolocationMatrix4 = new Matrix4;
        this._srcatchGeolocationMatrix3 = new Matrix3;
        this._scratchGeolocationQuaternion = new Quaternion;
        this._eastUpSouthToFixedFrame = eastUpSouthToFixedFrame;
        this._scratchCartographic = new Cartographic;
        var addEventListener = this.frameStateEvent.addEventListener.bind(this.frameStateEvent);
        this.frameStateEvent.addEventListener = function (callback) {
            var result = addEventListener(callback);
            _this._checkFrameStateListeners();
            return result;
        };
        var removeEventListener = this.frameStateEvent.removeEventListener.bind(this.frameStateEvent);
        this.frameStateEvent.removeEventListener = function (callback) {
            var result = removeEventListener(callback);
            _this._checkFrameStateListeners();
            return result;
        };
        if (owner.isRealityManager) {
            this.entityService.subscribedEvent.addEventListener(function (evt) {
                if (evt.id === 'ar.origin' || evt.id === 'ar.stage') {
                    _this.suggestedGeolocationSubscription = evt.options || {};
                    _this.suggestedGeolocationSubscriptionChangeEvent.raiseEvent(undefined);
                }
            });
            this.entityService.unsubscribedEvent.addEventListener(function (evt) {
                if (evt.id === 'ar.origin' || evt.id === 'ar.stage') {
                    _this.suggestedGeolocationSubscription = undefined;
                    _this.suggestedGeolocationSubscriptionChangeEvent.raiseEvent(undefined);
                }
            });
        }
    }
    Device.prototype.getSubviewEntity = function (index) {
        var subviewEntity = this.entityService.collection.getOrCreateEntity('ar.device.view_' + index);
        if (!subviewEntity.position) {
            subviewEntity.position = new DynamicPositionProperty(Cartesian3.ZERO, this.user);
        }
        if (!subviewEntity.orientation) {
            subviewEntity.orientation = new DynamicProperty(Quaternion.IDENTITY);
        }
        return subviewEntity;
    };
    Object.defineProperty(Device.prototype, "strict", {
        get: function () {
            return !!(this._overrideState && this._overrideState.strict) ||
                this.displayMode === 'head' && !this._hasPolyfillWebVRDisplay();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Device.prototype, "suggestedUserHeight", {
        /**
         * @private
         * deprecated
         * */
        get: function () {
            return this.displayMode === 'head' ? this.naturalUserHeight : this.naturalUserHeight * 0.75;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Device.prototype, "hasSeparateRealityLayer", {
        // The device is able to render reality into a separate layer in the primary display
        get: function () {
            return (this.vrDisplay && !!this.vrDisplay.displayName.match(/polyfill/g)) || this.vrDisplay === undefined;
        },
        enumerable: true,
        configurable: true
    });
    Device.prototype._checkFrameStateListeners = function () {
        // if we have listeners, subscribe to device state, otherwise, unsubscribe
        var numListeners = this.frameStateEvent.numberOfListeners;
        var previousNumListeners = this._previousNumListeners;
        this._previousNumListeners = numListeners;
        if (typeof window === 'undefined' || !window.addEventListener) {
            if (previousNumListeners === 0 && numListeners === 1 && !this._running) {
                this._running = true;
                this.requestAnimationFrame(this._onUpdateFrameState);
            }
            return;
        }
        if (previousNumListeners === 0 && numListeners === 1) {
            if (this._useWebVR) {
                this._selectVRDisplay();
            }
            else {
                this.userTracking = isIOS || isAndroid ? '3DOF' : 'none';
                this.userTrackingChangeEvent.raiseEvent(undefined);
            }
            window.addEventListener('orientationchange', this._handleScreenOrientationChange);
            window.addEventListener('vrdisplaypresentchange', this._handleVRDisplayPresentChange);
            this.requestAnimationFrame(this._onUpdateFrameState);
        }
        else if (previousNumListeners === 1 && numListeners === 0) {
            var vrDisplay = this.vrDisplay;
            if (vrDisplay) {
                if (vrDisplay.isPresenting)
                    vrDisplay.exitPresent();
                this.vrDisplay = undefined;
                this.vrDisplayChangeEvent.raiseEvent(undefined);
                this.userTracking = 'none';
                this.userTrackingChangeEvent.raiseEvent(undefined);
            }
            window.removeEventListener('orientationchange', this._handleScreenOrientationChange);
            window.removeEventListener('vrdisplaypresentchange', this._handleVRDisplayPresentChange);
        }
    };
    Device.prototype._selectVRDisplay = function () {
        var _this = this;
        navigator.getVRDisplays().then(function (displays) {
            _this.vrDisplays = displays;
            var display = _this.vrDisplay = displays[0];
            if (!display)
                return;
            _this.userTracking =
                display.capabilities.hasPosition && display.capabilities.hasOrientation ?
                    "6DOF" : "3DOF";
            _this.vrDisplaysUpdatedEvent.raiseEvent(undefined);
            _this.vrDisplayChangeEvent.raiseEvent(undefined);
            _this.userTrackingChangeEvent.raiseEvent(undefined);
        });
    };
    Device.prototype.onUpdateFrameState = function () {
        this._updateViewport();
        // use webvr if the current display is not an external display and can't present, 
        // or if it is currently presenting
        var vrDisp = this.vrDisplay;
        if (vrDisp && vrDisp.isPresenting ||
            vrDisp && !vrDisp.capabilities.hasExternalDisplay &&
                !vrDisp.capabilities.canPresent && vrDisp.displayName.indexOf('polyfill') === -1) {
            this._updateForWebVR();
        }
        else {
            this._updateDefault();
        }
    };
    Device.prototype._updateViewport = function () {
        var overrideState = this._overrideState;
        var state = this.frameState;
        var viewport = state.viewport;
        if (overrideState && overrideState.viewport) {
            CanvasViewport.clone(overrideState.viewport, viewport);
        }
        else {
            var element = this.viewItems.element;
            viewport.x = 0;
            viewport.y = 0;
            viewport.width = element && element.clientWidth || 0;
            viewport.height = element && element.clientHeight || 0;
            var vrDisplay = this.vrDisplay;
            if (vrDisplay && vrDisplay.isPresenting) {
                var leftEye = vrDisplay.getEyeParameters("left");
                var rightEye = vrDisplay.getEyeParameters("right");
                var viewport_1 = state.viewport;
                viewport_1.renderWidthScaleFactor = 2 * Math.max(leftEye.renderWidth, rightEye.renderWidth) / viewport_1.width;
                viewport_1.renderHeightScaleFactor = Math.max(leftEye.renderHeight, rightEye.renderHeight) / viewport_1.height;
            }
            else {
                viewport.renderHeightScaleFactor = 1;
                viewport.renderWidthScaleFactor = 1;
            }
        }
    };
    Device.prototype._updateDefault = function () {
        this._updateDefaultStage();
        this._updateDefaultUser();
        this._updateDefaultOrigin();
        var overrideState = this._overrideState;
        var frameState = this.frameState;
        var viewport = frameState.viewport;
        if (overrideState && overrideState.viewport) {
            CanvasViewport.clone(overrideState.viewport, viewport);
        }
        var subviews = frameState.subviews;
        if (overrideState && overrideState.subviews) {
            SerializedSubviewList.clone(overrideState.subviews, subviews);
        }
        else {
            subviews.length = 1;
            var subview = subviews[0] || {};
            subview.type = SubviewType.SINGULAR;
            subview.viewport.x = 0;
            subview.viewport.y = 0;
            subview.viewport.width = viewport.width;
            subview.viewport.height = viewport.height;
            var aspect = viewport.width / viewport.height;
            var frustum = this._scratchFrustum;
            frustum.near = DEFAULT_NEAR_PLANE;
            frustum.far = DEFAULT_FAR_PLANE;
            frustum.fov = CesiumMath.PI_OVER_THREE;
            frustum.aspectRatio = isFinite(aspect) && aspect !== 0 ? aspect : 1;
            subview.projectionMatrix = Matrix4.clone(frustum.projectionMatrix, subview.projectionMatrix);
            var subviewEntity = this.getSubviewEntity(0);
            subviewEntity.position.setValue(Cartesian3.ZERO, this.user);
            subviewEntity.orientation.setValue(Quaternion.IDENTITY);
        }
    };
    Device.prototype._updateDefaultStage = function () {
        var stage = this.stage;
        // if manager is updating the device stage state, don't update it here
        var contextFrameState = this._contextFrameState;
        if (contextFrameState && stage.id in contextFrameState.entities)
            return;
        stage.position.setValue(Cartesian3.fromElements(0, -this.suggestedUserHeight, 0, this._scratchCartesian), this.deviceGeolocation);
        stage.orientation.setValue(Quaternion.IDENTITY);
    };
    Device.prototype._updateDefaultUser = function () {
        var user = this.user;
        this._tryOrientationUpdates();
        // if manager is updating the device user state, don't update it here
        var contextFrameState = this._contextFrameState;
        if (contextFrameState && user.id in contextFrameState.entities)
            return;
        var screenOrientation = Quaternion.fromAxisAngle(Cartesian3.UNIT_Z, this.screenOrientationDegrees * CesiumMath.RADIANS_PER_DEGREE, this._scratchQuaternion);
        user.position.setValue(Cartesian3.ZERO, this.deviceOrientation);
        user.orientation.setValue(screenOrientation);
        // const deviceOrientationValue = 
        //     (this.deviceOrientation.orientation as DynamicProperty).getValue(this.frameState.time);
        // (user.orientation as DynamicProperty).setValue(
        //     Quaternion.multiply(
        //         deviceOrientationValue,
        //         screenOrientation,
        //         this._scratchQuaternion
        //     )
        // );
        // stage['meta'] = stage['meta'] || {};
        // stage['meta'].geoHeadingAccuracy = this._deviceOrientationHeadingAccuracy;
    };
    Device.prototype._updateDefaultOrigin = function () {
        var origin = this.origin;
        var deviceGeolocation = this.deviceGeolocation;
        // if manager is updating the device origin state, don't update it here
        var contextFrameState = this._contextFrameState;
        if (contextFrameState && origin.id in contextFrameState.entities)
            return;
        var time = this.frameState.time;
        var originPose = this.entityService.getEntityPose(origin, deviceGeolocation, time);
        var deviceGeolocationPose = this.entityService.getEntityPose(deviceGeolocation, ReferenceFrame.FIXED, time);
        if ((originPose.status & PoseStatus.KNOWN) === 0 && deviceGeolocationPose.status & PoseStatus.KNOWN ||
            origin.position.referenceFrame !== ReferenceFrame.FIXED && deviceGeolocationPose.status & PoseStatus.KNOWN ||
            originPose.status & PoseStatus.KNOWN && deviceGeolocationPose.status & PoseStatus.KNOWN &&
                Cartesian3.magnitudeSquared(originPose.position) > 10000) {
            origin.position.setValue(deviceGeolocationPose.position, ReferenceFrame.FIXED);
            origin.orientation.setValue(deviceGeolocationPose.orientation);
            console.log('Updated device origin to ' + JSON.stringify(deviceGeolocationPose.position) + " at FIXED");
            return;
        }
        if ((deviceGeolocationPose.status & PoseStatus.KNOWN) === 0) {
            origin.position.setValue(Cartesian3.ZERO, deviceGeolocation);
            origin.orientation.setValue(Quaternion.IDENTITY);
        }
    };
    Device.prototype._updateForWebVR = function () {
        var vrDisplay = this.vrDisplay;
        if (!vrDisplay)
            throw new Error('No vr display!');
        var frameState = this.frameState;
        var vrFrameData = this._vrFrameData =
            this._vrFrameData || new VRFrameData();
        vrDisplay.getFrameData(vrFrameData);
        var layer = vrDisplay.getLayers()[0];
        var leftBounds = layer && layer.leftBounds;
        var rightBounds = layer && layer.rightBounds;
        if (layer) {
            leftBounds = layer.leftBounds && layer.leftBounds.length === 4 ? layer.leftBounds : this._defaultLeftBounds;
            rightBounds = layer.rightBounds && layer.rightBounds.length === 4 ? layer.rightBounds : this._defaultRightBounds;
        }
        else {
            leftBounds = this._defaultLeftBounds;
            rightBounds = this._defaultRightBounds;
        }
        var viewport = frameState.viewport;
        var subviews = frameState.subviews = frameState.subviews || [];
        subviews.length = 2;
        var leftSubview = subviews[0] = subviews[0] || {};
        var rightSubview = subviews[1] = subviews[1] || {};
        leftSubview.type = SubviewType.LEFTEYE;
        rightSubview.type = SubviewType.RIGHTEYE;
        var leftViewport = leftSubview.viewport = leftSubview.viewport || {};
        leftViewport.x = leftBounds[0] * viewport.width;
        leftViewport.y = leftBounds[1] * viewport.height;
        leftViewport.width = leftBounds[2] * viewport.width;
        leftViewport.height = leftBounds[3] * viewport.height;
        var rightViewport = rightSubview.viewport = rightSubview.viewport || {};
        rightViewport.x = rightBounds[0] * viewport.width;
        rightViewport.y = rightBounds[1] * viewport.height;
        rightViewport.width = rightBounds[2] * viewport.width;
        rightViewport.height = rightBounds[3] * viewport.height;
        leftSubview.projectionMatrix = Matrix4.clone(vrFrameData.leftProjectionMatrix, leftSubview.projectionMatrix);
        rightSubview.projectionMatrix = Matrix4.clone(vrFrameData.rightProjectionMatrix, rightSubview.projectionMatrix);
        var user = this.user;
        // Define "sitting space", positioned at device geolocation
        this._sittingSpace.position.setValue(Cartesian3.ZERO, this.deviceGeolocation);
        this._sittingSpace.orientation.setValue(Quaternion.IDENTITY);
        // let stage be equivalent to "standing space"
        var sittingToStandingTransform = vrDisplay.stageParameters ?
            vrDisplay.stageParameters.sittingToStandingTransform :
            Matrix4.IDENTITY;
        var standingToSittingTransform = Matrix4.inverseTransformation(sittingToStandingTransform, this._scratchMatrix4);
        var standingToSittingPosition = Matrix4.getTranslation(standingToSittingTransform, this._scratchCartesian);
        var standingToSittingRotation = Matrix4.getRotation(standingToSittingTransform, this._scratchMatrix3);
        var standingToSittingOrientation = Quaternion.fromRotationMatrix(standingToSittingRotation, this._scratchQuaternion);
        this.stage.position.setValue(standingToSittingPosition, this._sittingSpace);
        this.stage.orientation.setValue(standingToSittingOrientation);
        // let origin also be at "standing space"
        this.origin.position.setValue(Cartesian3.ZERO, this.stage);
        this.origin.orientation.setValue(Quaternion.IDENTITY);
        // user pose is given in "sitting space"
        var hasPosition = vrDisplay.capabilities.hasPosition;
        var userPosition = !hasPosition ?
            Cartesian3.ZERO : vrFrameData.pose.position ?
            Cartesian3.unpack(vrFrameData.pose.position, 0, this._scratchCartesian) : undefined;
        var userOrientation = vrFrameData.pose.orientation ?
            Quaternion.unpack(vrFrameData.pose.orientation, 0, this._scratchQuaternion2) : undefined;
        user.position.setValue(userPosition, this._sittingSpace);
        user.orientation.setValue(userOrientation);
        // left eye transform is given relative to sitting space
        var leftEyeTransform = Matrix4.inverseTransformation(vrFrameData.leftViewMatrix, this._scratchMatrix4);
        var leftEye = this.getSubviewEntity(0);
        var leftEyePosition = Matrix4.getTranslation(leftEyeTransform, this._scratchCartesian);
        var leftEyeRotation = Matrix4.getRotation(leftEyeTransform, this._scratchMatrix3);
        var leftEyeOrientation = Quaternion.fromRotationMatrix(leftEyeRotation, this._scratchQuaternion);
        leftEye.position.setValue(leftEyePosition, this._sittingSpace);
        leftEye.orientation.setValue(leftEyeOrientation);
        // right eye transform is given relative to sitting space
        var rightEyeTransform = Matrix4.inverseTransformation(vrFrameData.rightViewMatrix, this._scratchMatrix4);
        var rightEye = this.getSubviewEntity(1);
        var rightEyePosition = Matrix4.getTranslation(rightEyeTransform, this._scratchCartesian);
        var rightEyeRotation = Matrix4.getRotation(rightEyeTransform, this._scratchMatrix3);
        var rightEyeOrientation = Quaternion.fromRotationMatrix(rightEyeRotation, this._scratchQuaternion);
        rightEye.position.setValue(rightEyePosition, this._sittingSpace);
        rightEye.orientation.setValue(rightEyeOrientation);
        // the polyfill does not support reporting an absolute orientation (yet), 
        // so fall back to the default origin/stage/user pose in this case
        if (vrDisplay.displayName.includes('polyfill')) {
            // change left/right eye pose to be relative to user, 
            // which is necessary since we are redefining the user pose to use absolute orientation
            var leftEyeRelativeToUser = this.entityService.getEntityPose(leftEye, user, frameState.time);
            var rightEyeRelativeToUser = this.entityService.getEntityPose(rightEye, user, frameState.time);
            leftEye.position.setValue(leftEyeRelativeToUser.position, user);
            rightEye.position.setValue(rightEyeRelativeToUser.position, user);
            leftEye.orientation.setValue(leftEyeRelativeToUser.orientation);
            rightEye.orientation.setValue(rightEyeRelativeToUser.orientation);
            this._updateDefaultStage();
            this._updateDefaultUser();
            return;
        }
    };
    Device.prototype._tryOrientationUpdates = function () {
        var _this = this;
        if (typeof window == 'undefined' || !window.addEventListener)
            return;
        if (defined(this._deviceOrientationListener))
            return;
        var headingDrift = 0;
        var alphaOffset = undefined;
        this._deviceOrientationListener = function (e) {
            var alphaDegrees = e.alpha;
            var webkitCompassHeading = e['webkitCompassHeading'];
            var webkitCompassAccuracy = +e['webkitCompassAccuracy'];
            if (!defined(alphaDegrees)) {
                return;
            }
            if (e.absolute) {
                alphaOffset = 0;
            }
            // when the phone is almost updside down, webkit flips the compass heading 
            // (not documented anywhere, annoyingly)
            // if (e.beta >= 130 || e.beta <= -130) webkitCompassHeading = undefined;
            _this._deviceOrientationHeadingAccuracy = webkitCompassAccuracy > 0 ? webkitCompassAccuracy : undefined;
            if ((!defined(alphaOffset) || Math.abs(headingDrift) > 5) &&
                defined(webkitCompassHeading) &&
                webkitCompassAccuracy >= 0 &&
                webkitCompassAccuracy < 80 &&
                webkitCompassHeading >= 0) {
                if (!defined(alphaOffset)) {
                    alphaOffset = -webkitCompassHeading;
                }
                else {
                    alphaOffset -= headingDrift;
                }
            }
            if (!defined(alphaOffset) ||
                !defined(e.alpha) ||
                !defined(e.beta) ||
                !defined(e.gamma))
                return;
            var alpha = CesiumMath.RADIANS_PER_DEGREE * (e.alpha + alphaOffset || -webkitCompassHeading || 0);
            var beta = CesiumMath.RADIANS_PER_DEGREE * e.beta;
            var gamma = CesiumMath.RADIANS_PER_DEGREE * e.gamma;
            var alphaQuat = Quaternion.fromAxisAngle(Cartesian3.UNIT_Z, alpha, _this._scratchQuaternion);
            var betaQuat = Quaternion.fromAxisAngle(Cartesian3.UNIT_X, beta, _this._scratchQuaternion2);
            var alphaBetaQuat = Quaternion.multiply(alphaQuat, betaQuat, _this._scratchQuaternion);
            var gammaQuat = Quaternion.fromAxisAngle(Cartesian3.UNIT_Y, gamma, _this._scratchQuaternion2);
            var alphaBetaGammaQuat = Quaternion.multiply(alphaBetaQuat, gammaQuat, _this._scratchQuaternion);
            // finally, convert from ENU to EUS
            var deviceOrientationValue = Quaternion.multiply(_this._negX90, alphaBetaGammaQuat, _this._scratchQuaternion2); // rotate from ENU to EUS
            _this.deviceOrientation.orientation.setValue(deviceOrientationValue);
            _this.deviceOrientation['meta'] = _this.deviceOrientation['meta'] || {};
            _this.deviceOrientation['meta'].geoHeadingAccuracy = webkitCompassAccuracy || undefined;
            // TODO: fix heading drift calculation (heading should match webkitCompassHeading)
            // if (defined(webkitCompassHeading)) {
            //     const q = alphaBetaGammaQuat//utils.getEntityOrientationInReferenceFrame(this.interfaceEntity, JulianDate.now(), this.locationEntity, this._scratchQuaternion1);
            //     var heading = -Math.atan2(2*(q.w*q.z + q.x*q.y), 1 - 2*(q.y*q.y + q.z*q.z));
            //     if (heading < 0) heading += 2*Math.PI;
            //     const {swing,twist} = swingTwistDecomposition(alphaBetaGammaQuat, Cartesian3.UNIT_Z);
            //     const twistAngle = 2 * Math.acos(twist.w);
            //     console.log(twist.w + ' ' + twistAngle * CesiumMath.DEGREES_PER_RADIAN + '\n' + webkitCompassHeading);
            //     // this._headingDrift = webkitCompassHeading - heading * CesiumMath.DEGREES_PER_RADIAN;
            // }
        };
        if ('ondeviceorientationabsolute' in window) {
            window.addEventListener('deviceorientationabsolute', this._deviceOrientationListener);
        }
        else if ('ondeviceorientation' in window) {
            window.addEventListener('deviceorientation', this._deviceOrientationListener);
        }
    };
    Device.prototype._hasPolyfillWebVRDisplay = function () {
        return !!this.vrDisplay && !!this.vrDisplay.displayName.match(/polyfill/g);
    };
    Object.defineProperty(Device.prototype, "screenOrientationDegrees", {
        get: function () {
            return typeof window !== 'undefined' ? (screen['orientation'] && -screen['orientation'].angle) || -window.orientation || 0 : 0;
        },
        enumerable: true,
        configurable: true
    });
    Device.prototype.requestHeadDisplayMode = function () {
        var vrDisplay = this.vrDisplay;
        var element = this.viewItems.element;
        var viewLayers = this.viewItems.layers;
        if (!element)
            return Promise.reject(new Error("A DOM element is required"));
        if (!vrDisplay || !vrDisplay.capabilities.canPresent)
            return Promise.reject(new Error("Display mode 'head' is not supported"));
        var layers = [{
                source: viewLayers && viewLayers[0] && viewLayers[0].source ||
                    element.querySelector('canvas') ||
                    element.lastElementChild
            }];
        return vrDisplay.requestPresent(layers);
    };
    Device.prototype.exitHeadDisplayMode = function () {
        return this.vrDisplay && this.vrDisplay.isPresenting
            ? this.vrDisplay.exitPresent() : Promise.reject(new Error("Display is not currently in 'head' mode"));
    };
    Device.prototype._setState = function (state) {
        this._overrideState = state;
        if (this.userTracking !== state.userTracking) {
            this.userTracking = state.userTracking;
            this.userTrackingChangeEvent.raiseEvent(undefined);
        }
        if (this.displayMode !== state.displayMode) {
            this.displayMode = state.displayMode;
            this.displayModeChangeEvent.raiseEvent(undefined);
        }
        if (!jsonEquals(this.suggestedGeolocationSubscription, state.suggestedGeolocationSubscription)) {
            this.suggestedGeolocationSubscription = state.suggestedGeolocationSubscription;
            this.suggestedGeolocationSubscriptionChangeEvent.raiseEvent(undefined);
        }
    };
    Device.prototype.onGeolocationUpdate = function (cartographic, geoHorizontalAccuracy, geoVerticalAccuracy) {
        var _this = this;
        if (!defined(geoVerticalAccuracy) && cartographic.height === 0) {
            updateHeightFromTerrain(cartographic).then(function () { return _this.onGeolocationUpdate(cartographic, geoHorizontalAccuracy, 0); });
            return;
        }
        var geolocation = this.deviceGeolocation;
        var fixedPosition = Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, cartographic.height, undefined, this._scratchGeolocationCartesian);
        var eusTransform = this._eastUpSouthToFixedFrame(fixedPosition, undefined, this._scratchGeolocationMatrix4);
        var eusRotation = Matrix4.getRotation(eusTransform, this._srcatchGeolocationMatrix3);
        var eusOrientation = Quaternion.fromRotationMatrix(eusRotation, this._scratchGeolocationQuaternion);
        geolocation.position.setValue(fixedPosition, ReferenceFrame.FIXED);
        geolocation.orientation.setValue(eusOrientation);
        var gpsMeta = geolocation['meta'] = geolocation['meta'] || {};
        gpsMeta.geoHorizontalAccuracy = geoHorizontalAccuracy;
        gpsMeta.geoVerticalAccuracy = geoVerticalAccuracy;
    };
    /**
     * Overridable. Should call configureStage when new geolocation is available
     */
    Device.prototype.startGeolocationUpdates = function (options) {
        var _this = this;
        if (typeof navigator == 'undefined' || !navigator.geolocation)
            throw new Error('Unable to start geolocation updates');
        if (!defined(this._geolocationWatchId)) {
            this._geolocationWatchId = navigator.geolocation.watchPosition(function (pos) {
                var longDegrees = pos.coords.longitude;
                var latDegrees = pos.coords.latitude;
                var altitude = pos.coords.altitude;
                var cartographic = Cartographic.fromDegrees(longDegrees, latDegrees, altitude || 0, _this._scratchCartographic);
                _this.onGeolocationUpdate(cartographic, (pos.coords.accuracy > 0) ? pos.coords.accuracy : undefined, pos.coords.altitudeAccuracy || undefined);
            }, function (e) {
                console.warn('Unable to start geolocation updates: ' + e.message);
            }, options);
        }
    };
    /**
     * Overridable.
     */
    Device.prototype.stopGeolocationUpdates = function () {
        if (typeof navigator !== 'undefined' && defined(this._geolocationWatchId)) {
            navigator.geolocation.clearWatch(this._geolocationWatchId);
            this._geolocationWatchId = undefined;
        }
    };
    Device = __decorate([
        autoinject,
        __metadata("design:paramtypes", [SessionService,
            EntityService,
            ViewItems])
    ], Device);
    return Device;
}());
export { Device };
/**
 * The DeviceService provides the current device state
 */
var DeviceService = (function () {
    function DeviceService(sessionService, entityService, viewService, _device) {
        var _this = this;
        this.sessionService = sessionService;
        this.entityService = entityService;
        this.viewService = viewService;
        this._device = _device;
        /**
         * If this is true (and we are presenting via webvr api), then
         * vrDisplay.submitFrame is called after the frameState event
         */
        this.autoSubmitFrame = true;
        /**
         * Device state for the current frame. This
         * is not updated unless the view is visible.
         */
        this.frameState = this._device.frameState;
        /**
         * An event that fires every time the device frameState is updated.
         */
        this.frameStateEvent = new Event();
        /**
         * An even that fires when the view starts or stops presenting to an HMD.
         * Deprecated. Use displayModeChangeEvent
         */
        this.presentHMDChangeEvent = this._device.displayModeChangeEvent;
        /**
         * An event that fires when the display changes
         */
        this.vrDisplayChangeEvent = this._device.vrDisplayChangeEvent;
        /**
         * An even that fires when the display mode changes
         */
        this.displayModeChangeEvent = this._device.displayModeChangeEvent;
        /*
         * An event that fires when the screen orientation changes
         */
        this.screenOrientationChangeEvent = this._device.screenOrientationChangeEvent;
        /*
         * An event that fires when userTracking state changes
         */
        this.userTrackingChangeEvent = this._device.userTrackingChangeEvent;
        /*
         * An event that fires when getVRDisplay() is finished
         */
        this.vrDisplaysUpdatedEvent = this._device.vrDisplaysUpdatedEvent;
        /**
         * A coordinate system representing the physical space in which the user is free to
         * move around, positioned on the surface the user is standing on,
         * where +X is east, +Y is up, and +Z is south (East-Up-South), if geolocation is known.
         * If the stage is not geolocated, then the +X and +Z directions are arbitrary.
         */
        this.stage = this._device.stage;
        /**
         * An entity representing the origin of the device coordinate system, +Y up.
         */
        this.origin = this._device.origin;
        /**
         * An entity representing the physical pose of the user,
         * where +X is right, +Y is up, and -Z is forward
         */
        this.user = this._device.user;
        /*
        * An event that fires when the screen orientation changes
        */
        this.suggestedGeolocationSubscriptionChangeEvent = this._device.suggestedGeolocationSubscriptionChangeEvent;
        /**
         * Request an animation frame callback for the current view.
         */
        this.requestAnimationFrame = this._device.requestAnimationFrame.bind(this._device);
        /**
         * Cancel an animation frame callback for the current view.
         */
        this.cancelAnimationFrame = this._device.cancelAnimationFrame.bind(this._device);
        this._onDeviceFrameEvent = function () {
            _this.frameStateEvent.raiseEvent(_this._device.frameState);
        };
        this.getSubviewEntity = this._device.getSubviewEntity.bind(this._device);
        this.entityService.collection.add(this.stage);
        this.entityService.collection.add(this.origin);
        this.entityService.collection.add(this.user);
        this.entityService.collection.add(this._device.deviceGeolocation);
        this.entityService.collection.add(this._device.deviceOrientation);
        this._startUpdates();
        this.sessionService.manager.closeEvent.addEventListener(function () { return _this._stopUpdates(); });
        if (!this.sessionService.isRealityManager) {
            sessionService.manager.on['ar.device.state'] = sessionService.manager.on['ar.device.frameState'] = function (stableState) {
                // only apply device state if we the owning session
                if (_this._device.owner === _this.sessionService) {
                    _this._device._setState(stableState);
                }
            };
        }
    }
    Object.defineProperty(DeviceService.prototype, "vrDisplay", {
        get: function () { return this._device.vrDisplay; },
        enumerable: true,
        configurable: true
    });
    ;
    Object.defineProperty(DeviceService.prototype, "vrDisplays", {
        get: function () { return this._device.vrDisplays; },
        enumerable: true,
        configurable: true
    });
    ;
    Object.defineProperty(DeviceService.prototype, "displayMode", {
        get: function () { return this._device.displayMode; },
        enumerable: true,
        configurable: true
    });
    ;
    Object.defineProperty(DeviceService.prototype, "screenOrientationDegrees", {
        get: function () {
            return this._device.screenOrientationDegrees;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DeviceService.prototype, "userTracking", {
        /**
         * Returns the DOF support of the device.
         * "none"|"3DOF"|"6DOF"
         */
        get: function () {
            return this._device.userTracking;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DeviceService.prototype, "geoHeadingAccuracy", {
        /**
         * The heading accuracy of the user's geopose
         */
        get: function () {
            return this.stage['meta'] ? this.stage['meta'].geoHeadingAccuracy : undefined;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DeviceService.prototype, "geoHorizontalAccuracy", {
        /**
         * The horizontal accuracy of the user's geopose
         */
        get: function () {
            return this.stage['meta'] ? this.stage['meta'].geoHorizontalAccuracy : undefined;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DeviceService.prototype, "geoVerticalAccuracy", {
        /**
         * The horizontal accuracy of the user's geopose
         */
        get: function () {
            return this.stage['meta'] ? this.stage['meta'].geoVerticalAccuracy : undefined;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DeviceService.prototype, "suggestedGeolocationSubscription", {
        get: function () {
            return this._device.suggestedGeolocationSubscription;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DeviceService.prototype, "suggestedUserHeight", {
        get: function () {
            return this._device.suggestedUserHeight;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DeviceService.prototype, "strict", {
        get: function () {
            return this._device.strict;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Internal.
     * @private
     */
    DeviceService.prototype._processContextFrameState = function (frameState) {
        this._device._contextFrameState = frameState;
    };
    /**
     * Start emmitting frameState events
     */
    DeviceService.prototype._startUpdates = function () {
        var _this = this;
        this.sessionService.manager.whenConnected().then(function () {
            if (_this.sessionService.manager.version[0] > 0) {
                _this.sessionService.manager.send('ar.device.startUpdates');
            }
        });
        this._device.frameStateEvent.addEventListener(this._onDeviceFrameEvent);
    };
    /**
     * Stop emitting frameState events
     */
    DeviceService.prototype._stopUpdates = function () {
        var _this = this;
        this.sessionService.manager.whenConnected().then(function () {
            if (_this.sessionService.manager.version[0] > 0) {
                _this.sessionService.manager.send('ar.device.stopUpdates');
            }
        });
        this._device.frameStateEvent.removeEventListener(this._onDeviceFrameEvent);
    };
    DeviceService.prototype.onRequestPresentHMD = function () {
        return this._device.requestHeadDisplayMode();
    };
    DeviceService.prototype.onExitPresentHMD = function () {
        return this._device.exitHeadDisplayMode();
    };
    DeviceService.prototype.createContextFrameState = function (time, viewport, subviewList, options) {
        return ArgonSystem.instance.context.createFrameState(time, viewport, subviewList, options);
    };
    DeviceService.prototype.subscribeGeolocation = function (options, session) {
        var _this = this;
        if (session === void 0) { session = this.sessionService.manager; }
        return this.sessionService.manager.whenConnected().then(function () {
            if (_this.sessionService.manager.versionNumber >= 1.4)
                return _this.entityService.subscribe(_this.origin.id, options).then(function () { });
            else
                return _this.entityService.subscribe(_this.stage.id, options).then(function () { });
        });
    };
    DeviceService.prototype.unsubscribeGeolocation = function (session) {
        var _this = this;
        if (session === void 0) { session = this.sessionService.manager; }
        this.sessionService.manager.whenConnected().then(function () {
            if (_this.sessionService.manager.versionNumber >= 1.4)
                _this.entityService.unsubscribe(_this.origin.id);
            else
                _this.entityService.unsubscribe(_this.stage.id);
        });
    };
    Object.defineProperty(DeviceService.prototype, "isPresentingHMD", {
        /**
         * Is the view presenting to an HMD.
         * Same as `displayMode === 'head'`.
         */
        get: function () {
            return this._device.displayMode === 'head';
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DeviceService.prototype, "isPresentingRealityHMD", {
        /**
         * Is the current reality presenting to an HMD.
         * Same as `displayMode === 'head' && `hasSeparateRealityLayer === true`.
         */
        get: function () {
            return this._device.displayMode === 'head' && this._device.hasSeparateRealityLayer;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DeviceService.prototype, "hasSeparateRealityLayer", {
        get: function () {
            return this._device.hasSeparateRealityLayer;
        },
        enumerable: true,
        configurable: true
    });
    DeviceService.prototype.requestPresentHMD = function () {
        if (!this.sessionService.manager.isConnected)
            throw new Error('Session must be connected');
        if (this.sessionService.isRealityManager) {
            return this.onRequestPresentHMD();
        }
        return this.sessionService.manager.request('ar.device.requestPresentHMD');
    };
    DeviceService.prototype.exitPresentHMD = function () {
        if (!this.sessionService.manager.isConnected)
            throw new Error('Session must be connected');
        if (this.sessionService.isRealityManager) {
            return this.onExitPresentHMD();
        }
        return this.sessionService.manager.request('ar.device.exitPresentHMD');
    };
    __decorate([
        deprecated(),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", [JulianDate,
            CanvasViewport,
            SerializedSubviewList, Object]),
        __metadata("design:returntype", Object)
    ], DeviceService.prototype, "createContextFrameState", null);
    DeviceService = __decorate([
        singleton(true) // register in child container
        ,
        __metadata("design:paramtypes", [SessionService,
            EntityService,
            ViewService,
            Device])
    ], DeviceService);
    return DeviceService;
}());
export { DeviceService };
/**
 *
 */
var DeviceServiceProvider = (function () {
    function DeviceServiceProvider(sessionService, deviceService, viewService, entityService, entityServiceProvider, visibilityServiceProvider, device) {
        var _this = this;
        this.sessionService = sessionService;
        this.deviceService = deviceService;
        this.viewService = viewService;
        this.entityService = entityService;
        this.entityServiceProvider = entityServiceProvider;
        this.visibilityServiceProvider = visibilityServiceProvider;
        this.device = device;
        this.needsPublish = false;
        this._stableState = new DeviceStableState;
        this._targetGeolocationOptions = {};
        this._sessionGeolocationOptions = new Map();
        this.sessionService.connectEvent.addEventListener(function (session) {
            // deprecated
            session.on['ar.device.requestFrameState'] = function () { };
            session.on['ar.device.startUpdates'] = function () { };
            session.on['ar.device.stopUpdates'] = function () { };
            // to be removed (subscription options are handled by EntityService now)
            session.on['ar.device.setGeolocationOptions'] = function (_a) {
                var options = _a.options;
                _this._sessionGeolocationOptions.set(session, options);
                _this._checkDeviceGeolocationSubscribers();
            };
            session.on['ar.device.requestPresentHMD'] = function () {
                return _this.handleRequestPresentHMD(session);
            };
            session.on['ar.device.exitPresentHMD'] = function () {
                return _this.handleExitPresentHMD(session);
            };
            session.closeEvent.addEventListener(function () {
                if (_this._sessionGeolocationOptions.has(session)) {
                    _this._sessionGeolocationOptions.delete(session);
                    _this._checkDeviceGeolocationSubscribers();
                }
            });
            _this.needsPublish = true;
        });
        this.entityServiceProvider.sessionSubscribedEvent.addEventListener(function (_a) {
            var id = _a.id, options = _a.options, session = _a.session;
            if (_this.deviceService.origin.id === id) {
                _this._sessionGeolocationOptions.set(session, options);
                _this._checkDeviceGeolocationSubscribers();
            }
        });
        this.entityServiceProvider.sessionUnsubscribedEvent.addEventListener(function (_a) {
            var id = _a.id;
            if (_this.deviceService.origin.id === id)
                _this._checkDeviceGeolocationSubscribers();
        });
        var setNeedsPublish = function () { return _this.needsPublish = true; };
        this.deviceService.suggestedGeolocationSubscriptionChangeEvent.addEventListener(setNeedsPublish);
        this.deviceService.screenOrientationChangeEvent.addEventListener(setNeedsPublish);
        this.deviceService.userTrackingChangeEvent.addEventListener(setNeedsPublish);
        this.deviceService.displayModeChangeEvent.addEventListener(setNeedsPublish);
        this.viewService.viewportChangeEvent.addEventListener(setNeedsPublish);
        this.viewService.viewportModeChangeEvent.addEventListener(setNeedsPublish);
        var previousViewportMode = this.viewService.viewportMode;
        this.deviceService.displayModeChangeEvent.addEventListener(function () {
            // if device mode changes to 'head', enter immersive viewport mode
            if (_this.deviceService.displayMode === 'head') {
                var vrDisplay = _this.deviceService.vrDisplay;
                if (vrDisplay && vrDisplay.displayName.match(/polyfill/g)) {
                    var layers = viewService.layers;
                    var baseLayer = layers && layers[0];
                    var canvas = baseLayer && baseLayer.source;
                    if (canvas)
                        canvas.classList.add('argon-interactive');
                    previousViewportMode = viewService.viewportMode;
                    viewService.desiredViewportMode = 1 /* IMMERSIVE */;
                }
            }
            else {
                var layers = viewService.layers;
                var baseLayer = layers && layers[0];
                var canvas = baseLayer && baseLayer.source;
                if (canvas)
                    canvas.classList.remove('argon-interactive');
                viewService.desiredViewportMode = previousViewportMode;
            }
        });
        this.deviceService.frameStateEvent.addEventListener(function (state) {
            if (_this.needsPublish ||
                _this._stableState.isPresentingHMD !== _this.deviceService.isPresentingHMD ||
                _this._stableState.isPresentingRealityHMD !== _this.deviceService.isPresentingRealityHMD ||
                CanvasViewport.equals(_this._stableState.viewport, state.viewport) === false) {
                _this.needsPublish = true;
            }
            else if (_this._stableState.subviews) {
                if (_this._stableState.subviews.length === state.subviews.length) {
                    for (var i = 0; i < state.subviews.length; i++) {
                        if (!SerializedSubview.equals(state.subviews[i], _this._stableState.subviews[i])) {
                            _this.needsPublish = true;
                            break;
                        }
                    }
                }
                else {
                    _this.needsPublish = true;
                }
            }
            if (_this.needsPublish)
                _this.publishStableState();
        });
        this.viewService.viewportModeChangeEvent.addEventListener(function (mode) {
            if (mode === 0 /* PAGE */ && _this.deviceService.vrDisplay && _this.deviceService.vrDisplay.displayName.match(/polyfill/g) && _this.deviceService.displayMode === 'head')
                _this.deviceService.exitPresentHMD();
        });
    }
    DeviceServiceProvider.prototype.handleRequestPresentHMD = function (session) {
        return this.deviceService.requestPresentHMD();
    };
    DeviceServiceProvider.prototype.handleExitPresentHMD = function (session) {
        return this.deviceService.exitPresentHMD();
    };
    DeviceServiceProvider.prototype.publishStableState = function () {
        var stableState = this._stableState;
        stableState.isPresentingHMD = this.deviceService.isPresentingHMD;
        stableState.isPresentingRealityHMD = this.deviceService.isPresentingRealityHMD;
        stableState.suggestedGeolocationSubscription = this.deviceService.suggestedGeolocationSubscription;
        stableState.strict = this.deviceService.strict;
        stableState.viewport = CanvasViewport.clone(this.deviceService.frameState.viewport, stableState.viewport);
        stableState.subviews = SerializedSubviewList.clone(this.deviceService.frameState.subviews, stableState.subviews);
        stableState.displayMode = this.deviceService.displayMode;
        stableState.userTracking = this.deviceService.userTracking;
        this.onUpdateStableState(this._stableState);
        // send stable state to each visible session
        for (var _i = 0, _a = this.sessionService.managedSessions; _i < _a.length; _i++) {
            var session = _a[_i];
            if (session.version[0] > 0 && session !== this.sessionService.manager &&
                this.visibilityServiceProvider.visibleSessions.has(session)) {
                session.send('ar.device.state', stableState);
            }
        }
        this.needsPublish = false;
    };
    DeviceServiceProvider.prototype.onUpdateStableState = function (stableState) { };
    DeviceServiceProvider.prototype._checkDeviceGeolocationSubscribers = function () {
        var subscribers = this.entityServiceProvider.subscribersByEntity.get(this.deviceService.origin.id);
        if (subscribers && subscribers.size > 0) {
            var reducedOptions_1 = {};
            this._sessionGeolocationOptions.forEach(function (options, session) {
                reducedOptions_1.enableHighAccuracy =
                    reducedOptions_1.enableHighAccuracy || (options && options.enableHighAccuracy) || false;
            });
            if (this._targetGeolocationOptions.enableHighAccuracy !== reducedOptions_1.enableHighAccuracy) {
                this._targetGeolocationOptions = reducedOptions_1;
            }
            if (JSON.stringify(this._targetGeolocationOptions) !== JSON.stringify(this._currentGeolocationOptions)) {
                this._currentGeolocationOptions = this._targetGeolocationOptions;
                this.device.stopGeolocationUpdates();
                this.device.startGeolocationUpdates(this._targetGeolocationOptions);
            }
        }
        else {
            this.device.stopGeolocationUpdates();
            this._currentGeolocationOptions = undefined;
        }
        this.needsPublish = true;
    };
    DeviceServiceProvider = __decorate([
        autoinject(),
        __metadata("design:paramtypes", [SessionService,
            DeviceService,
            ViewService,
            EntityService,
            EntityServiceProvider,
            VisibilityServiceProvider,
            Device])
    ], DeviceServiceProvider);
    return DeviceServiceProvider;
}());
export { DeviceServiceProvider };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZGV2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLE9BQU8sRUFDSCxNQUFNLEVBQ04sdUJBQXVCLEVBQ3ZCLGVBQWUsRUFDZixjQUFjLEVBQ2QsVUFBVSxFQUNWLE9BQU8sRUFDUCxPQUFPLEVBQ1AsVUFBVSxFQUNWLFVBQVUsRUFDVixVQUFVLEVBQ1Ysa0JBQWtCLEVBQ2xCLE9BQU8sRUFDUCxZQUFZLEVBQ2YsTUFBTSx5QkFBeUIsQ0FBQTtBQUdoQyxPQUFPLEVBQUMsVUFBVSxFQUFFLFNBQVMsRUFBQyxNQUFNLDhCQUE4QixDQUFDO0FBQ25FLE9BQU8sRUFBQyxhQUFhLEVBQUUscUJBQXFCLEVBQUUsVUFBVSxFQUFDLE1BQU0sVUFBVSxDQUFBO0FBQ3pFLE9BQU8sRUFBQyxjQUFjLEVBQWMsTUFBTSxXQUFXLENBQUE7QUFFckQsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLFNBQVMsQ0FBQTtBQUVuQyxPQUFPLEVBQ0gsa0JBQWtCLEVBQ2xCLGtCQUFrQixFQUNsQixpQkFBaUIsRUFDakIsY0FBYyxFQUNkLFFBQVEsRUFDUixxQkFBcUIsRUFDckIsV0FBVyxFQUVYLGlCQUFpQixFQUNwQixNQUFNLFVBQVUsQ0FBQTtBQUVqQixPQUFPLEVBQ0gsVUFBVSxFQUNWLHVCQUF1QixFQUN2QixxQkFBcUIsRUFDckIsb0JBQW9CLEVBQ3BCLHVCQUF1QixFQUN2QixVQUFVLEVBQ1YsS0FBSyxFQUNSLE1BQU0sU0FBUyxDQUFBO0FBRWhCLE9BQU8sRUFDSCxXQUFXLEVBRVgsU0FBUyxFQUNaLE1BQU0sUUFBUSxDQUFBO0FBRWYsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sY0FBYyxDQUFBO0FBRXhELE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFBO0FBRTFDO0lBQUE7UUFHSSxxQ0FBZ0MsR0FBa0MsU0FBUyxDQUFDO1FBRTVFLGlC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QyxDQUFDLENBQUM7Z0JBQ3JHLElBQUksQ0FBQywwQkFBMEIsR0FBRyxJQUFJLENBQUMseUJBQXlCLENBQUM7Z0JBQ2pFLElBQUksQ0FBQyxNQUFNLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztnQkFDckMsSUFBSSxDQUFDLE1BQU0sQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMseUJBQXlCLENBQUMsQ0FBQztZQUN4RSxDQUFDO1FBQ0wsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osSUFBSSxDQUFDLE1BQU0sQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1lBQ3JDLElBQUksQ0FBQywwQkFBMEIsR0FBRyxTQUFTLENBQUM7UUFDaEQsQ0FBQztRQUNELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO0lBQzdCLENBQUM7SUFwTFEscUJBQXFCO1FBRGpDLFVBQVUsRUFBRTt5Q0FJb0IsY0FBYztZQUNmLGFBQWE7WUFDZixXQUFXO1lBQ1QsYUFBYTtZQUNMLHFCQUFxQjtZQUNqQix5QkFBeUI7WUFDNUMsTUFBTTtPQVRsQixxQkFBcUIsQ0FzTGpDO0lBQUQsNEJBQUM7Q0FBQSxBQXRMRCxJQXNMQztTQXRMWSxxQkFBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIEVudGl0eSwgXG4gICAgRHluYW1pY1Bvc2l0aW9uUHJvcGVydHksXG4gICAgRHluYW1pY1Byb3BlcnR5LFxuICAgIFJlZmVyZW5jZUZyYW1lLFxuICAgIENhcnRlc2lhbjMsXG4gICAgTWF0cml4MyxcbiAgICBNYXRyaXg0LFxuICAgIENlc2l1bU1hdGgsXG4gICAgUXVhdGVybmlvbixcbiAgICBKdWxpYW5EYXRlLFxuICAgIFBlcnNwZWN0aXZlRnJ1c3R1bSxcbiAgICBkZWZpbmVkLFxuICAgIENhcnRvZ3JhcGhpY1xufSBmcm9tICcuL2Nlc2l1bS9jZXNpdW0taW1wb3J0cydcblxuaW1wb3J0IHtDb250ZXh0RnJhbWVTdGF0ZX0gZnJvbSAnLi9jb21tb24nXG5pbXBvcnQge2F1dG9pbmplY3QsIHNpbmdsZXRvbn0gZnJvbSAnYXVyZWxpYS1kZXBlbmRlbmN5LWluamVjdGlvbic7XG5pbXBvcnQge0VudGl0eVNlcnZpY2UsIEVudGl0eVNlcnZpY2VQcm92aWRlciwgUG9zZVN0YXR1c30gZnJvbSAnLi9lbnRpdHknXG5pbXBvcnQge1Nlc3Npb25TZXJ2aWNlLCBTZXNzaW9uUG9ydH0gZnJvbSAnLi9zZXNzaW9uJ1xuXG5pbXBvcnQge0FyZ29uU3lzdGVtfSBmcm9tICcuL2FyZ29uJ1xuXG5pbXBvcnQge1xuICAgIEFWRVJBR0VfRVlFX0hFSUdIVCxcbiAgICBERUZBVUxUX05FQVJfUExBTkUsXG4gICAgREVGQVVMVF9GQVJfUExBTkUsXG4gICAgQ2FudmFzVmlld3BvcnQsXG4gICAgVmlld3BvcnQsXG4gICAgU2VyaWFsaXplZFN1YnZpZXdMaXN0LFxuICAgIFN1YnZpZXdUeXBlLFxuICAgIEdlb2xvY2F0aW9uT3B0aW9ucyxcbiAgICBTZXJpYWxpemVkU3Vidmlld1xufSBmcm9tICcuL2NvbW1vbidcblxuaW1wb3J0IHtcbiAgICBkZXByZWNhdGVkLFxuICAgIGVhc3RVcFNvdXRoVG9GaXhlZEZyYW1lLFxuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSxcbiAgICBjYW5jZWxBbmltYXRpb25GcmFtZSxcbiAgICB1cGRhdGVIZWlnaHRGcm9tVGVycmFpbixcbiAgICBqc29uRXF1YWxzLFxuICAgIEV2ZW50XG59IGZyb20gJy4vdXRpbHMnXG5cbmltcG9ydCB7XG4gICAgVmlld1NlcnZpY2UsXG4gICAgVmlld3BvcnRNb2RlLFxuICAgIFZpZXdJdGVtc1xufSBmcm9tICcuL3ZpZXcnXG5cbmltcG9ydCB7IFZpc2liaWxpdHlTZXJ2aWNlUHJvdmlkZXIgfSBmcm9tICcuL3Zpc2liaWxpdHknXG5cbmltcG9ydCB7IGlzQW5kcm9pZCwgaXNJT1MgfSBmcm9tICcuL3V0aWxzJ1xuXG5leHBvcnQgY2xhc3MgRGV2aWNlU3RhYmxlU3RhdGUge1xuICAgIHZpZXdwb3J0PzpDYW52YXNWaWV3cG9ydDtcbiAgICBzdWJ2aWV3cz86U2VyaWFsaXplZFN1YnZpZXdMaXN0O1xuICAgIHN1Z2dlc3RlZEdlb2xvY2F0aW9uU3Vic2NyaXB0aW9uPzp7ZW5hYmxlSGlnaEFjY3VyYWN5Pzpib29sZWFufSA9IHVuZGVmaW5lZDtcblxuICAgIHVzZXJUcmFja2luZzonbm9uZSd8JzNET0YnfCc2RE9GJyA9ICdub25lJztcbiAgICBkaXNwbGF5TW9kZTonaGFuZCd8J2hlYWQnfCdvdGhlcicgPSAnb3RoZXInO1xuICAgIGlzUHJlc2VudGluZ0hNRCA9IGZhbHNlO1xuICAgIGlzUHJlc2VudGluZ1JlYWxpdHlITUQgPSBmYWxzZTtcbiAgICBzdHJpY3QgPSBmYWxzZTtcbn1cblxuZXhwb3J0IGNsYXNzIERldmljZUZyYW1lU3RhdGUge1xuICAgIHByaXZhdGUgX3NjcmF0Y2hGcnVzdHVtID0gbmV3IFBlcnNwZWN0aXZlRnJ1c3R1bSgpO1xuXG4gICAgdGltZSA9IEp1bGlhbkRhdGUubm93KCk7XG5cbiAgICB2aWV3cG9ydCA9IG5ldyBDYW52YXNWaWV3cG9ydDtcblxuICAgIHN1YnZpZXdzOlNlcmlhbGl6ZWRTdWJ2aWV3TGlzdCA9IFt7XG4gICAgICAgIHR5cGU6IFN1YnZpZXdUeXBlLlNJTkdVTEFSLFxuICAgICAgICB2aWV3cG9ydDogbmV3IFZpZXdwb3J0LFxuICAgICAgICBwcm9qZWN0aW9uTWF0cml4OiAoXG4gICAgICAgICAgICB0aGlzLl9zY3JhdGNoRnJ1c3R1bS5uZWFyID0gREVGQVVMVF9ORUFSX1BMQU5FLFxuICAgICAgICAgICAgdGhpcy5fc2NyYXRjaEZydXN0dW0uZmFyID0gREVGQVVMVF9GQVJfUExBTkUsXG4gICAgICAgICAgICB0aGlzLl9zY3JhdGNoRnJ1c3R1bS5mb3YgPSBDZXNpdW1NYXRoLlBJX09WRVJfVEhSRUUsIFxuICAgICAgICAgICAgdGhpcy5fc2NyYXRjaEZydXN0dW0uYXNwZWN0UmF0aW8gPSAxLCBcbiAgICAgICAgICAgIE1hdHJpeDQuY2xvbmUodGhpcy5fc2NyYXRjaEZydXN0dW0ucHJvamVjdGlvbk1hdHJpeClcbiAgICAgICAgKVxuICAgIH1dO1xuXG4gICAgdXNlclRyYWNraW5nOidub25lJ3wnM0RPRid8JzZET0YnID0gJ25vbmUnO1xufTtcblxuQGF1dG9pbmplY3RcbmV4cG9ydCBjbGFzcyBEZXZpY2Uge1xuXG4gICAgdnJEaXNwbGF5czpWUkRpc3BsYXlbXXx1bmRlZmluZWQ7XG4gICAgdnJEaXNwbGF5OlZSRGlzcGxheXx1bmRlZmluZWQ7XG4gICAgdXNlclRyYWNraW5nOidub25lJ3wnM0RPRid8JzZET0YnID0gJ25vbmUnO1xuICAgIGRpc3BsYXlNb2RlOidoYW5kJ3wnaGVhZCd8J290aGVyJyA9IGlzSU9TIHx8IGlzQW5kcm9pZCA/ICdoYW5kJyA6ICdvdGhlcic7XG4gICAgc2NyZWVuT3JpZW50YXRpb24gPSAwO1xuICAgIHN1Z2dlc3RlZEdlb2xvY2F0aW9uU3Vic2NyaXB0aW9uOntlbmFibGVIaWdoQWNjdXJhY3k/OmJvb2xlYW59fHVuZGVmaW5lZDtcblxuICAgIGZyYW1lU3RhdGUgPSBuZXcgRGV2aWNlRnJhbWVTdGF0ZTtcbiAgICBmcmFtZVN0YXRlRXZlbnQgPSBuZXcgRXZlbnQ8RGV2aWNlRnJhbWVTdGF0ZT4oKTtcbiAgICBcbiAgICB2ckRpc3BsYXlzVXBkYXRlZEV2ZW50PSBuZXcgRXZlbnQ8dm9pZD4oKTtcbiAgICB2ckRpc3BsYXlDaGFuZ2VFdmVudD0gbmV3IEV2ZW50PHZvaWQ+KCk7XG4gICAgdXNlclRyYWNraW5nQ2hhbmdlRXZlbnQ9IG5ldyBFdmVudDx2b2lkPigpO1xuICAgIGRpc3BsYXlNb2RlQ2hhbmdlRXZlbnQ9IG5ldyBFdmVudDx2b2lkPigpO1xuICAgIHNjcmVlbk9yaWVudGF0aW9uQ2hhbmdlRXZlbnQ9IG5ldyBFdmVudDx2b2lkPigpO1xuICAgIHN1Z2dlc3RlZEdlb2xvY2F0aW9uU3Vic2NyaXB0aW9uQ2hhbmdlRXZlbnQgPSBuZXcgRXZlbnQ8dm9pZD4oKTtcblxuICAgIHB1YmxpYyBkZXZpY2VHZW9sb2NhdGlvbiA9IG5ldyBFbnRpdHkoe1xuICAgICAgICBpZDogJ2FyLmRldmljZS1nZW9sb2NhdGlvbicsXG4gICAgICAgIHBvc2l0aW9uOiBuZXcgRHluYW1pY1Bvc2l0aW9uUHJvcGVydHkodW5kZWZpbmVkLCBSZWZlcmVuY2VGcmFtZS5GSVhFRCksXG4gICAgICAgIG9yaWVudGF0aW9uOiBuZXcgRHluYW1pY1Byb3BlcnR5KHVuZGVmaW5lZClcbiAgICB9KTtcbiAgICBcbiAgICBwdWJsaWMgZGV2aWNlT3JpZW50YXRpb24gPSBuZXcgRW50aXR5KHtcbiAgICAgICAgaWQ6ICdhci5kZXZpY2Utb3JpZW50YXRpb24nLFxuICAgICAgICBwb3NpdGlvbjogbmV3IER5bmFtaWNQb3NpdGlvblByb3BlcnR5KENhcnRlc2lhbjMuWkVSTywgdGhpcy5kZXZpY2VHZW9sb2NhdGlvbiksXG4gICAgICAgIG9yaWVudGF0aW9uOiBuZXcgRHluYW1pY1Byb3BlcnR5KHVuZGVmaW5lZClcbiAgICB9KTtcbiAgICBcbiAgICBwdWJsaWMgb3JpZ2luOiBFbnRpdHkgPSBuZXcgRW50aXR5KHtcbiAgICAgICAgaWQ6ICdhci5kZXZpY2Uub3JpZ2luJyxcbiAgICAgICAgbmFtZTogJ0RldmljZSBPcmlnaW4nLFxuICAgICAgICBwb3NpdGlvbjogbmV3IER5bmFtaWNQb3NpdGlvblByb3BlcnR5KHVuZGVmaW5lZCwgdGhpcy5kZXZpY2VHZW9sb2NhdGlvbiksXG4gICAgICAgIG9yaWVudGF0aW9uOiBuZXcgRHluYW1pY1Byb3BlcnR5KHVuZGVmaW5lZClcbiAgICB9KTtcbiAgICBcbiAgICBwdWJsaWMgc3RhZ2U6IEVudGl0eSA9IG5ldyBFbnRpdHkoe1xuICAgICAgICBpZDogJ2FyLmRldmljZS5zdGFnZScsXG4gICAgICAgIG5hbWU6ICdEZXZpY2UgU3RhZ2UnLFxuICAgICAgICBwb3NpdGlvbjogbmV3IER5bmFtaWNQb3NpdGlvblByb3BlcnR5KHVuZGVmaW5lZCwgdGhpcy5kZXZpY2VHZW9sb2NhdGlvbiksXG4gICAgICAgIG9yaWVudGF0aW9uOiBuZXcgRHluYW1pY1Byb3BlcnR5KHVuZGVmaW5lZClcbiAgICB9KTtcblxuICAgIHB1YmxpYyB1c2VyOiBFbnRpdHkgPSBuZXcgRW50aXR5KHtcbiAgICAgICAgaWQ6ICdhci5kZXZpY2UudXNlcicsXG4gICAgICAgIG5hbWU6ICdEZXZpY2UgVXNlcicsXG4gICAgICAgIHBvc2l0aW9uOiBuZXcgRHluYW1pY1Bvc2l0aW9uUHJvcGVydHkodW5kZWZpbmVkLCB0aGlzLm9yaWdpbiksXG4gICAgICAgIG9yaWVudGF0aW9uOiBuZXcgRHluYW1pY1Byb3BlcnR5KHVuZGVmaW5lZClcbiAgICB9KTtcblxuICAgIHB1YmxpYyBnZXRTdWJ2aWV3RW50aXR5KGluZGV4Om51bWJlcikge1xuICAgICAgICBjb25zdCBzdWJ2aWV3RW50aXR5ID0gdGhpcy5lbnRpdHlTZXJ2aWNlLmNvbGxlY3Rpb24uZ2V0T3JDcmVhdGVFbnRpdHkoJ2FyLmRldmljZS52aWV3XycraW5kZXgpO1xuICAgICAgICBpZiAoIXN1YnZpZXdFbnRpdHkucG9zaXRpb24pIHtcbiAgICAgICAgICAgIHN1YnZpZXdFbnRpdHkucG9zaXRpb24gPSBuZXcgRHluYW1pY1Bvc2l0aW9uUHJvcGVydHkoQ2FydGVzaWFuMy5aRVJPLCB0aGlzLnVzZXIpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghc3Vidmlld0VudGl0eS5vcmllbnRhdGlvbikge1xuICAgICAgICAgICAgc3Vidmlld0VudGl0eS5vcmllbnRhdGlvbiA9IG5ldyBEeW5hbWljUHJvcGVydHkoUXVhdGVybmlvbi5JREVOVElUWSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHN1YnZpZXdFbnRpdHk7XG4gICAgfVxuICAgIFxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwdWJsaWMgb3duZXI6U2Vzc2lvblNlcnZpY2UsIFxuICAgICAgICBwdWJsaWMgZW50aXR5U2VydmljZTpFbnRpdHlTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHZpZXdJdGVtczogVmlld0l0ZW1zKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IGFkZEV2ZW50TGlzdGVuZXIgPSB0aGlzLmZyYW1lU3RhdGVFdmVudC5hZGRFdmVudExpc3RlbmVyLmJpbmQodGhpcy5mcmFtZVN0YXRlRXZlbnQpO1xuICAgICAgICAgICAgdGhpcy5mcmFtZVN0YXRlRXZlbnQuYWRkRXZlbnRMaXN0ZW5lciA9IChjYWxsYmFjaykgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGFkZEV2ZW50TGlzdGVuZXIoY2FsbGJhY2spO1xuICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrRnJhbWVTdGF0ZUxpc3RlbmVycygpO1xuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHJlbW92ZUV2ZW50TGlzdGVuZXIgPSB0aGlzLmZyYW1lU3RhdGVFdmVudC5yZW1vdmVFdmVudExpc3RlbmVyLmJpbmQodGhpcy5mcmFtZVN0YXRlRXZlbnQpO1xuICAgICAgICAgICAgdGhpcy5mcmFtZVN0YXRlRXZlbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IChjYWxsYmFjaykgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHJlbW92ZUV2ZW50TGlzdGVuZXIoY2FsbGJhY2spO1xuICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrRnJhbWVTdGF0ZUxpc3RlbmVycygpO1xuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChvd25lci5pc1JlYWxpdHlNYW5hZ2VyKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5lbnRpdHlTZXJ2aWNlLnN1YnNjcmliZWRFdmVudC5hZGRFdmVudExpc3RlbmVyKChldnQpPT57XG4gICAgICAgICAgICAgICAgICAgIGlmIChldnQuaWQgPT09ICdhci5vcmlnaW4nIHx8IGV2dC5pZCA9PT0gJ2FyLnN0YWdlJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdWdnZXN0ZWRHZW9sb2NhdGlvblN1YnNjcmlwdGlvbiA9IGV2dC5vcHRpb25zIHx8IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdWdnZXN0ZWRHZW9sb2NhdGlvblN1YnNjcmlwdGlvbkNoYW5nZUV2ZW50LnJhaXNlRXZlbnQodW5kZWZpbmVkKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRoaXMuZW50aXR5U2VydmljZS51bnN1YnNjcmliZWRFdmVudC5hZGRFdmVudExpc3RlbmVyKChldnQpPT57XG4gICAgICAgICAgICAgICAgICAgIGlmIChldnQuaWQgPT09ICdhci5vcmlnaW4nIHx8IGV2dC5pZCA9PT0gJ2FyLnN0YWdlJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdWdnZXN0ZWRHZW9sb2NhdGlvblN1YnNjcmlwdGlvbiA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3VnZ2VzdGVkR2VvbG9jYXRpb25TdWJzY3JpcHRpb25DaGFuZ2VFdmVudC5yYWlzZUV2ZW50KHVuZGVmaW5lZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9XG4gICAgXG4gICAgLy8gZm9yIG5vdywgb25seSB1c2Ugd2VidnIgd2hlbiBub3QgaW4gYXJnb24tYXBwXG4gICAgcHJpdmF0ZSAgX3VzZVdlYlZSID0gKHR5cGVvZiBuYXZpZ2F0b3IgIT09ICd1bmRlZmluZWQnICYmIFxuICAgICAgICBuYXZpZ2F0b3IuZ2V0VlJEaXNwbGF5cyAmJiBcbiAgICAgICAgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCdBcmdvbicpID4gMCA9PT0gZmFsc2UpO1xuXG4gICAgcHJvdGVjdGVkIF9vdmVycmlkZVN0YXRlIDogRGV2aWNlU3RhYmxlU3RhdGV8dW5kZWZpbmVkO1xuXG4gICAgcHJvdGVjdGVkIF9zY3JhdGNoQ2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjM7XG4gICAgcHJvdGVjdGVkIF9zY3JhdGNoRnJ1c3R1bSA9IG5ldyBQZXJzcGVjdGl2ZUZydXN0dW0oKTtcblxuICAgIHB1YmxpYyBnZXQgc3RyaWN0KCkgOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICEhKHRoaXMuX292ZXJyaWRlU3RhdGUgJiYgdGhpcy5fb3ZlcnJpZGVTdGF0ZS5zdHJpY3QpIHx8XG4gICAgICAgICAgICB0aGlzLmRpc3BsYXlNb2RlID09PSAnaGVhZCcgJiYgIXRoaXMuX2hhc1BvbHlmaWxsV2ViVlJEaXNwbGF5KCk7XG4gICAgfVxuXG4gICAgcHVibGljIG5hdHVyYWxVc2VySGVpZ2h0ID0gQVZFUkFHRV9FWUVfSEVJR0hUO1xuICAgIFxuICAgIC8qKlxuICAgICAqIEBwcml2YXRlXG4gICAgICogZGVwcmVjYXRlZFxuICAgICAqICovXG4gICAgcHVibGljIGdldCBzdWdnZXN0ZWRVc2VySGVpZ2h0KCkge1xuICAgICAgICByZXR1cm4gdGhpcy5kaXNwbGF5TW9kZSA9PT0gJ2hlYWQnID8gdGhpcy5uYXR1cmFsVXNlckhlaWdodCA6IHRoaXMubmF0dXJhbFVzZXJIZWlnaHQgKiAwLjc1O1xuICAgIH1cblxuICAgIC8vIFRoZSBkZXZpY2UgaXMgYWJsZSB0byByZW5kZXIgcmVhbGl0eSBpbnRvIGEgc2VwYXJhdGUgbGF5ZXIgaW4gdGhlIHByaW1hcnkgZGlzcGxheVxuICAgIHB1YmxpYyBnZXQgaGFzU2VwYXJhdGVSZWFsaXR5TGF5ZXIoKSA6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKHRoaXMudnJEaXNwbGF5ICYmICEhdGhpcy52ckRpc3BsYXkuZGlzcGxheU5hbWUubWF0Y2goL3BvbHlmaWxsL2cpKSB8fCB0aGlzLnZyRGlzcGxheSA9PT0gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3J1bm5pbmcgPSBmYWxzZTtcblxuICAgIHByaXZhdGUgX3ByZXZpb3VzTnVtTGlzdGVuZXJzID0gMDtcblxuICAgIHByaXZhdGUgX2NoZWNrRnJhbWVTdGF0ZUxpc3RlbmVycygpIHsgICAgICAgICAgICAgICAgXG4gICAgICAgIC8vIGlmIHdlIGhhdmUgbGlzdGVuZXJzLCBzdWJzY3JpYmUgdG8gZGV2aWNlIHN0YXRlLCBvdGhlcndpc2UsIHVuc3Vic2NyaWJlXG4gICAgICAgIGNvbnN0IG51bUxpc3RlbmVycyA9IHRoaXMuZnJhbWVTdGF0ZUV2ZW50Lm51bWJlck9mTGlzdGVuZXJzO1xuICAgICAgICBjb25zdCBwcmV2aW91c051bUxpc3RlbmVycyA9IHRoaXMuX3ByZXZpb3VzTnVtTGlzdGVuZXJzO1xuICAgICAgICB0aGlzLl9wcmV2aW91c051bUxpc3RlbmVycyA9IG51bUxpc3RlbmVycztcblxuICAgICAgICBpZiAodHlwZW9mIHdpbmRvdyA9PT0gJ3VuZGVmaW5lZCcgfHwgIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKSB7XG4gICAgICAgICAgICBpZiAocHJldmlvdXNOdW1MaXN0ZW5lcnMgPT09IDAgJiYgbnVtTGlzdGVuZXJzID09PSAxICYmICF0aGlzLl9ydW5uaW5nKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcnVubmluZyA9IHRydWU7XG4gICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5fb25VcGRhdGVGcmFtZVN0YXRlKTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmIChwcmV2aW91c051bUxpc3RlbmVycyA9PT0gMCAmJiBudW1MaXN0ZW5lcnMgPT09IDEpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLl91c2VXZWJWUikgeyBcbiAgICAgICAgICAgICAgICB0aGlzLl9zZWxlY3RWUkRpc3BsYXkoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy51c2VyVHJhY2tpbmcgPSBpc0lPUyB8fCBpc0FuZHJvaWQgPyAnM0RPRicgOiAnbm9uZSc7XG4gICAgICAgICAgICAgICAgdGhpcy51c2VyVHJhY2tpbmdDaGFuZ2VFdmVudC5yYWlzZUV2ZW50KHVuZGVmaW5lZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignb3JpZW50YXRpb25jaGFuZ2UnLCB0aGlzLl9oYW5kbGVTY3JlZW5PcmllbnRhdGlvbkNoYW5nZSk7XG4gICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndnJkaXNwbGF5cHJlc2VudGNoYW5nZScsIHRoaXMuX2hhbmRsZVZSRGlzcGxheVByZXNlbnRDaGFuZ2UpO1xuICAgICAgICAgICAgdGhpcy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5fb25VcGRhdGVGcmFtZVN0YXRlKTtcbiAgICAgICAgfSBlbHNlIGlmIChwcmV2aW91c051bUxpc3RlbmVycyA9PT0gMSAmJiBudW1MaXN0ZW5lcnMgPT09IDApIHtcbiAgICAgICAgICAgIGNvbnN0IHZyRGlzcGxheSA9IHRoaXMudnJEaXNwbGF5O1xuICAgICAgICAgICAgaWYgKHZyRGlzcGxheSkge1xuICAgICAgICAgICAgICAgIGlmICh2ckRpc3BsYXkuaXNQcmVzZW50aW5nKSB2ckRpc3BsYXkuZXhpdFByZXNlbnQoKTtcbiAgICAgICAgICAgICAgICB0aGlzLnZyRGlzcGxheSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB0aGlzLnZyRGlzcGxheUNoYW5nZUV2ZW50LnJhaXNlRXZlbnQodW5kZWZpbmVkKTtcbiAgICAgICAgICAgICAgICB0aGlzLnVzZXJUcmFja2luZyA9ICdub25lJztcbiAgICAgICAgICAgICAgICB0aGlzLnVzZXJUcmFja2luZ0NoYW5nZUV2ZW50LnJhaXNlRXZlbnQodW5kZWZpbmVkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdvcmllbnRhdGlvbmNoYW5nZScsIHRoaXMuX2hhbmRsZVNjcmVlbk9yaWVudGF0aW9uQ2hhbmdlKTtcbiAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCd2cmRpc3BsYXlwcmVzZW50Y2hhbmdlJywgdGhpcy5faGFuZGxlVlJEaXNwbGF5UHJlc2VudENoYW5nZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9zZWxlY3RWUkRpc3BsYXkoKSB7XG4gICAgICAgIG5hdmlnYXRvci5nZXRWUkRpc3BsYXlzKCkudGhlbihkaXNwbGF5cyA9PiB7XG4gICAgICAgICAgICB0aGlzLnZyRGlzcGxheXMgPSBkaXNwbGF5cztcbiAgICAgICAgICAgIGNvbnN0IGRpc3BsYXkgPSB0aGlzLnZyRGlzcGxheSA9IGRpc3BsYXlzWzBdO1xuICAgICAgICAgICAgaWYgKCFkaXNwbGF5KSByZXR1cm47XG5cbiAgICAgICAgICAgIHRoaXMudXNlclRyYWNraW5nID0gXG4gICAgICAgICAgICAgICAgZGlzcGxheS5jYXBhYmlsaXRpZXMuaGFzUG9zaXRpb24gJiYgZGlzcGxheS5jYXBhYmlsaXRpZXMuaGFzT3JpZW50YXRpb24gPyBcbiAgICAgICAgICAgICAgICBcIjZET0ZcIiA6IFwiM0RPRlwiO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy52ckRpc3BsYXlzVXBkYXRlZEV2ZW50LnJhaXNlRXZlbnQodW5kZWZpbmVkKTtcbiAgICAgICAgICAgIHRoaXMudnJEaXNwbGF5Q2hhbmdlRXZlbnQucmFpc2VFdmVudCh1bmRlZmluZWQpO1xuICAgICAgICAgICAgdGhpcy51c2VyVHJhY2tpbmdDaGFuZ2VFdmVudC5yYWlzZUV2ZW50KHVuZGVmaW5lZCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2hhbmRsZVNjcmVlbk9yaWVudGF0aW9uQ2hhbmdlID0gKCkgPT4ge1xuICAgICAgICBjb25zdCBlbmQgPSAoZGlzcGF0Y2hFdmVudCkgPT4ge1xuICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgICAgICB0aGlzLnNjcmVlbk9yaWVudGF0aW9uQ2hhbmdlRXZlbnQucmFpc2VFdmVudCh1bmRlZmluZWQpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBsYXN0SW5uZXJXaWR0aDpudW1iZXI7XG4gICAgICAgIGxldCBsYXN0SW5uZXJIZWlnaHQ6bnVtYmVyO1xuICAgICAgICBsZXQgbm9DaGFuZ2VDb3VudDpudW1iZXI7XG4gICAgICAgIGNvbnN0IGludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICAgICAgaWYgKHdpbmRvdy5pbm5lcldpZHRoID09PSBsYXN0SW5uZXJXaWR0aCAmJiB3aW5kb3cuaW5uZXJIZWlnaHQgPT09IGxhc3RJbm5lckhlaWdodCkge1xuICAgICAgICAgICAgICAgIG5vQ2hhbmdlQ291bnQrKztcbiAgICAgICAgICAgICAgICBpZiAobm9DaGFuZ2VDb3VudCA9PT0gMTAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGVuZCh0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxhc3RJbm5lcldpZHRoID0gd2luZG93LmlubmVyV2lkdGg7XG4gICAgICAgICAgICAgICAgbGFzdElubmVySGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0O1xuICAgICAgICAgICAgICAgIG5vQ2hhbmdlQ291bnQgPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICBlbmQodHJ1ZSk7XG4gICAgICAgIH0sIDEwMDApO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2hhbmRsZVZSRGlzcGxheVByZXNlbnRDaGFuZ2UgPSAoZSkgPT4geyAgICAgICAgICAgICAgICBcbiAgICAgICAgY29uc3QgZGlzcGxheTpWUkRpc3BsYXl8dW5kZWZpbmVkID0gZS5kaXNwbGF5IHx8IGUuZGV0YWlsLnZyZGlzcGxheSB8fCBlLmRldGFpbC5kaXNwbGF5O1xuICAgICAgICBpZiAoZGlzcGxheSAmJiBkaXNwbGF5ID09PSB0aGlzLnZyRGlzcGxheSkge1xuICAgICAgICAgICAgY29uc3QgbmV3RGlzcGxheU1vZGUgPSBkaXNwbGF5LmlzUHJlc2VudGluZyA/ICdoZWFkJyA6IFxuICAgICAgICAgICAgICAgIGRpc3BsYXkuY2FwYWJpbGl0aWVzLmhhc09yaWVudGF0aW9uID8gJ2hhbmQnIDogJ290aGVyJztcbiAgICAgICAgICAgIGlmIChuZXdEaXNwbGF5TW9kZSAhPT0gdGhpcy5kaXNwbGF5TW9kZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZGlzcGxheU1vZGUgPSBuZXdEaXNwbGF5TW9kZTtcbiAgICAgICAgICAgICAgICB0aGlzLmRpc3BsYXlNb2RlQ2hhbmdlRXZlbnQucmFpc2VFdmVudCh1bmRlZmluZWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfb25VcGRhdGVGcmFtZVN0YXRlID0gKCkgPT4ge1xuICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMuZnJhbWVTdGF0ZTtcbiAgICAgICAgSnVsaWFuRGF0ZS5ub3coc3RhdGUudGltZSk7XG4gICAgICAgIHN0YXRlWydzdHJpY3QnXSA9IHRoaXMuc3RyaWN0OyAvLyBiYWNrd2FyZHMtY29tcGF0XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMub25VcGRhdGVGcmFtZVN0YXRlKCk7XG4gICAgICAgICAgICB0aGlzLmZyYW1lU3RhdGVFdmVudC5yYWlzZUV2ZW50KHN0YXRlKTtcbiAgICAgICAgfSBjYXRjaChlKSB7XG4gICAgICAgICAgICB0aGlzLm93bmVyLm1hbmFnZXIuc2VuZEVycm9yKGUpO1xuICAgICAgICAgICAgdGhpcy5vd25lci5lcnJvckV2ZW50LnJhaXNlRXZlbnQoZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5mcmFtZVN0YXRlRXZlbnQubnVtYmVyT2ZMaXN0ZW5lcnMgPiAwKSB7XG4gICAgICAgICAgICB0aGlzLnJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLl9vblVwZGF0ZUZyYW1lU3RhdGUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fcnVubmluZyA9IGZhbHNlO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIG9uVXBkYXRlRnJhbWVTdGF0ZSgpIHtcbiAgICAgICAgdGhpcy5fdXBkYXRlVmlld3BvcnQoKTtcbiAgICAgICAgLy8gdXNlIHdlYnZyIGlmIHRoZSBjdXJyZW50IGRpc3BsYXkgaXMgbm90IGFuIGV4dGVybmFsIGRpc3BsYXkgYW5kIGNhbid0IHByZXNlbnQsIFxuICAgICAgICAvLyBvciBpZiBpdCBpcyBjdXJyZW50bHkgcHJlc2VudGluZ1xuICAgICAgICBjb25zdCB2ckRpc3AgPSB0aGlzLnZyRGlzcGxheTtcbiAgICAgICAgaWYgKHZyRGlzcCAmJiB2ckRpc3AuaXNQcmVzZW50aW5nIHx8XG4gICAgICAgICAgICAgICAgdnJEaXNwICYmICF2ckRpc3AuY2FwYWJpbGl0aWVzLmhhc0V4dGVybmFsRGlzcGxheSAmJiBcbiAgICAgICAgICAgICAgICAhdnJEaXNwLmNhcGFiaWxpdGllcy5jYW5QcmVzZW50ICYmIHZyRGlzcC5kaXNwbGF5TmFtZS5pbmRleE9mKCdwb2x5ZmlsbCcpID09PSAtMSkge1xuICAgICAgICAgICAgdGhpcy5fdXBkYXRlRm9yV2ViVlIoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlZmF1bHQoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX3VwZGF0ZVZpZXdwb3J0KCkge1xuICAgICAgICBjb25zdCBvdmVycmlkZVN0YXRlID0gdGhpcy5fb3ZlcnJpZGVTdGF0ZTtcbiAgICAgICAgY29uc3Qgc3RhdGUgPSB0aGlzLmZyYW1lU3RhdGU7XG4gICAgICAgIGNvbnN0IHZpZXdwb3J0ID0gc3RhdGUudmlld3BvcnQ7XG4gICAgICAgIFxuICAgICAgICBpZiAob3ZlcnJpZGVTdGF0ZSAmJiBvdmVycmlkZVN0YXRlLnZpZXdwb3J0KSB7IFxuXG4gICAgICAgICAgICBDYW52YXNWaWV3cG9ydC5jbG9uZShvdmVycmlkZVN0YXRlLnZpZXdwb3J0LCB2aWV3cG9ydCk7XG5cbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IHRoaXMudmlld0l0ZW1zLmVsZW1lbnQ7XG4gICAgICAgICAgICB2aWV3cG9ydC54ID0gMDtcbiAgICAgICAgICAgIHZpZXdwb3J0LnkgPSAwO1xuICAgICAgICAgICAgdmlld3BvcnQud2lkdGggPSBlbGVtZW50ICYmIGVsZW1lbnQuY2xpZW50V2lkdGggfHwgMDtcbiAgICAgICAgICAgIHZpZXdwb3J0LmhlaWdodCA9IGVsZW1lbnQgJiYgZWxlbWVudC5jbGllbnRIZWlnaHQgfHwgMDtcblxuICAgICAgICAgICAgY29uc3QgdnJEaXNwbGF5ID0gdGhpcy52ckRpc3BsYXk7XG5cbiAgICAgICAgICAgIGlmICh2ckRpc3BsYXkgJiYgdnJEaXNwbGF5LmlzUHJlc2VudGluZykge1xuXG4gICAgICAgICAgICAgICAgdmFyIGxlZnRFeWUgPSB2ckRpc3BsYXkuZ2V0RXllUGFyYW1ldGVycyhcImxlZnRcIik7XG4gICAgICAgICAgICAgICAgdmFyIHJpZ2h0RXllID0gdnJEaXNwbGF5LmdldEV5ZVBhcmFtZXRlcnMoXCJyaWdodFwiKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBjb25zdCB2aWV3cG9ydCA9IHN0YXRlLnZpZXdwb3J0O1xuICAgICAgICAgICAgICAgIHZpZXdwb3J0LnJlbmRlcldpZHRoU2NhbGVGYWN0b3IgPSAyICogTWF0aC5tYXgobGVmdEV5ZS5yZW5kZXJXaWR0aCwgcmlnaHRFeWUucmVuZGVyV2lkdGgpIC8gdmlld3BvcnQud2lkdGg7XG4gICAgICAgICAgICAgICAgdmlld3BvcnQucmVuZGVySGVpZ2h0U2NhbGVGYWN0b3IgPSBNYXRoLm1heChsZWZ0RXllLnJlbmRlckhlaWdodCwgcmlnaHRFeWUucmVuZGVySGVpZ2h0KSAvIHZpZXdwb3J0LmhlaWdodDtcblxuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgIHZpZXdwb3J0LnJlbmRlckhlaWdodFNjYWxlRmFjdG9yID0gMTtcbiAgICAgICAgICAgICAgICB2aWV3cG9ydC5yZW5kZXJXaWR0aFNjYWxlRmFjdG9yID0gMTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcHJpdmF0ZSBfdXBkYXRlRGVmYXVsdCgpIHtcbiAgICAgICAgdGhpcy5fdXBkYXRlRGVmYXVsdFN0YWdlKCk7XG4gICAgICAgIHRoaXMuX3VwZGF0ZURlZmF1bHRVc2VyKCk7XG4gICAgICAgIHRoaXMuX3VwZGF0ZURlZmF1bHRPcmlnaW4oKTtcblxuICAgICAgICBjb25zdCBvdmVycmlkZVN0YXRlID0gdGhpcy5fb3ZlcnJpZGVTdGF0ZTtcbiAgICAgICAgY29uc3QgZnJhbWVTdGF0ZSA9IHRoaXMuZnJhbWVTdGF0ZTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHZpZXdwb3J0ID0gZnJhbWVTdGF0ZS52aWV3cG9ydDtcbiAgICAgICAgaWYgKG92ZXJyaWRlU3RhdGUgJiYgb3ZlcnJpZGVTdGF0ZS52aWV3cG9ydCkge1xuICAgICAgICAgICAgQ2FudmFzVmlld3BvcnQuY2xvbmUob3ZlcnJpZGVTdGF0ZS52aWV3cG9ydCwgdmlld3BvcnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc3Vidmlld3MgPSBmcmFtZVN0YXRlLnN1YnZpZXdzO1xuICAgICAgICBpZiAob3ZlcnJpZGVTdGF0ZSAmJiBvdmVycmlkZVN0YXRlLnN1YnZpZXdzKSB7XG4gICAgICAgICAgICBTZXJpYWxpemVkU3Vidmlld0xpc3QuY2xvbmUob3ZlcnJpZGVTdGF0ZS5zdWJ2aWV3cywgc3Vidmlld3MpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3Vidmlld3MubGVuZ3RoID0gMTtcbiAgICAgICAgICAgIGNvbnN0IHN1YnZpZXcgPSBzdWJ2aWV3c1swXSB8fCB7fTtcbiAgXG4gICAgICAgICAgICBzdWJ2aWV3LnR5cGUgPSBTdWJ2aWV3VHlwZS5TSU5HVUxBUjtcblxuICAgICAgICAgICAgc3Vidmlldy52aWV3cG9ydC54ID0gMDtcbiAgICAgICAgICAgIHN1YnZpZXcudmlld3BvcnQueSA9IDA7XG4gICAgICAgICAgICBzdWJ2aWV3LnZpZXdwb3J0LndpZHRoID0gdmlld3BvcnQud2lkdGg7XG4gICAgICAgICAgICBzdWJ2aWV3LnZpZXdwb3J0LmhlaWdodCA9IHZpZXdwb3J0LmhlaWdodDtcblxuICAgICAgICAgICAgY29uc3QgYXNwZWN0ID0gdmlld3BvcnQud2lkdGggLyB2aWV3cG9ydC5oZWlnaHQ7XG4gICAgICAgICAgICBjb25zdCBmcnVzdHVtID0gdGhpcy5fc2NyYXRjaEZydXN0dW07XG4gICAgICAgICAgICBmcnVzdHVtLm5lYXIgPSBERUZBVUxUX05FQVJfUExBTkU7XG4gICAgICAgICAgICBmcnVzdHVtLmZhciA9IERFRkFVTFRfRkFSX1BMQU5FO1xuICAgICAgICAgICAgZnJ1c3R1bS5mb3YgPSBDZXNpdW1NYXRoLlBJX09WRVJfVEhSRUU7XG4gICAgICAgICAgICBmcnVzdHVtLmFzcGVjdFJhdGlvID0gaXNGaW5pdGUoYXNwZWN0KSAmJiBhc3BlY3QgIT09IDAgPyBhc3BlY3QgOiAxO1xuICAgICAgICAgICAgc3Vidmlldy5wcm9qZWN0aW9uTWF0cml4ID0gTWF0cml4NC5jbG9uZShmcnVzdHVtLnByb2plY3Rpb25NYXRyaXgsIHN1YnZpZXcucHJvamVjdGlvbk1hdHJpeCk7XG5cbiAgICAgICAgICAgIGNvbnN0IHN1YnZpZXdFbnRpdHkgPSB0aGlzLmdldFN1YnZpZXdFbnRpdHkoMCk7XG4gICAgICAgICAgICAoc3Vidmlld0VudGl0eS5wb3NpdGlvbiBhcyBEeW5hbWljUG9zaXRpb25Qcm9wZXJ0eSkuc2V0VmFsdWUoQ2FydGVzaWFuMy5aRVJPLCB0aGlzLnVzZXIpO1xuICAgICAgICAgICAgKHN1YnZpZXdFbnRpdHkub3JpZW50YXRpb24gYXMgRHluYW1pY1Byb3BlcnR5KS5zZXRWYWx1ZShRdWF0ZXJuaW9uLklERU5USVRZKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIF91cGRhdGVEZWZhdWx0U3RhZ2UoKSB7XG4gICAgICAgIGNvbnN0IHN0YWdlID0gdGhpcy5zdGFnZTtcblxuICAgICAgICAvLyBpZiBtYW5hZ2VyIGlzIHVwZGF0aW5nIHRoZSBkZXZpY2Ugc3RhZ2Ugc3RhdGUsIGRvbid0IHVwZGF0ZSBpdCBoZXJlXG4gICAgICAgIGNvbnN0IGNvbnRleHRGcmFtZVN0YXRlID0gdGhpcy5fY29udGV4dEZyYW1lU3RhdGU7XG4gICAgICAgIGlmIChjb250ZXh0RnJhbWVTdGF0ZSAmJiBzdGFnZS5pZCBpbiBjb250ZXh0RnJhbWVTdGF0ZS5lbnRpdGllcykgcmV0dXJuO1xuXG4gICAgICAgIChzdGFnZS5wb3NpdGlvbiBhcyBEeW5hbWljUG9zaXRpb25Qcm9wZXJ0eSkuc2V0VmFsdWUoXG4gICAgICAgICAgICBDYXJ0ZXNpYW4zLmZyb21FbGVtZW50cygwLC10aGlzLnN1Z2dlc3RlZFVzZXJIZWlnaHQsMCwgdGhpcy5fc2NyYXRjaENhcnRlc2lhbiksIFxuICAgICAgICAgICAgdGhpcy5kZXZpY2VHZW9sb2NhdGlvblxuICAgICAgICApO1xuICAgICAgICAoc3RhZ2Uub3JpZW50YXRpb24gYXMgRHluYW1pY1Byb3BlcnR5KS5zZXRWYWx1ZShRdWF0ZXJuaW9uLklERU5USVRZKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF91cGRhdGVEZWZhdWx0VXNlcigpIHtcbiAgICAgICAgY29uc3QgdXNlciA9IHRoaXMudXNlcjtcblxuICAgICAgICB0aGlzLl90cnlPcmllbnRhdGlvblVwZGF0ZXMoKTtcblxuICAgICAgICAvLyBpZiBtYW5hZ2VyIGlzIHVwZGF0aW5nIHRoZSBkZXZpY2UgdXNlciBzdGF0ZSwgZG9uJ3QgdXBkYXRlIGl0IGhlcmVcbiAgICAgICAgY29uc3QgY29udGV4dEZyYW1lU3RhdGUgPSB0aGlzLl9jb250ZXh0RnJhbWVTdGF0ZTtcbiAgICAgICAgaWYgKGNvbnRleHRGcmFtZVN0YXRlICYmIHVzZXIuaWQgaW4gY29udGV4dEZyYW1lU3RhdGUuZW50aXRpZXMpIHJldHVybjtcblxuICAgICAgICBjb25zdCBzY3JlZW5PcmllbnRhdGlvbiA9IFxuICAgICAgICAgICAgUXVhdGVybmlvbi5mcm9tQXhpc0FuZ2xlKFxuICAgICAgICAgICAgICAgIENhcnRlc2lhbjMuVU5JVF9aLCBcbiAgICAgICAgICAgICAgICB0aGlzLnNjcmVlbk9yaWVudGF0aW9uRGVncmVlcyAqIENlc2l1bU1hdGguUkFESUFOU19QRVJfREVHUkVFLCBcbiAgICAgICAgICAgICAgICB0aGlzLl9zY3JhdGNoUXVhdGVybmlvblxuICAgICAgICAgICAgKTtcbiAgICAgICAgXG4gICAgICAgICh1c2VyLnBvc2l0aW9uIGFzIER5bmFtaWNQb3NpdGlvblByb3BlcnR5KS5zZXRWYWx1ZShcbiAgICAgICAgICAgIENhcnRlc2lhbjMuWkVSTyxcbiAgICAgICAgICAgIHRoaXMuZGV2aWNlT3JpZW50YXRpb25cbiAgICAgICAgKTtcblxuICAgICAgICAodXNlci5vcmllbnRhdGlvbiBhcyBEeW5hbWljUHJvcGVydHkpLnNldFZhbHVlKFxuICAgICAgICAgICAgc2NyZWVuT3JpZW50YXRpb25cbiAgICAgICAgKTtcblxuICAgICAgICAvLyBjb25zdCBkZXZpY2VPcmllbnRhdGlvblZhbHVlID0gXG4gICAgICAgIC8vICAgICAodGhpcy5kZXZpY2VPcmllbnRhdGlvbi5vcmllbnRhdGlvbiBhcyBEeW5hbWljUHJvcGVydHkpLmdldFZhbHVlKHRoaXMuZnJhbWVTdGF0ZS50aW1lKTtcbiAgICAgICAgLy8gKHVzZXIub3JpZW50YXRpb24gYXMgRHluYW1pY1Byb3BlcnR5KS5zZXRWYWx1ZShcbiAgICAgICAgLy8gICAgIFF1YXRlcm5pb24ubXVsdGlwbHkoXG4gICAgICAgIC8vICAgICAgICAgZGV2aWNlT3JpZW50YXRpb25WYWx1ZSxcbiAgICAgICAgLy8gICAgICAgICBzY3JlZW5PcmllbnRhdGlvbixcbiAgICAgICAgLy8gICAgICAgICB0aGlzLl9zY3JhdGNoUXVhdGVybmlvblxuICAgICAgICAvLyAgICAgKVxuICAgICAgICAvLyApO1xuXG4gICAgICAgIC8vIHN0YWdlWydtZXRhJ10gPSBzdGFnZVsnbWV0YSddIHx8IHt9O1xuICAgICAgICAvLyBzdGFnZVsnbWV0YSddLmdlb0hlYWRpbmdBY2N1cmFjeSA9IHRoaXMuX2RldmljZU9yaWVudGF0aW9uSGVhZGluZ0FjY3VyYWN5O1xuICAgIH1cbiAgICBcblxuICAgIHByaXZhdGUgX3VwZGF0ZURlZmF1bHRPcmlnaW4oKSB7XG4gICAgICAgIGNvbnN0IG9yaWdpbiA9IHRoaXMub3JpZ2luO1xuICAgICAgICBjb25zdCBkZXZpY2VHZW9sb2NhdGlvbiA9IHRoaXMuZGV2aWNlR2VvbG9jYXRpb247XG5cbiAgICAgICAgLy8gaWYgbWFuYWdlciBpcyB1cGRhdGluZyB0aGUgZGV2aWNlIG9yaWdpbiBzdGF0ZSwgZG9uJ3QgdXBkYXRlIGl0IGhlcmVcbiAgICAgICAgY29uc3QgY29udGV4dEZyYW1lU3RhdGUgPSB0aGlzLl9jb250ZXh0RnJhbWVTdGF0ZTtcbiAgICAgICAgaWYgKGNvbnRleHRGcmFtZVN0YXRlICYmIG9yaWdpbi5pZCBpbiBjb250ZXh0RnJhbWVTdGF0ZS5lbnRpdGllcykgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IHRpbWUgPSB0aGlzLmZyYW1lU3RhdGUudGltZTtcbiAgICAgICAgY29uc3Qgb3JpZ2luUG9zZSA9IHRoaXMuZW50aXR5U2VydmljZS5nZXRFbnRpdHlQb3NlKG9yaWdpbiwgZGV2aWNlR2VvbG9jYXRpb24sIHRpbWUpO1xuICAgICAgICBjb25zdCBkZXZpY2VHZW9sb2NhdGlvblBvc2UgPSB0aGlzLmVudGl0eVNlcnZpY2UuZ2V0RW50aXR5UG9zZShkZXZpY2VHZW9sb2NhdGlvbiwgUmVmZXJlbmNlRnJhbWUuRklYRUQsIHRpbWUpO1xuXG4gICAgICAgIGlmICgob3JpZ2luUG9zZS5zdGF0dXMgJiBQb3NlU3RhdHVzLktOT1dOKSA9PT0gMCAmJiBkZXZpY2VHZW9sb2NhdGlvblBvc2Uuc3RhdHVzICYgUG9zZVN0YXR1cy5LTk9XTiB8fFxuICAgICAgICAgICAgb3JpZ2luLnBvc2l0aW9uIS5yZWZlcmVuY2VGcmFtZSAhPT0gUmVmZXJlbmNlRnJhbWUuRklYRUQgJiYgZGV2aWNlR2VvbG9jYXRpb25Qb3NlLnN0YXR1cyAmIFBvc2VTdGF0dXMuS05PV04gfHxcbiAgICAgICAgICAgIG9yaWdpblBvc2Uuc3RhdHVzICYgUG9zZVN0YXR1cy5LTk9XTiAmJiBkZXZpY2VHZW9sb2NhdGlvblBvc2Uuc3RhdHVzICYgUG9zZVN0YXR1cy5LTk9XTiAmJlxuICAgICAgICAgICAgICAgIENhcnRlc2lhbjMubWFnbml0dWRlU3F1YXJlZChvcmlnaW5Qb3NlLnBvc2l0aW9uKSA+IDEwMDAwIFxuICAgICAgICApIHtcbiAgICAgICAgICAgIChvcmlnaW4ucG9zaXRpb24gYXMgRHluYW1pY1Bvc2l0aW9uUHJvcGVydHkpLnNldFZhbHVlKGRldmljZUdlb2xvY2F0aW9uUG9zZS5wb3NpdGlvbiwgUmVmZXJlbmNlRnJhbWUuRklYRUQpO1xuICAgICAgICAgICAgKG9yaWdpbi5vcmllbnRhdGlvbiBhcyBEeW5hbWljUHJvcGVydHkpLnNldFZhbHVlKGRldmljZUdlb2xvY2F0aW9uUG9zZS5vcmllbnRhdGlvbik7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnVXBkYXRlZCBkZXZpY2Ugb3JpZ2luIHRvICcgKyBKU09OLnN0cmluZ2lmeShkZXZpY2VHZW9sb2NhdGlvblBvc2UucG9zaXRpb24pICsgXCIgYXQgRklYRURcIik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoKGRldmljZUdlb2xvY2F0aW9uUG9zZS5zdGF0dXMgJiBQb3NlU3RhdHVzLktOT1dOKSA9PT0gMCkge1xuICAgICAgICAgICAgKG9yaWdpbi5wb3NpdGlvbiBhcyBEeW5hbWljUG9zaXRpb25Qcm9wZXJ0eSkuc2V0VmFsdWUoQ2FydGVzaWFuMy5aRVJPLCBkZXZpY2VHZW9sb2NhdGlvbik7XG4gICAgICAgICAgICAob3JpZ2luLm9yaWVudGF0aW9uIGFzIER5bmFtaWNQcm9wZXJ0eSkuc2V0VmFsdWUoUXVhdGVybmlvbi5JREVOVElUWSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF92ckZyYW1lRGF0YT86YW55O1xuICAgIHByaXZhdGUgX3NjcmF0Y2hRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb247XG4gICAgcHJpdmF0ZSBfc2NyYXRjaFF1YXRlcm5pb24yID0gbmV3IFF1YXRlcm5pb247XG4gICAgcHJpdmF0ZSBfc2NyYXRjaE1hdHJpeDMgPSBuZXcgTWF0cml4MztcbiAgICBwcml2YXRlIF9zY3JhdGNoTWF0cml4NCA9IG5ldyBNYXRyaXg0O1xuXG5cdHByaXZhdGUgX2RlZmF1bHRMZWZ0Qm91bmRzID0gWyAwLjAsIDAuMCwgMC41LCAxLjAgXTtcbiAgICBwcml2YXRlIF9kZWZhdWx0UmlnaHRCb3VuZHMgPSBbIDAuNSwgMC4wLCAwLjUsIDEuMCBdO1xuICAgIFxuICAgIHByaXZhdGUgX3NpdHRpbmdTcGFjZSA9IG5ldyBFbnRpdHkoe1xuICAgICAgICBwb3NpdGlvbjogbmV3IER5bmFtaWNQb3NpdGlvblByb3BlcnR5LFxuICAgICAgICBvcmllbnRhdGlvbjogbmV3IER5bmFtaWNQcm9wZXJ0eVxuICAgIH0pO1xuXG4gICAgcHJpdmF0ZSBfdXBkYXRlRm9yV2ViVlIoKSB7XG4gICAgICAgIGNvbnN0IHZyRGlzcGxheSA9IHRoaXMudnJEaXNwbGF5O1xuICAgICAgICBpZiAoIXZyRGlzcGxheSkgdGhyb3cgbmV3IEVycm9yKCdObyB2ciBkaXNwbGF5IScpO1xuXG4gICAgICAgIGNvbnN0IGZyYW1lU3RhdGUgPSB0aGlzLmZyYW1lU3RhdGU7XG5cbiAgICAgICAgY29uc3QgdnJGcmFtZURhdGEgOiBWUkZyYW1lRGF0YSA9IHRoaXMuX3ZyRnJhbWVEYXRhID0gXG4gICAgICAgICAgICB0aGlzLl92ckZyYW1lRGF0YSB8fCBuZXcgVlJGcmFtZURhdGEoKTtcbiAgICAgICAgdnJEaXNwbGF5LmdldEZyYW1lRGF0YSh2ckZyYW1lRGF0YSk7XG5cbiAgICAgICAgY29uc3QgbGF5ZXIgPSB2ckRpc3BsYXkuZ2V0TGF5ZXJzKClbMF07XG4gICAgICAgIGxldCBsZWZ0Qm91bmRzID0gbGF5ZXIgJiYgbGF5ZXIubGVmdEJvdW5kcztcbiAgICAgICAgbGV0IHJpZ2h0Qm91bmRzID0gbGF5ZXIgJiYgbGF5ZXIucmlnaHRCb3VuZHM7XG5cbiAgICAgICAgaWYgKCBsYXllciApIHtcbiAgICAgICAgICAgIGxlZnRCb3VuZHMgPSBsYXllci5sZWZ0Qm91bmRzICYmIGxheWVyLmxlZnRCb3VuZHMubGVuZ3RoID09PSA0ID8gbGF5ZXIubGVmdEJvdW5kcyA6IHRoaXMuX2RlZmF1bHRMZWZ0Qm91bmRzO1xuICAgICAgICAgICAgcmlnaHRCb3VuZHMgPSBsYXllci5yaWdodEJvdW5kcyAmJiBsYXllci5yaWdodEJvdW5kcy5sZW5ndGggPT09IDQgPyBsYXllci5yaWdodEJvdW5kcyA6IHRoaXMuX2RlZmF1bHRSaWdodEJvdW5kcztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxlZnRCb3VuZHMgPSB0aGlzLl9kZWZhdWx0TGVmdEJvdW5kcztcbiAgICAgICAgICAgIHJpZ2h0Qm91bmRzID0gdGhpcy5fZGVmYXVsdFJpZ2h0Qm91bmRzO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBjb25zdCB2aWV3cG9ydCA9IGZyYW1lU3RhdGUudmlld3BvcnQ7XG4gICAgICAgIGNvbnN0IHN1YnZpZXdzID0gZnJhbWVTdGF0ZS5zdWJ2aWV3cyA9IGZyYW1lU3RhdGUuc3Vidmlld3MgfHwgW107XG4gICAgICAgIHN1YnZpZXdzLmxlbmd0aCA9IDI7XG5cbiAgICAgICAgY29uc3QgbGVmdFN1YnZpZXcgPSBzdWJ2aWV3c1swXSA9IHN1YnZpZXdzWzBdIHx8IHt9O1xuICAgICAgICBjb25zdCByaWdodFN1YnZpZXcgPSBzdWJ2aWV3c1sxXSA9IHN1YnZpZXdzWzFdIHx8IHt9O1xuICAgICAgICBsZWZ0U3Vidmlldy50eXBlID0gU3Vidmlld1R5cGUuTEVGVEVZRTtcbiAgICAgICAgcmlnaHRTdWJ2aWV3LnR5cGUgPSBTdWJ2aWV3VHlwZS5SSUdIVEVZRTtcblxuICAgICAgICBjb25zdCBsZWZ0Vmlld3BvcnQgPSBsZWZ0U3Vidmlldy52aWV3cG9ydCA9IGxlZnRTdWJ2aWV3LnZpZXdwb3J0IHx8IDxDYW52YXNWaWV3cG9ydD57fTtcbiAgICAgICAgbGVmdFZpZXdwb3J0LnggPSBsZWZ0Qm91bmRzWzBdICogdmlld3BvcnQud2lkdGg7XG4gICAgICAgIGxlZnRWaWV3cG9ydC55ID0gbGVmdEJvdW5kc1sxXSAqIHZpZXdwb3J0LmhlaWdodDtcbiAgICAgICAgbGVmdFZpZXdwb3J0LndpZHRoID0gbGVmdEJvdW5kc1syXSAqIHZpZXdwb3J0LndpZHRoO1xuICAgICAgICBsZWZ0Vmlld3BvcnQuaGVpZ2h0ID0gbGVmdEJvdW5kc1szXSAqIHZpZXdwb3J0LmhlaWdodDtcblxuICAgICAgICBjb25zdCByaWdodFZpZXdwb3J0ID0gcmlnaHRTdWJ2aWV3LnZpZXdwb3J0ID0gcmlnaHRTdWJ2aWV3LnZpZXdwb3J0IHx8IDxDYW52YXNWaWV3cG9ydD57fTtcbiAgICAgICAgcmlnaHRWaWV3cG9ydC54ID0gcmlnaHRCb3VuZHNbMF0gKiB2aWV3cG9ydC53aWR0aDtcbiAgICAgICAgcmlnaHRWaWV3cG9ydC55ID0gcmlnaHRCb3VuZHNbMV0gKiB2aWV3cG9ydC5oZWlnaHQ7XG4gICAgICAgIHJpZ2h0Vmlld3BvcnQud2lkdGggPSByaWdodEJvdW5kc1syXSAqIHZpZXdwb3J0LndpZHRoO1xuICAgICAgICByaWdodFZpZXdwb3J0LmhlaWdodCA9IHJpZ2h0Qm91bmRzWzNdICogdmlld3BvcnQuaGVpZ2h0O1xuXG4gICAgICAgIGxlZnRTdWJ2aWV3LnByb2plY3Rpb25NYXRyaXggPSBNYXRyaXg0LmNsb25lKFxuICAgICAgICAgICAgPGFueT52ckZyYW1lRGF0YS5sZWZ0UHJvamVjdGlvbk1hdHJpeCwgXG4gICAgICAgICAgICBsZWZ0U3Vidmlldy5wcm9qZWN0aW9uTWF0cml4XG4gICAgICAgICk7XG4gICAgICAgIHJpZ2h0U3Vidmlldy5wcm9qZWN0aW9uTWF0cml4ID0gTWF0cml4NC5jbG9uZShcbiAgICAgICAgICAgIDxhbnk+dnJGcmFtZURhdGEucmlnaHRQcm9qZWN0aW9uTWF0cml4LCBcbiAgICAgICAgICAgIHJpZ2h0U3Vidmlldy5wcm9qZWN0aW9uTWF0cml4XG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgdXNlciA9IHRoaXMudXNlcjtcblxuICAgICAgICAvLyBEZWZpbmUgXCJzaXR0aW5nIHNwYWNlXCIsIHBvc2l0aW9uZWQgYXQgZGV2aWNlIGdlb2xvY2F0aW9uXG4gICAgICAgICh0aGlzLl9zaXR0aW5nU3BhY2UucG9zaXRpb24gYXMgRHluYW1pY1Bvc2l0aW9uUHJvcGVydHkpLnNldFZhbHVlKENhcnRlc2lhbjMuWkVSTywgdGhpcy5kZXZpY2VHZW9sb2NhdGlvbik7XG4gICAgICAgICh0aGlzLl9zaXR0aW5nU3BhY2Uub3JpZW50YXRpb24gYXMgRHluYW1pY1Byb3BlcnR5KS5zZXRWYWx1ZShRdWF0ZXJuaW9uLklERU5USVRZKTtcbiAgICAgICAgXG4gICAgICAgIC8vIGxldCBzdGFnZSBiZSBlcXVpdmFsZW50IHRvIFwic3RhbmRpbmcgc3BhY2VcIlxuICAgICAgICBjb25zdCBzaXR0aW5nVG9TdGFuZGluZ1RyYW5zZm9ybSA9IHZyRGlzcGxheS5zdGFnZVBhcmFtZXRlcnMgPyBcbiAgICAgICAgICAgIDxNYXRyaXg0Pjxhbnk+IHZyRGlzcGxheS5zdGFnZVBhcmFtZXRlcnMuc2l0dGluZ1RvU3RhbmRpbmdUcmFuc2Zvcm0gOlxuICAgICAgICAgICAgTWF0cml4NC5JREVOVElUWTtcbiAgICAgICAgY29uc3Qgc3RhbmRpbmdUb1NpdHRpbmdUcmFuc2Zvcm0gPSBNYXRyaXg0LmludmVyc2VUcmFuc2Zvcm1hdGlvbihzaXR0aW5nVG9TdGFuZGluZ1RyYW5zZm9ybSwgdGhpcy5fc2NyYXRjaE1hdHJpeDQpO1xuICAgICAgICBjb25zdCBzdGFuZGluZ1RvU2l0dGluZ1Bvc2l0aW9uID0gTWF0cml4NC5nZXRUcmFuc2xhdGlvbihzdGFuZGluZ1RvU2l0dGluZ1RyYW5zZm9ybSwgdGhpcy5fc2NyYXRjaENhcnRlc2lhbik7XG4gICAgICAgIGNvbnN0IHN0YW5kaW5nVG9TaXR0aW5nUm90YXRpb24gPSBNYXRyaXg0LmdldFJvdGF0aW9uKHN0YW5kaW5nVG9TaXR0aW5nVHJhbnNmb3JtLCB0aGlzLl9zY3JhdGNoTWF0cml4Myk7XG4gICAgICAgIGNvbnN0IHN0YW5kaW5nVG9TaXR0aW5nT3JpZW50YXRpb24gPSBRdWF0ZXJuaW9uLmZyb21Sb3RhdGlvbk1hdHJpeChzdGFuZGluZ1RvU2l0dGluZ1JvdGF0aW9uLCB0aGlzLl9zY3JhdGNoUXVhdGVybmlvbik7XG4gICAgICAgICh0aGlzLnN0YWdlLnBvc2l0aW9uIGFzIER5bmFtaWNQb3NpdGlvblByb3BlcnR5KS5zZXRWYWx1ZShzdGFuZGluZ1RvU2l0dGluZ1Bvc2l0aW9uLCB0aGlzLl9zaXR0aW5nU3BhY2UpO1xuICAgICAgICAodGhpcy5zdGFnZS5vcmllbnRhdGlvbiBhcyBEeW5hbWljUHJvcGVydHkpLnNldFZhbHVlKHN0YW5kaW5nVG9TaXR0aW5nT3JpZW50YXRpb24pO1xuXG4gICAgICAgIC8vIGxldCBvcmlnaW4gYWxzbyBiZSBhdCBcInN0YW5kaW5nIHNwYWNlXCJcbiAgICAgICAgKHRoaXMub3JpZ2luLnBvc2l0aW9uIGFzIER5bmFtaWNQb3NpdGlvblByb3BlcnR5KS5zZXRWYWx1ZShDYXJ0ZXNpYW4zLlpFUk8sIHRoaXMuc3RhZ2UpO1xuICAgICAgICAodGhpcy5vcmlnaW4ub3JpZW50YXRpb24gYXMgRHluYW1pY1Byb3BlcnR5KS5zZXRWYWx1ZShRdWF0ZXJuaW9uLklERU5USVRZKTtcblxuICAgICAgICAvLyB1c2VyIHBvc2UgaXMgZ2l2ZW4gaW4gXCJzaXR0aW5nIHNwYWNlXCJcbiAgICAgICAgY29uc3QgaGFzUG9zaXRpb24gPSB2ckRpc3BsYXkuY2FwYWJpbGl0aWVzLmhhc1Bvc2l0aW9uO1xuICAgICAgICBjb25zdCB1c2VyUG9zaXRpb24gOiBDYXJ0ZXNpYW4zfHVuZGVmaW5lZCA9ICFoYXNQb3NpdGlvbiA/IFxuICAgICAgICAgICAgQ2FydGVzaWFuMy5aRVJPIDogdnJGcmFtZURhdGEucG9zZS5wb3NpdGlvbiA/IFxuICAgICAgICAgICAgICAgIENhcnRlc2lhbjMudW5wYWNrKDxhbnk+dnJGcmFtZURhdGEucG9zZS5wb3NpdGlvbiwgMCwgdGhpcy5fc2NyYXRjaENhcnRlc2lhbikgOiB1bmRlZmluZWQ7XG4gICAgICAgIGNvbnN0IHVzZXJPcmllbnRhdGlvbiA6IFF1YXRlcm5pb258dW5kZWZpbmVkID0gdnJGcmFtZURhdGEucG9zZS5vcmllbnRhdGlvbiA/IFxuICAgICAgICAgICAgUXVhdGVybmlvbi51bnBhY2soPGFueT52ckZyYW1lRGF0YS5wb3NlLm9yaWVudGF0aW9uLCAwLCB0aGlzLl9zY3JhdGNoUXVhdGVybmlvbjIpIDogdW5kZWZpbmVkO1xuICAgICAgICAodXNlci5wb3NpdGlvbiBhcyBEeW5hbWljUG9zaXRpb25Qcm9wZXJ0eSkuc2V0VmFsdWUodXNlclBvc2l0aW9uLCB0aGlzLl9zaXR0aW5nU3BhY2UpO1xuICAgICAgICAodXNlci5vcmllbnRhdGlvbiBhcyBEeW5hbWljUHJvcGVydHkpLnNldFZhbHVlKHVzZXJPcmllbnRhdGlvbik7XG5cbiAgICAgICAgLy8gbGVmdCBleWUgdHJhbnNmb3JtIGlzIGdpdmVuIHJlbGF0aXZlIHRvIHNpdHRpbmcgc3BhY2VcbiAgICAgICAgY29uc3QgbGVmdEV5ZVRyYW5zZm9ybSA9IE1hdHJpeDQuaW52ZXJzZVRyYW5zZm9ybWF0aW9uKFxuICAgICAgICAgICAgPGFueT52ckZyYW1lRGF0YS5sZWZ0Vmlld01hdHJpeCwgXG4gICAgICAgICAgICB0aGlzLl9zY3JhdGNoTWF0cml4NFxuICAgICAgICApO1xuICAgICAgICBjb25zdCBsZWZ0RXllID0gdGhpcy5nZXRTdWJ2aWV3RW50aXR5KDApO1xuICAgICAgICBjb25zdCBsZWZ0RXllUG9zaXRpb24gPSBNYXRyaXg0LmdldFRyYW5zbGF0aW9uKGxlZnRFeWVUcmFuc2Zvcm0sIHRoaXMuX3NjcmF0Y2hDYXJ0ZXNpYW4pO1xuICAgICAgICBjb25zdCBsZWZ0RXllUm90YXRpb24gPSBNYXRyaXg0LmdldFJvdGF0aW9uKGxlZnRFeWVUcmFuc2Zvcm0sIHRoaXMuX3NjcmF0Y2hNYXRyaXgzKTtcbiAgICAgICAgY29uc3QgbGVmdEV5ZU9yaWVudGF0aW9uID0gUXVhdGVybmlvbi5mcm9tUm90YXRpb25NYXRyaXgobGVmdEV5ZVJvdGF0aW9uLCB0aGlzLl9zY3JhdGNoUXVhdGVybmlvbik7XG4gICAgICAgIChsZWZ0RXllLnBvc2l0aW9uIGFzIER5bmFtaWNQb3NpdGlvblByb3BlcnR5KS5zZXRWYWx1ZShsZWZ0RXllUG9zaXRpb24sIHRoaXMuX3NpdHRpbmdTcGFjZSk7XG4gICAgICAgIChsZWZ0RXllLm9yaWVudGF0aW9uIGFzIER5bmFtaWNQcm9wZXJ0eSkuc2V0VmFsdWUobGVmdEV5ZU9yaWVudGF0aW9uKTtcbiAgICAgICAgXG4gICAgICAgIC8vIHJpZ2h0IGV5ZSB0cmFuc2Zvcm0gaXMgZ2l2ZW4gcmVsYXRpdmUgdG8gc2l0dGluZyBzcGFjZVxuICAgICAgICBjb25zdCByaWdodEV5ZVRyYW5zZm9ybSA9IE1hdHJpeDQuaW52ZXJzZVRyYW5zZm9ybWF0aW9uKFxuICAgICAgICAgICAgPGFueT52ckZyYW1lRGF0YS5yaWdodFZpZXdNYXRyaXgsIFxuICAgICAgICAgICAgdGhpcy5fc2NyYXRjaE1hdHJpeDRcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3QgcmlnaHRFeWUgPSB0aGlzLmdldFN1YnZpZXdFbnRpdHkoMSk7XG4gICAgICAgIGNvbnN0IHJpZ2h0RXllUG9zaXRpb24gPSBNYXRyaXg0LmdldFRyYW5zbGF0aW9uKHJpZ2h0RXllVHJhbnNmb3JtLCB0aGlzLl9zY3JhdGNoQ2FydGVzaWFuKTtcbiAgICAgICAgY29uc3QgcmlnaHRFeWVSb3RhdGlvbiA9IE1hdHJpeDQuZ2V0Um90YXRpb24ocmlnaHRFeWVUcmFuc2Zvcm0sIHRoaXMuX3NjcmF0Y2hNYXRyaXgzKTtcbiAgICAgICAgY29uc3QgcmlnaHRFeWVPcmllbnRhdGlvbiA9IFF1YXRlcm5pb24uZnJvbVJvdGF0aW9uTWF0cml4KHJpZ2h0RXllUm90YXRpb24sIHRoaXMuX3NjcmF0Y2hRdWF0ZXJuaW9uKTtcbiAgICAgICAgKHJpZ2h0RXllLnBvc2l0aW9uIGFzIER5bmFtaWNQb3NpdGlvblByb3BlcnR5KS5zZXRWYWx1ZShyaWdodEV5ZVBvc2l0aW9uLCB0aGlzLl9zaXR0aW5nU3BhY2UpO1xuICAgICAgICAocmlnaHRFeWUub3JpZW50YXRpb24gYXMgRHluYW1pY1Byb3BlcnR5KS5zZXRWYWx1ZShyaWdodEV5ZU9yaWVudGF0aW9uKTtcblxuICAgICAgICAvLyB0aGUgcG9seWZpbGwgZG9lcyBub3Qgc3VwcG9ydCByZXBvcnRpbmcgYW4gYWJzb2x1dGUgb3JpZW50YXRpb24gKHlldCksIFxuICAgICAgICAvLyBzbyBmYWxsIGJhY2sgdG8gdGhlIGRlZmF1bHQgb3JpZ2luL3N0YWdlL3VzZXIgcG9zZSBpbiB0aGlzIGNhc2VcbiAgICAgICAgaWYgKHZyRGlzcGxheS5kaXNwbGF5TmFtZS5pbmNsdWRlcygncG9seWZpbGwnKSkge1xuICAgICAgICAgICAgLy8gY2hhbmdlIGxlZnQvcmlnaHQgZXllIHBvc2UgdG8gYmUgcmVsYXRpdmUgdG8gdXNlciwgXG4gICAgICAgICAgICAvLyB3aGljaCBpcyBuZWNlc3Nhcnkgc2luY2Ugd2UgYXJlIHJlZGVmaW5pbmcgdGhlIHVzZXIgcG9zZSB0byB1c2UgYWJzb2x1dGUgb3JpZW50YXRpb25cbiAgICAgICAgICAgIGNvbnN0IGxlZnRFeWVSZWxhdGl2ZVRvVXNlciA9IHRoaXMuZW50aXR5U2VydmljZS5nZXRFbnRpdHlQb3NlKGxlZnRFeWUsIHVzZXIsIGZyYW1lU3RhdGUudGltZSk7XG4gICAgICAgICAgICBjb25zdCByaWdodEV5ZVJlbGF0aXZlVG9Vc2VyID0gdGhpcy5lbnRpdHlTZXJ2aWNlLmdldEVudGl0eVBvc2UocmlnaHRFeWUsIHVzZXIsIGZyYW1lU3RhdGUudGltZSk7XG4gICAgICAgICAgICAobGVmdEV5ZS5wb3NpdGlvbiBhcyBEeW5hbWljUG9zaXRpb25Qcm9wZXJ0eSkuc2V0VmFsdWUobGVmdEV5ZVJlbGF0aXZlVG9Vc2VyLnBvc2l0aW9uLCB1c2VyKTtcbiAgICAgICAgICAgIChyaWdodEV5ZS5wb3NpdGlvbiBhcyBEeW5hbWljUG9zaXRpb25Qcm9wZXJ0eSkuc2V0VmFsdWUocmlnaHRFeWVSZWxhdGl2ZVRvVXNlci5wb3NpdGlvbiwgdXNlcik7XG4gICAgICAgICAgICAobGVmdEV5ZS5vcmllbnRhdGlvbiBhcyBEeW5hbWljUHJvcGVydHkpLnNldFZhbHVlKGxlZnRFeWVSZWxhdGl2ZVRvVXNlci5vcmllbnRhdGlvbik7XG4gICAgICAgICAgICAocmlnaHRFeWUub3JpZW50YXRpb24gYXMgRHluYW1pY1Byb3BlcnR5KS5zZXRWYWx1ZShyaWdodEV5ZVJlbGF0aXZlVG9Vc2VyLm9yaWVudGF0aW9uKTtcbiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZURlZmF1bHRTdGFnZSgpO1xuICAgICAgICAgICAgdGhpcy5fdXBkYXRlRGVmYXVsdFVzZXIoKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2RldmljZU9yaWVudGF0aW9uTGlzdGVuZXI7XG4gICAgcHJpdmF0ZSBfZGV2aWNlT3JpZW50YXRpb25IZWFkaW5nQWNjdXJhY3k6bnVtYmVyfHVuZGVmaW5lZDtcblxuICAgIHByaXZhdGUgX25lZ1g5MCA9IFF1YXRlcm5pb24uZnJvbUF4aXNBbmdsZShDYXJ0ZXNpYW4zLlVOSVRfWCwgLUNlc2l1bU1hdGguUElfT1ZFUl9UV08pO1xuXG4gICAgcHJpdmF0ZSBfdHJ5T3JpZW50YXRpb25VcGRhdGVzKCkgOiB2b2lkIHtcbiAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgPT0gJ3VuZGVmaW5lZCcgfHwgIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKSBcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBpZiAoZGVmaW5lZCh0aGlzLl9kZXZpY2VPcmllbnRhdGlvbkxpc3RlbmVyKSkgcmV0dXJuO1xuXG4gICAgICAgIGxldCBoZWFkaW5nRHJpZnQgPSAwO1xuICAgICAgICBsZXQgYWxwaGFPZmZzZXQ6bnVtYmVyfHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcblxuICAgICAgICB0aGlzLl9kZXZpY2VPcmllbnRhdGlvbkxpc3RlbmVyID0gKGU6IERldmljZU9yaWVudGF0aW9uRXZlbnQpID0+IHtcblxuICAgICAgICAgICAgbGV0IGFscGhhRGVncmVlcyA9IGUuYWxwaGE7XG4gICAgICAgICAgICBsZXQgd2Via2l0Q29tcGFzc0hlYWRpbmc6IG51bWJlciA9IGVbJ3dlYmtpdENvbXBhc3NIZWFkaW5nJ107XG4gICAgICAgICAgICBjb25zdCB3ZWJraXRDb21wYXNzQWNjdXJhY3k6IG51bWJlciA9ICtlWyd3ZWJraXRDb21wYXNzQWNjdXJhY3knXTtcblxuICAgICAgICAgICAgaWYgKCFkZWZpbmVkKGFscGhhRGVncmVlcykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChlLmFic29sdXRlKSB7XG4gICAgICAgICAgICAgICAgYWxwaGFPZmZzZXQgPSAwO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyB3aGVuIHRoZSBwaG9uZSBpcyBhbG1vc3QgdXBkc2lkZSBkb3duLCB3ZWJraXQgZmxpcHMgdGhlIGNvbXBhc3MgaGVhZGluZyBcbiAgICAgICAgICAgIC8vIChub3QgZG9jdW1lbnRlZCBhbnl3aGVyZSwgYW5ub3lpbmdseSlcbiAgICAgICAgICAgIC8vIGlmIChlLmJldGEgPj0gMTMwIHx8IGUuYmV0YSA8PSAtMTMwKSB3ZWJraXRDb21wYXNzSGVhZGluZyA9IHVuZGVmaW5lZDtcblxuICAgICAgICAgICAgdGhpcy5fZGV2aWNlT3JpZW50YXRpb25IZWFkaW5nQWNjdXJhY3kgPSB3ZWJraXRDb21wYXNzQWNjdXJhY3kgPiAwID8gd2Via2l0Q29tcGFzc0FjY3VyYWN5IDogdW5kZWZpbmVkO1xuXG4gICAgICAgICAgICBpZiAoKCFkZWZpbmVkKGFscGhhT2Zmc2V0KSB8fCBNYXRoLmFicyhoZWFkaW5nRHJpZnQpID4gNSkgJiZcbiAgICAgICAgICAgICAgICBkZWZpbmVkKHdlYmtpdENvbXBhc3NIZWFkaW5nKSAmJlxuICAgICAgICAgICAgICAgIHdlYmtpdENvbXBhc3NBY2N1cmFjeSA+PSAwICYmXG4gICAgICAgICAgICAgICAgd2Via2l0Q29tcGFzc0FjY3VyYWN5IDwgODAgJiZcbiAgICAgICAgICAgICAgICB3ZWJraXRDb21wYXNzSGVhZGluZyA+PSAwKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFkZWZpbmVkKGFscGhhT2Zmc2V0KSkge1xuICAgICAgICAgICAgICAgICAgICBhbHBoYU9mZnNldCA9IC13ZWJraXRDb21wYXNzSGVhZGluZztcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhbHBoYU9mZnNldCAtPSBoZWFkaW5nRHJpZnQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIWRlZmluZWQoYWxwaGFPZmZzZXQpIHx8IFxuICAgICAgICAgICAgICAgICFkZWZpbmVkKGUuYWxwaGEpIHx8IFxuICAgICAgICAgICAgICAgICFkZWZpbmVkKGUuYmV0YSkgfHwgXG4gICAgICAgICAgICAgICAgIWRlZmluZWQoZS5nYW1tYSkpIFxuICAgICAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICAgICAgY29uc3QgYWxwaGEgPSBDZXNpdW1NYXRoLlJBRElBTlNfUEVSX0RFR1JFRSAqIChlLmFscGhhICsgYWxwaGFPZmZzZXQgfHwgLXdlYmtpdENvbXBhc3NIZWFkaW5nIHx8IDApO1xuICAgICAgICAgICAgY29uc3QgYmV0YSA9IENlc2l1bU1hdGguUkFESUFOU19QRVJfREVHUkVFICogZS5iZXRhO1xuICAgICAgICAgICAgY29uc3QgZ2FtbWEgPSBDZXNpdW1NYXRoLlJBRElBTlNfUEVSX0RFR1JFRSAqIGUuZ2FtbWE7XG5cbiAgICAgICAgICAgIGNvbnN0IGFscGhhUXVhdCA9IFF1YXRlcm5pb24uZnJvbUF4aXNBbmdsZShDYXJ0ZXNpYW4zLlVOSVRfWiwgYWxwaGEsIHRoaXMuX3NjcmF0Y2hRdWF0ZXJuaW9uKTtcbiAgICAgICAgICAgIGNvbnN0IGJldGFRdWF0ID0gUXVhdGVybmlvbi5mcm9tQXhpc0FuZ2xlKENhcnRlc2lhbjMuVU5JVF9YLCBiZXRhLCB0aGlzLl9zY3JhdGNoUXVhdGVybmlvbjIpO1xuICAgICAgICAgICAgY29uc3QgYWxwaGFCZXRhUXVhdCA9IFF1YXRlcm5pb24ubXVsdGlwbHkoYWxwaGFRdWF0LCBiZXRhUXVhdCwgdGhpcy5fc2NyYXRjaFF1YXRlcm5pb24pO1xuICAgICAgICAgICAgY29uc3QgZ2FtbWFRdWF0ID0gUXVhdGVybmlvbi5mcm9tQXhpc0FuZ2xlKENhcnRlc2lhbjMuVU5JVF9ZLCBnYW1tYSwgdGhpcy5fc2NyYXRjaFF1YXRlcm5pb24yKTtcbiAgICAgICAgICAgIGNvbnN0IGFscGhhQmV0YUdhbW1hUXVhdCA9IFF1YXRlcm5pb24ubXVsdGlwbHkoYWxwaGFCZXRhUXVhdCwgZ2FtbWFRdWF0LCB0aGlzLl9zY3JhdGNoUXVhdGVybmlvbik7XG5cbiAgICAgICAgICAgIC8vIGZpbmFsbHksIGNvbnZlcnQgZnJvbSBFTlUgdG8gRVVTXG4gICAgICAgICAgICBjb25zdCBkZXZpY2VPcmllbnRhdGlvblZhbHVlID0gUXVhdGVybmlvbi5tdWx0aXBseSh0aGlzLl9uZWdYOTAsIGFscGhhQmV0YUdhbW1hUXVhdCwgdGhpcy5fc2NyYXRjaFF1YXRlcm5pb24yKTsgLy8gcm90YXRlIGZyb20gRU5VIHRvIEVVU1xuICAgICAgICAgICAgKHRoaXMuZGV2aWNlT3JpZW50YXRpb24ub3JpZW50YXRpb24gYXMgRHluYW1pY1Byb3BlcnR5KS5zZXRWYWx1ZShkZXZpY2VPcmllbnRhdGlvblZhbHVlKTtcbiAgICAgICAgICAgIHRoaXMuZGV2aWNlT3JpZW50YXRpb25bJ21ldGEnXSA9IHRoaXMuZGV2aWNlT3JpZW50YXRpb25bJ21ldGEnXSB8fCB7fTtcbiAgICAgICAgICAgIHRoaXMuZGV2aWNlT3JpZW50YXRpb25bJ21ldGEnXS5nZW9IZWFkaW5nQWNjdXJhY3kgPSB3ZWJraXRDb21wYXNzQWNjdXJhY3kgfHwgdW5kZWZpbmVkO1xuXG4gICAgICAgICAgICAvLyBUT0RPOiBmaXggaGVhZGluZyBkcmlmdCBjYWxjdWxhdGlvbiAoaGVhZGluZyBzaG91bGQgbWF0Y2ggd2Via2l0Q29tcGFzc0hlYWRpbmcpXG4gICAgICAgICAgICAvLyBpZiAoZGVmaW5lZCh3ZWJraXRDb21wYXNzSGVhZGluZykpIHtcbiAgICAgICAgICAgIC8vICAgICBjb25zdCBxID0gYWxwaGFCZXRhR2FtbWFRdWF0Ly91dGlscy5nZXRFbnRpdHlPcmllbnRhdGlvbkluUmVmZXJlbmNlRnJhbWUodGhpcy5pbnRlcmZhY2VFbnRpdHksIEp1bGlhbkRhdGUubm93KCksIHRoaXMubG9jYXRpb25FbnRpdHksIHRoaXMuX3NjcmF0Y2hRdWF0ZXJuaW9uMSk7XG4gICAgICAgICAgICAvLyAgICAgdmFyIGhlYWRpbmcgPSAtTWF0aC5hdGFuMigyKihxLncqcS56ICsgcS54KnEueSksIDEgLSAyKihxLnkqcS55ICsgcS56KnEueikpO1xuICAgICAgICAgICAgLy8gICAgIGlmIChoZWFkaW5nIDwgMCkgaGVhZGluZyArPSAyKk1hdGguUEk7XG4gICAgICAgICAgICAvLyAgICAgY29uc3Qge3N3aW5nLHR3aXN0fSA9IHN3aW5nVHdpc3REZWNvbXBvc2l0aW9uKGFscGhhQmV0YUdhbW1hUXVhdCwgQ2FydGVzaWFuMy5VTklUX1opO1xuICAgICAgICAgICAgLy8gICAgIGNvbnN0IHR3aXN0QW5nbGUgPSAyICogTWF0aC5hY29zKHR3aXN0LncpO1xuICAgICAgICAgICAgLy8gICAgIGNvbnNvbGUubG9nKHR3aXN0LncgKyAnICcgKyB0d2lzdEFuZ2xlICogQ2VzaXVtTWF0aC5ERUdSRUVTX1BFUl9SQURJQU4gKyAnXFxuJyArIHdlYmtpdENvbXBhc3NIZWFkaW5nKTtcbiAgICAgICAgICAgIC8vICAgICAvLyB0aGlzLl9oZWFkaW5nRHJpZnQgPSB3ZWJraXRDb21wYXNzSGVhZGluZyAtIGhlYWRpbmcgKiBDZXNpdW1NYXRoLkRFR1JFRVNfUEVSX1JBRElBTjtcbiAgICAgICAgICAgIC8vIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICgnb25kZXZpY2VvcmllbnRhdGlvbmFic29sdXRlJyBpbiB3aW5kb3cpIHtcbiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdkZXZpY2VvcmllbnRhdGlvbmFic29sdXRlJywgdGhpcy5fZGV2aWNlT3JpZW50YXRpb25MaXN0ZW5lcilcbiAgICAgICAgfSBlbHNlIGlmICgnb25kZXZpY2VvcmllbnRhdGlvbicgaW4gd2luZG93KSB7XG4gICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZGV2aWNlb3JpZW50YXRpb24nLCB0aGlzLl9kZXZpY2VPcmllbnRhdGlvbkxpc3RlbmVyKVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfaGFzUG9seWZpbGxXZWJWUkRpc3BsYXkoKSA6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gISF0aGlzLnZyRGlzcGxheSAmJiAhIXRoaXMudnJEaXNwbGF5LmRpc3BsYXlOYW1lLm1hdGNoKC9wb2x5ZmlsbC9nKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHNjcmVlbk9yaWVudGF0aW9uRGVncmVlcygpIDogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnID8gKHNjcmVlblsnb3JpZW50YXRpb24nXSAmJiAtc2NyZWVuWydvcmllbnRhdGlvbiddLmFuZ2xlKSB8fCAtd2luZG93Lm9yaWVudGF0aW9uIHx8IDAgOiAwO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBSZXF1ZXN0IGFuIGFuaW1hdGlvbiBmcmFtZSBjYWxsYmFja1xuICAgICAqL1xuICAgIHB1YmxpYyByZXF1ZXN0QW5pbWF0aW9uRnJhbWU6ICgoY2FsbGJhY2s6KHRpbWVzdGFtcDpudW1iZXIpPT52b2lkKSA9PiBudW1iZXIpID0gY2FsbGJhY2sgPT4ge1xuICAgICAgICBpZiAodGhpcy52ckRpc3BsYXkgJiYgdGhpcy52ckRpc3BsYXkuaXNQcmVzZW50aW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy52ckRpc3BsYXkucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGNhbGxiYWNrKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoY2FsbGJhY2spO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FuY2VsIGFuIGFuaW1hdGlvbiBmcmFtZSBjYWxsYmFja1xuICAgICAqL1xuICAgIHB1YmxpYyBjYW5jZWxBbmltYXRpb25GcmFtZTogKChpZDpudW1iZXIpID0+IHZvaWQpID0gaWQgPT4ge1xuICAgICAgICBpZiAodGhpcy52ckRpc3BsYXkpIHtcbiAgICAgICAgICAgIHRoaXMudnJEaXNwbGF5LmNhbmNlbEFuaW1hdGlvbkZyYW1lKGlkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKGlkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyByZXF1ZXN0SGVhZERpc3BsYXlNb2RlKCkge1xuICAgICAgICBjb25zdCB2ckRpc3BsYXkgPSB0aGlzLnZyRGlzcGxheVxuICAgICAgICBjb25zdCBlbGVtZW50ID0gdGhpcy52aWV3SXRlbXMuZWxlbWVudDtcbiAgICAgICAgY29uc3Qgdmlld0xheWVycyA9IHRoaXMudmlld0l0ZW1zLmxheWVycztcbiAgICAgICAgaWYgKCFlbGVtZW50KSByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKFwiQSBET00gZWxlbWVudCBpcyByZXF1aXJlZFwiKSk7XG4gICAgICAgIGlmICghdnJEaXNwbGF5IHx8ICF2ckRpc3BsYXkuY2FwYWJpbGl0aWVzLmNhblByZXNlbnQpIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoXCJEaXNwbGF5IG1vZGUgJ2hlYWQnIGlzIG5vdCBzdXBwb3J0ZWRcIikpO1xuXG4gICAgICAgIGNvbnN0IGxheWVyczpWUkxheWVyJnt9W10gPSBcbiAgICAgICAgICAgIFt7XG4gICAgICAgICAgICAgICAgc291cmNlOlxuICAgICAgICAgICAgICAgICAgICB2aWV3TGF5ZXJzICYmIHZpZXdMYXllcnNbMF0gJiYgdmlld0xheWVyc1swXS5zb3VyY2UgfHwgXG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucXVlcnlTZWxlY3RvcignY2FudmFzJykgfHwgXG4gICAgICAgICAgICAgICAgICAgIDxIVE1MQ2FudmFzRWxlbWVudD5lbGVtZW50Lmxhc3RFbGVtZW50Q2hpbGRcbiAgICAgICAgICAgIH1dO1xuXG4gICAgICAgIHJldHVybiB2ckRpc3BsYXkucmVxdWVzdFByZXNlbnQobGF5ZXJzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZXhpdEhlYWREaXNwbGF5TW9kZSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudnJEaXNwbGF5ICYmIHRoaXMudnJEaXNwbGF5LmlzUHJlc2VudGluZyBcbiAgICAgICAgICAgID8gdGhpcy52ckRpc3BsYXkuZXhpdFByZXNlbnQoKSA6IFByb21pc2UucmVqZWN0KG5ldyBFcnJvcihcIkRpc3BsYXkgaXMgbm90IGN1cnJlbnRseSBpbiAnaGVhZCcgbW9kZVwiKSk7XG4gICAgfVxuXG4gICAgcHVibGljIF9zZXRTdGF0ZShzdGF0ZTpEZXZpY2VTdGFibGVTdGF0ZSkge1xuICAgICAgICB0aGlzLl9vdmVycmlkZVN0YXRlID0gc3RhdGU7XG5cbiAgICAgICAgaWYgKHRoaXMudXNlclRyYWNraW5nICE9PSBzdGF0ZS51c2VyVHJhY2tpbmcpIHtcbiAgICAgICAgICAgIHRoaXMudXNlclRyYWNraW5nID0gc3RhdGUudXNlclRyYWNraW5nO1xuICAgICAgICAgICAgdGhpcy51c2VyVHJhY2tpbmdDaGFuZ2VFdmVudC5yYWlzZUV2ZW50KHVuZGVmaW5lZCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5kaXNwbGF5TW9kZSAhPT0gc3RhdGUuZGlzcGxheU1vZGUpIHtcbiAgICAgICAgICAgIHRoaXMuZGlzcGxheU1vZGUgPSBzdGF0ZS5kaXNwbGF5TW9kZTtcbiAgICAgICAgICAgIHRoaXMuZGlzcGxheU1vZGVDaGFuZ2VFdmVudC5yYWlzZUV2ZW50KHVuZGVmaW5lZCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWpzb25FcXVhbHModGhpcy5zdWdnZXN0ZWRHZW9sb2NhdGlvblN1YnNjcmlwdGlvbiwgc3RhdGUuc3VnZ2VzdGVkR2VvbG9jYXRpb25TdWJzY3JpcHRpb24pKSB7XG4gICAgICAgICAgICB0aGlzLnN1Z2dlc3RlZEdlb2xvY2F0aW9uU3Vic2NyaXB0aW9uID0gc3RhdGUuc3VnZ2VzdGVkR2VvbG9jYXRpb25TdWJzY3JpcHRpb247XG4gICAgICAgICAgICB0aGlzLnN1Z2dlc3RlZEdlb2xvY2F0aW9uU3Vic2NyaXB0aW9uQ2hhbmdlRXZlbnQucmFpc2VFdmVudCh1bmRlZmluZWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIF9jb250ZXh0RnJhbWVTdGF0ZTpDb250ZXh0RnJhbWVTdGF0ZTtcblxuICAgIHByaXZhdGUgX3NjcmF0Y2hHZW9sb2NhdGlvbkNhcnRlc2lhbiA9IG5ldyBDYXJ0ZXNpYW4zO1xuICAgIHByaXZhdGUgX3NjcmF0Y2hHZW9sb2NhdGlvbk1hdHJpeDQgPSBuZXcgTWF0cml4NDtcbiAgICBwcml2YXRlIF9zcmNhdGNoR2VvbG9jYXRpb25NYXRyaXgzID0gbmV3IE1hdHJpeDM7XG4gICAgcHJpdmF0ZSBfc2NyYXRjaEdlb2xvY2F0aW9uUXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uO1xuICAgIHByaXZhdGUgX2Vhc3RVcFNvdXRoVG9GaXhlZEZyYW1lID0gZWFzdFVwU291dGhUb0ZpeGVkRnJhbWU7XG5cbiAgICBwcm90ZWN0ZWQgb25HZW9sb2NhdGlvblVwZGF0ZShcbiAgICAgICAgICAgIGNhcnRvZ3JhcGhpYzpDYXJ0b2dyYXBoaWMsXG4gICAgICAgICAgICBnZW9Ib3Jpem9udGFsQWNjdXJhY3k/Om51bWJlcixcbiAgICAgICAgICAgIGdlb1ZlcnRpY2FsQWNjdXJhY3k/Om51bWJlcikge1xuXG4gICAgICAgIGlmICghZGVmaW5lZChnZW9WZXJ0aWNhbEFjY3VyYWN5KSAmJiBjYXJ0b2dyYXBoaWMuaGVpZ2h0ID09PSAwKSB7XG4gICAgICAgICAgICB1cGRhdGVIZWlnaHRGcm9tVGVycmFpbihjYXJ0b2dyYXBoaWMpLnRoZW4oKCkgPT4gdGhpcy5vbkdlb2xvY2F0aW9uVXBkYXRlKGNhcnRvZ3JhcGhpYywgZ2VvSG9yaXpvbnRhbEFjY3VyYWN5LCAwKSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBnZW9sb2NhdGlvbiA9IHRoaXMuZGV2aWNlR2VvbG9jYXRpb247XG4gICAgICAgIFxuICAgICAgICBjb25zdCBmaXhlZFBvc2l0aW9uID0gQ2FydGVzaWFuMy5mcm9tUmFkaWFucyhjYXJ0b2dyYXBoaWMubG9uZ2l0dWRlLCBjYXJ0b2dyYXBoaWMubGF0aXR1ZGUsIGNhcnRvZ3JhcGhpYy5oZWlnaHQsIHVuZGVmaW5lZCwgdGhpcy5fc2NyYXRjaEdlb2xvY2F0aW9uQ2FydGVzaWFuKTtcbiAgICAgICAgY29uc3QgZXVzVHJhbnNmb3JtID0gdGhpcy5fZWFzdFVwU291dGhUb0ZpeGVkRnJhbWUoZml4ZWRQb3NpdGlvbiwgdW5kZWZpbmVkLCB0aGlzLl9zY3JhdGNoR2VvbG9jYXRpb25NYXRyaXg0KTtcbiAgICAgICAgY29uc3QgZXVzUm90YXRpb24gPSBNYXRyaXg0LmdldFJvdGF0aW9uKGV1c1RyYW5zZm9ybSwgdGhpcy5fc3JjYXRjaEdlb2xvY2F0aW9uTWF0cml4Myk7XG4gICAgICAgIGNvbnN0IGV1c09yaWVudGF0aW9uID0gUXVhdGVybmlvbi5mcm9tUm90YXRpb25NYXRyaXgoZXVzUm90YXRpb24sIHRoaXMuX3NjcmF0Y2hHZW9sb2NhdGlvblF1YXRlcm5pb24pO1xuXG4gICAgICAgIChnZW9sb2NhdGlvbi5wb3NpdGlvbiBhcyBEeW5hbWljUG9zaXRpb25Qcm9wZXJ0eSkuc2V0VmFsdWUoXG4gICAgICAgICAgICBmaXhlZFBvc2l0aW9uLFxuICAgICAgICAgICAgUmVmZXJlbmNlRnJhbWUuRklYRURcbiAgICAgICAgKTtcblxuICAgICAgICAoZ2VvbG9jYXRpb24ub3JpZW50YXRpb24gYXMgRHluYW1pY1Byb3BlcnR5KS5zZXRWYWx1ZShcbiAgICAgICAgICAgIGV1c09yaWVudGF0aW9uXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgZ3BzTWV0YSA9IGdlb2xvY2F0aW9uWydtZXRhJ10gPSBnZW9sb2NhdGlvblsnbWV0YSddIHx8IHt9OyBcbiAgICAgICAgZ3BzTWV0YS5nZW9Ib3Jpem9udGFsQWNjdXJhY3kgPSBnZW9Ib3Jpem9udGFsQWNjdXJhY3k7XG4gICAgICAgIGdwc01ldGEuZ2VvVmVydGljYWxBY2N1cmFjeSA9IGdlb1ZlcnRpY2FsQWNjdXJhY3k7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2VvbG9jYXRpb25XYXRjaElkPzpudW1iZXI7XG4gICAgcHJpdmF0ZSBfc2NyYXRjaENhcnRvZ3JhcGhpYyA9IG5ldyBDYXJ0b2dyYXBoaWM7XG5cbiAgICAvKipcbiAgICAgKiBPdmVycmlkYWJsZS4gU2hvdWxkIGNhbGwgY29uZmlndXJlU3RhZ2Ugd2hlbiBuZXcgZ2VvbG9jYXRpb24gaXMgYXZhaWxhYmxlIFxuICAgICAqL1xuICAgIHB1YmxpYyBzdGFydEdlb2xvY2F0aW9uVXBkYXRlcyhvcHRpb25zOkdlb2xvY2F0aW9uT3B0aW9ucykgOiB2b2lkIHtcbiAgICAgICAgaWYgKHR5cGVvZiBuYXZpZ2F0b3IgPT0gJ3VuZGVmaW5lZCcgfHwgIW5hdmlnYXRvci5nZW9sb2NhdGlvbilcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5hYmxlIHRvIHN0YXJ0IGdlb2xvY2F0aW9uIHVwZGF0ZXMnKTtcbiAgICAgICAgaWYgKCFkZWZpbmVkKHRoaXMuX2dlb2xvY2F0aW9uV2F0Y2hJZCkpIHtcbiAgICAgICAgICAgIHRoaXMuX2dlb2xvY2F0aW9uV2F0Y2hJZCA9IG5hdmlnYXRvci5nZW9sb2NhdGlvbi53YXRjaFBvc2l0aW9uKChwb3MpID0+IHtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGxvbmdEZWdyZWVzID0gcG9zLmNvb3Jkcy5sb25naXR1ZGU7XG4gICAgICAgICAgICAgICAgY29uc3QgbGF0RGVncmVlcyA9IHBvcy5jb29yZHMubGF0aXR1ZGU7XG4gICAgICAgICAgICAgICAgY29uc3QgYWx0aXR1ZGUgPSBwb3MuY29vcmRzLmFsdGl0dWRlO1xuICAgICAgICAgICAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYyA9IENhcnRvZ3JhcGhpYy5mcm9tRGVncmVlcyhsb25nRGVncmVlcywgbGF0RGVncmVlcywgYWx0aXR1ZGV8fDAsIHRoaXMuX3NjcmF0Y2hDYXJ0b2dyYXBoaWMpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5vbkdlb2xvY2F0aW9uVXBkYXRlKFxuICAgICAgICAgICAgICAgICAgICBjYXJ0b2dyYXBoaWMsXG4gICAgICAgICAgICAgICAgICAgIChwb3MuY29vcmRzLmFjY3VyYWN5ID4gMCkgPyBwb3MuY29vcmRzLmFjY3VyYWN5IDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICAgICBwb3MuY29vcmRzLmFsdGl0dWRlQWNjdXJhY3kgfHwgdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0sIChlKT0+e1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignVW5hYmxlIHRvIHN0YXJ0IGdlb2xvY2F0aW9uIHVwZGF0ZXM6ICcgKyBlLm1lc3NhZ2UpO1xuICAgICAgICAgICAgfSwgb3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBPdmVycmlkYWJsZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgc3RvcEdlb2xvY2F0aW9uVXBkYXRlcygpIDogdm9pZCB7XG4gICAgICAgIGlmICh0eXBlb2YgbmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJyAmJiBkZWZpbmVkKHRoaXMuX2dlb2xvY2F0aW9uV2F0Y2hJZCkpIHtcbiAgICAgICAgICAgIG5hdmlnYXRvci5nZW9sb2NhdGlvbi5jbGVhcldhdGNoKHRoaXMuX2dlb2xvY2F0aW9uV2F0Y2hJZCk7XG4gICAgICAgICAgICB0aGlzLl9nZW9sb2NhdGlvbldhdGNoSWQgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8qKlxuICogVGhlIERldmljZVNlcnZpY2UgcHJvdmlkZXMgdGhlIGN1cnJlbnQgZGV2aWNlIHN0YXRlXG4gKi9cbkBzaW5nbGV0b24odHJ1ZSkgLy8gcmVnaXN0ZXIgaW4gY2hpbGQgY29udGFpbmVyXG5leHBvcnQgY2xhc3MgRGV2aWNlU2VydmljZSB7XG5cbiAgICAvKipcbiAgICAgKiBJZiB0aGlzIGlzIHRydWUgKGFuZCB3ZSBhcmUgcHJlc2VudGluZyB2aWEgd2VidnIgYXBpKSwgdGhlblxuICAgICAqIHZyRGlzcGxheS5zdWJtaXRGcmFtZSBpcyBjYWxsZWQgYWZ0ZXIgdGhlIGZyYW1lU3RhdGUgZXZlbnRcbiAgICAgKi9cbiAgICBwdWJsaWMgYXV0b1N1Ym1pdEZyYW1lID0gdHJ1ZTtcblxuICAgIC8qKlxuICAgICAqIERldmljZSBzdGF0ZSBmb3IgdGhlIGN1cnJlbnQgZnJhbWUuIFRoaXNcbiAgICAgKiBpcyBub3QgdXBkYXRlZCB1bmxlc3MgdGhlIHZpZXcgaXMgdmlzaWJsZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgZnJhbWVTdGF0ZSA9IHRoaXMuX2RldmljZS5mcmFtZVN0YXRlO1xuXG4gICAgLyoqXG4gICAgICogQW4gZXZlbnQgdGhhdCBmaXJlcyBldmVyeSB0aW1lIHRoZSBkZXZpY2UgZnJhbWVTdGF0ZSBpcyB1cGRhdGVkLiBcbiAgICAgKi9cbiAgICBwdWJsaWMgZnJhbWVTdGF0ZUV2ZW50ID0gbmV3IEV2ZW50PERldmljZUZyYW1lU3RhdGU+KCk7XG5cbiAgICAvKipcbiAgICAgKiBBbiBldmVuIHRoYXQgZmlyZXMgd2hlbiB0aGUgdmlldyBzdGFydHMgb3Igc3RvcHMgcHJlc2VudGluZyB0byBhbiBITUQuXG4gICAgICogRGVwcmVjYXRlZC4gVXNlIGRpc3BsYXlNb2RlQ2hhbmdlRXZlbnRcbiAgICAgKi9cbiAgICBwdWJsaWMgcHJlc2VudEhNRENoYW5nZUV2ZW50ID0gdGhpcy5fZGV2aWNlLmRpc3BsYXlNb2RlQ2hhbmdlRXZlbnQ7XG5cblxuICAgIC8qKlxuICAgICAqIEFuIGV2ZW50IHRoYXQgZmlyZXMgd2hlbiB0aGUgZGlzcGxheSBjaGFuZ2VzXG4gICAgICovXG4gICAgcHVibGljIHZyRGlzcGxheUNoYW5nZUV2ZW50ID0gdGhpcy5fZGV2aWNlLnZyRGlzcGxheUNoYW5nZUV2ZW50O1xuICAgIHB1YmxpYyBnZXQgdnJEaXNwbGF5KCkgeyByZXR1cm4gdGhpcy5fZGV2aWNlLnZyRGlzcGxheSB9O1xuICAgIHB1YmxpYyBnZXQgdnJEaXNwbGF5cygpIHsgcmV0dXJuIHRoaXMuX2RldmljZS52ckRpc3BsYXlzIH07XG5cbiAgICAvKipcbiAgICAgKiBBbiBldmVuIHRoYXQgZmlyZXMgd2hlbiB0aGUgZGlzcGxheSBtb2RlIGNoYW5nZXNcbiAgICAgKi9cbiAgICBwdWJsaWMgZGlzcGxheU1vZGVDaGFuZ2VFdmVudCA9IHRoaXMuX2RldmljZS5kaXNwbGF5TW9kZUNoYW5nZUV2ZW50O1xuICAgIHB1YmxpYyBnZXQgZGlzcGxheU1vZGUoKSB7IHJldHVybiB0aGlzLl9kZXZpY2UuZGlzcGxheU1vZGUgfTtcblxuICAgIC8qXG4gICAgICogQW4gZXZlbnQgdGhhdCBmaXJlcyB3aGVuIHRoZSBzY3JlZW4gb3JpZW50YXRpb24gY2hhbmdlc1xuICAgICAqL1xuICAgIHB1YmxpYyBzY3JlZW5PcmllbnRhdGlvbkNoYW5nZUV2ZW50ID0gdGhpcy5fZGV2aWNlLnNjcmVlbk9yaWVudGF0aW9uQ2hhbmdlRXZlbnQ7XG4gICAgcHVibGljIGdldCBzY3JlZW5PcmllbnRhdGlvbkRlZ3JlZXMoKSA6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kZXZpY2Uuc2NyZWVuT3JpZW50YXRpb25EZWdyZWVzO1xuICAgIH1cblxuICAgIC8qXG4gICAgICogQW4gZXZlbnQgdGhhdCBmaXJlcyB3aGVuIHVzZXJUcmFja2luZyBzdGF0ZSBjaGFuZ2VzXG4gICAgICovXG4gICAgcHVibGljIHVzZXJUcmFja2luZ0NoYW5nZUV2ZW50ID0gdGhpcy5fZGV2aWNlLnVzZXJUcmFja2luZ0NoYW5nZUV2ZW50O1xuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyB0aGUgRE9GIHN1cHBvcnQgb2YgdGhlIGRldmljZS5cbiAgICAgKiBcIm5vbmVcInxcIjNET0ZcInxcIjZET0ZcIlxuICAgICAqL1xuICAgIHB1YmxpYyBnZXQgdXNlclRyYWNraW5nKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZGV2aWNlLnVzZXJUcmFja2luZztcbiAgICB9XG5cbiAgICAvKlxuICAgICAqIEFuIGV2ZW50IHRoYXQgZmlyZXMgd2hlbiBnZXRWUkRpc3BsYXkoKSBpcyBmaW5pc2hlZFxuICAgICAqL1xuICAgIHB1YmxpYyB2ckRpc3BsYXlzVXBkYXRlZEV2ZW50ID0gdGhpcy5fZGV2aWNlLnZyRGlzcGxheXNVcGRhdGVkRXZlbnQ7XG5cbiAgICAvKipcbiAgICAgKiBBIGNvb3JkaW5hdGUgc3lzdGVtIHJlcHJlc2VudGluZyB0aGUgcGh5c2ljYWwgc3BhY2UgaW4gd2hpY2ggdGhlIHVzZXIgaXMgZnJlZSB0byBcbiAgICAgKiBtb3ZlIGFyb3VuZCwgcG9zaXRpb25lZCBvbiB0aGUgc3VyZmFjZSB0aGUgdXNlciBpcyBzdGFuZGluZyBvbixcbiAgICAgKiB3aGVyZSArWCBpcyBlYXN0LCArWSBpcyB1cCwgYW5kICtaIGlzIHNvdXRoIChFYXN0LVVwLVNvdXRoKSwgaWYgZ2VvbG9jYXRpb24gaXMga25vd24uXG4gICAgICogSWYgdGhlIHN0YWdlIGlzIG5vdCBnZW9sb2NhdGVkLCB0aGVuIHRoZSArWCBhbmQgK1ogZGlyZWN0aW9ucyBhcmUgYXJiaXRyYXJ5LiBcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhZ2U6IEVudGl0eSA9IHRoaXMuX2RldmljZS5zdGFnZTtcbiAgICBcbiAgICAvKipcbiAgICAgKiBBbiBlbnRpdHkgcmVwcmVzZW50aW5nIHRoZSBvcmlnaW4gb2YgdGhlIGRldmljZSBjb29yZGluYXRlIHN5c3RlbSwgK1kgdXAuXG4gICAgICovXG4gICAgcHVibGljIG9yaWdpbjogRW50aXR5ID0gdGhpcy5fZGV2aWNlLm9yaWdpbjtcbiAgICBcbiAgICAvKipcbiAgICAgKiBBbiBlbnRpdHkgcmVwcmVzZW50aW5nIHRoZSBwaHlzaWNhbCBwb3NlIG9mIHRoZSB1c2VyLCBcbiAgICAgKiB3aGVyZSArWCBpcyByaWdodCwgK1kgaXMgdXAsIGFuZCAtWiBpcyBmb3J3YXJkXG4gICAgICovXG4gICAgcHVibGljIHVzZXI6IEVudGl0eSA9IHRoaXMuX2RldmljZS51c2VyO1xuICAgIFxuICAgIC8qKlxuICAgICAqIFRoZSBoZWFkaW5nIGFjY3VyYWN5IG9mIHRoZSB1c2VyJ3MgZ2VvcG9zZVxuICAgICAqL1xuICAgIHB1YmxpYyBnZXQgZ2VvSGVhZGluZ0FjY3VyYWN5KCkgOiBudW1iZXJ8dW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhZ2VbJ21ldGEnXSA/IHRoaXMuc3RhZ2VbJ21ldGEnXS5nZW9IZWFkaW5nQWNjdXJhY3kgOiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIFRoZSBob3Jpem9udGFsIGFjY3VyYWN5IG9mIHRoZSB1c2VyJ3MgZ2VvcG9zZVxuICAgICAqL1xuICAgIHB1YmxpYyBnZXQgZ2VvSG9yaXpvbnRhbEFjY3VyYWN5KCkgOiBudW1iZXJ8dW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhZ2VbJ21ldGEnXSA/IHRoaXMuc3RhZ2VbJ21ldGEnXS5nZW9Ib3Jpem9udGFsQWNjdXJhY3kgOiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIFRoZSBob3Jpem9udGFsIGFjY3VyYWN5IG9mIHRoZSB1c2VyJ3MgZ2VvcG9zZVxuICAgICAqL1xuICAgIHB1YmxpYyBnZXQgZ2VvVmVydGljYWxBY2N1cmFjeSgpIDogbnVtYmVyfHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YWdlWydtZXRhJ10gPyB0aGlzLnN0YWdlWydtZXRhJ10uZ2VvVmVydGljYWxBY2N1cmFjeSA6IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgXG4gICAgLypcbiAgICAqIEFuIGV2ZW50IHRoYXQgZmlyZXMgd2hlbiB0aGUgc2NyZWVuIG9yaWVudGF0aW9uIGNoYW5nZXNcbiAgICAqL1xuICAgIHB1YmxpYyBzdWdnZXN0ZWRHZW9sb2NhdGlvblN1YnNjcmlwdGlvbkNoYW5nZUV2ZW50ID0gdGhpcy5fZGV2aWNlLnN1Z2dlc3RlZEdlb2xvY2F0aW9uU3Vic2NyaXB0aW9uQ2hhbmdlRXZlbnQ7XG4gICAgcHVibGljIGdldCBzdWdnZXN0ZWRHZW9sb2NhdGlvblN1YnNjcmlwdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RldmljZS5zdWdnZXN0ZWRHZW9sb2NhdGlvblN1YnNjcmlwdGlvbjtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHN1Z2dlc3RlZFVzZXJIZWlnaHQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kZXZpY2Uuc3VnZ2VzdGVkVXNlckhlaWdodDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHN0cmljdCgpIDogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kZXZpY2Uuc3RyaWN0O1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcm90ZWN0ZWQgc2Vzc2lvblNlcnZpY2U6U2Vzc2lvblNlcnZpY2UsXG4gICAgICAgIHByb3RlY3RlZCBlbnRpdHlTZXJ2aWNlOkVudGl0eVNlcnZpY2UsXG4gICAgICAgIHByb3RlY3RlZCB2aWV3U2VydmljZTpWaWV3U2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBfZGV2aWNlOkRldmljZSxcbiAgICApIHtcbiAgICAgICAgdGhpcy5lbnRpdHlTZXJ2aWNlLmNvbGxlY3Rpb24uYWRkKHRoaXMuc3RhZ2UpO1xuICAgICAgICB0aGlzLmVudGl0eVNlcnZpY2UuY29sbGVjdGlvbi5hZGQodGhpcy5vcmlnaW4pO1xuICAgICAgICB0aGlzLmVudGl0eVNlcnZpY2UuY29sbGVjdGlvbi5hZGQodGhpcy51c2VyKTtcbiAgICAgICAgdGhpcy5lbnRpdHlTZXJ2aWNlLmNvbGxlY3Rpb24uYWRkKHRoaXMuX2RldmljZS5kZXZpY2VHZW9sb2NhdGlvbik7XG4gICAgICAgIHRoaXMuZW50aXR5U2VydmljZS5jb2xsZWN0aW9uLmFkZCh0aGlzLl9kZXZpY2UuZGV2aWNlT3JpZW50YXRpb24pO1xuXG4gICAgICAgIHRoaXMuX3N0YXJ0VXBkYXRlcygpO1xuICAgICAgICB0aGlzLnNlc3Npb25TZXJ2aWNlLm1hbmFnZXIuY2xvc2VFdmVudC5hZGRFdmVudExpc3RlbmVyKCgpPT4gdGhpcy5fc3RvcFVwZGF0ZXMoKSk7XG5cbiAgICAgICAgaWYgKCF0aGlzLnNlc3Npb25TZXJ2aWNlLmlzUmVhbGl0eU1hbmFnZXIpIHtcbiAgICAgICAgICAgIHNlc3Npb25TZXJ2aWNlLm1hbmFnZXIub25bJ2FyLmRldmljZS5zdGF0ZSddID0gc2Vzc2lvblNlcnZpY2UubWFuYWdlci5vblsnYXIuZGV2aWNlLmZyYW1lU3RhdGUnXSA9IChzdGFibGVTdGF0ZTpEZXZpY2VTdGFibGVTdGF0ZSkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIG9ubHkgYXBwbHkgZGV2aWNlIHN0YXRlIGlmIHdlIHRoZSBvd25pbmcgc2Vzc2lvblxuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9kZXZpY2Uub3duZXIgPT09IHRoaXMuc2Vzc2lvblNlcnZpY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGV2aWNlLl9zZXRTdGF0ZShzdGFibGVTdGF0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEludGVybmFsLlxuICAgICAqIEBwcml2YXRlIFxuICAgICAqL1xuICAgIHB1YmxpYyBfcHJvY2Vzc0NvbnRleHRGcmFtZVN0YXRlKGZyYW1lU3RhdGU6Q29udGV4dEZyYW1lU3RhdGUpIHtcbiAgICAgICAgdGhpcy5fZGV2aWNlLl9jb250ZXh0RnJhbWVTdGF0ZSA9IGZyYW1lU3RhdGU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVxdWVzdCBhbiBhbmltYXRpb24gZnJhbWUgY2FsbGJhY2sgZm9yIHRoZSBjdXJyZW50IHZpZXcuIFxuICAgICAqL1xuICAgIHB1YmxpYyByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSB0aGlzLl9kZXZpY2UucmVxdWVzdEFuaW1hdGlvbkZyYW1lLmJpbmQodGhpcy5fZGV2aWNlKTtcblxuICAgIC8qKlxuICAgICAqIENhbmNlbCBhbiBhbmltYXRpb24gZnJhbWUgY2FsbGJhY2sgZm9yIHRoZSBjdXJyZW50IHZpZXcuIFxuICAgICAqL1xuICAgIHB1YmxpYyBjYW5jZWxBbmltYXRpb25GcmFtZSA9IHRoaXMuX2RldmljZS5jYW5jZWxBbmltYXRpb25GcmFtZS5iaW5kKHRoaXMuX2RldmljZSk7XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCBlbW1pdHRpbmcgZnJhbWVTdGF0ZSBldmVudHNcbiAgICAgKi9cbiAgICBwcml2YXRlIF9zdGFydFVwZGF0ZXMoKSA6IHZvaWQge1xuICAgICAgICB0aGlzLnNlc3Npb25TZXJ2aWNlLm1hbmFnZXIud2hlbkNvbm5lY3RlZCgpLnRoZW4oKCk9PntcbiAgICAgICAgICAgIGlmICh0aGlzLnNlc3Npb25TZXJ2aWNlLm1hbmFnZXIudmVyc2lvblswXSA+IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNlc3Npb25TZXJ2aWNlLm1hbmFnZXIuc2VuZCgnYXIuZGV2aWNlLnN0YXJ0VXBkYXRlcycpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5fZGV2aWNlLmZyYW1lU3RhdGVFdmVudC5hZGRFdmVudExpc3RlbmVyKHRoaXMuX29uRGV2aWNlRnJhbWVFdmVudCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RvcCBlbWl0dGluZyBmcmFtZVN0YXRlIGV2ZW50c1xuICAgICAqL1xuICAgIHByaXZhdGUgX3N0b3BVcGRhdGVzKCkgOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zZXNzaW9uU2VydmljZS5tYW5hZ2VyLndoZW5Db25uZWN0ZWQoKS50aGVuKCgpPT57XG4gICAgICAgICAgICBpZiAodGhpcy5zZXNzaW9uU2VydmljZS5tYW5hZ2VyLnZlcnNpb25bMF0gPiAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXNzaW9uU2VydmljZS5tYW5hZ2VyLnNlbmQoJ2FyLmRldmljZS5zdG9wVXBkYXRlcycpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5fZGV2aWNlLmZyYW1lU3RhdGVFdmVudC5yZW1vdmVFdmVudExpc3RlbmVyKHRoaXMuX29uRGV2aWNlRnJhbWVFdmVudCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfb25EZXZpY2VGcmFtZUV2ZW50ID0gKCkgPT4ge1xuICAgICAgICB0aGlzLmZyYW1lU3RhdGVFdmVudC5yYWlzZUV2ZW50KHRoaXMuX2RldmljZS5mcmFtZVN0YXRlKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgb25SZXF1ZXN0UHJlc2VudEhNRCgpIDogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kZXZpY2UucmVxdWVzdEhlYWREaXNwbGF5TW9kZSgpO1xuICAgIH1cbiAgICBcbiAgICBwcm90ZWN0ZWQgb25FeGl0UHJlc2VudEhNRCgpIDogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kZXZpY2UuZXhpdEhlYWREaXNwbGF5TW9kZSgpO1xuICAgIH1cblxuICAgIEBkZXByZWNhdGVkKClcbiAgICBwdWJsaWMgY3JlYXRlQ29udGV4dEZyYW1lU3RhdGUoXG4gICAgICAgIHRpbWU6SnVsaWFuRGF0ZSxcbiAgICAgICAgdmlld3BvcnQ6Q2FudmFzVmlld3BvcnQsXG4gICAgICAgIHN1YnZpZXdMaXN0OlNlcmlhbGl6ZWRTdWJ2aWV3TGlzdCxcbiAgICAgICAgb3B0aW9ucz86IHtvdmVycmlkZVN0YWdlPzpib29sZWFuLCBvdmVycmlkZVVzZXI/OmJvb2xlYW4sIG92ZXJyaWRlVmlldz86Ym9vbGVhbiwgZmxvb3JPZmZzZXQ/Om51bWJlciwgdXNlclRyYWNraW5nPzonbm9uZSd8JzNET0YnfCc2RE9GJ31cbiAgICApIDogYW55IHtcbiAgICAgICAgcmV0dXJuIEFyZ29uU3lzdGVtLmluc3RhbmNlIS5jb250ZXh0LmNyZWF0ZUZyYW1lU3RhdGUodGltZSwgdmlld3BvcnQsIHN1YnZpZXdMaXN0LCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICBnZXRTdWJ2aWV3RW50aXR5ID0gdGhpcy5fZGV2aWNlLmdldFN1YnZpZXdFbnRpdHkuYmluZCh0aGlzLl9kZXZpY2UpO1xuXG4gICAgc3Vic2NyaWJlR2VvbG9jYXRpb24ob3B0aW9ucz86R2VvbG9jYXRpb25PcHRpb25zLCBzZXNzaW9uPXRoaXMuc2Vzc2lvblNlcnZpY2UubWFuYWdlcikgOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2Vzc2lvblNlcnZpY2UubWFuYWdlci53aGVuQ29ubmVjdGVkKCkudGhlbigoKT0+e1xuICAgICAgICAgICAgaWYgKHRoaXMuc2Vzc2lvblNlcnZpY2UubWFuYWdlci52ZXJzaW9uTnVtYmVyID49IDEuNClcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbnRpdHlTZXJ2aWNlLnN1YnNjcmliZSh0aGlzLm9yaWdpbi5pZCwgb3B0aW9ucykudGhlbigoKT0+e30pO1xuICAgICAgICAgICAgZWxzZSBcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbnRpdHlTZXJ2aWNlLnN1YnNjcmliZSh0aGlzLnN0YWdlLmlkLCBvcHRpb25zKS50aGVuKCgpPT57fSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHVuc3Vic2NyaWJlR2VvbG9jYXRpb24oc2Vzc2lvbj10aGlzLnNlc3Npb25TZXJ2aWNlLm1hbmFnZXIpIDogdm9pZCB7XG4gICAgICAgIHRoaXMuc2Vzc2lvblNlcnZpY2UubWFuYWdlci53aGVuQ29ubmVjdGVkKCkudGhlbigoKT0+e1xuICAgICAgICAgICAgaWYgKHRoaXMuc2Vzc2lvblNlcnZpY2UubWFuYWdlci52ZXJzaW9uTnVtYmVyID49IDEuNClcbiAgICAgICAgICAgICAgICB0aGlzLmVudGl0eVNlcnZpY2UudW5zdWJzY3JpYmUodGhpcy5vcmlnaW4uaWQpO1xuICAgICAgICAgICAgZWxzZSBcbiAgICAgICAgICAgICAgICB0aGlzLmVudGl0eVNlcnZpY2UudW5zdWJzY3JpYmUodGhpcy5zdGFnZS5pZCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIElzIHRoZSB2aWV3IHByZXNlbnRpbmcgdG8gYW4gSE1ELiBcbiAgICAgKiBTYW1lIGFzIGBkaXNwbGF5TW9kZSA9PT0gJ2hlYWQnYC5cbiAgICAgKi9cbiAgICBnZXQgaXNQcmVzZW50aW5nSE1EKCkgOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RldmljZS5kaXNwbGF5TW9kZSA9PT0gJ2hlYWQnO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIElzIHRoZSBjdXJyZW50IHJlYWxpdHkgcHJlc2VudGluZyB0byBhbiBITUQuICBcbiAgICAgKiBTYW1lIGFzIGBkaXNwbGF5TW9kZSA9PT0gJ2hlYWQnICYmIGBoYXNTZXBhcmF0ZVJlYWxpdHlMYXllciA9PT0gdHJ1ZWAuXG4gICAgICovXG4gICAgZ2V0IGlzUHJlc2VudGluZ1JlYWxpdHlITUQoKSA6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fZGV2aWNlLmRpc3BsYXlNb2RlID09PSAnaGVhZCcgJiYgdGhpcy5fZGV2aWNlLmhhc1NlcGFyYXRlUmVhbGl0eUxheWVyO1xuICAgIH1cblxuICAgIGdldCBoYXNTZXBhcmF0ZVJlYWxpdHlMYXllcigpIDogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kZXZpY2UuaGFzU2VwYXJhdGVSZWFsaXR5TGF5ZXI7XG4gICAgfVxuXG4gICAgcmVxdWVzdFByZXNlbnRITUQoKSA6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAoIXRoaXMuc2Vzc2lvblNlcnZpY2UubWFuYWdlci5pc0Nvbm5lY3RlZCkgXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Nlc3Npb24gbXVzdCBiZSBjb25uZWN0ZWQnKTtcbiAgICAgICAgaWYgKHRoaXMuc2Vzc2lvblNlcnZpY2UuaXNSZWFsaXR5TWFuYWdlcikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMub25SZXF1ZXN0UHJlc2VudEhNRCgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnNlc3Npb25TZXJ2aWNlLm1hbmFnZXIucmVxdWVzdCgnYXIuZGV2aWNlLnJlcXVlc3RQcmVzZW50SE1EJyk7XG4gICAgfVxuXG4gICAgZXhpdFByZXNlbnRITUQoKSA6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAoIXRoaXMuc2Vzc2lvblNlcnZpY2UubWFuYWdlci5pc0Nvbm5lY3RlZCkgXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Nlc3Npb24gbXVzdCBiZSBjb25uZWN0ZWQnKTtcbiAgICAgICAgaWYgKHRoaXMuc2Vzc2lvblNlcnZpY2UuaXNSZWFsaXR5TWFuYWdlcikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMub25FeGl0UHJlc2VudEhNRCgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnNlc3Npb25TZXJ2aWNlLm1hbmFnZXIucmVxdWVzdCgnYXIuZGV2aWNlLmV4aXRQcmVzZW50SE1EJyk7XG4gICAgfVxufVxuXG4vKipcbiAqIFxuICovXG5AYXV0b2luamVjdCgpXG5leHBvcnQgY2xhc3MgRGV2aWNlU2VydmljZVByb3ZpZGVyIHtcbiAgICBcbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJvdGVjdGVkIHNlc3Npb25TZXJ2aWNlOlNlc3Npb25TZXJ2aWNlLFxuICAgICAgICBwcm90ZWN0ZWQgZGV2aWNlU2VydmljZTpEZXZpY2VTZXJ2aWNlLFxuICAgICAgICBwcm90ZWN0ZWQgdmlld1NlcnZpY2U6Vmlld1NlcnZpY2UsXG4gICAgICAgIHByb3RlY3RlZCBlbnRpdHlTZXJ2aWNlOkVudGl0eVNlcnZpY2UsXG4gICAgICAgIHByb3RlY3RlZCBlbnRpdHlTZXJ2aWNlUHJvdmlkZXI6RW50aXR5U2VydmljZVByb3ZpZGVyLFxuICAgICAgICBwcm90ZWN0ZWQgdmlzaWJpbGl0eVNlcnZpY2VQcm92aWRlcjpWaXNpYmlsaXR5U2VydmljZVByb3ZpZGVyLFxuICAgICAgICBwcm90ZWN0ZWQgZGV2aWNlOkRldmljZSxcbiAgICApIHtcbiAgICAgICAgdGhpcy5zZXNzaW9uU2VydmljZS5jb25uZWN0RXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoc2Vzc2lvbik9PntcblxuICAgICAgICAgICAgLy8gZGVwcmVjYXRlZFxuICAgICAgICAgICAgc2Vzc2lvbi5vblsnYXIuZGV2aWNlLnJlcXVlc3RGcmFtZVN0YXRlJ10gPSAoKSA9PiB7fVxuICAgICAgICAgICAgc2Vzc2lvbi5vblsnYXIuZGV2aWNlLnN0YXJ0VXBkYXRlcyddID0gKCkgPT4ge31cbiAgICAgICAgICAgIHNlc3Npb24ub25bJ2FyLmRldmljZS5zdG9wVXBkYXRlcyddID0gKCkgPT4ge31cblxuICAgICAgICAgICAgLy8gdG8gYmUgcmVtb3ZlZCAoc3Vic2NyaXB0aW9uIG9wdGlvbnMgYXJlIGhhbmRsZWQgYnkgRW50aXR5U2VydmljZSBub3cpXG4gICAgICAgICAgICBzZXNzaW9uLm9uWydhci5kZXZpY2Uuc2V0R2VvbG9jYXRpb25PcHRpb25zJ10gPSAoe29wdGlvbnN9KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fc2Vzc2lvbkdlb2xvY2F0aW9uT3B0aW9ucy5zZXQoc2Vzc2lvbiwgb3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tEZXZpY2VHZW9sb2NhdGlvblN1YnNjcmliZXJzKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHNlc3Npb24ub25bJ2FyLmRldmljZS5yZXF1ZXN0UHJlc2VudEhNRCddID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmhhbmRsZVJlcXVlc3RQcmVzZW50SE1EKHNlc3Npb24pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzZXNzaW9uLm9uWydhci5kZXZpY2UuZXhpdFByZXNlbnRITUQnXSA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5oYW5kbGVFeGl0UHJlc2VudEhNRChzZXNzaW9uKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgc2Vzc2lvbi5jbG9zZUV2ZW50LmFkZEV2ZW50TGlzdGVuZXIoKCk9PntcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fc2Vzc2lvbkdlb2xvY2F0aW9uT3B0aW9ucy5oYXMoc2Vzc2lvbikpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2Vzc2lvbkdlb2xvY2F0aW9uT3B0aW9ucy5kZWxldGUoc2Vzc2lvbik7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrRGV2aWNlR2VvbG9jYXRpb25TdWJzY3JpYmVycygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB0aGlzLm5lZWRzUHVibGlzaCA9IHRydWU7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuZW50aXR5U2VydmljZVByb3ZpZGVyLnNlc3Npb25TdWJzY3JpYmVkRXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoe2lkLCBvcHRpb25zLCBzZXNzaW9ufSk9PntcbiAgICAgICAgICAgIGlmICh0aGlzLmRldmljZVNlcnZpY2Uub3JpZ2luLmlkID09PSBpZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3Nlc3Npb25HZW9sb2NhdGlvbk9wdGlvbnMuc2V0KHNlc3Npb24sIG9wdGlvbnMpO1xuICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrRGV2aWNlR2VvbG9jYXRpb25TdWJzY3JpYmVycygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmVudGl0eVNlcnZpY2VQcm92aWRlci5zZXNzaW9uVW5zdWJzY3JpYmVkRXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoe2lkfSk9PntcbiAgICAgICAgICAgIGlmICh0aGlzLmRldmljZVNlcnZpY2Uub3JpZ2luLmlkID09PSBpZClcbiAgICAgICAgICAgICAgICB0aGlzLl9jaGVja0RldmljZUdlb2xvY2F0aW9uU3Vic2NyaWJlcnMoKTtcbiAgICAgICAgfSlcblxuICAgICAgICBjb25zdCBzZXROZWVkc1B1Ymxpc2ggPSAoKSA9PiB0aGlzLm5lZWRzUHVibGlzaCA9IHRydWU7XG5cbiAgICAgICAgdGhpcy5kZXZpY2VTZXJ2aWNlLnN1Z2dlc3RlZEdlb2xvY2F0aW9uU3Vic2NyaXB0aW9uQ2hhbmdlRXZlbnQuYWRkRXZlbnRMaXN0ZW5lcihzZXROZWVkc1B1Ymxpc2gpO1xuICAgICAgICB0aGlzLmRldmljZVNlcnZpY2Uuc2NyZWVuT3JpZW50YXRpb25DaGFuZ2VFdmVudC5hZGRFdmVudExpc3RlbmVyKHNldE5lZWRzUHVibGlzaCk7XG4gICAgICAgIHRoaXMuZGV2aWNlU2VydmljZS51c2VyVHJhY2tpbmdDaGFuZ2VFdmVudC5hZGRFdmVudExpc3RlbmVyKHNldE5lZWRzUHVibGlzaCk7XG4gICAgICAgIHRoaXMuZGV2aWNlU2VydmljZS5kaXNwbGF5TW9kZUNoYW5nZUV2ZW50LmFkZEV2ZW50TGlzdGVuZXIoc2V0TmVlZHNQdWJsaXNoKTtcblxuICAgICAgICB0aGlzLnZpZXdTZXJ2aWNlLnZpZXdwb3J0Q2hhbmdlRXZlbnQuYWRkRXZlbnRMaXN0ZW5lcihzZXROZWVkc1B1Ymxpc2gpO1xuICAgICAgICB0aGlzLnZpZXdTZXJ2aWNlLnZpZXdwb3J0TW9kZUNoYW5nZUV2ZW50LmFkZEV2ZW50TGlzdGVuZXIoc2V0TmVlZHNQdWJsaXNoKTtcblxuICAgICAgICBsZXQgcHJldmlvdXNWaWV3cG9ydE1vZGU6Vmlld3BvcnRNb2RlID0gdGhpcy52aWV3U2VydmljZS52aWV3cG9ydE1vZGU7XG5cbiAgICAgICAgdGhpcy5kZXZpY2VTZXJ2aWNlLmRpc3BsYXlNb2RlQ2hhbmdlRXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoKT0+e1xuICAgICAgICAgICAgLy8gaWYgZGV2aWNlIG1vZGUgY2hhbmdlcyB0byAnaGVhZCcsIGVudGVyIGltbWVyc2l2ZSB2aWV3cG9ydCBtb2RlXG4gICAgICAgICAgICBpZiAodGhpcy5kZXZpY2VTZXJ2aWNlLmRpc3BsYXlNb2RlID09PSAnaGVhZCcpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB2ckRpc3BsYXkgPSB0aGlzLmRldmljZVNlcnZpY2UudnJEaXNwbGF5O1xuICAgICAgICAgICAgICAgIGlmICh2ckRpc3BsYXkgJiYgdnJEaXNwbGF5LmRpc3BsYXlOYW1lLm1hdGNoKC9wb2x5ZmlsbC9nKSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXllcnMgPSB2aWV3U2VydmljZS5sYXllcnM7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhc2VMYXllciA9IGxheWVycyAmJiBsYXllcnNbMF07XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbnZhcyA9IGJhc2VMYXllciAmJiBiYXNlTGF5ZXIuc291cmNlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2FudmFzKSBjYW52YXMuY2xhc3NMaXN0LmFkZCgnYXJnb24taW50ZXJhY3RpdmUnKTtcbiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNWaWV3cG9ydE1vZGUgPSB2aWV3U2VydmljZS52aWV3cG9ydE1vZGU7XG4gICAgICAgICAgICAgICAgICAgIHZpZXdTZXJ2aWNlLmRlc2lyZWRWaWV3cG9ydE1vZGUgPSBWaWV3cG9ydE1vZGUuSU1NRVJTSVZFO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbGF5ZXJzID0gdmlld1NlcnZpY2UubGF5ZXJzO1xuICAgICAgICAgICAgICAgIGNvbnN0IGJhc2VMYXllciA9IGxheWVycyAmJiBsYXllcnNbMF07XG4gICAgICAgICAgICAgICAgY29uc3QgY2FudmFzID0gYmFzZUxheWVyICYmIGJhc2VMYXllci5zb3VyY2U7XG4gICAgICAgICAgICAgICAgaWYgKGNhbnZhcykgY2FudmFzLmNsYXNzTGlzdC5yZW1vdmUoJ2FyZ29uLWludGVyYWN0aXZlJyk7XG4gICAgICAgICAgICAgICAgdmlld1NlcnZpY2UuZGVzaXJlZFZpZXdwb3J0TW9kZSA9IHByZXZpb3VzVmlld3BvcnRNb2RlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmRldmljZVNlcnZpY2UuZnJhbWVTdGF0ZUV2ZW50LmFkZEV2ZW50TGlzdGVuZXIoKHN0YXRlKT0+eyAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKHRoaXMubmVlZHNQdWJsaXNoIHx8XG4gICAgICAgICAgICAgICAgdGhpcy5fc3RhYmxlU3RhdGUuaXNQcmVzZW50aW5nSE1EICE9PSB0aGlzLmRldmljZVNlcnZpY2UuaXNQcmVzZW50aW5nSE1EIHx8XG4gICAgICAgICAgICAgICAgdGhpcy5fc3RhYmxlU3RhdGUuaXNQcmVzZW50aW5nUmVhbGl0eUhNRCAhPT0gdGhpcy5kZXZpY2VTZXJ2aWNlLmlzUHJlc2VudGluZ1JlYWxpdHlITUQgfHxcbiAgICAgICAgICAgICAgICBDYW52YXNWaWV3cG9ydC5lcXVhbHModGhpcy5fc3RhYmxlU3RhdGUudmlld3BvcnQsIHN0YXRlLnZpZXdwb3J0KSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5uZWVkc1B1Ymxpc2ggPSB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9zdGFibGVTdGF0ZS5zdWJ2aWV3cykge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9zdGFibGVTdGF0ZS5zdWJ2aWV3cy5sZW5ndGggPT09IHN0YXRlLnN1YnZpZXdzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpPTA7IGkgPCBzdGF0ZS5zdWJ2aWV3cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFTZXJpYWxpemVkU3Vidmlldy5lcXVhbHMoc3RhdGUuc3Vidmlld3NbaV0sIHRoaXMuX3N0YWJsZVN0YXRlLnN1YnZpZXdzW2ldKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubmVlZHNQdWJsaXNoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubmVlZHNQdWJsaXNoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0aGlzLm5lZWRzUHVibGlzaCkgdGhpcy5wdWJsaXNoU3RhYmxlU3RhdGUoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy52aWV3U2VydmljZS52aWV3cG9ydE1vZGVDaGFuZ2VFdmVudC5hZGRFdmVudExpc3RlbmVyKChtb2RlKT0+e1xuICAgICAgICAgICAgaWYgKG1vZGUgPT09IFZpZXdwb3J0TW9kZS5QQUdFICYmIHRoaXMuZGV2aWNlU2VydmljZS52ckRpc3BsYXkgJiYgdGhpcy5kZXZpY2VTZXJ2aWNlLnZyRGlzcGxheS5kaXNwbGF5TmFtZS5tYXRjaCgvcG9seWZpbGwvZykgJiYgdGhpcy5kZXZpY2VTZXJ2aWNlLmRpc3BsYXlNb2RlID09PSAnaGVhZCcpIFxuICAgICAgICAgICAgICAgIHRoaXMuZGV2aWNlU2VydmljZS5leGl0UHJlc2VudEhNRCgpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgaGFuZGxlUmVxdWVzdFByZXNlbnRITUQoc2Vzc2lvbjpTZXNzaW9uUG9ydCkgOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGV2aWNlU2VydmljZS5yZXF1ZXN0UHJlc2VudEhNRCgpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBoYW5kbGVFeGl0UHJlc2VudEhNRChzZXNzaW9uOlNlc3Npb25Qb3J0KSA6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kZXZpY2VTZXJ2aWNlLmV4aXRQcmVzZW50SE1EKCk7XG4gICAgfVxuXG4gICAgcHVibGljIG5lZWRzUHVibGlzaCA9IGZhbHNlO1xuICAgIHByaXZhdGUgX3N0YWJsZVN0YXRlID0gbmV3IERldmljZVN0YWJsZVN0YXRlO1xuXG4gICAgcHVibGljIHB1Ymxpc2hTdGFibGVTdGF0ZSgpIHtcbiAgICAgICAgY29uc3Qgc3RhYmxlU3RhdGUgPSB0aGlzLl9zdGFibGVTdGF0ZTtcbiAgICAgICAgXG4gICAgICAgIHN0YWJsZVN0YXRlLmlzUHJlc2VudGluZ0hNRCA9IHRoaXMuZGV2aWNlU2VydmljZS5pc1ByZXNlbnRpbmdITUQ7XG4gICAgICAgIHN0YWJsZVN0YXRlLmlzUHJlc2VudGluZ1JlYWxpdHlITUQgPSB0aGlzLmRldmljZVNlcnZpY2UuaXNQcmVzZW50aW5nUmVhbGl0eUhNRDtcbiAgICAgICAgc3RhYmxlU3RhdGUuc3VnZ2VzdGVkR2VvbG9jYXRpb25TdWJzY3JpcHRpb24gPSB0aGlzLmRldmljZVNlcnZpY2Uuc3VnZ2VzdGVkR2VvbG9jYXRpb25TdWJzY3JpcHRpb247XG4gICAgICAgIHN0YWJsZVN0YXRlLnN0cmljdCA9IHRoaXMuZGV2aWNlU2VydmljZS5zdHJpY3Q7XG4gICAgICAgIHN0YWJsZVN0YXRlLnZpZXdwb3J0ID0gQ2FudmFzVmlld3BvcnQuY2xvbmUodGhpcy5kZXZpY2VTZXJ2aWNlLmZyYW1lU3RhdGUudmlld3BvcnQsIHN0YWJsZVN0YXRlLnZpZXdwb3J0KVxuICAgICAgICBzdGFibGVTdGF0ZS5zdWJ2aWV3cyA9IFNlcmlhbGl6ZWRTdWJ2aWV3TGlzdC5jbG9uZSh0aGlzLmRldmljZVNlcnZpY2UuZnJhbWVTdGF0ZS5zdWJ2aWV3cywgc3RhYmxlU3RhdGUuc3Vidmlld3MpO1xuICAgICAgICBzdGFibGVTdGF0ZS5kaXNwbGF5TW9kZSA9IHRoaXMuZGV2aWNlU2VydmljZS5kaXNwbGF5TW9kZTtcbiAgICAgICAgc3RhYmxlU3RhdGUudXNlclRyYWNraW5nID0gdGhpcy5kZXZpY2VTZXJ2aWNlLnVzZXJUcmFja2luZztcblxuICAgICAgICB0aGlzLm9uVXBkYXRlU3RhYmxlU3RhdGUodGhpcy5fc3RhYmxlU3RhdGUpO1xuXG4gICAgICAgIC8vIHNlbmQgc3RhYmxlIHN0YXRlIHRvIGVhY2ggdmlzaWJsZSBzZXNzaW9uXG4gICAgICAgIGZvciAoY29uc3Qgc2Vzc2lvbiBvZiB0aGlzLnNlc3Npb25TZXJ2aWNlLm1hbmFnZWRTZXNzaW9ucykge1xuICAgICAgICAgICAgaWYgKHNlc3Npb24udmVyc2lvblswXSA+IDAgJiYgc2Vzc2lvbiAhPT0gdGhpcy5zZXNzaW9uU2VydmljZS5tYW5hZ2VyICYmIFxuICAgICAgICAgICAgICAgIHRoaXMudmlzaWJpbGl0eVNlcnZpY2VQcm92aWRlci52aXNpYmxlU2Vzc2lvbnMuaGFzKHNlc3Npb24pKSB7XG4gICAgICAgICAgICAgICAgICAgIHNlc3Npb24uc2VuZCgnYXIuZGV2aWNlLnN0YXRlJywgc3RhYmxlU3RhdGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5uZWVkc1B1Ymxpc2ggPSBmYWxzZTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgb25VcGRhdGVTdGFibGVTdGF0ZShzdGFibGVTdGF0ZTpEZXZpY2VTdGFibGVTdGF0ZSkge31cblxuICAgIHByaXZhdGUgX2N1cnJlbnRHZW9sb2NhdGlvbk9wdGlvbnM/Okdlb2xvY2F0aW9uT3B0aW9ucztcbiAgICBwcml2YXRlIF90YXJnZXRHZW9sb2NhdGlvbk9wdGlvbnM6R2VvbG9jYXRpb25PcHRpb25zID0ge307XG4gICAgcHJpdmF0ZSBfc2Vzc2lvbkdlb2xvY2F0aW9uT3B0aW9ucyA9IG5ldyBNYXA8U2Vzc2lvblBvcnQsIEdlb2xvY2F0aW9uT3B0aW9uc3x1bmRlZmluZWQ+KCk7XG5cbiAgICBwcml2YXRlIF9jaGVja0RldmljZUdlb2xvY2F0aW9uU3Vic2NyaWJlcnMoKSB7XG4gICAgICAgIGNvbnN0IHN1YnNjcmliZXJzID0gdGhpcy5lbnRpdHlTZXJ2aWNlUHJvdmlkZXIuc3Vic2NyaWJlcnNCeUVudGl0eS5nZXQodGhpcy5kZXZpY2VTZXJ2aWNlLm9yaWdpbi5pZCk7XG4gICAgICAgIGlmIChzdWJzY3JpYmVycyAmJiBzdWJzY3JpYmVycy5zaXplID4gMCkge1xuXG4gICAgICAgICAgICBjb25zdCByZWR1Y2VkT3B0aW9uczpHZW9sb2NhdGlvbk9wdGlvbnMgPSB7fTtcbiAgICAgICAgICAgIHRoaXMuX3Nlc3Npb25HZW9sb2NhdGlvbk9wdGlvbnMuZm9yRWFjaCgob3B0aW9ucywgc2Vzc2lvbik9PntcbiAgICAgICAgICAgICAgICByZWR1Y2VkT3B0aW9ucy5lbmFibGVIaWdoQWNjdXJhY3kgPSBcbiAgICAgICAgICAgICAgICAgICAgcmVkdWNlZE9wdGlvbnMuZW5hYmxlSGlnaEFjY3VyYWN5IHx8IChvcHRpb25zICYmIG9wdGlvbnMuZW5hYmxlSGlnaEFjY3VyYWN5KSB8fCBmYWxzZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaWYgKHRoaXMuX3RhcmdldEdlb2xvY2F0aW9uT3B0aW9ucy5lbmFibGVIaWdoQWNjdXJhY3kgIT09IHJlZHVjZWRPcHRpb25zLmVuYWJsZUhpZ2hBY2N1cmFjeSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3RhcmdldEdlb2xvY2F0aW9uT3B0aW9ucyA9IHJlZHVjZWRPcHRpb25zO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoSlNPTi5zdHJpbmdpZnkodGhpcy5fdGFyZ2V0R2VvbG9jYXRpb25PcHRpb25zKSAhPT0gSlNPTi5zdHJpbmdpZnkodGhpcy5fY3VycmVudEdlb2xvY2F0aW9uT3B0aW9ucykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50R2VvbG9jYXRpb25PcHRpb25zID0gdGhpcy5fdGFyZ2V0R2VvbG9jYXRpb25PcHRpb25zO1xuICAgICAgICAgICAgICAgIHRoaXMuZGV2aWNlLnN0b3BHZW9sb2NhdGlvblVwZGF0ZXMoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmRldmljZS5zdGFydEdlb2xvY2F0aW9uVXBkYXRlcyh0aGlzLl90YXJnZXRHZW9sb2NhdGlvbk9wdGlvbnMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5kZXZpY2Uuc3RvcEdlb2xvY2F0aW9uVXBkYXRlcygpO1xuICAgICAgICAgICAgdGhpcy5fY3VycmVudEdlb2xvY2F0aW9uT3B0aW9ucyA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm5lZWRzUHVibGlzaCA9IHRydWU7XG4gICAgfVxuXG59XG5cbmRlY2xhcmUgY2xhc3MgVlJGcmFtZURhdGEge1xuICAgIHRpbWVzdGFtcDpudW1iZXI7XG5cbiAgICBsZWZ0UHJvamVjdGlvbk1hdHJpeDpGbG9hdDMyQXJyYXk7XG4gICAgbGVmdFZpZXdNYXRyaXg6RmxvYXQzMkFycmF5O1xuXG4gICAgcmlnaHRQcm9qZWN0aW9uTWF0cml4OkZsb2F0MzJBcnJheTtcbiAgICByaWdodFZpZXdNYXRyaXg6RmxvYXQzMkFycmF5O1xuXG4gICAgcG9zZTpWUlBvc2U7XG59Il19