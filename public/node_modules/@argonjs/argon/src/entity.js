var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
import { autoinject } from 'aurelia-dependency-injection';
import { SessionService } from './session';
import { Event, getEntityPositionInReferenceFrame, getEntityOrientationInReferenceFrame, getSerializedEntityState, jsonEquals, stringIdentifierFromReferenceFrame } from './utils';
import { PermissionServiceProvider } from './permission';
import { defined, Cartesian3, Cartographic, Entity, EntityCollection, ConstantPositionProperty, ConstantProperty, JulianDate, Matrix3, Matrix4, ReferenceFrame, ReferenceEntity, Quaternion } from './cesium/cesium-imports';
/**
 * Represents the pose of an entity relative to a particular reference frame.
 *
 * The `update` method must be called in order to update the position / orientation / poseStatus.
 */
var EntityPose = (function () {
    function EntityPose(_collection, entityOrId, referenceFrameId) {
        this._collection = _collection;
        /**
         * The status of this pose, as a bitmask.
         *
         * If the current pose is known, then the KNOWN bit is 1.
         * If the current pose is not known, then the KNOWN bit is 0.
         *
         * If the previous pose was known and the current pose is unknown,
         * then the LOST bit is 1.
         * If the previous pose was unknown and the current pose status is known,
         * then the FOUND bit is 1.
         * In all other cases, both the LOST bit and the FOUND bit are 0.
         */
        this.status = 0;
        this.position = new Cartesian3;
        this.orientation = new Quaternion;
        this.time = new JulianDate(0, 0);
        this.previousStatus = 0;
        this._getEntityPositionInReferenceFrame = getEntityPositionInReferenceFrame;
        this._getEntityOrientationInReferenceFrame = getEntityOrientationInReferenceFrame;
        this._collection['_firing'] = true; // hack: disable collectionChanged event
        if (typeof entityOrId === 'string') {
            var entity = this._collection.getById(entityOrId);
            if (!entity)
                entity = new ReferenceEntity(this._collection, entityOrId);
            this._entity = entity;
        }
        else {
            this._entity = entityOrId;
        }
        if (typeof referenceFrameId === 'string') {
            var referenceFrame = this._collection.getById(referenceFrameId);
            if (!defined(referenceFrame))
                referenceFrame = new ReferenceEntity(this._collection, referenceFrameId);
            this._referenceFrame = referenceFrame;
        }
        else {
            this._referenceFrame = referenceFrameId;
        }
    }
    Object.defineProperty(EntityPose.prototype, "entity", {
        get: function () { return this._entity; },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityPose.prototype, "referenceFrame", {
        get: function () {
            return this._referenceFrame;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityPose.prototype, "poseStatus", {
        /**
         * alias for status
         */
        get: function () { return this.status; },
        enumerable: true,
        configurable: true
    });
    ;
    EntityPose.prototype.update = function (time) {
        var _JulianDate = JulianDate;
        var _PoseStatus = PoseStatus;
        _JulianDate.clone(time, this.time);
        if (!_JulianDate.equals(this.previousTime, time)) {
            this.previousStatus = this.status;
            this.previousTime = _JulianDate.clone(time, this.previousTime);
            this.previousPosition = Cartesian3.clone(this.position, this.previousPosition);
            this.previousOrientation = Quaternion.clone(this.orientation, this.previousOrientation);
        }
        var entity = this.entity;
        var referenceFrame = this.referenceFrame;
        var position = this._getEntityPositionInReferenceFrame(entity, time, referenceFrame, this.position);
        var orientation = this._getEntityOrientationInReferenceFrame(entity, time, referenceFrame, this.orientation);
        var hasPose = position && orientation;
        var currentStatus = 0;
        var previousStatus = this.previousStatus;
        if (hasPose) {
            currentStatus |= _PoseStatus.KNOWN;
        }
        if (hasPose && !(previousStatus & _PoseStatus.KNOWN)) {
            currentStatus |= _PoseStatus.FOUND;
        }
        else if (!hasPose && previousStatus & _PoseStatus.KNOWN) {
            currentStatus |= _PoseStatus.LOST;
        }
        if (!Cartesian3.equals(this.previousPosition, position) ||
            !Quaternion.equals(this.previousOrientation, orientation)) {
            currentStatus |= _PoseStatus.CHANGED;
        }
        this.status = currentStatus;
    };
    return EntityPose;
}());
export { EntityPose };
/**
* A bitmask that provides metadata about an EntityPose.
*   KNOWN - the pose of the entity is defined for the current frame time
*   FOUND - the pose was undefined at the previous frame time, and is now defined
*   LOST - the pose was defined at the previous frame time, and is now undefined
*   CHANGED - the pose has changed since the previous frame time
*/
export var PoseStatus;
(function (PoseStatus) {
    PoseStatus[PoseStatus["KNOWN"] = 1] = "KNOWN";
    PoseStatus[PoseStatus["FOUND"] = 2] = "FOUND";
    PoseStatus[PoseStatus["LOST"] = 4] = "LOST";
    PoseStatus[PoseStatus["CHANGED"] = 8] = "CHANGED";
})(PoseStatus || (PoseStatus = {}));
/**
 * A service for subscribing/unsubscribing to entities
 */
var EntityService = (function () {
    function EntityService(sessionService) {
        this.sessionService = sessionService;
        this.collection = new EntityCollection;
        this.subscribedEvent = new Event();
        this.unsubscribedEvent = new Event();
        this.subscriptions = new Map();
        this._scratchCartesian = new Cartesian3;
        this._scratchQuaternion = new Quaternion;
        this._scratchMatrix3 = new Matrix3;
        this._scratchMatrix4 = new Matrix4;
        this._getEntityPositionInReferenceFrame = getEntityPositionInReferenceFrame;
        this._entityPoseMap = new Map();
        this._stringIdentifierFromReferenceFrame = stringIdentifierFromReferenceFrame;
    }
    EntityService.prototype._handleSubscribed = function (evt) {
        var s = this.subscriptions.get(evt.id);
        var stringifiedOptions = evt.options && JSON.stringify(evt.options);
        if (!s || JSON.stringify(s) === stringifiedOptions) {
            if (s)
                this._handleUnsubscribed(evt.id);
            this.subscriptions.set(evt.id, stringifiedOptions && JSON.parse(stringifiedOptions));
            this.subscribedEvent.raiseEvent(evt);
        }
        ;
    };
    EntityService.prototype._handleUnsubscribed = function (id) {
        if (this.subscriptions.has(id)) {
            this.subscriptions.delete(id);
            this.unsubscribedEvent.raiseEvent({ id: id });
        }
        ;
    };
    /**
     * Get the cartographic position of an Entity at the given time
     */
    EntityService.prototype.getCartographic = function (entity, time, result) {
        var fixedPosition = this._getEntityPositionInReferenceFrame(entity, time, ReferenceFrame.FIXED, this._scratchCartesian);
        if (fixedPosition) {
            result = result || new Cartographic();
            return Cartographic.fromCartesian(fixedPosition, undefined, result);
        }
        return undefined;
    };
    /**
    * Create an entity that is positioned at the given cartographic location,
    * with an orientation computed according to the provided `localToFixed` transform function.
    *
    * For the `localToFixed` parameter, you can pass any of the following:
    *
    * ```
    * Argon.Cesium.Transforms.eastNorthUpToFixedFrame
    * Argon.Cesium.Transforms.northEastDownToFixedFrame
    * Argon.Cesium.Transforms.northUpEastToFixedFrame
    * Argon.Cesium.Transforms.northWestUpToFixedFrame
    * ```
    *
    * Additionally, argon.js provides:
    *
    * ```
    * Argon.eastUpSouthToFixedFrame
    * ```
    *
    * Alternative transform functions can be created with:
    *
    * ```
    * Argon.Cesium.Transforms.localFrameToFixedFrameGenerator
    * ```
    */
    EntityService.prototype.createFixed = function (cartographic, localToFixed) {
        // Convert the cartographic location to an ECEF position
        var position = Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, cartographic.height, undefined, this._scratchCartesian);
        // compute an appropriate orientation on the surface of the earth
        var transformMatrix = localToFixed(position, undefined, this._scratchMatrix4);
        var rotationMatrix = Matrix4.getRotation(transformMatrix, this._scratchMatrix3);
        var orientation = Quaternion.fromRotationMatrix(rotationMatrix, this._scratchQuaternion);
        // create the entity
        var entity = new Entity({
            position: position,
            orientation: orientation
        });
        return entity;
    };
    EntityService.prototype.subscribe = function (idOrEntity, options, session) {
        var _this = this;
        if (session === void 0) { session = this.sessionService.manager; }
        var id = idOrEntity.id || idOrEntity;
        var evt = { id: id, options: options };
        return session.whenConnected().then(function () {
            if (session.version[0] === 0 && session.version[1] < 2)
                return session.request('ar.context.subscribe', evt);
            else
                return session.request('ar.entity.subscribe', evt);
        }).then(function () {
            var entity = _this.collection.getOrCreateEntity(id);
            _this._handleSubscribed(evt);
            return entity;
        });
    };
    EntityService.prototype.unsubscribe = function (idOrEntity, session) {
        var _this = this;
        if (session === void 0) { session = this.sessionService.manager; }
        var id = idOrEntity.id || idOrEntity;
        session.whenConnected().then(function () {
            if (session.version[0] === 0 && session.version[1] < 2)
                session.send('ar.context.unsubscribe', { id: id });
            else
                session.send('ar.entity.unsubscribe', { id: id });
        }).then(function () {
            _this._handleUnsubscribed(id);
        });
    };
    /**
     * Create a new EntityPose instance to represent the pose of an entity
     * relative to a given reference frame.
     *
     * @param entity - the entity to track
     * @param referenceFrameOrId - the reference frame to use
     */
    EntityService.prototype.createEntityPose = function (entityOrId, referenceFrameOrId) {
        return new EntityPose(this.collection, entityOrId, referenceFrameOrId);
    };
    /**
     * Gets the pose of an entity, relative to a given reference frame at a given time.
     *
     * @param entityOrId - The entity whose state is to be queried.
     * @param referenceFrameOrId - The intended reference frame. Defaults to `this.defaultReferenceFrame`.
     */
    EntityService.prototype.getEntityPose = function (entityOrId, referenceFrameOrId, time) {
        var key = this._stringIdentifierFromReferenceFrame(entityOrId) + '@' + this._stringIdentifierFromReferenceFrame(referenceFrameOrId);
        var entityPose = this._entityPoseMap.get(key);
        if (!entityPose) {
            entityPose = this.createEntityPose(entityOrId, referenceFrameOrId);
            this._entityPoseMap.set(key, entityPose);
        }
        entityPose.update(time);
        return entityPose;
    };
    /**
     *
     * @param id
     * @param entityState
     */
    EntityService.prototype.updateEntityFromSerializedState = function (id, entityState) {
        var entity = this.collection.getOrCreateEntity(id);
        if (!entityState) {
            if (entity.position) {
                entity.position.setValue(undefined);
            }
            if (entity.orientation) {
                entity.orientation.setValue(undefined);
            }
            entity['meta'] = undefined;
            return entity;
        }
        var positionValue = entityState.p;
        var orientationValue = Quaternion.clone(entityState.o, this._scratchQuaternion); // workaround for https://github.com/AnalyticalGraphicsInc/cesium/issues/5031
        var referenceFrame = typeof entityState.r === 'number' ?
            entityState.r : this.collection.getOrCreateEntity(entityState.r);
        var entityPosition = entity.position;
        var entityOrientation = entity.orientation;
        if (entityPosition instanceof ConstantPositionProperty) {
            entityPosition.setValue(positionValue, referenceFrame);
        }
        else {
            entity.position = new ConstantPositionProperty(positionValue, referenceFrame);
        }
        if (entityOrientation instanceof ConstantProperty) {
            entityOrientation.setValue(orientationValue);
        }
        else {
            entity.orientation = new ConstantProperty(orientationValue);
        }
        entity['meta'] = entityState.meta;
        return entity;
    };
    EntityService = __decorate([
        autoinject(),
        __metadata("design:paramtypes", [SessionService])
    ], EntityService);
    return EntityService;
}());
export { EntityService };
/**
 * A service for publishing entity states to managed sessions
 */
var EntityServiceProvider = (function () {
    function EntityServiceProvider(sessionService, entityService, permissionServiceProvider) {
        var _this = this;
        this.sessionService = sessionService;
        this.entityService = entityService;
        this.permissionServiceProvider = permissionServiceProvider;
        this.subscriptionsBySubscriber = new WeakMap();
        this.subscribersByEntity = new Map();
        this.sessionSubscribedEvent = new Event();
        this.sessionUnsubscribedEvent = new Event();
        this._cacheTime = new JulianDate(0, 0);
        this._entityStateCache = {};
        this._getSerializedEntityState = getSerializedEntityState;
        this.sessionService.ensureIsRealityManager();
        this.sessionService.connectEvent.addEventListener(function (session) {
            var subscriptions = {};
            _this.subscriptionsBySubscriber.set(session, subscriptions);
            session.on['ar.entity.subscribe'] = session.on['ar.context.subscribe'] = function (_a) {
                var id = _a.id, options = _a.options;
                var currentOptions = subscriptions[id];
                if (currentOptions && jsonEquals(currentOptions, options))
                    return;
                options = options || {};
                var subscribers = _this.subscribersByEntity.get(id) || new Set();
                _this.subscribersByEntity.set(id, subscribers);
                subscribers.add(session);
                subscriptions[id] = options;
                _this.sessionSubscribedEvent.raiseEvent({ session: session, id: id, options: options });
                return _this.permissionServiceProvider.handlePermissionRequest(session, id, options).then(function () { });
            };
            session.on['ar.entity.unsubscribe'] = session.on['ar.context.unsubscribe'] = function (_a) {
                var id = _a.id;
                if (!subscriptions[id])
                    return;
                var subscribers = _this.subscribersByEntity.get(id);
                subscribers && subscribers.delete(session);
                delete subscriptions[id];
                _this.sessionUnsubscribedEvent.raiseEvent({ id: id, session: session });
            };
            session.closeEvent.addEventListener(function () {
                _this.subscriptionsBySubscriber.delete(session);
                for (var id in subscriptions) {
                    var subscribers = _this.subscribersByEntity.get(id);
                    subscribers && subscribers.delete(session);
                    _this.sessionUnsubscribedEvent.raiseEvent({ id: id, session: session });
                }
            });
        });
    }
    /**
     * Serialize into a serialization state mpat, the given entities using the given time.
     * Serialization includes the ancestor reference frames of included, excluding any entities in the excludedFrames list.
     */
    EntityServiceProvider.prototype.fillEntityStateMap = function (entities, time, includedMap, excludedMap) {
        for (var id in includedMap) {
            var entity = this.entityService.collection.getById(id);
            while (defined(entity) &&
                entities[id = entity.id] === undefined) {
                var referenceFrame = entity && entity.position && entity.position.referenceFrame;
                if (excludedMap[id]) {
                    entities[id] = null;
                    break;
                }
                else {
                    var pose = this._getCachedSerializedEntityState(entity, time, referenceFrame);
                    entities[id] = pose;
                    if (pose === null || typeof referenceFrame === 'number')
                        break;
                    entity = referenceFrame;
                }
            }
        }
    };
    EntityServiceProvider.prototype._getCachedSerializedEntityState = function (entity, time, referenceFrame) {
        if (!entity || !defined(referenceFrame))
            return null;
        var id = entity.id;
        if (!defined(this._entityStateCache[id]) || !this._cacheTime.equalsEpsilon(time, 0.000001)) {
            this._entityStateCache[id] = this._getSerializedEntityState(entity, time, referenceFrame);
        }
        return this._entityStateCache[id];
    };
    EntityServiceProvider = __decorate([
        autoinject,
        __metadata("design:paramtypes", [SessionService,
            EntityService,
            PermissionServiceProvider])
    ], EntityServiceProvider);
    return EntityServiceProvider;
}());
export { EntityServiceProvider };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZW50aXR5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsY0FBYyxFQUFlLE1BQU0sV0FBVyxDQUFDO0FBQ3hELE9BQU8sRUFDSCxLQUFLLEVBQ0wsaUNBQWlDLEVBQ2pDLG9DQUFvQyxFQUNwQyx3QkFBd0IsRUFDeEIsVUFBVSxFQUNWLGtDQUFrQyxFQUNyQyxNQUFNLFNBQVMsQ0FBQztBQUVqQixPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSxjQUFjLENBQUE7QUFDeEQsT0FBTyxFQUNILE9BQU8sRUFDUCxVQUFVLEVBQ1YsWUFBWSxFQUNaLE1BQU0sRUFDTixnQkFBZ0IsRUFDaEIsd0JBQXdCLEVBQ3hCLGdCQUFnQixFQUNoQixVQUFVLEVBQ1YsT0FBTyxFQUNQLE9BQU8sRUFDUCxjQUFjLEVBQ2QsZUFBZSxFQUVmLFVBQVUsRUFDYixNQUFNLHlCQUF5QixDQUFBO0FBSWhDOzs7O0dBSUc7QUFDSDtJQUVJLG9CQUNZLFdBQTRCLEVBQ3BDLFVBQXdCLEVBQ3hCLGdCQUE2QztRQUZyQyxnQkFBVyxHQUFYLFdBQVcsQ0FBaUI7UUFnQ3hDOzs7Ozs7Ozs7OztXQVdHO1FBQ0gsV0FBTSxHQUFjLENBQUMsQ0FBQztRQU90QixhQUFRLEdBQUcsSUFBSSxVQUFVLENBQUM7UUFDMUIsZ0JBQVcsR0FBRyxJQUFJLFVBQVUsQ0FBQztRQUM3QixTQUFJLEdBQUcsSUFBSSxVQUFVLENBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQyxDQUFBO1FBTW5CLG1CQUFjLEdBQWMsQ0FBQyxDQUFDO1FBRTdCLHVDQUFrQyxHQUFHLGlDQUFpQyxDQUFDO1FBQ3ZFLDBDQUFxQyxHQUFHLG9DQUFvQyxDQUFDO1FBMURqRixJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxHQUFHLElBQUksQ0FBQyxD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QUFHLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQzlGLENBQUM7UUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUExRlEscUJBQXFCO1FBRGpDLFVBQVU7eUNBU3FCLGNBQWM7WUFDZixhQUFhO1lBQ0QseUJBQXlCO09BVnZELHFCQUFxQixDQTJGakM7SUFBRCw0QkFBQztDQUFBLEFBM0ZELElBMkZDO1NBM0ZZLHFCQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGF1dG9pbmplY3QgfSBmcm9tICdhdXJlbGlhLWRlcGVuZGVuY3ktaW5qZWN0aW9uJztcbmltcG9ydCB7IFNlc3Npb25TZXJ2aWNlLCBTZXNzaW9uUG9ydCB9IGZyb20gJy4vc2Vzc2lvbic7XG5pbXBvcnQge1xuICAgIEV2ZW50LCBcbiAgICBnZXRFbnRpdHlQb3NpdGlvbkluUmVmZXJlbmNlRnJhbWUsIFxuICAgIGdldEVudGl0eU9yaWVudGF0aW9uSW5SZWZlcmVuY2VGcmFtZSwgXG4gICAgZ2V0U2VyaWFsaXplZEVudGl0eVN0YXRlLCBcbiAgICBqc29uRXF1YWxzLCBcbiAgICBzdHJpbmdJZGVudGlmaWVyRnJvbVJlZmVyZW5jZUZyYW1lIFxufSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IFNlcmlhbGl6ZWRFbnRpdHlTdGF0ZSwgU2VyaWFsaXplZEVudGl0eVN0YXRlTWFwIH0gZnJvbSAnLi9jb21tb24nO1xuaW1wb3J0IHsgUGVybWlzc2lvblNlcnZpY2VQcm92aWRlciB9IGZyb20gJy4vcGVybWlzc2lvbidcbmltcG9ydCB7XG4gICAgZGVmaW5lZCxcbiAgICBDYXJ0ZXNpYW4zLFxuICAgIENhcnRvZ3JhcGhpYyxcbiAgICBFbnRpdHksXG4gICAgRW50aXR5Q29sbGVjdGlvbixcbiAgICBDb25zdGFudFBvc2l0aW9uUHJvcGVydHksXG4gICAgQ29uc3RhbnRQcm9wZXJ0eSxcbiAgICBKdWxpYW5EYXRlLFxuICAgIE1hdHJpeDMsXG4gICAgTWF0cml4NCxcbiAgICBSZWZlcmVuY2VGcmFtZSxcbiAgICBSZWZlcmVuY2VFbnRpdHksXG4gICAgVHJhbnNmb3JtcyxcbiAgICBRdWF0ZXJuaW9uXG59IGZyb20gJy4vY2VzaXVtL2Nlc2l1bS1pbXBvcnRzJ1xuXG5cblxuLyoqXG4gKiBSZXByZXNlbnRzIHRoZSBwb3NlIG9mIGFuIGVudGl0eSByZWxhdGl2ZSB0byBhIHBhcnRpY3VsYXIgcmVmZXJlbmNlIGZyYW1lLiBcbiAqIFxuICogVGhlIGB1cGRhdGVgIG1ldGhvZCBtdXN0IGJlIGNhbGxlZCBpbiBvcmRlciB0byB1cGRhdGUgdGhlIHBvc2l0aW9uIC8gb3JpZW50YXRpb24gLyBwb3NlU3RhdHVzLiBcbiAqL1xuZXhwb3J0IGNsYXNzIEVudGl0eVBvc2Uge1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgX2NvbGxlY3Rpb246RW50aXR5Q29sbGVjdGlvbiwgXG4gICAgICAgIGVudGl0eU9ySWQ6RW50aXR5fHN0cmluZywgXG4gICAgICAgIHJlZmVyZW5jZUZyYW1lSWQ6RW50aXR5fFJlZmVyZW5jZUZyYW1lfHN0cmluZ1xuICAgICl7XG4gICAgICAgIHRoaXMuX2NvbGxlY3Rpb25bJ19maXJpbmcnXSA9IHRydWU7IC8vIGhhY2s6IGRpc2FibGUgY29sbGVjdGlvbkNoYW5nZWQgZXZlbnRcblxuICAgICAgICBpZiAodHlwZW9mIGVudGl0eU9ySWQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBsZXQgZW50aXR5OkVudGl0eXxSZWZlcmVuY2VFbnRpdHl8dW5kZWZpbmVkID0gdGhpcy5fY29sbGVjdGlvbi5nZXRCeUlkKGVudGl0eU9ySWQpO1xuICAgICAgICAgICAgaWYgKCFlbnRpdHkpIGVudGl0eSA9IDxFbnRpdHk+PGFueT4gbmV3IFJlZmVyZW5jZUVudGl0eSh0aGlzLl9jb2xsZWN0aW9uLCBlbnRpdHlPcklkKTtcbiAgICAgICAgICAgIHRoaXMuX2VudGl0eSA9IGVudGl0eTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX2VudGl0eSA9IGVudGl0eU9ySWQ7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmICh0eXBlb2YgcmVmZXJlbmNlRnJhbWVJZCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIGxldCByZWZlcmVuY2VGcmFtZTpFbnRpdHl8UmVmZXJlbmNlRW50aXR5fFJlZmVyZW5jZUZyYW1lfHVuZGVmaW5lZCA9IHRoaXMuX2NvbGxlY3Rpb24uZ2V0QnlJZChyZWZlcmVuY2VGcmFtZUlkKTtcbiAgICAgICAgICAgIGlmICghZGVmaW5lZChyZWZlcmVuY2VGcmFtZSkpIHJlZmVyZW5jZUZyYW1lID0gPEVudGl0eT48YW55PiBuZXcgUmVmZXJlbmNlRW50aXR5KHRoaXMuX2NvbGxlY3Rpb24sIHJlZmVyZW5jZUZyYW1lSWQpO1xuICAgICAgICAgICAgdGhpcy5fcmVmZXJlbmNlRnJhbWUgPSByZWZlcmVuY2VGcmFtZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3JlZmVyZW5jZUZyYW1lID0gcmVmZXJlbmNlRnJhbWVJZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2VudGl0eTpFbnRpdHk7XG4gICAgcHJpdmF0ZSBfcmVmZXJlbmNlRnJhbWU6RW50aXR5fFJlZmVyZW5jZUZyYW1lO1xuXG4gICAgZ2V0IGVudGl0eSgpIHsgcmV0dXJuIHRoaXMuX2VudGl0eSB9XG5cbiAgICBnZXQgcmVmZXJlbmNlRnJhbWUoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9yZWZlcmVuY2VGcmFtZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGUgc3RhdHVzIG9mIHRoaXMgcG9zZSwgYXMgYSBiaXRtYXNrLlxuICAgICAqIFxuICAgICAqIElmIHRoZSBjdXJyZW50IHBvc2UgaXMga25vd24sIHRoZW4gdGhlIEtOT1dOIGJpdCBpcyAxLlxuICAgICAqIElmIHRoZSBjdXJyZW50IHBvc2UgaXMgbm90IGtub3duLCB0aGVuIHRoZSBLTk9XTiBiaXQgaXMgMC4gXG4gICAgICogXG4gICAgICogSWYgdGhlIHByZXZpb3VzIHBvc2Ugd2FzIGtub3duIGFuZCB0aGUgY3VycmVudCBwb3NlIGlzIHVua25vd24sIFxuICAgICAqIHRoZW4gdGhlIExPU1QgYml0IGlzIDEuIFxuICAgICAqIElmIHRoZSBwcmV2aW91cyBwb3NlIHdhcyB1bmtub3duIGFuZCB0aGUgY3VycmVudCBwb3NlIHN0YXR1cyBpcyBrbm93biwgXG4gICAgICogdGhlbiB0aGUgRk9VTkQgYml0IGlzIDEuXG4gICAgICogSW4gYWxsIG90aGVyIGNhc2VzLCBib3RoIHRoZSBMT1NUIGJpdCBhbmQgdGhlIEZPVU5EIGJpdCBhcmUgMC4gXG4gICAgICovXG4gICAgc3RhdHVzOlBvc2VTdGF0dXMgPSAwO1xuXG4gICAgLyoqXG4gICAgICogYWxpYXMgZm9yIHN0YXR1c1xuICAgICAqL1xuICAgIGdldCBwb3NlU3RhdHVzKCkgeyByZXR1cm4gdGhpcy5zdGF0dXMgfTtcblxuICAgIHBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjM7XG4gICAgb3JpZW50YXRpb24gPSBuZXcgUXVhdGVybmlvbjtcbiAgICB0aW1lID0gbmV3IEp1bGlhbkRhdGUoMCwwKVxuXG4gICAgXG4gICAgcHVibGljIHByZXZpb3VzVGltZTpKdWxpYW5EYXRlO1xuICAgIHB1YmxpYyBwcmV2aW91c1Bvc2l0aW9uOkNhcnRlc2lhbjM7XG4gICAgcHVibGljIHByZXZpb3VzT3JpZW50YXRpb246UXVhdGVybmlvbjtcbiAgICBwdWJsaWMgcHJldmlvdXNTdGF0dXM6UG9zZVN0YXR1cyA9IDA7XG5cbiAgICBwcml2YXRlIF9nZXRFbnRpdHlQb3NpdGlvbkluUmVmZXJlbmNlRnJhbWUgPSBnZXRFbnRpdHlQb3NpdGlvbkluUmVmZXJlbmNlRnJhbWU7XG4gICAgcHJpdmF0ZSBfZ2V0RW50aXR5T3JpZW50YXRpb25JblJlZmVyZW5jZUZyYW1lID0gZ2V0RW50aXR5T3JpZW50YXRpb25JblJlZmVyZW5jZUZyYW1lO1xuXG4gICAgdXBkYXRlKHRpbWU6SnVsaWFuRGF0ZSkge1xuICAgICAgICBjb25zdCBfSnVsaWFuRGF0ZSA9IEp1bGlhbkRhdGU7XG4gICAgICAgIGNvbnN0IF9Qb3NlU3RhdHVzID0gUG9zZVN0YXR1cztcblxuICAgICAgICBfSnVsaWFuRGF0ZS5jbG9uZSh0aW1lLCB0aGlzLnRpbWUpO1xuXG4gICAgICAgIGlmICghX0p1bGlhbkRhdGUuZXF1YWxzKHRoaXMucHJldmlvdXNUaW1lLCB0aW1lKSkge1xuICAgICAgICAgICAgdGhpcy5wcmV2aW91c1N0YXR1cyA9IHRoaXMuc3RhdHVzO1xuICAgICAgICAgICAgdGhpcy5wcmV2aW91c1RpbWUgPSBfSnVsaWFuRGF0ZS5jbG9uZSh0aW1lLCB0aGlzLnByZXZpb3VzVGltZSk7XG4gICAgICAgICAgICB0aGlzLnByZXZpb3VzUG9zaXRpb24gPSBDYXJ0ZXNpYW4zLmNsb25lKHRoaXMucG9zaXRpb24sIHRoaXMucHJldmlvdXNQb3NpdGlvbik7XG4gICAgICAgICAgICB0aGlzLnByZXZpb3VzT3JpZW50YXRpb24gPSBRdWF0ZXJuaW9uLmNsb25lKHRoaXMub3JpZW50YXRpb24sIHRoaXMucHJldmlvdXNPcmllbnRhdGlvbik7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBlbnRpdHkgPSB0aGlzLmVudGl0eTtcbiAgICAgICAgY29uc3QgcmVmZXJlbmNlRnJhbWUgPSB0aGlzLnJlZmVyZW5jZUZyYW1lO1xuICAgICAgICBcbiAgICAgICAgbGV0IHBvc2l0aW9uID0gdGhpcy5fZ2V0RW50aXR5UG9zaXRpb25JblJlZmVyZW5jZUZyYW1lKFxuICAgICAgICAgICAgZW50aXR5LFxuICAgICAgICAgICAgdGltZSxcbiAgICAgICAgICAgIHJlZmVyZW5jZUZyYW1lLFxuICAgICAgICAgICAgdGhpcy5wb3NpdGlvblxuICAgICAgICApO1xuXG4gICAgICAgIGxldCBvcmllbnRhdGlvbiA9IHRoaXMuX2dldEVudGl0eU9yaWVudGF0aW9uSW5SZWZlcmVuY2VGcmFtZShcbiAgICAgICAgICAgIGVudGl0eSxcbiAgICAgICAgICAgIHRpbWUsXG4gICAgICAgICAgICByZWZlcmVuY2VGcmFtZSxcbiAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb25cbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBoYXNQb3NlID0gcG9zaXRpb24gJiYgb3JpZW50YXRpb247XG5cbiAgICAgICAgbGV0IGN1cnJlbnRTdGF0dXM6IFBvc2VTdGF0dXMgPSAwO1xuICAgICAgICBjb25zdCBwcmV2aW91c1N0YXR1cyA9IHRoaXMucHJldmlvdXNTdGF0dXM7XG5cbiAgICAgICAgaWYgKGhhc1Bvc2UpIHtcbiAgICAgICAgICAgIGN1cnJlbnRTdGF0dXMgfD0gX1Bvc2VTdGF0dXMuS05PV047XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzUG9zZSAmJiAhKHByZXZpb3VzU3RhdHVzICYgX1Bvc2VTdGF0dXMuS05PV04pKSB7XG4gICAgICAgICAgICBjdXJyZW50U3RhdHVzIHw9IF9Qb3NlU3RhdHVzLkZPVU5EO1xuICAgICAgICB9IGVsc2UgaWYgKCFoYXNQb3NlICYmIHByZXZpb3VzU3RhdHVzICYgX1Bvc2VTdGF0dXMuS05PV04pIHtcbiAgICAgICAgICAgIGN1cnJlbnRTdGF0dXMgfD0gX1Bvc2VTdGF0dXMuTE9TVDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghQ2FydGVzaWFuMy5lcXVhbHModGhpcy5wcmV2aW91c1Bvc2l0aW9uLCBwb3NpdGlvbikgfHwgXG4gICAgICAgICAgICAhUXVhdGVybmlvbi5lcXVhbHModGhpcy5wcmV2aW91c09yaWVudGF0aW9uLCBvcmllbnRhdGlvbikpIHtcbiAgICAgICAgICAgIGN1cnJlbnRTdGF0dXMgfD0gX1Bvc2VTdGF0dXMuQ0hBTkdFRDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc3RhdHVzID0gY3VycmVudFN0YXR1cztcbiAgICB9XG59XG5cbi8qKlxuKiBBIGJpdG1hc2sgdGhhdCBwcm92aWRlcyBtZXRhZGF0YSBhYm91dCBhbiBFbnRpdHlQb3NlLlxuKiAgIEtOT1dOIC0gdGhlIHBvc2Ugb2YgdGhlIGVudGl0eSBpcyBkZWZpbmVkIGZvciB0aGUgY3VycmVudCBmcmFtZSB0aW1lXG4qICAgRk9VTkQgLSB0aGUgcG9zZSB3YXMgdW5kZWZpbmVkIGF0IHRoZSBwcmV2aW91cyBmcmFtZSB0aW1lLCBhbmQgaXMgbm93IGRlZmluZWRcbiogICBMT1NUIC0gdGhlIHBvc2Ugd2FzIGRlZmluZWQgYXQgdGhlIHByZXZpb3VzIGZyYW1lIHRpbWUsIGFuZCBpcyBub3cgdW5kZWZpbmVkXG4qICAgQ0hBTkdFRCAtIHRoZSBwb3NlIGhhcyBjaGFuZ2VkIHNpbmNlIHRoZSBwcmV2aW91cyBmcmFtZSB0aW1lXG4qL1xuZXhwb3J0IGVudW0gUG9zZVN0YXR1cyB7XG4gICAgS05PV04gPSAxLFxuICAgIEZPVU5EID0gMixcbiAgICBMT1NUID0gNCxcbiAgICBDSEFOR0VEID0gOFxufVxuXG4vKipcbiAqIEEgc2VydmljZSBmb3Igc3Vic2NyaWJpbmcvdW5zdWJzY3JpYmluZyB0byBlbnRpdGllc1xuICovXG5AYXV0b2luamVjdCgpXG5leHBvcnQgY2xhc3MgRW50aXR5U2VydmljZSB7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgc2Vzc2lvblNlcnZpY2U6IFNlc3Npb25TZXJ2aWNlKSB7fVxuXG4gICAgcHVibGljIGNvbGxlY3Rpb24gPSBuZXcgRW50aXR5Q29sbGVjdGlvbjtcblxuICAgIHB1YmxpYyBzdWJzY3JpYmVkRXZlbnQgPSBuZXcgRXZlbnQ8e2lkOnN0cmluZywgb3B0aW9ucz86e319PigpO1xuICAgIHB1YmxpYyB1bnN1YnNjcmliZWRFdmVudCA9IG5ldyBFdmVudDx7aWQ6c3RyaW5nfT4oKTtcblxuICAgIHB1YmxpYyBzdWJzY3JpcHRpb25zID0gbmV3IE1hcDxzdHJpbmcsIHt9PigpO1xuXG4gICAgcHJpdmF0ZSBfaGFuZGxlU3Vic2NyaWJlZChldnQ6e2lkOnN0cmluZywgb3B0aW9ucz86e319KSB7XG4gICAgICAgIGNvbnN0IHMgPSB0aGlzLnN1YnNjcmlwdGlvbnMuZ2V0KGV2dC5pZCk7XG4gICAgICAgIGNvbnN0IHN0cmluZ2lmaWVkT3B0aW9ucyA9IGV2dC5vcHRpb25zICYmIEpTT04uc3RyaW5naWZ5KGV2dC5vcHRpb25zKTtcbiAgICAgICAgaWYgKCFzIHx8IEpTT04uc3RyaW5naWZ5KHMpID09PSBzdHJpbmdpZmllZE9wdGlvbnMpIHtcbiAgICAgICAgICAgIGlmIChzKSB0aGlzLl9oYW5kbGVVbnN1YnNjcmliZWQoZXZ0LmlkKTtcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5zZXQoZXZ0LmlkLCBzdHJpbmdpZmllZE9wdGlvbnMgJiYgSlNPTi5wYXJzZShzdHJpbmdpZmllZE9wdGlvbnMpKTtcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaWJlZEV2ZW50LnJhaXNlRXZlbnQoZXZ0KTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9oYW5kbGVVbnN1YnNjcmliZWQoaWQ6c3RyaW5nKSB7XG4gICAgICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbnMuaGFzKGlkKSkge1xuICAgICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLmRlbGV0ZShpZCk7XG4gICAgICAgICAgICB0aGlzLnVuc3Vic2NyaWJlZEV2ZW50LnJhaXNlRXZlbnQoe2lkfSk7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc2NyYXRjaENhcnRlc2lhbiA9IG5ldyBDYXJ0ZXNpYW4zO1xuICAgIHByaXZhdGUgX3NjcmF0Y2hRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb247XG4gICAgcHJpdmF0ZSBfc2NyYXRjaE1hdHJpeDMgPSBuZXcgTWF0cml4MztcbiAgICBwcml2YXRlIF9zY3JhdGNoTWF0cml4NCA9IG5ldyBNYXRyaXg0O1xuICAgIHByaXZhdGUgX2dldEVudGl0eVBvc2l0aW9uSW5SZWZlcmVuY2VGcmFtZSA9IGdldEVudGl0eVBvc2l0aW9uSW5SZWZlcmVuY2VGcmFtZTtcbiAgICBcbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIGNhcnRvZ3JhcGhpYyBwb3NpdGlvbiBvZiBhbiBFbnRpdHkgYXQgdGhlIGdpdmVuIHRpbWVcbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0Q2FydG9ncmFwaGljKGVudGl0eTpFbnRpdHksIHRpbWU6SnVsaWFuRGF0ZSwgcmVzdWx0PzpDYXJ0b2dyYXBoaWMpIDogQ2FydG9ncmFwaGljfHVuZGVmaW5lZCB7XG4gICAgICAgIGNvbnN0IGZpeGVkUG9zaXRpb24gPSBcbiAgICAgICAgICAgIHRoaXMuX2dldEVudGl0eVBvc2l0aW9uSW5SZWZlcmVuY2VGcmFtZShlbnRpdHksIHRpbWUsIFJlZmVyZW5jZUZyYW1lLkZJWEVELCB0aGlzLl9zY3JhdGNoQ2FydGVzaWFuKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChmaXhlZFBvc2l0aW9uKSB7XG4gICAgICAgICAgICByZXN1bHQgPSByZXN1bHQgfHwgbmV3IENhcnRvZ3JhcGhpYygpO1xuICAgICAgICAgICAgcmV0dXJuIENhcnRvZ3JhcGhpYy5mcm9tQ2FydGVzaWFuKGZpeGVkUG9zaXRpb24sIHVuZGVmaW5lZCwgcmVzdWx0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgIC8qKlxuICAgICAqIENyZWF0ZSBhbiBlbnRpdHkgdGhhdCBpcyBwb3NpdGlvbmVkIGF0IHRoZSBnaXZlbiBjYXJ0b2dyYXBoaWMgbG9jYXRpb24sXG4gICAgICogd2l0aCBhbiBvcmllbnRhdGlvbiBjb21wdXRlZCBhY2NvcmRpbmcgdG8gdGhlIHByb3ZpZGVkIGBsb2NhbFRvRml4ZWRgIHRyYW5zZm9ybSBmdW5jdGlvbi5cbiAgICAgKiBcbiAgICAgKiBGb3IgdGhlIGBsb2NhbFRvRml4ZWRgIHBhcmFtZXRlciwgeW91IGNhbiBwYXNzIGFueSBvZiB0aGUgZm9sbG93aW5nOlxuICAgICAqIFxuICAgICAqIGBgYFxuICAgICAqIEFyZ29uLkNlc2l1bS5UcmFuc2Zvcm1zLmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lXG4gICAgICogQXJnb24uQ2VzaXVtLlRyYW5zZm9ybXMubm9ydGhFYXN0RG93blRvRml4ZWRGcmFtZVxuICAgICAqIEFyZ29uLkNlc2l1bS5UcmFuc2Zvcm1zLm5vcnRoVXBFYXN0VG9GaXhlZEZyYW1lXG4gICAgICogQXJnb24uQ2VzaXVtLlRyYW5zZm9ybXMubm9ydGhXZXN0VXBUb0ZpeGVkRnJhbWVcbiAgICAgKiBgYGBcbiAgICAgKiAgXG4gICAgICogQWRkaXRpb25hbGx5LCBhcmdvbi5qcyBwcm92aWRlczpcbiAgICAgKiBcbiAgICAgKiBgYGBcbiAgICAgKiBBcmdvbi5lYXN0VXBTb3V0aFRvRml4ZWRGcmFtZVxuICAgICAqIGBgYFxuICAgICAqIFxuICAgICAqIEFsdGVybmF0aXZlIHRyYW5zZm9ybSBmdW5jdGlvbnMgY2FuIGJlIGNyZWF0ZWQgd2l0aDpcbiAgICAgKiBcbiAgICAgKiBgYGBcbiAgICAgKiBBcmdvbi5DZXNpdW0uVHJhbnNmb3Jtcy5sb2NhbEZyYW1lVG9GaXhlZEZyYW1lR2VuZXJhdG9yXG4gICAgICogYGBgXG4gICAgICovXG4gICAgcHVibGljIGNyZWF0ZUZpeGVkKGNhcnRvZ3JhcGhpYzogQ2FydG9ncmFwaGljLCBsb2NhbFRvRml4ZWQ6IHR5cGVvZiBUcmFuc2Zvcm1zLm5vcnRoVXBFYXN0VG9GaXhlZEZyYW1lKSA6IEVudGl0eSB7XG4gICAgICAgIC8vIENvbnZlcnQgdGhlIGNhcnRvZ3JhcGhpYyBsb2NhdGlvbiB0byBhbiBFQ0VGIHBvc2l0aW9uXG4gICAgICAgIHZhciBwb3NpdGlvbiA9IENhcnRlc2lhbjMuZnJvbVJhZGlhbnMoY2FydG9ncmFwaGljLmxvbmdpdHVkZSwgY2FydG9ncmFwaGljLmxhdGl0dWRlLCBjYXJ0b2dyYXBoaWMuaGVpZ2h0LCB1bmRlZmluZWQsIHRoaXMuX3NjcmF0Y2hDYXJ0ZXNpYW4pO1xuXG4gICAgICAgIC8vIGNvbXB1dGUgYW4gYXBwcm9wcmlhdGUgb3JpZW50YXRpb24gb24gdGhlIHN1cmZhY2Ugb2YgdGhlIGVhcnRoXG4gICAgICAgIHZhciB0cmFuc2Zvcm1NYXRyaXggPSBsb2NhbFRvRml4ZWQocG9zaXRpb24sIHVuZGVmaW5lZCwgdGhpcy5fc2NyYXRjaE1hdHJpeDQpO1xuICAgICAgICB2YXIgcm90YXRpb25NYXRyaXggPSBNYXRyaXg0LmdldFJvdGF0aW9uKHRyYW5zZm9ybU1hdHJpeCx0aGlzLl9zY3JhdGNoTWF0cml4MylcbiAgICAgICAgdmFyIG9yaWVudGF0aW9uID0gUXVhdGVybmlvbi5mcm9tUm90YXRpb25NYXRyaXgocm90YXRpb25NYXRyaXgsIHRoaXMuX3NjcmF0Y2hRdWF0ZXJuaW9uKTtcblxuICAgICAgICAvLyBjcmVhdGUgdGhlIGVudGl0eVxuICAgICAgICB2YXIgZW50aXR5ID0gbmV3IEVudGl0eSh7XG4gICAgICAgICAgICBwb3NpdGlvbixcbiAgICAgICAgICAgIG9yaWVudGF0aW9uXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZW50aXR5O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN1YnNjcmliZSB0byBwb3NlIHVwZGF0ZXMgZm9yIHRoZSBnaXZlbiBlbnRpdHkgaWRcbiAgICAgKiBAcmV0dXJucyBBIFByb21pc2UgdGhhdCByZXNvbHZlcyB0byBhIG5ldyBvciBleGlzdGluZyBlbnRpdHlcbiAgICAgKi9cbiAgICBwdWJsaWMgc3Vic2NyaWJlKGlkT3JFbnRpdHk6IHN0cmluZ3xFbnRpdHkpIDogUHJvbWlzZTxFbnRpdHk+O1xuICAgIHB1YmxpYyBzdWJzY3JpYmUoaWRPckVudGl0eTogc3RyaW5nfEVudGl0eSwgb3B0aW9ucz86e30sIHNlc3Npb24/OlNlc3Npb25Qb3J0KSA6IFByb21pc2U8RW50aXR5PjtcbiAgICBwdWJsaWMgc3Vic2NyaWJlKGlkT3JFbnRpdHk6IHN0cmluZ3xFbnRpdHksIG9wdGlvbnM/Ont9LCBzZXNzaW9uPXRoaXMuc2Vzc2lvblNlcnZpY2UubWFuYWdlcikgOiBQcm9taXNlPEVudGl0eT4ge1xuICAgICAgICBjb25zdCBpZCA9ICg8RW50aXR5PmlkT3JFbnRpdHkpLmlkIHx8IDxzdHJpbmc+aWRPckVudGl0eTtcbiAgICAgICAgY29uc3QgZXZ0ID0ge2lkLCBvcHRpb25zfTtcbiAgICAgICAgcmV0dXJuIHNlc3Npb24ud2hlbkNvbm5lY3RlZCgpLnRoZW4oKCk9PntcbiAgICAgICAgICAgIGlmIChzZXNzaW9uLnZlcnNpb25bMF0gPT09IDAgJiYgc2Vzc2lvbi52ZXJzaW9uWzFdIDwgMikgcmV0dXJuIHNlc3Npb24ucmVxdWVzdCgnYXIuY29udGV4dC5zdWJzY3JpYmUnLCBldnQpXG4gICAgICAgICAgICBlbHNlIHJldHVybiBzZXNzaW9uLnJlcXVlc3QoJ2FyLmVudGl0eS5zdWJzY3JpYmUnLCBldnQpXG4gICAgICAgIH0pLnRoZW4oKCk9PntcbiAgICAgICAgICAgIGNvbnN0IGVudGl0eSA9IHRoaXMuY29sbGVjdGlvbi5nZXRPckNyZWF0ZUVudGl0eShpZCk7XG4gICAgICAgICAgICB0aGlzLl9oYW5kbGVTdWJzY3JpYmVkKGV2dCk7XG4gICAgICAgICAgICByZXR1cm4gZW50aXR5O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVbnN1YnNjcmliZSBmcm9tIHBvc2UgdXBkYXRlcyBmb3IgdGhlIGdpdmVuIGVudGl0eSBpZFxuICAgICAqL1xuICAgIHB1YmxpYyB1bnN1YnNjcmliZShpZE9yRW50aXR5KSA6IHZvaWQ7XG4gICAgcHVibGljIHVuc3Vic2NyaWJlKGlkT3JFbnRpdHk6IHN0cmluZ3xFbnRpdHksIHNlc3Npb24/OlNlc3Npb25Qb3J0KSA6IHZvaWQ7XG4gICAgcHVibGljIHVuc3Vic2NyaWJlKGlkT3JFbnRpdHk6IHN0cmluZ3xFbnRpdHksIHNlc3Npb249dGhpcy5zZXNzaW9uU2VydmljZS5tYW5hZ2VyKSA6IHZvaWQge1xuICAgICAgICBjb25zdCBpZCA9ICg8RW50aXR5PmlkT3JFbnRpdHkpLmlkIHx8IDxzdHJpbmc+aWRPckVudGl0eTtcbiAgICAgICAgc2Vzc2lvbi53aGVuQ29ubmVjdGVkKCkudGhlbigoKT0+e1xuICAgICAgICAgICAgaWYgKHNlc3Npb24udmVyc2lvblswXSA9PT0gMCAmJiBzZXNzaW9uLnZlcnNpb25bMV0gPCAyKSBzZXNzaW9uLnNlbmQoJ2FyLmNvbnRleHQudW5zdWJzY3JpYmUnLCB7aWR9KTtcbiAgICAgICAgICAgIGVsc2Ugc2Vzc2lvbi5zZW5kKCdhci5lbnRpdHkudW5zdWJzY3JpYmUnLCB7aWR9KTtcbiAgICAgICAgfSkudGhlbigoKT0+e1xuICAgICAgICAgICAgdGhpcy5faGFuZGxlVW5zdWJzY3JpYmVkKGlkKTtcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgRW50aXR5UG9zZSBpbnN0YW5jZSB0byByZXByZXNlbnQgdGhlIHBvc2Ugb2YgYW4gZW50aXR5XG4gICAgICogcmVsYXRpdmUgdG8gYSBnaXZlbiByZWZlcmVuY2UgZnJhbWUuXG4gICAgICogXG4gICAgICogQHBhcmFtIGVudGl0eSAtIHRoZSBlbnRpdHkgdG8gdHJhY2tcbiAgICAgKiBAcGFyYW0gcmVmZXJlbmNlRnJhbWVPcklkIC0gdGhlIHJlZmVyZW5jZSBmcmFtZSB0byB1c2VcbiAgICAgKi9cbiAgICBwdWJsaWMgY3JlYXRlRW50aXR5UG9zZShlbnRpdHlPcklkOiBFbnRpdHl8c3RyaW5nLCByZWZlcmVuY2VGcmFtZU9ySWQ6IHN0cmluZyB8IFJlZmVyZW5jZUZyYW1lIHwgRW50aXR5KSB7ICAgICAgICAgICAgXG4gICAgICAgIHJldHVybiBuZXcgRW50aXR5UG9zZSh0aGlzLmNvbGxlY3Rpb24sIGVudGl0eU9ySWQsIHJlZmVyZW5jZUZyYW1lT3JJZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZW50aXR5UG9zZU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBFbnRpdHlQb3NlIHwgdW5kZWZpbmVkPigpO1xuICAgIHByaXZhdGUgX3N0cmluZ0lkZW50aWZpZXJGcm9tUmVmZXJlbmNlRnJhbWUgPSBzdHJpbmdJZGVudGlmaWVyRnJvbVJlZmVyZW5jZUZyYW1lO1xuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgcG9zZSBvZiBhbiBlbnRpdHksIHJlbGF0aXZlIHRvIGEgZ2l2ZW4gcmVmZXJlbmNlIGZyYW1lIGF0IGEgZ2l2ZW4gdGltZS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBlbnRpdHlPcklkIC0gVGhlIGVudGl0eSB3aG9zZSBzdGF0ZSBpcyB0byBiZSBxdWVyaWVkLlxuICAgICAqIEBwYXJhbSByZWZlcmVuY2VGcmFtZU9ySWQgLSBUaGUgaW50ZW5kZWQgcmVmZXJlbmNlIGZyYW1lLiBEZWZhdWx0cyB0byBgdGhpcy5kZWZhdWx0UmVmZXJlbmNlRnJhbWVgLlxuICAgICAqL1xuICAgIHB1YmxpYyBnZXRFbnRpdHlQb3NlKGVudGl0eU9ySWQ6IEVudGl0eXxzdHJpbmcsIHJlZmVyZW5jZUZyYW1lT3JJZDogc3RyaW5nIHwgUmVmZXJlbmNlRnJhbWUgfCBFbnRpdHksIHRpbWU6IEp1bGlhbkRhdGUpOiBFbnRpdHlQb3NlIHtcbiAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5fc3RyaW5nSWRlbnRpZmllckZyb21SZWZlcmVuY2VGcmFtZShlbnRpdHlPcklkKSArICdAJyArIHRoaXMuX3N0cmluZ0lkZW50aWZpZXJGcm9tUmVmZXJlbmNlRnJhbWUocmVmZXJlbmNlRnJhbWVPcklkKTtcbiAgICAgICAgXG4gICAgICAgIGxldCBlbnRpdHlQb3NlID0gdGhpcy5fZW50aXR5UG9zZU1hcC5nZXQoa2V5KTtcbiAgICAgICAgaWYgKCFlbnRpdHlQb3NlKSB7XG4gICAgICAgICAgICBlbnRpdHlQb3NlID0gdGhpcy5jcmVhdGVFbnRpdHlQb3NlKGVudGl0eU9ySWQsIHJlZmVyZW5jZUZyYW1lT3JJZCk7XG4gICAgICAgICAgICB0aGlzLl9lbnRpdHlQb3NlTWFwLnNldChrZXksIGVudGl0eVBvc2UpO1xuICAgICAgICB9XG4gICAgICAgIGVudGl0eVBvc2UudXBkYXRlKHRpbWUpO1xuXG4gICAgICAgIHJldHVybiBlbnRpdHlQb3NlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFxuICAgICAqIEBwYXJhbSBpZCBcbiAgICAgKiBAcGFyYW0gZW50aXR5U3RhdGUgXG4gICAgICovXG4gICAgcHVibGljIHVwZGF0ZUVudGl0eUZyb21TZXJpYWxpemVkU3RhdGUoaWQ6c3RyaW5nLCBlbnRpdHlTdGF0ZTpTZXJpYWxpemVkRW50aXR5U3RhdGV8bnVsbCkge1xuICAgICAgICBjb25zdCBlbnRpdHkgPSB0aGlzLmNvbGxlY3Rpb24uZ2V0T3JDcmVhdGVFbnRpdHkoaWQpO1xuICAgICAgICBcbiAgICAgICAgaWYgKCFlbnRpdHlTdGF0ZSkge1xuICAgICAgICAgICAgaWYgKGVudGl0eS5wb3NpdGlvbikge1xuICAgICAgICAgICAgICAgIChlbnRpdHkucG9zaXRpb24gYXMgQ29uc3RhbnRQb3NpdGlvblByb3BlcnR5KS5zZXRWYWx1ZSh1bmRlZmluZWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGVudGl0eS5vcmllbnRhdGlvbikge1xuICAgICAgICAgICAgICAgIChlbnRpdHkub3JpZW50YXRpb24gYXMgQ29uc3RhbnRQcm9wZXJ0eSkuc2V0VmFsdWUodW5kZWZpbmVkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVudGl0eVsnbWV0YSddID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgY29uc3QgcG9zaXRpb25WYWx1ZSA9IGVudGl0eVN0YXRlLnA7XG4gICAgICAgIGNvbnN0IG9yaWVudGF0aW9uVmFsdWUgPSBRdWF0ZXJuaW9uLmNsb25lKGVudGl0eVN0YXRlLm8sIHRoaXMuX3NjcmF0Y2hRdWF0ZXJuaW9uKTsgLy8gd29ya2Fyb3VuZCBmb3IgaHR0cHM6Ly9naXRodWIuY29tL0FuYWx5dGljYWxHcmFwaGljc0luYy9jZXNpdW0vaXNzdWVzLzUwMzFcbiAgICAgICAgY29uc3QgcmVmZXJlbmNlRnJhbWU6RW50aXR5fFJlZmVyZW5jZUZyYW1lID0gXG4gICAgICAgICAgICB0eXBlb2YgZW50aXR5U3RhdGUuciA9PT0gJ251bWJlcicgP1xuICAgICAgICAgICAgZW50aXR5U3RhdGUuciA6IHRoaXMuY29sbGVjdGlvbi5nZXRPckNyZWF0ZUVudGl0eShlbnRpdHlTdGF0ZS5yKTtcblxuICAgICAgICBsZXQgZW50aXR5UG9zaXRpb24gPSBlbnRpdHkucG9zaXRpb247XG4gICAgICAgIGxldCBlbnRpdHlPcmllbnRhdGlvbiA9IGVudGl0eS5vcmllbnRhdGlvbjtcblxuICAgICAgICBpZiAoZW50aXR5UG9zaXRpb24gaW5zdGFuY2VvZiBDb25zdGFudFBvc2l0aW9uUHJvcGVydHkpIHtcbiAgICAgICAgICAgIGVudGl0eVBvc2l0aW9uLnNldFZhbHVlKHBvc2l0aW9uVmFsdWUsIHJlZmVyZW5jZUZyYW1lKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGVudGl0eS5wb3NpdGlvbiA9IG5ldyBDb25zdGFudFBvc2l0aW9uUHJvcGVydHkocG9zaXRpb25WYWx1ZSwgcmVmZXJlbmNlRnJhbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGVudGl0eU9yaWVudGF0aW9uIGluc3RhbmNlb2YgQ29uc3RhbnRQcm9wZXJ0eSkge1xuICAgICAgICAgICAgZW50aXR5T3JpZW50YXRpb24uc2V0VmFsdWUob3JpZW50YXRpb25WYWx1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBlbnRpdHkub3JpZW50YXRpb24gPSBuZXcgQ29uc3RhbnRQcm9wZXJ0eShvcmllbnRhdGlvblZhbHVlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGVudGl0eVsnbWV0YSddID0gZW50aXR5U3RhdGUubWV0YTtcblxuICAgICAgICByZXR1cm4gZW50aXR5O1xuICAgIH1cblxufVxuXG5cbi8qKlxuICogQSBzZXJ2aWNlIGZvciBwdWJsaXNoaW5nIGVudGl0eSBzdGF0ZXMgdG8gbWFuYWdlZCBzZXNzaW9uc1xuICovXG5AYXV0b2luamVjdFxuZXhwb3J0IGNsYXNzIEVudGl0eVNlcnZpY2VQcm92aWRlciB7XG5cbiAgICBwdWJsaWMgc3Vic2NyaXB0aW9uc0J5U3Vic2NyaWJlciA9IG5ldyBXZWFrTWFwPFNlc3Npb25Qb3J0LCB7W2VudGl0eUlkOnN0cmluZ106e318dW5kZWZpbmVkfT4oKTtcbiAgICBwdWJsaWMgc3Vic2NyaWJlcnNCeUVudGl0eSA9IG5ldyBNYXA8c3RyaW5nLCBTZXQ8U2Vzc2lvblBvcnQ+PigpO1xuICAgIHB1YmxpYyBzZXNzaW9uU3Vic2NyaWJlZEV2ZW50ID0gbmV3IEV2ZW50PHtzZXNzaW9uOlNlc3Npb25Qb3J0LCBpZDpzdHJpbmcsIG9wdGlvbnM6e319PigpO1xuICAgIHB1YmxpYyBzZXNzaW9uVW5zdWJzY3JpYmVkRXZlbnQgPSBuZXcgRXZlbnQ8e3Nlc3Npb246U2Vzc2lvblBvcnQsIGlkOnN0cmluZ30+KCk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBzZXNzaW9uU2VydmljZTogU2Vzc2lvblNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgZW50aXR5U2VydmljZTogRW50aXR5U2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBwZXJtaXNzaW9uU2VydmljZVByb3ZpZGVyOiBQZXJtaXNzaW9uU2VydmljZVByb3ZpZGVyXG4gICAgKSB7XG4gICAgICAgIHRoaXMuc2Vzc2lvblNlcnZpY2UuZW5zdXJlSXNSZWFsaXR5TWFuYWdlcigpO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5zZXNzaW9uU2VydmljZS5jb25uZWN0RXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoc2Vzc2lvbikgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9ucyA9IHt9O1xuICAgICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zQnlTdWJzY3JpYmVyLnNldChzZXNzaW9uLCBzdWJzY3JpcHRpb25zKTtcblxuICAgICAgICAgICAgc2Vzc2lvbi5vblsnYXIuZW50aXR5LnN1YnNjcmliZSddID0gc2Vzc2lvbi5vblsnYXIuY29udGV4dC5zdWJzY3JpYmUnXSA9ICh7aWQsIG9wdGlvbnN9OntpZDpzdHJpbmcsIG9wdGlvbnM6e318dW5kZWZpbmVkfSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRPcHRpb25zID0gc3Vic2NyaXB0aW9uc1tpZF07XG4gICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRPcHRpb25zICYmIGpzb25FcXVhbHMoY3VycmVudE9wdGlvbnMsb3B0aW9ucykpIHJldHVybjtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgICAgICAgICAgICAgICBjb25zdCBzdWJzY3JpYmVycyA9IHRoaXMuc3Vic2NyaWJlcnNCeUVudGl0eS5nZXQoaWQpIHx8IG5ldyBTZXQ8U2Vzc2lvblBvcnQ+KCk7XG4gICAgICAgICAgICAgICAgdGhpcy5zdWJzY3JpYmVyc0J5RW50aXR5LnNldChpZCwgc3Vic2NyaWJlcnMpO1xuICAgICAgICAgICAgICAgIHN1YnNjcmliZXJzLmFkZChzZXNzaW9uKTtcbiAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25zW2lkXSA9IG9wdGlvbnM7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXNzaW9uU3Vic2NyaWJlZEV2ZW50LnJhaXNlRXZlbnQoe3Nlc3Npb24sIGlkLCBvcHRpb25zfSk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucGVybWlzc2lvblNlcnZpY2VQcm92aWRlci5oYW5kbGVQZXJtaXNzaW9uUmVxdWVzdChzZXNzaW9uLCBpZCwgb3B0aW9ucykudGhlbigoKT0+e30pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzZXNzaW9uLm9uWydhci5lbnRpdHkudW5zdWJzY3JpYmUnXSA9IHNlc3Npb24ub25bJ2FyLmNvbnRleHQudW5zdWJzY3JpYmUnXSA9ICh7aWR9OntpZDpzdHJpbmd9KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFzdWJzY3JpcHRpb25zW2lkXSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGNvbnN0IHN1YnNjcmliZXJzID0gdGhpcy5zdWJzY3JpYmVyc0J5RW50aXR5LmdldChpZCk7XG4gICAgICAgICAgICAgICAgc3Vic2NyaWJlcnMgJiYgc3Vic2NyaWJlcnMuZGVsZXRlKHNlc3Npb24pO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBzdWJzY3JpcHRpb25zW2lkXTtcbiAgICAgICAgICAgICAgICB0aGlzLnNlc3Npb25VbnN1YnNjcmliZWRFdmVudC5yYWlzZUV2ZW50KHtpZCwgc2Vzc2lvbn0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzZXNzaW9uLmNsb3NlRXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoKT0+e1xuICAgICAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uc0J5U3Vic2NyaWJlci5kZWxldGUoc2Vzc2lvbik7XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBpZCBpbiBzdWJzY3JpcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHN1YnNjcmliZXJzID0gdGhpcy5zdWJzY3JpYmVyc0J5RW50aXR5LmdldChpZCk7XG4gICAgICAgICAgICAgICAgICAgIHN1YnNjcmliZXJzICYmIHN1YnNjcmliZXJzLmRlbGV0ZShzZXNzaW9uKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXNzaW9uVW5zdWJzY3JpYmVkRXZlbnQucmFpc2VFdmVudCh7aWQsIHNlc3Npb259KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZXJpYWxpemUgaW50byBhIHNlcmlhbGl6YXRpb24gc3RhdGUgbXBhdCwgdGhlIGdpdmVuIGVudGl0aWVzIHVzaW5nIHRoZSBnaXZlbiB0aW1lLlxuICAgICAqIFNlcmlhbGl6YXRpb24gaW5jbHVkZXMgdGhlIGFuY2VzdG9yIHJlZmVyZW5jZSBmcmFtZXMgb2YgaW5jbHVkZWQsIGV4Y2x1ZGluZyBhbnkgZW50aXRpZXMgaW4gdGhlIGV4Y2x1ZGVkRnJhbWVzIGxpc3QuIFxuICAgICAqL1xuICAgIHB1YmxpYyBmaWxsRW50aXR5U3RhdGVNYXAoZW50aXRpZXM6U2VyaWFsaXplZEVudGl0eVN0YXRlTWFwLCB0aW1lOkp1bGlhbkRhdGUsIGluY2x1ZGVkTWFwOnt9LCBleGNsdWRlZE1hcDp7fSkge1xuICAgICAgICBmb3IgKGxldCBpZCBpbiBpbmNsdWRlZE1hcCkge1xuICAgICAgICAgICAgbGV0IGVudGl0eSA9IHRoaXMuZW50aXR5U2VydmljZS5jb2xsZWN0aW9uLmdldEJ5SWQoaWQpO1xuICAgICAgICAgICAgd2hpbGUgKFxuICAgICAgICAgICAgICAgIGRlZmluZWQoZW50aXR5KSAmJiBcbiAgICAgICAgICAgICAgICBlbnRpdGllc1tpZCA9IGVudGl0eS5pZF0gPT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgKSB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNvbnN0IHJlZmVyZW5jZUZyYW1lID0gZW50aXR5ICYmIGVudGl0eS5wb3NpdGlvbiAmJiBlbnRpdHkucG9zaXRpb24ucmVmZXJlbmNlRnJhbWU7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGVkTWFwW2lkXSkge1xuICAgICAgICAgICAgICAgICAgICBlbnRpdGllc1tpZF0gPSBudWxsOyBcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zZSA9IHRoaXMuX2dldENhY2hlZFNlcmlhbGl6ZWRFbnRpdHlTdGF0ZShlbnRpdHksIHRpbWUsIHJlZmVyZW5jZUZyYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgZW50aXRpZXNbaWRdID0gcG9zZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBvc2UgPT09IG51bGwgfHwgdHlwZW9mIHJlZmVyZW5jZUZyYW1lID09PSAnbnVtYmVyJykgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGVudGl0eSA9IHJlZmVyZW5jZUZyYW1lO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2NhY2hlVGltZSA9IG5ldyBKdWxpYW5EYXRlKDAsMClcbiAgICBwcml2YXRlIF9lbnRpdHlTdGF0ZUNhY2hlOiBTZXJpYWxpemVkRW50aXR5U3RhdGVNYXAgPSB7fTtcbiAgICBwcml2YXRlIF9nZXRTZXJpYWxpemVkRW50aXR5U3RhdGUgPSBnZXRTZXJpYWxpemVkRW50aXR5U3RhdGU7XG5cbiAgICBwcml2YXRlIF9nZXRDYWNoZWRTZXJpYWxpemVkRW50aXR5U3RhdGUoZW50aXR5OiBFbnRpdHl8dW5kZWZpbmVkLCB0aW1lOkp1bGlhbkRhdGUsIHJlZmVyZW5jZUZyYW1lOkVudGl0eXxSZWZlcmVuY2VGcmFtZXx1bmRlZmluZWQpIHtcbiAgICAgICAgaWYgKCFlbnRpdHkgfHwgIWRlZmluZWQocmVmZXJlbmNlRnJhbWUpKSByZXR1cm4gbnVsbDtcblxuICAgICAgICBjb25zdCBpZCA9IGVudGl0eS5pZDtcbiAgICAgICAgaWYgKCFkZWZpbmVkKHRoaXMuX2VudGl0eVN0YXRlQ2FjaGVbaWRdKSB8fCAhdGhpcy5fY2FjaGVUaW1lLmVxdWFsc0Vwc2lsb24odGltZSwgMC4wMDAwMDEpKSB7XG4gICAgICAgICAgICB0aGlzLl9lbnRpdHlTdGF0ZUNhY2hlW2lkXSA9IHRoaXMuX2dldFNlcmlhbGl6ZWRFbnRpdHlTdGF0ZShlbnRpdHksIHRpbWUsIHJlZmVyZW5jZUZyYW1lKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLl9lbnRpdHlTdGF0ZUNhY2hlW2lkXTtcbiAgICB9XG59Il19