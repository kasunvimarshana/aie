var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
import { inject, Container } from 'aurelia-dependency-injection';
import { CameraEventAggregator, CameraEventType, ConstantPositionProperty, ConstantProperty, ReferenceFrame, Cartesian3, Quaternion, Matrix3, Matrix4, PerspectiveFrustum, CesiumMath, Entity } from '../cesium/cesium-imports';
import { Configuration, Role, SerializedSubviewList, DEFAULT_NEAR_PLANE, DEFAULT_FAR_PLANE } from '../common';
import { SessionService, ConnectService, SessionConnectService } from '../session';
import { eastUpSouthToFixedFrame, decomposePerspectiveProjectionMatrix, getEntityPositionInReferenceFrame, getEntityOrientationInReferenceFrame } from '../utils';
import { EntityService } from '../entity';
import { ContextService } from '../context';
import { DeviceService } from '../device';
import { ViewService } from '../view';
import { PoseStatus } from '../entity';
import { RealityViewer } from './base';
import { RealityService } from '../reality';
import { VisibilityService } from '../visibility';
/**
 * Note: To use this reality, an app must load three.js
 *
 * To share a canvas, an app must do the following:
 *   - Have a canvas element
 *   - Call Argon.init with sharedCanvas=true
 *   - Register the canvas element via setLayers
 *   - Do not clear the canvas (e.g. set renderer.autoClear=false in three.js)
 *   - Rebind GL state before rendering (e.g. renderer.resetGLState() in three.js)
 */
var WebRTCRealityViewer = (function (_super) {
    __extends(WebRTCRealityViewer, _super);
    function WebRTCRealityViewer(sessionService, viewService, contextService, container, uri) {
        var _this = _super.call(this, uri) || this;
        _this.sessionService = sessionService;
        _this.viewService = viewService;
        _this.contextService = contextService;
        _this.container = container;
        _this.uri = uri;
        _this.type = 'webrtc';
        _this.userTracking = '3DOF';
        _this._sharedCanvasFinal = false;
        _this._scratchCartesian = new Cartesian3();
        _this._scratchQuaternion = new Quaternion();
        _this._artoolkitTrackerEntity = new Entity({
            position: new ConstantPositionProperty(Cartesian3.ZERO, _this.contextService.user),
            orientation: new ConstantProperty(Quaternion.IDENTITY)
        });
        _this._markerEntities = new Map();
        _this._moveFlags = {
            moveForward: false,
            moveBackward: false,
            moveUp: false,
            moveDown: false,
            moveLeft: false,
            moveRight: false
        };
        _this._scratchMatrix3 = new Matrix3;
        _this._scratchMatrix4 = new Matrix4;
        _this._artoolkitReady = new Promise(function (resolve, reject) {
            _this._resolveReady = resolve;
            _this._rejectReady = reject;
        });
        function getFlagForKeyCode(keyCode) {
            switch (keyCode) {
                case 'W'.charCodeAt(0):
                    return 'moveForward';
                case 'S'.charCodeAt(0):
                    return 'moveBackward';
                case 'E'.charCodeAt(0):
                    return 'moveUp';
                case 'R'.charCodeAt(0):
                    return 'moveDown';
                case 'D'.charCodeAt(0):
                    return 'moveRight';
                case 'A'.charCodeAt(0):
                    return 'moveLeft';
                default:
                    return undefined;
            }
        }
        var keydownListener = function (e) {
            var flagName = getFlagForKeyCode(e.keyCode);
            if (typeof flagName !== 'undefined') {
                _this._moveFlags[flagName] = true;
            }
        };
        var keyupListener = function (e) {
            var flagName = getFlagForKeyCode(e.keyCode);
            if (typeof flagName !== 'undefined') {
                _this._moveFlags[flagName] = false;
            }
        };
        if (typeof document !== 'undefined') {
            _this.presentChangeEvent.addEventListener(function () {
                if (_this.isPresenting) {
                    _this.viewService.element.style.backgroundColor = 'white';
                    if (!_this._aggregator && _this.viewService.element) {
                        _this.viewService.element['disableRootEvents'] = true;
                        _this._aggregator = new CameraEventAggregator(_this.viewService.element);
                        document.addEventListener('keydown', keydownListener, false);
                        document && document.addEventListener('keyup', keyupListener, false);
                    }
                }
                else {
                    delete _this.viewService.element.style.backgroundColor;
                    _this._aggregator && _this._aggregator.destroy();
                    _this._aggregator = undefined;
                    document && document.removeEventListener('keydown', keydownListener);
                    document && document.removeEventListener('keyup', keyupListener);
                    for (var k in _this._moveFlags) {
                        _this._moveFlags[k] = false;
                    }
                }
            });
        }
        _this.viewService.viewportChangeEvent.addEventListener(function (viewport) {
            _this.updateViewport(viewport);
        });
        // for now, initialize artoolkit here
        // eventually we want to decouple video setup from artoolkit setup
        // and only initialize the video here
        _this.initARToolKit().then(function () {
            _this._resolveReady();
        }, function (error) {
            _this._rejectReady(error);
        });
        return _this;
    }
    WebRTCRealityViewer.prototype.load = function () {
        var _this = this;
        // Create a child container so that we can conveniently setup all the services
        // that would exist in a normal hosted reality viewer 
        var child = this.container.createChild();
        // Create the session instance that will be used by the managerÂ to talk to the reality 
        var session = this.sessionService.addManagedSessionPort(this.uri);
        session.connectEvent.addEventListener(function () {
            _this.connectEvent.raiseEvent(session); // let the manager know the session is ready
        });
        // use a SessionConnectService to create a connection via the session instance we created
        child.registerInstance(ConnectService, new SessionConnectService(session, this.sessionService.configuration));
        // setup the configuration for our webrtc reality
        child.registerInstance(Configuration, {
            role: Role.REALITY_VIEWER,
            uri: this.uri,
            title: 'WebRTC',
            version: this.sessionService.configuration.version,
            supportsCustomProtocols: true,
            protocols: ['ar.configureStage@v1', 'ar.jsartoolkit'],
            sharedCanvas: true
        });
        // Create the basic services that we need to use. 
        // Note: we won't create a child ViewService here,
        // as we are already managing the DOM with the
        // ViewService that exists in the root container. 
        child.autoRegisterAll([SessionService, EntityService, VisibilityService, ContextService, DeviceService, RealityService]);
        var childContextService = child.get(ContextService);
        var childDeviceService = child.get(DeviceService);
        var childSessionService = child.get(SessionService);
        var childRealityService = child.get(RealityService);
        var childViewService = child.get(ViewService);
        // the child device service should *not* submit frames to the vrdisplay. 
        childDeviceService.autoSubmitFrame = false;
        var customStagePosition;
        var customStageOrientation;
        // Create protocol handlers for `ar.configureStage` protocol
        childRealityService.connectEvent.addEventListener(function (session) {
            session.on['ar.configureStage.setStageGeolocation'] = function (_a) {
                var geolocation = _a.geolocation;
                customStagePosition = Cartesian3.fromRadians(geolocation.longitude, geolocation.latitude, geolocation.height, undefined, customStagePosition);
                var transformMatrix = eastUpSouthToFixedFrame(customStagePosition, undefined, _this._scratchMatrix4);
                var rotationMatrix = Matrix4.getRotation(transformMatrix, _this._scratchMatrix3);
                customStageOrientation = Quaternion.fromRotationMatrix(rotationMatrix, customStageOrientation);
            };
            session.on['ar.configureStage.resetStageGeolocation'] = function () {
                customStagePosition = undefined;
                customStageOrientation = undefined;
            };
            session.on['ar.jsartoolkit.init'] = function () {
                console.log("*** ar.jsartoolkit.init ***");
                return new Promise(function (resolve, reject) {
                    //this.initARToolKit().then(()=>{  // use this once video and artoolkit are decoupled
                    _this._artoolkitReady.then(function () {
                        /**
                         * _artoolkitTrackerEntity matches the user position but does not rotate as the device rotates
                         * it also rotates the artoolkit content to match our preferred coordinate system,
                         * where +X is right, +Y is down, and +Z is in the camera direction
                         */
                        var x180 = Quaternion.fromAxisAngle(Cartesian3.UNIT_X, CesiumMath.PI);
                        _this._artoolkitTrackerEntity.orientation.setValue(x180);
                        // this is only called when markers are visible
                        _this._arController.addEventListener('getMarker', function (ev) {
                            var marker = ev.data.marker;
                            var id = _this._getIdForMarker(marker.id);
                            var entity = _this.contextService.entities.getById(id);
                            if (entity) {
                                var pose = ev.data.matrix;
                                var position = Matrix4.getTranslation(pose, _this._scratchCartesian);
                                var rotationMatrix = Matrix4.getRotation(pose, _this._scratchMatrix3);
                                var orientation_1 = Quaternion.fromRotationMatrix(rotationMatrix, _this._scratchQuaternion);
                                if (entity.position instanceof ConstantPositionProperty) {
                                    entity.position.setValue(position, _this._artoolkitTrackerEntity);
                                }
                                else {
                                    entity.position = new ConstantPositionProperty(position, _this._artoolkitTrackerEntity);
                                }
                                if (entity.orientation instanceof ConstantProperty) {
                                    entity.orientation.setValue(orientation_1);
                                }
                                else {
                                    entity.orientation = new ConstantProperty(orientation_1);
                                }
                            }
                        });
                        resolve();
                    }, function (error) {
                        console.log(error);
                        reject(error);
                    });
                });
            };
            session.on['ar.jsartoolkit.addMarker'] = function (msg) {
                console.log("*** ar.jsartoolkit.addMarker ***");
                console.log("*** url: " + msg.url);
                var promise = new Promise(function (resolve, reject) {
                    _this._arController.loadMarker(msg.url, function (markerId) {
                        // TODO: handle size of markers
                        var id = _this._getIdForMarker(markerId);
                        var entity = new Entity({ id: id });
                        _this.contextService.entities.add(entity);
                        _this._markerEntities.set(id, entity);
                        resolve({ id: id });
                    }, function (error) {
                        console.log(error);
                        reject(error);
                    });
                });
                return promise;
            };
            // TODO: add support for barcode markers and multimarkers
        });
        // Setup everything after connected to the manager. The manager only connects once.
        childSessionService.manager.connectEvent.addEventListener(function () {
            // since we aren't create a child view service and viewport service, 
            // suppress any errors from not handling these messages
            childSessionService.manager.suppressErrorOnUnknownTopic = true;
            var scratchQuaternion = new Quaternion;
            var scratchQuaternionDragYaw = new Quaternion;
            // const pitchQuat = new Quaternion;
            var positionScratchCartesian = new Cartesian3;
            var movementScratchCartesian = new Cartesian3;
            var orientationMatrix = new Matrix3;
            var up = new Cartesian3(0, 0, 1);
            var right = new Cartesian3(1, 0, 0);
            var forward = new Cartesian3(0, -1, 0);
            var scratchFrustum = new PerspectiveFrustum();
            var deviceStage = childDeviceService.stage;
            var deviceUser = childDeviceService.user;
            var NEGATIVE_UNIT_Z = new Cartesian3(0, 0, -1);
            // const X_90ROT = Quaternion.fromAxisAngle(Cartesian3.UNIT_X, CesiumMath.PI_OVER_TWO);
            var subviews = [];
            var deviceUserPose = childContextService.createEntityPose(deviceUser, deviceStage);
            var checkSuggestedGeolocationSubscription = function () {
                if (childDeviceService.suggestedGeolocationSubscription) {
                    childDeviceService.subscribeGeolocation(childDeviceService.suggestedGeolocationSubscription);
                }
                else {
                    childDeviceService.unsubscribeGeolocation();
                }
            };
            checkSuggestedGeolocationSubscription();
            var remove1 = childDeviceService.suggestedGeolocationSubscriptionChangeEvent.addEventListener(checkSuggestedGeolocationSubscription);
            var remove2 = childDeviceService.frameStateEvent.addEventListener(function (frameState) {
                if (childSessionService.manager.isClosed)
                    return;
                var aggregator = _this._aggregator;
                var flags = _this._moveFlags;
                if (!_this.isPresenting) {
                    aggregator && aggregator.reset();
                    return;
                }
                SerializedSubviewList.clone(frameState.subviews, subviews);
                // provide fov controls
                if (!childDeviceService.strict) {
                    decomposePerspectiveProjectionMatrix(subviews[0].projectionMatrix, scratchFrustum);
                    scratchFrustum.fov = childViewService.subviews[0] && childViewService.subviews[0].frustum.fov || CesiumMath.PI_OVER_THREE;
                    if (aggregator && aggregator.isMoving(CameraEventType.WHEEL)) {
                        var wheelMovement = aggregator.getMovement(CameraEventType.WHEEL);
                        var diff = wheelMovement.endPosition.y;
                        scratchFrustum.fov = Math.min(Math.max(scratchFrustum.fov - diff * 0.02, Math.PI / 8), Math.PI - Math.PI / 8);
                    }
                    if (aggregator && aggregator.isMoving(CameraEventType.PINCH)) {
                        var pinchMovement = aggregator.getMovement(CameraEventType.PINCH);
                        var diff = pinchMovement.distance.endPosition.y - pinchMovement.distance.startPosition.y;
                        scratchFrustum.fov = Math.min(Math.max(scratchFrustum.fov - diff * 0.02, Math.PI / 8), Math.PI - Math.PI / 8);
                    }
                    subviews.forEach(function (s) {
                        var aspect = s.viewport.width / s.viewport.height;
                        scratchFrustum.aspectRatio = isFinite(aspect) ? aspect : 1;
                        Matrix4.clone(scratchFrustum.projectionMatrix, s.projectionMatrix);
                        // TODO: remove logic above, but note that _artoolkitProjection is not immediately ready
                        if (_this._artoolkitProjection)
                            Matrix4.clone(_this._artoolkitProjection, s.projectionMatrix);
                    });
                }
                var time = frameState.time;
                deviceUserPose.update(time);
                var overrideUser = !(deviceUserPose.status & PoseStatus.KNOWN);
                // provide controls if the device does not have a physical pose
                if (overrideUser) {
                    var contextUser = childContextService.user;
                    var contextStage = childContextService.stage;
                    var position = getEntityPositionInReferenceFrame(contextUser, time, contextStage, positionScratchCartesian) ||
                        Cartesian3.fromElements(0, childDeviceService.suggestedUserHeight, 0, positionScratchCartesian);
                    var orientation_2 = getEntityOrientationInReferenceFrame(contextUser, time, contextStage, scratchQuaternion) ||
                        Quaternion.clone(Quaternion.IDENTITY, scratchQuaternion);
                    if (aggregator && aggregator.isMoving(CameraEventType.LEFT_DRAG)) {
                        var dragMovement = aggregator.getMovement(CameraEventType.LEFT_DRAG);
                        if (orientation_2) {
                            // const dragPitch = Quaternion.fromAxisAngle(Cartesian3.UNIT_X, frustum.fov * (dragMovement.endPosition.y - dragMovement.startPosition.y) / app.view.getViewport().height, scratchQuaternionDragPitch);
                            var dragYaw = Quaternion.fromAxisAngle(Cartesian3.UNIT_Y, scratchFrustum.fov * (dragMovement.endPosition.x - dragMovement.startPosition.x) / frameState.viewport.width, scratchQuaternionDragYaw);
                            // const drag = Quaternion.multiply(dragPitch, dragYaw, dragYaw);
                            orientation_2 = Quaternion.multiply(orientation_2, dragYaw, dragYaw);
                            contextUser.orientation.setValue(orientation_2);
                        }
                    }
                    Matrix3.fromQuaternion(orientation_2, orientationMatrix);
                    Matrix3.multiplyByVector(orientationMatrix, Cartesian3.UNIT_Y, up);
                    Matrix3.multiplyByVector(orientationMatrix, Cartesian3.UNIT_X, right);
                    Matrix3.multiplyByVector(orientationMatrix, NEGATIVE_UNIT_Z, forward);
                    var moveRate = 0.02;
                    if (flags.moveForward) {
                        Cartesian3.multiplyByScalar(forward, moveRate, movementScratchCartesian);
                        Cartesian3.add(position, movementScratchCartesian, position);
                    }
                    if (flags.moveBackward) {
                        Cartesian3.multiplyByScalar(forward, -moveRate, movementScratchCartesian);
                        Cartesian3.add(position, movementScratchCartesian, position);
                    }
                    if (flags.moveUp) {
                        Cartesian3.multiplyByScalar(up, moveRate, movementScratchCartesian);
                        Cartesian3.add(position, movementScratchCartesian, position);
                    }
                    if (flags.moveDown) {
                        Cartesian3.multiplyByScalar(up, -moveRate, movementScratchCartesian);
                        Cartesian3.add(position, movementScratchCartesian, position);
                    }
                    if (flags.moveLeft) {
                        Cartesian3.multiplyByScalar(right, -moveRate, movementScratchCartesian);
                        Cartesian3.add(position, movementScratchCartesian, position);
                    }
                    if (flags.moveRight) {
                        Cartesian3.multiplyByScalar(right, moveRate, movementScratchCartesian);
                        Cartesian3.add(position, movementScratchCartesian, position);
                    }
                    contextUser.position.setValue(position, contextStage);
                    contextUser.orientation.setValue(orientation_2);
                }
                var overrideStage = customStagePosition && customStageOrientation ? true : false;
                if (overrideStage) {
                    var contextStage = childContextService.stage;
                    contextStage.position.setValue(customStagePosition, ReferenceFrame.FIXED);
                    contextStage.orientation.setValue(customStageOrientation);
                }
                if (_this._arScene) {
                    _this._resetMarkers();
                    _this._arScene.process();
                    _this._arScene.renderOn(_this._renderer);
                }
                var contextFrameState = childContextService.createFrameState(time, frameState.viewport, subviews, {
                    overrideUser: overrideUser,
                    overrideStage: overrideStage,
                    userTracking: _this.userTracking
                });
                childContextService.submitFrameState(contextFrameState);
                aggregator && aggregator.reset();
            });
            childSessionService.manager.closeEvent.addEventListener(function () {
                remove1();
                remove2();
            });
        });
        childSessionService.connect();
    };
    WebRTCRealityViewer.prototype._getIdForMarker = function (markerUID) {
        return "jsartoolkit_marker_" + markerUID;
    };
    WebRTCRealityViewer.prototype._resetMarkers = function () {
        // jsartoolkit does not currently have a marker lost event
        // for now, clear poses each frame before processing
        this._markerEntities.forEach(function (entity, id, map) {
            entity.position = undefined;
            entity.orientation = undefined;
        });
    };
    WebRTCRealityViewer.prototype.initARToolKit = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            // for now we're dynamically loading these scripts
            var script = document.createElement('script');
            script.src = 'https://rawgit.com/blairmacintyre/jsartoolkit5/master/build/artoolkit.min.js';
            script.onload = function () {
                console.log("*** artoolkit.min.js loaded ***");
                var script2 = document.createElement('script');
                script2.src = 'https://rawgit.com/blairmacintyre/jsartoolkit5/master/js/artoolkit.api.js';
                script2.onload = function () {
                    console.log("*** artoolkit.api.js loaded ***");
                    integrateCustomARToolKit();
                    _this.initARController().then(function () {
                        resolve();
                    }, function (error) {
                        reject(error);
                    });
                };
                document.head.appendChild(script2);
            };
            document.head.appendChild(script);
        });
    };
    WebRTCRealityViewer.prototype.initARController = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            ARController.getUserMediaThreeScene({ width: 240, height: 240, cameraParam: 45 * Math.PI / 180,
                onSuccess: function (arScene, arController, arCamera) {
                    console.log("*** getUserMediaThreeScene success ***");
                    _this._arScene = arScene;
                    _this._arController = arController;
                    _this.updateViewport(_this.viewService.viewport);
                    document.body.className = arController.orientation;
                    var argonCanvas;
                    if (_this.viewService.layers) {
                        for (var _i = 0, _a = _this.viewService.layers; _i < _a.length; _i++) {
                            var layer = _a[_i];
                            if (layer.source instanceof HTMLCanvasElement) {
                                argonCanvas = layer.source;
                            }
                        }
                    }
                    if (_this.isSharedCanvas && !argonCanvas) {
                        console.log("sharedCanvas is true but no canvas registered with setLayers");
                        //this._sharedCanvas = false; // currently the RealityServiceProvider overwrites this each frame
                    }
                    if (_this.isSharedCanvas && argonCanvas) {
                        // found an existing canvas, use it
                        console.log("Found argon canvas, video background is sharing its context");
                        _this._renderer = new THREE.WebGLRenderer({ canvas: argonCanvas, antialias: false });
                        _this._sharedCanvasFinal = true;
                    }
                    else {
                        // no canvas, create a new one
                        console.log("No argon shared canvas, creating one for video background");
                        var renderer = new THREE.WebGLRenderer({ antialias: false });
                        renderer.setSize(_this.viewService.renderWidth, _this.viewService.renderHeight, true);
                        _this.viewService.element.insertBefore(renderer.domElement, _this.viewService.element.firstChild);
                        renderer.domElement.style.zIndex = '0';
                        _this._renderer = renderer;
                        _this._sharedCanvasFinal = false;
                    }
                    resolve();
                },
                onError: function (error) {
                    reject(error);
                }
            });
        });
    };
    WebRTCRealityViewer.prototype.updateViewport = function (viewport) {
        if (!this._arController)
            return;
        console.log("updateViewport size: " + viewport.width + ", " + viewport.height);
        console.log("camera image size: " + this._arController.image.videoWidth + ", " + this._arController.image.videoHeight);
        var canvasAspect = viewport.width / viewport.height;
        var cameraAspect = this._arController.image.videoWidth / this._arController.image.videoHeight;
        console.log("canvasAspect: " + canvasAspect);
        console.log("cameraAspect: " + cameraAspect);
        // Scale the video plane to aspect fill the screen
        if (canvasAspect > cameraAspect) {
            // canvas is wider than camera image
            console.log("canvas is wider than camera image");
            this._arScene.videoPlane.scale.x = 1;
            this._arScene.videoPlane.scale.y = canvasAspect / cameraAspect;
        }
        else {
            // camera image is wider than canvas
            console.log("camera image is wider than canvas");
            this._arScene.videoPlane.scale.x = cameraAspect / canvasAspect;
            this._arScene.videoPlane.scale.y = 1;
        }
        // Resize the canvas if we own it
        if (!this._sharedCanvasFinal && this._renderer) {
            this._renderer.setSize(this.viewService.renderWidth, this.viewService.renderHeight, true);
        }
        this.updateProjection(viewport);
    };
    WebRTCRealityViewer.prototype.updateProjection = function (viewport) {
        var scratchFrustum = new PerspectiveFrustum();
        var projMatrix = Matrix4.fromArray(this._arController.getCameraMatrix());
        console.log("ARToolKit projection:");
        console.log(Matrix4.toArray(projMatrix)); // toString method gives a transposed matrix! this is a safer way to print
        // this is required for Cesium to accept this matrix
        projMatrix[4] *= -1; // x
        projMatrix[5] *= -1; // y
        projMatrix[6] *= -1; // z
        projMatrix[7] *= -1; // w
        projMatrix[8] *= -1; // x
        projMatrix[9] *= -1; // y
        projMatrix[10] *= -1; // z
        projMatrix[11] *= -1; // w
        console.log("Cesium-ready projection:");
        console.log(Matrix4.toArray(projMatrix));
        try {
            console.log("BEFORE:");
            decomposePerspectiveProjectionMatrix(projMatrix, scratchFrustum);
            console.log("projMatrix aspect: " + scratchFrustum.aspectRatio);
            console.log("projMatrix fov: " + scratchFrustum.fov);
            console.log("projMatrix near: " + scratchFrustum.near);
            console.log("projMatrix far: " + scratchFrustum.far);
            console.log("projMatrix fovy: " + scratchFrustum.fovy);
        }
        catch (e) {
            console.log("*** error: " + e);
        }
        // TDOD: adjust the fov in case the camera image is not square
        var viewportAspect = viewport.width / viewport.height;
        scratchFrustum.aspectRatio = viewportAspect;
        scratchFrustum.near = DEFAULT_NEAR_PLANE;
        scratchFrustum.far = DEFAULT_FAR_PLANE;
        projMatrix = scratchFrustum.projectionMatrix;
        this._artoolkitProjection = Matrix4.clone(projMatrix);
        try {
            console.log("AFTER:");
            decomposePerspectiveProjectionMatrix(projMatrix, scratchFrustum);
            console.log("projMatrix aspect: " + scratchFrustum.aspectRatio);
            console.log("projMatrix fov: " + scratchFrustum.fov);
            console.log("projMatrix near: " + scratchFrustum.near);
            console.log("projMatrix far: " + scratchFrustum.far);
            console.log("projMatrix fovy: " + scratchFrustum.fovy);
        }
        catch (e) {
            console.log("*** error: " + e);
        }
    };
    WebRTCRealityViewer = __decorate([
        inject(SessionService, ViewService, ContextService, Container),
        __metadata("design:paramtypes", [SessionService,
            ViewService,
            ContextService,
            Container, String])
    ], WebRTCRealityViewer);
    return WebRTCRealityViewer;
}(RealityViewer));
export { WebRTCRealityViewer };
var integrateCustomARToolKit = function () {
    /**
     *  Override the artoolkit.api.js getUserMedia function (it is out of date)
     *  This is taken from AR.js (THREEx.ArToolkitSource.prototype._initSourceWebcam)
     * */
    ARController.getUserMedia = function (configuration) {
        var onSuccess = configuration.onSuccess;
        var onError = configuration.onError || function (err) { console.error("ARController.getUserMedia", err); };
        // TODO make it static
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
        var domElement = document.createElement('video');
        domElement.style.width = configuration.width + 'px';
        domElement.style.height = configuration.height + 'px';
        if (navigator.getUserMedia === undefined) {
            onError('browser does not support navigator.getUserMedia');
            return;
        }
        if (navigator.mediaDevices === undefined || navigator.mediaDevices.enumerateDevices === undefined) {
            onError('browser does not support navigator.mediaDevices.enumerateDevices');
            return;
        }
        navigator.mediaDevices.enumerateDevices().then(function (devices) {
            // define getUserMedia() constraints
            var constraints = {
                audio: false,
                video: {
                    mandatory: {
                        maxWidth: configuration.width,
                        maxHeight: configuration.height
                    }
                }
            };
            devices.forEach(function (device) {
                if (device.kind !== 'videoinput')
                    return;
                // TODO super unclear how to get the backward facing camera...
                // Note: this code grabs the last camera in the list (not guaranteed to be the back-facing one, but it seems to work)
                //if( constraints.video.optional !== undefined )	return
                constraints.video.optional = [{ sourceId: device.deviceId }];
            });
            // OLD API
            // it it finds the videoSource 'environment', modify constraints.video
            // for (var i = 0; i != sourceInfos.length; ++i) {
            //         var sourceInfo = sourceInfos[i];
            //         if(sourceInfo.kind == "video" && sourceInfo.facing == "environment") {
            //                 constraints.video.optional = [{sourceId: sourceInfo.id}]
            //         }
            // }
            navigator.getUserMedia(constraints, function success(stream) {
                // console.log('success', stream);
                domElement.src = window.URL.createObjectURL(stream);
                // to start the video, when it is possible to start it only on userevent. like in android
                document.body.addEventListener('click', function () {
                    domElement.play();
                });
                // domElement.play();
                //wait until the video stream is ready
                var interval = setInterval(function () {
                    if (!domElement.videoWidth)
                        return;
                    console.log("video element: " + domElement.videoWidth + ", " + domElement.videoHeight);
                    //onReady()
                    onSuccess(domElement);
                    clearInterval(interval);
                }, 1000 / 50);
            }, function (error) {
                console.log("Can't access user media", error);
                alert("Can't access user media :()");
                onError("Can't access user media", error);
            });
        }).catch(function (err) {
            console.log(err.name + ": " + err.message);
            onError(err.name + ": " + err.message);
        });
        return domElement;
    };
    /**
     * The rest of these functions are taken directly from artoolkit.three.js
     * This is a quick way to play with the code, but we should move it when finished
     * Changes:
     *   - matrix.elements.set -> matrix.fromArray (to be compatible with newer versions of THREE)
     *   - Added renderer.resetGLState() to the beginning of the render pass
     *   - Changed the orthographic camera to have a unit sized viewport
     *   - Changed video plane to a unit size plane
     */
    /**
        Helper for setting up a Three.js AR scene using the device camera as input.
        Pass in the maximum dimensions of the video you want to process and onSuccess and onError callbacks.

        On a successful initialization, the onSuccess callback is called with an ThreeARScene object.
        The ThreeARScene object contains two THREE.js scenes (one for the video image and other for the 3D scene)
        and a couple of helper functions for doing video frame processing and AR rendering.

        Here's the structure of the ThreeARScene object:
        {
            scene: THREE.Scene, // The 3D scene. Put your AR objects here.
            camera: THREE.Camera, // The 3D scene camera.

            arController: ARController,

            video: HTMLVideoElement, // The userMedia video element.

            videoScene: THREE.Scene, // The userMedia video image scene. Shows the video feed.
            videoCamera: THREE.Camera, // Camera for the userMedia video scene.

            process: function(), // Process the current video frame and update the markers in the scene.
            renderOn: function( THREE.WebGLRenderer ) // Render the AR scene and video background on the given Three.js renderer.
        }

        You should use the arScene.video.videoWidth and arScene.video.videoHeight to set the width and height of your renderer.

        In your frame loop, use arScene.process() and arScene.renderOn(renderer) to do frame processing and 3D rendering, respectively.

        @param {number} width - The maximum width of the userMedia video to request.
        @param {number} height - The maximum height of the userMedia video to request.
        @param {function} onSuccess - Called on successful initialization with an ThreeARScene object.
        @param {function} onError - Called if the initialization fails with the error encountered.
    */
    ARController.getUserMediaThreeScene = function (configuration) {
        var obj = {};
        for (var i in configuration) {
            obj[i] = configuration[i];
        }
        var onSuccess = configuration.onSuccess;
        obj.onSuccess = function (arController, arCameraParam) {
            arController.setProjectionNearPlane(0.01); // this does nothing...
            arController.setProjectionFarPlane(100000); // this does nothing...
            var scenes = arController.createThreeScene();
            onSuccess(scenes, arController, arCameraParam);
        };
        var video = this.getUserMediaARController(obj); // this is in artoolkit.api.js
        return video;
    };
    /**
        Creates a Three.js scene for use with this ARController.

        Returns a ThreeARScene object that contains two THREE.js scenes (one for the video image and other for the 3D scene)
        and a couple of helper functions for doing video frame processing and AR rendering.

        Here's the structure of the ThreeARScene object:
        {
            scene: THREE.Scene, // The 3D scene. Put your AR objects here.
            camera: THREE.Camera, // The 3D scene camera.

            arController: ARController,

            video: HTMLVideoElement, // The userMedia video element.

            videoScene: THREE.Scene, // The userMedia video image scene. Shows the video feed.
            videoCamera: THREE.Camera, // Camera for the userMedia video scene.

            process: function(), // Process the current video frame and update the markers in the scene.
            renderOn: function( THREE.WebGLRenderer ) // Render the AR scene and video background on the given Three.js renderer.
        }

        You should use the arScene.video.videoWidth and arScene.video.videoHeight to set the width and height of your renderer.

        In your frame loop, use arScene.process() and arScene.renderOn(renderer) to do frame processing and 3D rendering, respectively.

        @param video Video image to use as scene background. Defaults to this.image
    */
    ARController.prototype.createThreeScene = function (video) {
        video = video || this.image; // we're using this.image (set in ARController.getUserMediaARController)
        // To display the video, first create a texture from it.
        var videoTex = new THREE.Texture(video);
        videoTex.minFilter = THREE.LinearFilter;
        videoTex.flipY = false;
        // Then create a plane textured with the video.
        var plane = new THREE.Mesh(new THREE.PlaneBufferGeometry(1, 1), new THREE.MeshBasicMaterial({ map: videoTex, side: THREE.DoubleSide }));
        // The video plane shouldn't care about the z-buffer.
        plane.material.depthTest = false;
        plane.material.depthWrite = false;
        // Create a camera and a scene for the video plane and
        // add the camera and the video plane to the scene.
        var videoCamera = new THREE.OrthographicCamera(-0.5, 0.5, -0.5, 0.5, -0.5, 0.5);
        var videoScene = new THREE.Scene();
        videoScene.add(plane);
        videoScene.add(videoCamera);
        if (this.orientation === 'portrait') {
            plane.rotation.z = Math.PI / 2;
        }
        var scene = new THREE.Scene();
        var camera = new THREE.Camera();
        camera.matrixAutoUpdate = false;
        camera.projectionMatrix.fromArray(this.getCameraMatrix());
        scene.add(camera);
        var self = this;
        return {
            scene: scene,
            videoScene: videoScene,
            camera: camera,
            videoCamera: videoCamera,
            arController: this,
            video: video,
            videoPlane: plane,
            process: function () {
                self.process(video);
            },
            renderOn: function (renderer) {
                if (!renderer)
                    return;
                renderer.resetGLState();
                videoTex.needsUpdate = true;
                var ac = renderer.autoClear;
                renderer.autoClear = false;
                renderer.clear();
                renderer.render(this.videoScene, this.videoCamera);
                renderer.render(this.scene, this.camera);
                renderer.autoClear = ac;
            }
        };
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2VicnRjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsid2VicnRjLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLDhCQUE4QixDQUFBO0FBQ2hFLE9BQU8sRUFDSCxxQkFBcUIsRUFDckIsZUFBZSxFQUNmLHdCQUF3QixFQUN4QixnQkFBZ0IsRUFDaEIsY0FBYyxFQUdkLFVBQVUsRUFDVixVQUFVLEVBQ1YsT0FBTyxFQUNQLE9BQU8sRUFDUCxrQkFBa0IsRUFDbEIsVUFBVSxFQUNWLE1BQU0sRUFDVCxNQUFNLDBCQUEwQixDQUFBO0FBQ2pDLE9BQU8sRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLHFCQUFxQixFQUFrQixrQkFBa0IsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFdBQVcsQ0FBQTtBQUM3SCxPQUFPLEVBQUUsY0FBYyxFQUFFLGNBQWMsRUFBRSxxQkFBcUIsRUFBVyxNQUFNLFlBQVksQ0FBQTtBQUMzRixPQUFPLEVBQ0gsdUJBQXVCLEVBQ3ZCLG9DQUFvQyxFQUNwQyxpQ0FBaUMsRUFDakMsb0NBQW9DLEVBQ3ZDLE1BQU0sVUFBVSxDQUFBO0FBQ2pCLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxXQUFXLENBQUE7QUFDekMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLFlBQVksQ0FBQTtBQUMzQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sV0FBVyxDQUFBO0FBQ3pDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxTQUFTLENBQUE7QUFDckMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFdBQVcsQ0FBQTtBQUN0QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sUUFBUSxDQUFBO0FBQ3RDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxZQUFZLENBQUE7QUFDM0MsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZUFBZSxDQUFBO0FBZWpE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LHdCQUF3QixFQUFFLFFBQVEsQ0FBQyxDQUFDO29CQUNqRSxDQUFDO29CQUNELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO3dCQUNyQixVQUFVLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxFQUFFLHdCQUF3QixDQUFDLENBQUM7d0JBQzFFLFVBQVUsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLHdCQUF3QixFQUFFLFFBQVEsQ0FBQyxDQUFDO29CQUNqRSxDQUFDO29CQUNELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO3dCQUNmLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLEVBQUUsUUFBUSxFQUFFLHdCQUF3QixDQUFDLENBQUM7d0JBQ3BFLFVBQVUsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLHdCQUF3QixFQUFFLFFBQVEsQ0FBQyxDQUFDO29CQUNqRSxDQUFDO29CQUNELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO3dCQUNqQixVQUFVLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxFQUFFLENBQUMsUUFBUSxFQUFFLHdCQUF3QixDQUFDLENBQUM7d0JBQ3JFLFVBQVUsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLHdCQUF3QixFQUFFLFFBQVEsQ0FBQyxDQUFDO29CQUNqRSxDQUFDO29CQUNELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO3dCQUNqQixVQUFVLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLENBQUMsUUFBUSxFQUFFLHdCQUF3QixDQUFDLENBQUM7d0JBQ3hFLFVBQVUsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLHdCQUF3QixFQUFFLFFBQVEsQ0FBQyxDQUFDO29CQUNqRSxDQUFDO29CQUNELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO3dCQUNsQixVQUFVLENBQUMsZ0JBQWdC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O2dCQUN4QixRQUFRLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztnQkFFNUIsSUFBSSxFQUFFLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQztnQkFDNUIsUUFBUSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7Z0JBQzNCLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDakIsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDbkQsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDekMsUUFBUSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7WUFDNUIsQ0FBQztTQUNKLENBQUM7SUFDTixDQUFDLENBQUM7QUFDTixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7IGluamVjdCwgQ29udGFpbmVyIH0gZnJvbSAnYXVyZWxpYS1kZXBlbmRlbmN5LWluamVjdGlvbidcbmltcG9ydCB7IFxuICAgIENhbWVyYUV2ZW50QWdncmVnYXRvcixcbiAgICBDYW1lcmFFdmVudFR5cGUsXG4gICAgQ29uc3RhbnRQb3NpdGlvblByb3BlcnR5LFxuICAgIENvbnN0YW50UHJvcGVydHksXG4gICAgUmVmZXJlbmNlRnJhbWUsXG4gICAgQ2FydG9ncmFwaGljLFxuICAgIENhcnRlc2lhbjIsXG4gICAgQ2FydGVzaWFuMyxcbiAgICBRdWF0ZXJuaW9uLFxuICAgIE1hdHJpeDMsXG4gICAgTWF0cml4NCxcbiAgICBQZXJzcGVjdGl2ZUZydXN0dW0sXG4gICAgQ2VzaXVtTWF0aCxcbiAgICBFbnRpdHlcbn0gZnJvbSAnLi4vY2VzaXVtL2Nlc2l1bS1pbXBvcnRzJ1xuaW1wb3J0IHsgQ29uZmlndXJhdGlvbiwgUm9sZSwgU2VyaWFsaXplZFN1YnZpZXdMaXN0LCBDYW52YXNWaWV3cG9ydCwgREVGQVVMVF9ORUFSX1BMQU5FLCBERUZBVUxUX0ZBUl9QTEFORSB9IGZyb20gJy4uL2NvbW1vbidcbmltcG9ydCB7IFNlc3Npb25TZXJ2aWNlLCBDb25uZWN0U2VydmljZSwgU2Vzc2lvbkNvbm5lY3RTZXJ2aWNlLCBNZXNzYWdlIH0gZnJvbSAnLi4vc2Vzc2lvbidcbmltcG9ydCB7IFxuICAgIGVhc3RVcFNvdXRoVG9GaXhlZEZyYW1lLCBcbiAgICBkZWNvbXBvc2VQZXJzcGVjdGl2ZVByb2plY3Rpb25NYXRyaXgsIFxuICAgIGdldEVudGl0eVBvc2l0aW9uSW5SZWZlcmVuY2VGcmFtZSwgXG4gICAgZ2V0RW50aXR5T3JpZW50YXRpb25JblJlZmVyZW5jZUZyYW1lIFxufSBmcm9tICcuLi91dGlscydcbmltcG9ydCB7IEVudGl0eVNlcnZpY2UgfSBmcm9tICcuLi9lbnRpdHknXG5pbXBvcnQgeyBDb250ZXh0U2VydmljZSB9IGZyb20gJy4uL2NvbnRleHQnXG5pbXBvcnQgeyBEZXZpY2VTZXJ2aWNlIH0gZnJvbSAnLi4vZGV2aWNlJ1xuaW1wb3J0IHsgVmlld1NlcnZpY2UgfSBmcm9tICcuLi92aWV3J1xuaW1wb3J0IHsgUG9zZVN0YXR1cyB9IGZyb20gJy4uL2VudGl0eSdcbmltcG9ydCB7IFJlYWxpdHlWaWV3ZXIgfSBmcm9tICcuL2Jhc2UnXG5pbXBvcnQgeyBSZWFsaXR5U2VydmljZSB9IGZyb20gJy4uL3JlYWxpdHknXG5pbXBvcnQgeyBWaXNpYmlsaXR5U2VydmljZSB9IGZyb20gJy4uL3Zpc2liaWxpdHknXG5cbmRlY2xhcmUgdmFyIEFSQ29udHJvbGxlcjtcbmRlY2xhcmUgdmFyIFRIUkVFO1xuXG5pbnRlcmZhY2UgTW92ZW1lbnQge1xuICAgIHN0YXJ0UG9zaXRpb246Q2FydGVzaWFuMjsgXG4gICAgZW5kUG9zaXRpb246Q2FydGVzaWFuMjtcbn1cblxuaW50ZXJmYWNlIFBpbmNoTW92ZW1lbnQge1xuICAgIGRpc3RhbmNlOiBNb3ZlbWVudDtcbiAgICBhbmdsZUFuZEhlaWdodDogTW92ZW1lbnQ7XG59XG5cbi8qKlxuICogTm90ZTogVG8gdXNlIHRoaXMgcmVhbGl0eSwgYW4gYXBwIG11c3QgbG9hZCB0aHJlZS5qc1xuICogXG4gKiBUbyBzaGFyZSBhIGNhbnZhcywgYW4gYXBwIG11c3QgZG8gdGhlIGZvbGxvd2luZzpcbiAqICAgLSBIYXZlIGEgY2FudmFzIGVsZW1lbnRcbiAqICAgLSBDYWxsIEFyZ29uLmluaXQgd2l0aCBzaGFyZWRDYW52YXM9dHJ1ZVxuICogICAtIFJlZ2lzdGVyIHRoZSBjYW52YXMgZWxlbWVudCB2aWEgc2V0TGF5ZXJzXG4gKiAgIC0gRG8gbm90IGNsZWFyIHRoZSBjYW52YXMgKGUuZy4gc2V0IHJlbmRlcmVyLmF1dG9DbGVhcj1mYWxzZSBpbiB0aHJlZS5qcylcbiAqICAgLSBSZWJpbmQgR0wgc3RhdGUgYmVmb3JlIHJlbmRlcmluZyAoZS5nLiByZW5kZXJlci5yZXNldEdMU3RhdGUoKSBpbiB0aHJlZS5qcylcbiAqL1xuXG5AaW5qZWN0KFNlc3Npb25TZXJ2aWNlLCBWaWV3U2VydmljZSwgQ29udGV4dFNlcnZpY2UsIENvbnRhaW5lcilcbmV4cG9ydCBjbGFzcyBXZWJSVENSZWFsaXR5Vmlld2VyIGV4dGVuZHMgUmVhbGl0eVZpZXdlciB7XG5cbiAgICBwdWJsaWMgdHlwZSA9ICd3ZWJydGMnO1xuICAgIHB1YmxpYyB1c2VyVHJhY2tpbmc6ICdub25lJ3wnM0RPRid8JzZET0YnID0gJzNET0YnO1xuXG4gICAgcHJpdmF0ZSBfYXJTY2VuZTtcbiAgICBwcml2YXRlIF9hckNvbnRyb2xsZXI7XG4gICAgcHJpdmF0ZSBfcmVuZGVyZXI7XG4gICAgcHJpdmF0ZSBfc2hhcmVkQ2FudmFzRmluYWwgPSBmYWxzZTtcblxuICAgIHByaXZhdGUgX3NjcmF0Y2hDYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuMygpO1xuICAgIHByaXZhdGUgX3NjcmF0Y2hRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24oKTtcblxuICAgIHByaXZhdGUgX2FydG9vbGtpdFRyYWNrZXJFbnRpdHkgPSBuZXcgRW50aXR5KHtcbiAgICAgICAgcG9zaXRpb246IG5ldyBDb25zdGFudFBvc2l0aW9uUHJvcGVydHkoQ2FydGVzaWFuMy5aRVJPLCB0aGlzLmNvbnRleHRTZXJ2aWNlLnVzZXIpLFxuICAgICAgICBvcmllbnRhdGlvbjogbmV3IENvbnN0YW50UHJvcGVydHkoUXVhdGVybmlvbi5JREVOVElUWSlcbiAgICB9KTtcblxuICAgIHByaXZhdGUgX2FydG9vbGtpdFByb2plY3Rpb246TWF0cml4NHx1bmRlZmluZWQ7XG5cbiAgICBwcml2YXRlIF9tYXJrZXJFbnRpdGllcyA9IG5ldyBNYXA8c3RyaW5nLEVudGl0eT4oKTtcblxuICAgIHByaXZhdGUgX3Jlc29sdmVSZWFkeTpGdW5jdGlvbjtcbiAgICBwcml2YXRlIF9yZWplY3RSZWFkeTpGdW5jdGlvbjtcbiAgICBwcml2YXRlIF9hcnRvb2xraXRSZWFkeTpQcm9taXNlPHZvaWQ+O1xuXG4gICAgcHJpdmF0ZSBfYWdncmVnYXRvcjpDYW1lcmFFdmVudEFnZ3JlZ2F0b3J8dW5kZWZpbmVkO1xuICAgIHByaXZhdGUgX21vdmVGbGFncyA9IHtcbiAgICAgICAgbW92ZUZvcndhcmQgOiBmYWxzZSxcbiAgICAgICAgbW92ZUJhY2t3YXJkIDogZmFsc2UsXG4gICAgICAgIG1vdmVVcCA6IGZhbHNlLFxuICAgICAgICBtb3ZlRG93biA6IGZhbHNlLFxuICAgICAgICBtb3ZlTGVmdCA6IGZhbHNlLFxuICAgICAgICBtb3ZlUmlnaHQgOiBmYWxzZVxuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIHNlc3Npb25TZXJ2aWNlOiBTZXNzaW9uU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSB2aWV3U2VydmljZTogVmlld1NlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgY29udGV4dFNlcnZpY2U6IENvbnRleHRTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGNvbnRhaW5lcjogQ29udGFpbmVyLFxuICAgICAgICBwdWJsaWMgdXJpOnN0cmluZykge1xuICAgICAgICBzdXBlcih1cmkpO1xuXG4gICAgICAgIHRoaXMuX2FydG9vbGtpdFJlYWR5ID0gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZVJlYWR5ID0gcmVzb2x2ZTtcbiAgICAgICAgICAgIHRoaXMuX3JlamVjdFJlYWR5ID0gcmVqZWN0O1xuICAgICAgICB9KTtcblxuICAgICAgICBmdW5jdGlvbiBnZXRGbGFnRm9yS2V5Q29kZShrZXlDb2RlKSB7XG4gICAgICAgICAgICBzd2l0Y2ggKGtleUNvZGUpIHtcbiAgICAgICAgICAgIGNhc2UgJ1cnLmNoYXJDb2RlQXQoMCk6XG4gICAgICAgICAgICAgICAgcmV0dXJuICdtb3ZlRm9yd2FyZCc7XG4gICAgICAgICAgICBjYXNlICdTJy5jaGFyQ29kZUF0KDApOlxuICAgICAgICAgICAgICAgIHJldHVybiAnbW92ZUJhY2t3YXJkJztcbiAgICAgICAgICAgIGNhc2UgJ0UnLmNoYXJDb2RlQXQoMCk6XG4gICAgICAgICAgICAgICAgcmV0dXJuICdtb3ZlVXAnO1xuICAgICAgICAgICAgY2FzZSAnUicuY2hhckNvZGVBdCgwKTpcbiAgICAgICAgICAgICAgICByZXR1cm4gJ21vdmVEb3duJztcbiAgICAgICAgICAgIGNhc2UgJ0QnLmNoYXJDb2RlQXQoMCk6XG4gICAgICAgICAgICAgICAgcmV0dXJuICdtb3ZlUmlnaHQnO1xuICAgICAgICAgICAgY2FzZSAnQScuY2hhckNvZGVBdCgwKTpcbiAgICAgICAgICAgICAgICByZXR1cm4gJ21vdmVMZWZ0JztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgY29uc3Qga2V5ZG93bkxpc3RlbmVyID0gKGUpID0+IHtcbiAgICAgICAgICAgIHZhciBmbGFnTmFtZSA9IGdldEZsYWdGb3JLZXlDb2RlKGUua2V5Q29kZSk7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGZsYWdOYW1lICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIHRoaXMuX21vdmVGbGFnc1tmbGFnTmFtZV0gPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qga2V5dXBMaXN0ZW5lciA9IChlKSA9PiB7XG4gICAgICAgICAgICB2YXIgZmxhZ05hbWUgPSBnZXRGbGFnRm9yS2V5Q29kZShlLmtleUNvZGUpO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBmbGFnTmFtZSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9tb3ZlRmxhZ3NbZmxhZ05hbWVdID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHlwZW9mIGRvY3VtZW50ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgdGhpcy5wcmVzZW50Q2hhbmdlRXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoKT0+e1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzUHJlc2VudGluZykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnZpZXdTZXJ2aWNlLmVsZW1lbnQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gJ3doaXRlJztcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hZ2dyZWdhdG9yICYmIHRoaXMudmlld1NlcnZpY2UuZWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52aWV3U2VydmljZS5lbGVtZW50WydkaXNhYmxlUm9vdEV2ZW50cyddID0gdHJ1ZTsgXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZ2dyZWdhdG9yID0gbmV3IENhbWVyYUV2ZW50QWdncmVnYXRvcig8YW55PnRoaXMudmlld1NlcnZpY2UuZWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywga2V5ZG93bkxpc3RlbmVyLCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudCAmJiBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIGtleXVwTGlzdGVuZXIsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnZpZXdTZXJ2aWNlLmVsZW1lbnQuc3R5bGUuYmFja2dyb3VuZENvbG9yO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZ2dyZWdhdG9yICYmIHRoaXMuX2FnZ3JlZ2F0b3IuZGVzdHJveSgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZ2dyZWdhdG9yID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudCAmJiBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywga2V5ZG93bkxpc3RlbmVyKTtcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQgJiYgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5dXAnLCBrZXl1cExpc3RlbmVyKTtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBrIGluIHRoaXMuX21vdmVGbGFncykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbW92ZUZsYWdzW2tdID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudmlld1NlcnZpY2Uudmlld3BvcnRDaGFuZ2VFdmVudC5hZGRFdmVudExpc3RlbmVyKCh2aWV3cG9ydDpDYW52YXNWaWV3cG9ydCk9PntcbiAgICAgICAgICAgIHRoaXMudXBkYXRlVmlld3BvcnQodmlld3BvcnQpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBmb3Igbm93LCBpbml0aWFsaXplIGFydG9vbGtpdCBoZXJlXG4gICAgICAgIC8vIGV2ZW50dWFsbHkgd2Ugd2FudCB0byBkZWNvdXBsZSB2aWRlbyBzZXR1cCBmcm9tIGFydG9vbGtpdCBzZXR1cFxuICAgICAgICAvLyBhbmQgb25seSBpbml0aWFsaXplIHRoZSB2aWRlbyBoZXJlXG4gICAgICAgIHRoaXMuaW5pdEFSVG9vbEtpdCgpLnRoZW4oKCk9PntcbiAgICAgICAgICAgIHRoaXMuX3Jlc29sdmVSZWFkeSgpO1xuICAgICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX3JlamVjdFJlYWR5KGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc2NyYXRjaE1hdHJpeDMgPSBuZXcgTWF0cml4MztcbiAgICBwcml2YXRlIF9zY3JhdGNoTWF0cml4NCA9IG5ldyBNYXRyaXg0O1xuXG4gICAgcHVibGljIGxvYWQoKTogdm9pZCB7XG4gICAgICAgIC8vIENyZWF0ZSBhIGNoaWxkIGNvbnRhaW5lciBzbyB0aGF0IHdlIGNhbiBjb252ZW5pZW50bHkgc2V0dXAgYWxsIHRoZSBzZXJ2aWNlc1xuICAgICAgICAvLyB0aGF0IHdvdWxkIGV4aXN0IGluIGEgbm9ybWFsIGhvc3RlZCByZWFsaXR5IHZpZXdlciBcbiAgICAgICAgY29uc3QgY2hpbGQgPSB0aGlzLmNvbnRhaW5lci5jcmVhdGVDaGlsZCgpO1xuXG4gICAgICAgIC8vIENyZWF0ZSB0aGUgc2Vzc2lvbiBpbnN0YW5jZSB0aGF0IHdpbGwgYmUgdXNlZCBieSB0aGUgbWFuYWdlcsKgdG8gdGFsayB0byB0aGUgcmVhbGl0eSBcbiAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvblNlcnZpY2UuYWRkTWFuYWdlZFNlc3Npb25Qb3J0KHRoaXMudXJpKTtcbiAgICAgICAgc2Vzc2lvbi5jb25uZWN0RXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoKT0+e1xuICAgICAgICAgICAgdGhpcy5jb25uZWN0RXZlbnQucmFpc2VFdmVudChzZXNzaW9uKTsgLy8gbGV0IHRoZSBtYW5hZ2VyIGtub3cgdGhlIHNlc3Npb24gaXMgcmVhZHlcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gdXNlIGEgU2Vzc2lvbkNvbm5lY3RTZXJ2aWNlIHRvIGNyZWF0ZSBhIGNvbm5lY3Rpb24gdmlhIHRoZSBzZXNzaW9uIGluc3RhbmNlIHdlIGNyZWF0ZWRcbiAgICAgICAgY2hpbGQucmVnaXN0ZXJJbnN0YW5jZShDb25uZWN0U2VydmljZSwgXG4gICAgICAgICAgICBuZXcgU2Vzc2lvbkNvbm5lY3RTZXJ2aWNlKHNlc3Npb24sIHRoaXMuc2Vzc2lvblNlcnZpY2UuY29uZmlndXJhdGlvbilcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBzZXR1cCB0aGUgY29uZmlndXJhdGlvbiBmb3Igb3VyIHdlYnJ0YyByZWFsaXR5XG4gICAgICAgIGNoaWxkLnJlZ2lzdGVySW5zdGFuY2UoQ29uZmlndXJhdGlvbiwgeyBcbiAgICAgICAgICAgIHJvbGU6IFJvbGUuUkVBTElUWV9WSUVXRVIsIFxuICAgICAgICAgICAgdXJpOiB0aGlzLnVyaSxcbiAgICAgICAgICAgIHRpdGxlOiAnV2ViUlRDJyxcbiAgICAgICAgICAgIHZlcnNpb246IHRoaXMuc2Vzc2lvblNlcnZpY2UuY29uZmlndXJhdGlvbi52ZXJzaW9uLFxuICAgICAgICAgICAgc3VwcG9ydHNDdXN0b21Qcm90b2NvbHM6IHRydWUsXG4gICAgICAgICAgICBwcm90b2NvbHM6IFsnYXIuY29uZmlndXJlU3RhZ2VAdjEnLCAnYXIuanNhcnRvb2xraXQnXSxcbiAgICAgICAgICAgIHNoYXJlZENhbnZhczogdHJ1ZVxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBDcmVhdGUgdGhlIGJhc2ljIHNlcnZpY2VzIHRoYXQgd2UgbmVlZCB0byB1c2UuIFxuICAgICAgICAvLyBOb3RlOiB3ZSB3b24ndCBjcmVhdGUgYSBjaGlsZCBWaWV3U2VydmljZSBoZXJlLFxuICAgICAgICAvLyBhcyB3ZSBhcmUgYWxyZWFkeSBtYW5hZ2luZyB0aGUgRE9NIHdpdGggdGhlXG4gICAgICAgIC8vIFZpZXdTZXJ2aWNlIHRoYXQgZXhpc3RzIGluIHRoZSByb290IGNvbnRhaW5lci4gXG4gICAgICAgIGNoaWxkLmF1dG9SZWdpc3RlckFsbChbU2Vzc2lvblNlcnZpY2UsIEVudGl0eVNlcnZpY2UsIFZpc2liaWxpdHlTZXJ2aWNlLCBDb250ZXh0U2VydmljZSwgRGV2aWNlU2VydmljZSwgUmVhbGl0eVNlcnZpY2VdKTtcbiAgICAgICAgY29uc3QgY2hpbGRDb250ZXh0U2VydmljZSA9IGNoaWxkLmdldChDb250ZXh0U2VydmljZSkgYXMgQ29udGV4dFNlcnZpY2U7XG4gICAgICAgIGNvbnN0IGNoaWxkRGV2aWNlU2VydmljZSA9IGNoaWxkLmdldChEZXZpY2VTZXJ2aWNlKSBhcyBEZXZpY2VTZXJ2aWNlO1xuICAgICAgICBjb25zdCBjaGlsZFNlc3Npb25TZXJ2aWNlID0gY2hpbGQuZ2V0KFNlc3Npb25TZXJ2aWNlKSBhcyBTZXNzaW9uU2VydmljZTtcbiAgICAgICAgY29uc3QgY2hpbGRSZWFsaXR5U2VydmljZSA9IGNoaWxkLmdldChSZWFsaXR5U2VydmljZSkgYXMgUmVhbGl0eVNlcnZpY2U7XG4gICAgICAgIGNvbnN0IGNoaWxkVmlld1NlcnZpY2UgPSBjaGlsZC5nZXQoVmlld1NlcnZpY2UpIGFzIFZpZXdTZXJ2aWNlO1xuXG4gICAgICAgIC8vIHRoZSBjaGlsZCBkZXZpY2Ugc2VydmljZSBzaG91bGQgKm5vdCogc3VibWl0IGZyYW1lcyB0byB0aGUgdnJkaXNwbGF5LiBcbiAgICAgICAgY2hpbGREZXZpY2VTZXJ2aWNlLmF1dG9TdWJtaXRGcmFtZSA9IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgbGV0IGN1c3RvbVN0YWdlUG9zaXRpb246Q2FydGVzaWFuM3x1bmRlZmluZWQ7XG4gICAgICAgIGxldCBjdXN0b21TdGFnZU9yaWVudGF0aW9uOlF1YXRlcm5pb258dW5kZWZpbmVkO1xuXG4gICAgICAgIC8vIENyZWF0ZSBwcm90b2NvbCBoYW5kbGVycyBmb3IgYGFyLmNvbmZpZ3VyZVN0YWdlYCBwcm90b2NvbFxuICAgICAgICBjaGlsZFJlYWxpdHlTZXJ2aWNlLmNvbm5lY3RFdmVudC5hZGRFdmVudExpc3RlbmVyKChzZXNzaW9uKT0+e1xuXG4gICAgICAgICAgICBzZXNzaW9uLm9uWydhci5jb25maWd1cmVTdGFnZS5zZXRTdGFnZUdlb2xvY2F0aW9uJ10gPSAoe2dlb2xvY2F0aW9ufTp7Z2VvbG9jYXRpb246Q2FydG9ncmFwaGljfSkgPT4ge1xuICAgICAgICAgICAgICAgIGN1c3RvbVN0YWdlUG9zaXRpb24gPSBDYXJ0ZXNpYW4zLmZyb21SYWRpYW5zKGdlb2xvY2F0aW9uLmxvbmdpdHVkZSwgZ2VvbG9jYXRpb24ubGF0aXR1ZGUsIGdlb2xvY2F0aW9uLmhlaWdodCwgdW5kZWZpbmVkLCBjdXN0b21TdGFnZVBvc2l0aW9uKTtcbiAgICAgICAgICAgICAgICBjb25zdCB0cmFuc2Zvcm1NYXRyaXggPSBlYXN0VXBTb3V0aFRvRml4ZWRGcmFtZShjdXN0b21TdGFnZVBvc2l0aW9uLCB1bmRlZmluZWQsIHRoaXMuX3NjcmF0Y2hNYXRyaXg0KTtcbiAgICAgICAgICAgICAgICBjb25zdCByb3RhdGlvbk1hdHJpeCA9IE1hdHJpeDQuZ2V0Um90YXRpb24odHJhbnNmb3JtTWF0cml4LCB0aGlzLl9zY3JhdGNoTWF0cml4Myk7XG4gICAgICAgICAgICAgICAgY3VzdG9tU3RhZ2VPcmllbnRhdGlvbiA9IFF1YXRlcm5pb24uZnJvbVJvdGF0aW9uTWF0cml4KHJvdGF0aW9uTWF0cml4LCBjdXN0b21TdGFnZU9yaWVudGF0aW9uKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgc2Vzc2lvbi5vblsnYXIuY29uZmlndXJlU3RhZ2UucmVzZXRTdGFnZUdlb2xvY2F0aW9uJ10gPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgY3VzdG9tU3RhZ2VQb3NpdGlvbiA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICBjdXN0b21TdGFnZU9yaWVudGF0aW9uID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzZXNzaW9uLm9uWydhci5qc2FydG9vbGtpdC5pbml0J10gPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCIqKiogYXIuanNhcnRvb2xraXQuaW5pdCAqKipcIik7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpPT57XG4gICAgICAgICAgICAgICAgICAgIC8vdGhpcy5pbml0QVJUb29sS2l0KCkudGhlbigoKT0+eyAgLy8gdXNlIHRoaXMgb25jZSB2aWRlbyBhbmQgYXJ0b29sa2l0IGFyZSBkZWNvdXBsZWRcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYXJ0b29sa2l0UmVhZHkudGhlbigoKT0+e1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgICAgICAgICAqIF9hcnRvb2xraXRUcmFja2VyRW50aXR5IG1hdGNoZXMgdGhlIHVzZXIgcG9zaXRpb24gYnV0IGRvZXMgbm90IHJvdGF0ZSBhcyB0aGUgZGV2aWNlIHJvdGF0ZXNcbiAgICAgICAgICAgICAgICAgICAgICAgICAqIGl0IGFsc28gcm90YXRlcyB0aGUgYXJ0b29sa2l0IGNvbnRlbnQgdG8gbWF0Y2ggb3VyIHByZWZlcnJlZCBjb29yZGluYXRlIHN5c3RlbSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAqIHdoZXJlICtYIGlzIHJpZ2h0LCArWSBpcyBkb3duLCBhbmQgK1ogaXMgaW4gdGhlIGNhbWVyYSBkaXJlY3Rpb25cbiAgICAgICAgICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeDE4MCA9IFF1YXRlcm5pb24uZnJvbUF4aXNBbmdsZShDYXJ0ZXNpYW4zLlVOSVRfWCwgQ2VzaXVtTWF0aC5QSSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAodGhpcy5fYXJ0b29sa2l0VHJhY2tlckVudGl0eS5vcmllbnRhdGlvbiBhcyBDb25zdGFudFByb3BlcnR5KS5zZXRWYWx1ZSh4MTgwKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBpcyBvbmx5IGNhbGxlZCB3aGVuIG1hcmtlcnMgYXJlIHZpc2libGVcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2FyQ29udHJvbGxlci5hZGRFdmVudExpc3RlbmVyKCdnZXRNYXJrZXInLCAoZXYpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXJrZXIgPSBldi5kYXRhLm1hcmtlcjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpZCA9IHRoaXMuX2dldElkRm9yTWFya2VyKG1hcmtlci5pZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZW50aXR5OkVudGl0eXx1bmRlZmluZWQgPSB0aGlzLmNvbnRleHRTZXJ2aWNlLmVudGl0aWVzLmdldEJ5SWQoaWQpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVudGl0eSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3NlID0gZXYuZGF0YS5tYXRyaXg7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gTWF0cml4NC5nZXRUcmFuc2xhdGlvbihwb3NlLCB0aGlzLl9zY3JhdGNoQ2FydGVzaWFuKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm90YXRpb25NYXRyaXggPSBNYXRyaXg0LmdldFJvdGF0aW9uKHBvc2UsIHRoaXMuX3NjcmF0Y2hNYXRyaXgzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3JpZW50YXRpb24gPSBRdWF0ZXJuaW9uLmZyb21Sb3RhdGlvbk1hdHJpeChyb3RhdGlvbk1hdHJpeCwgdGhpcy5fc2NyYXRjaFF1YXRlcm5pb24pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkucG9zaXRpb24gaW5zdGFuY2VvZiBDb25zdGFudFBvc2l0aW9uUHJvcGVydHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eS5wb3NpdGlvbi5zZXRWYWx1ZShwb3NpdGlvbiwgdGhpcy5fYXJ0b29sa2l0VHJhY2tlckVudGl0eSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHkucG9zaXRpb24gPSBuZXcgQ29uc3RhbnRQb3NpdGlvblByb3BlcnR5KHBvc2l0aW9uLCB0aGlzLl9hcnRvb2xraXRUcmFja2VyRW50aXR5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHkub3JpZW50YXRpb24gaW5zdGFuY2VvZiBDb25zdGFudFByb3BlcnR5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHkub3JpZW50YXRpb24uc2V0VmFsdWUob3JpZW50YXRpb24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW50aXR5Lm9yaWVudGF0aW9uID0gbmV3IENvbnN0YW50UHJvcGVydHkob3JpZW50YXRpb24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgc2Vzc2lvbi5vblsnYXIuanNhcnRvb2xraXQuYWRkTWFya2VyJ10gPSAobXNnKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCIqKiogYXIuanNhcnRvb2xraXQuYWRkTWFya2VyICoqKlwiKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIioqKiB1cmw6IFwiICsgbXNnLnVybCk7XG4gICAgICAgICAgICAgICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlPE1lc3NhZ2U+KChyZXNvbHZlLCByZWplY3QpPT57XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2FyQ29udHJvbGxlci5sb2FkTWFya2VyKG1zZy51cmwsIChtYXJrZXJJZCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogaGFuZGxlIHNpemUgb2YgbWFya2Vyc1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gdGhpcy5fZ2V0SWRGb3JNYXJrZXIobWFya2VySWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVudGl0eSA9IG5ldyBFbnRpdHkoe2lkfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHRTZXJ2aWNlLmVudGl0aWVzLmFkZChlbnRpdHkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbWFya2VyRW50aXRpZXMuc2V0KGlkLCBlbnRpdHkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh7aWQ6IGlkfSk7XG4gICAgICAgICAgICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIFRPRE86IGFkZCBzdXBwb3J0IGZvciBiYXJjb2RlIG1hcmtlcnMgYW5kIG11bHRpbWFya2Vyc1xuXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFNldHVwIGV2ZXJ5dGhpbmcgYWZ0ZXIgY29ubmVjdGVkIHRvIHRoZSBtYW5hZ2VyLiBUaGUgbWFuYWdlciBvbmx5IGNvbm5lY3RzIG9uY2UuXG4gICAgICAgIGNoaWxkU2Vzc2lvblNlcnZpY2UubWFuYWdlci5jb25uZWN0RXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoKT0+e1xuXG4gICAgICAgICAgICAvLyBzaW5jZSB3ZSBhcmVuJ3QgY3JlYXRlIGEgY2hpbGQgdmlldyBzZXJ2aWNlIGFuZCB2aWV3cG9ydCBzZXJ2aWNlLCBcbiAgICAgICAgICAgIC8vIHN1cHByZXNzIGFueSBlcnJvcnMgZnJvbSBub3QgaGFuZGxpbmcgdGhlc2UgbWVzc2FnZXNcbiAgICAgICAgICAgIGNoaWxkU2Vzc2lvblNlcnZpY2UubWFuYWdlci5zdXBwcmVzc0Vycm9yT25Vbmtub3duVG9waWMgPSB0cnVlO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBzY3JhdGNoUXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uO1xuICAgICAgICAgICAgY29uc3Qgc2NyYXRjaFF1YXRlcm5pb25EcmFnWWF3ID0gbmV3IFF1YXRlcm5pb247XG4gICAgICAgICAgICAvLyBjb25zdCBwaXRjaFF1YXQgPSBuZXcgUXVhdGVybmlvbjtcbiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uU2NyYXRjaENhcnRlc2lhbiA9IG5ldyBDYXJ0ZXNpYW4zO1xuICAgICAgICAgICAgY29uc3QgbW92ZW1lbnRTY3JhdGNoQ2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjM7XG4gICAgICAgICAgICBjb25zdCBvcmllbnRhdGlvbk1hdHJpeCA9IG5ldyBNYXRyaXgzO1xuICAgICAgICAgICAgY29uc3QgdXAgPSBuZXcgQ2FydGVzaWFuMygwLDAsMSk7XG4gICAgICAgICAgICBjb25zdCByaWdodCA9IG5ldyBDYXJ0ZXNpYW4zKDEsMCwwKTtcbiAgICAgICAgICAgIGNvbnN0IGZvcndhcmQgPSBuZXcgQ2FydGVzaWFuMygwLC0xLDApO1xuICAgICAgICAgICAgY29uc3Qgc2NyYXRjaEZydXN0dW0gPSBuZXcgUGVyc3BlY3RpdmVGcnVzdHVtKCk7XG5cbiAgICAgICAgICAgIGNvbnN0IGRldmljZVN0YWdlID0gY2hpbGREZXZpY2VTZXJ2aWNlLnN0YWdlO1xuICAgICAgICAgICAgY29uc3QgZGV2aWNlVXNlciA9IGNoaWxkRGV2aWNlU2VydmljZS51c2VyO1xuXG4gICAgICAgICAgICBjb25zdCBORUdBVElWRV9VTklUX1ogPSBuZXcgQ2FydGVzaWFuMygwLDAsLTEpO1xuICAgICAgICAgICAgLy8gY29uc3QgWF85MFJPVCA9IFF1YXRlcm5pb24uZnJvbUF4aXNBbmdsZShDYXJ0ZXNpYW4zLlVOSVRfWCwgQ2VzaXVtTWF0aC5QSV9PVkVSX1RXTyk7XG5cbiAgICAgICAgICAgIGNvbnN0IHN1YnZpZXdzOlNlcmlhbGl6ZWRTdWJ2aWV3TGlzdCA9IFtdO1xuXG4gICAgICAgICAgICBjb25zdCBkZXZpY2VVc2VyUG9zZSA9IGNoaWxkQ29udGV4dFNlcnZpY2UuY3JlYXRlRW50aXR5UG9zZShkZXZpY2VVc2VyLCBkZXZpY2VTdGFnZSk7XG5cblxuICAgICAgICAgICAgY29uc3QgY2hlY2tTdWdnZXN0ZWRHZW9sb2NhdGlvblN1YnNjcmlwdGlvbiA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoY2hpbGREZXZpY2VTZXJ2aWNlLnN1Z2dlc3RlZEdlb2xvY2F0aW9uU3Vic2NyaXB0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIGNoaWxkRGV2aWNlU2VydmljZS5zdWJzY3JpYmVHZW9sb2NhdGlvbihjaGlsZERldmljZVNlcnZpY2Uuc3VnZ2VzdGVkR2VvbG9jYXRpb25TdWJzY3JpcHRpb24pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNoaWxkRGV2aWNlU2VydmljZS51bnN1YnNjcmliZUdlb2xvY2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjaGVja1N1Z2dlc3RlZEdlb2xvY2F0aW9uU3Vic2NyaXB0aW9uKCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHJlbW92ZTEgPSBjaGlsZERldmljZVNlcnZpY2Uuc3VnZ2VzdGVkR2VvbG9jYXRpb25TdWJzY3JpcHRpb25DaGFuZ2VFdmVudC5hZGRFdmVudExpc3RlbmVyKGNoZWNrU3VnZ2VzdGVkR2VvbG9jYXRpb25TdWJzY3JpcHRpb24pO1xuXG4gICAgICAgICAgICBjb25zdCByZW1vdmUyID0gY2hpbGREZXZpY2VTZXJ2aWNlLmZyYW1lU3RhdGVFdmVudC5hZGRFdmVudExpc3RlbmVyKChmcmFtZVN0YXRlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGNoaWxkU2Vzc2lvblNlcnZpY2UubWFuYWdlci5pc0Nsb3NlZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNvbnN0IGFnZ3JlZ2F0b3IgPSB0aGlzLl9hZ2dyZWdhdG9yO1xuICAgICAgICAgICAgICAgIGNvbnN0IGZsYWdzID0gdGhpcy5fbW92ZUZsYWdzO1xuXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzUHJlc2VudGluZykge1xuICAgICAgICAgICAgICAgICAgICBhZ2dyZWdhdG9yICYmIGFnZ3JlZ2F0b3IucmVzZXQoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIFNlcmlhbGl6ZWRTdWJ2aWV3TGlzdC5jbG9uZShmcmFtZVN0YXRlLnN1YnZpZXdzLCBzdWJ2aWV3cyk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gcHJvdmlkZSBmb3YgY29udHJvbHNcbiAgICAgICAgICAgICAgICBpZiAoIWNoaWxkRGV2aWNlU2VydmljZS5zdHJpY3QpIHsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBkZWNvbXBvc2VQZXJzcGVjdGl2ZVByb2plY3Rpb25NYXRyaXgoc3Vidmlld3NbMF0ucHJvamVjdGlvbk1hdHJpeCwgc2NyYXRjaEZydXN0dW0pO1xuICAgICAgICAgICAgICAgICAgICBzY3JhdGNoRnJ1c3R1bS5mb3YgPSBjaGlsZFZpZXdTZXJ2aWNlLnN1YnZpZXdzWzBdICYmIGNoaWxkVmlld1NlcnZpY2Uuc3Vidmlld3NbMF0uZnJ1c3R1bS5mb3YgfHwgQ2VzaXVtTWF0aC5QSV9PVkVSX1RIUkVFO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChhZ2dyZWdhdG9yICYmIGFnZ3JlZ2F0b3IuaXNNb3ZpbmcoQ2FtZXJhRXZlbnRUeXBlLldIRUVMKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd2hlZWxNb3ZlbWVudCA9IGFnZ3JlZ2F0b3IuZ2V0TW92ZW1lbnQoQ2FtZXJhRXZlbnRUeXBlLldIRUVMKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpZmYgPSB3aGVlbE1vdmVtZW50LmVuZFBvc2l0aW9uLnk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzY3JhdGNoRnJ1c3R1bS5mb3YgPSBNYXRoLm1pbihNYXRoLm1heChzY3JhdGNoRnJ1c3R1bS5mb3YgLSBkaWZmICogMC4wMiwgTWF0aC5QSS84KSwgTWF0aC5QSS1NYXRoLlBJLzgpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGFnZ3JlZ2F0b3IgJiYgYWdncmVnYXRvci5pc01vdmluZyhDYW1lcmFFdmVudFR5cGUuUElOQ0gpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwaW5jaE1vdmVtZW50OlBpbmNoTW92ZW1lbnQgPSBhZ2dyZWdhdG9yLmdldE1vdmVtZW50KENhbWVyYUV2ZW50VHlwZS5QSU5DSCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaWZmID0gcGluY2hNb3ZlbWVudC5kaXN0YW5jZS5lbmRQb3NpdGlvbi55IC0gcGluY2hNb3ZlbWVudC5kaXN0YW5jZS5zdGFydFBvc2l0aW9uLnk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzY3JhdGNoRnJ1c3R1bS5mb3YgPSBNYXRoLm1pbihNYXRoLm1heChzY3JhdGNoRnJ1c3R1bS5mb3YgLSBkaWZmICogMC4wMiwgTWF0aC5QSS84KSwgTWF0aC5QSS1NYXRoLlBJLzgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBzdWJ2aWV3cy5mb3JFYWNoKChzKT0+eyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhc3BlY3QgPSBzLnZpZXdwb3J0LndpZHRoIC8gcy52aWV3cG9ydC5oZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBzY3JhdGNoRnJ1c3R1bS5hc3BlY3RSYXRpbyA9IGlzRmluaXRlKGFzcGVjdCkgPyBhc3BlY3QgOiAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgTWF0cml4NC5jbG9uZShzY3JhdGNoRnJ1c3R1bS5wcm9qZWN0aW9uTWF0cml4LCBzLnByb2plY3Rpb25NYXRyaXgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogcmVtb3ZlIGxvZ2ljIGFib3ZlLCBidXQgbm90ZSB0aGF0IF9hcnRvb2xraXRQcm9qZWN0aW9uIGlzIG5vdCBpbW1lZGlhdGVseSByZWFkeVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FydG9vbGtpdFByb2plY3Rpb24pIE1hdHJpeDQuY2xvbmUodGhpcy5fYXJ0b29sa2l0UHJvamVjdGlvbiwgcy5wcm9qZWN0aW9uTWF0cml4KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IGZyYW1lU3RhdGUudGltZTtcblxuICAgICAgICAgICAgICAgIGRldmljZVVzZXJQb3NlLnVwZGF0ZSh0aW1lKTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IG92ZXJyaWRlVXNlciA9ICEoZGV2aWNlVXNlclBvc2Uuc3RhdHVzICYgUG9zZVN0YXR1cy5LTk9XTik7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gcHJvdmlkZSBjb250cm9scyBpZiB0aGUgZGV2aWNlIGRvZXMgbm90IGhhdmUgYSBwaHlzaWNhbCBwb3NlXG4gICAgICAgICAgICAgICAgaWYgKG92ZXJyaWRlVXNlcikge1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udGV4dFVzZXIgPSBjaGlsZENvbnRleHRTZXJ2aWNlLnVzZXI7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRleHRTdGFnZSA9IGNoaWxkQ29udGV4dFNlcnZpY2Uuc3RhZ2U7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBcbiAgICAgICAgICAgICAgICAgICAgICAgIGdldEVudGl0eVBvc2l0aW9uSW5SZWZlcmVuY2VGcmFtZShjb250ZXh0VXNlciwgdGltZSwgY29udGV4dFN0YWdlLCBwb3NpdGlvblNjcmF0Y2hDYXJ0ZXNpYW4pIHx8IFxuICAgICAgICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuMy5mcm9tRWxlbWVudHMoMCwgY2hpbGREZXZpY2VTZXJ2aWNlLnN1Z2dlc3RlZFVzZXJIZWlnaHQsIDAsIHBvc2l0aW9uU2NyYXRjaENhcnRlc2lhbik7XG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IG9yaWVudGF0aW9uID0gZ2V0RW50aXR5T3JpZW50YXRpb25JblJlZmVyZW5jZUZyYW1lKGNvbnRleHRVc2VyLCB0aW1lLCBjb250ZXh0U3RhZ2UsIHNjcmF0Y2hRdWF0ZXJuaW9uKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgUXVhdGVybmlvbi5jbG9uZShRdWF0ZXJuaW9uLklERU5USVRZLCBzY3JhdGNoUXVhdGVybmlvbik7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoYWdncmVnYXRvciAmJiBhZ2dyZWdhdG9yLmlzTW92aW5nKENhbWVyYUV2ZW50VHlwZS5MRUZUX0RSQUcpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkcmFnTW92ZW1lbnQgPSBhZ2dyZWdhdG9yLmdldE1vdmVtZW50KENhbWVyYUV2ZW50VHlwZS5MRUZUX0RSQUcpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob3JpZW50YXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zdCBkcmFnUGl0Y2ggPSBRdWF0ZXJuaW9uLmZyb21BeGlzQW5nbGUoQ2FydGVzaWFuMy5VTklUX1gsIGZydXN0dW0uZm92ICogKGRyYWdNb3ZlbWVudC5lbmRQb3NpdGlvbi55IC0gZHJhZ01vdmVtZW50LnN0YXJ0UG9zaXRpb24ueSkgLyBhcHAudmlldy5nZXRWaWV3cG9ydCgpLmhlaWdodCwgc2NyYXRjaFF1YXRlcm5pb25EcmFnUGl0Y2gpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRyYWdZYXcgPSBRdWF0ZXJuaW9uLmZyb21BeGlzQW5nbGUoQ2FydGVzaWFuMy5VTklUX1ksIHNjcmF0Y2hGcnVzdHVtLmZvdiAqIChkcmFnTW92ZW1lbnQuZW5kUG9zaXRpb24ueCAtIGRyYWdNb3ZlbWVudC5zdGFydFBvc2l0aW9uLngpIC8gZnJhbWVTdGF0ZS52aWV3cG9ydC53aWR0aCwgc2NyYXRjaFF1YXRlcm5pb25EcmFnWWF3KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zdCBkcmFnID0gUXVhdGVybmlvbi5tdWx0aXBseShkcmFnUGl0Y2gsIGRyYWdZYXcsIGRyYWdZYXcpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZW50YXRpb24gPSBRdWF0ZXJuaW9uLm11bHRpcGx5KG9yaWVudGF0aW9uLCBkcmFnWWF3LCBkcmFnWWF3KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoPGFueT5jb250ZXh0VXNlci5vcmllbnRhdGlvbikuc2V0VmFsdWUob3JpZW50YXRpb24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgTWF0cml4My5mcm9tUXVhdGVybmlvbihvcmllbnRhdGlvbiwgb3JpZW50YXRpb25NYXRyaXgpO1xuICAgICAgICAgICAgICAgICAgICBNYXRyaXgzLm11bHRpcGx5QnlWZWN0b3Iob3JpZW50YXRpb25NYXRyaXgsIENhcnRlc2lhbjMuVU5JVF9ZLCB1cCk7XG4gICAgICAgICAgICAgICAgICAgIE1hdHJpeDMubXVsdGlwbHlCeVZlY3RvcihvcmllbnRhdGlvbk1hdHJpeCwgQ2FydGVzaWFuMy5VTklUX1gsIHJpZ2h0KTtcbiAgICAgICAgICAgICAgICAgICAgTWF0cml4My5tdWx0aXBseUJ5VmVjdG9yKG9yaWVudGF0aW9uTWF0cml4LCBORUdBVElWRV9VTklUX1osIGZvcndhcmQpO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1vdmVSYXRlID0gMC4wMjtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWdzLm1vdmVGb3J3YXJkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zLm11bHRpcGx5QnlTY2FsYXIoZm9yd2FyZCwgbW92ZVJhdGUsIG1vdmVtZW50U2NyYXRjaENhcnRlc2lhbik7XG4gICAgICAgICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zLmFkZChwb3NpdGlvbiwgbW92ZW1lbnRTY3JhdGNoQ2FydGVzaWFuLCBwb3NpdGlvbik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWdzLm1vdmVCYWNrd2FyZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuMy5tdWx0aXBseUJ5U2NhbGFyKGZvcndhcmQsIC1tb3ZlUmF0ZSwgbW92ZW1lbnRTY3JhdGNoQ2FydGVzaWFuKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjMuYWRkKHBvc2l0aW9uLCBtb3ZlbWVudFNjcmF0Y2hDYXJ0ZXNpYW4sIHBvc2l0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoZmxhZ3MubW92ZVVwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zLm11bHRpcGx5QnlTY2FsYXIodXAsIG1vdmVSYXRlLCBtb3ZlbWVudFNjcmF0Y2hDYXJ0ZXNpYW4pO1xuICAgICAgICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuMy5hZGQocG9zaXRpb24sIG1vdmVtZW50U2NyYXRjaENhcnRlc2lhbiwgcG9zaXRpb24pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChmbGFncy5tb3ZlRG93bikge1xuICAgICAgICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuMy5tdWx0aXBseUJ5U2NhbGFyKHVwLCAtbW92ZVJhdGUsIG1vdmVtZW50U2NyYXRjaENhcnRlc2lhbik7XG4gICAgICAgICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zLmFkZChwb3NpdGlvbiwgbW92ZW1lbnRTY3JhdGNoQ2FydGVzaWFuLCBwb3NpdGlvbik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWdzLm1vdmVMZWZ0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zLm11bHRpcGx5QnlTY2FsYXIocmlnaHQsIC1tb3ZlUmF0ZSwgbW92ZW1lbnRTY3JhdGNoQ2FydGVzaWFuKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjMuYWRkKHBvc2l0aW9uLCBtb3ZlbWVudFNjcmF0Y2hDYXJ0ZXNpYW4sIHBvc2l0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoZmxhZ3MubW92ZVJpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zLm11bHRpcGx5QnlTY2FsYXIocmlnaHQsIG1vdmVSYXRlLCBtb3ZlbWVudFNjcmF0Y2hDYXJ0ZXNpYW4pO1xuICAgICAgICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuMy5hZGQocG9zaXRpb24sIG1vdmVtZW50U2NyYXRjaENhcnRlc2lhbiwgcG9zaXRpb24pO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgKGNvbnRleHRVc2VyLnBvc2l0aW9uIGFzIENvbnN0YW50UG9zaXRpb25Qcm9wZXJ0eSkuc2V0VmFsdWUocG9zaXRpb24sIGNvbnRleHRTdGFnZSk7XG4gICAgICAgICAgICAgICAgICAgIChjb250ZXh0VXNlci5vcmllbnRhdGlvbiBhcyBDb25zdGFudFByb3BlcnR5KS5zZXRWYWx1ZShvcmllbnRhdGlvbik7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc3Qgb3ZlcnJpZGVTdGFnZSA9IGN1c3RvbVN0YWdlUG9zaXRpb27CoCYmIGN1c3RvbVN0YWdlT3JpZW50YXRpb24gPyB0cnVlIDogZmFsc2U7XG5cbiAgICAgICAgICAgICAgICBpZiAob3ZlcnJpZGVTdGFnZSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb250ZXh0U3RhZ2UgPSBjaGlsZENvbnRleHRTZXJ2aWNlLnN0YWdlO1xuICAgICAgICAgICAgICAgICAgICAoY29udGV4dFN0YWdlLnBvc2l0aW9uIGFzIENvbnN0YW50UG9zaXRpb25Qcm9wZXJ0eSkuc2V0VmFsdWUoY3VzdG9tU3RhZ2VQb3NpdGlvbiwgUmVmZXJlbmNlRnJhbWUuRklYRUQpO1xuICAgICAgICAgICAgICAgICAgICAoY29udGV4dFN0YWdlLm9yaWVudGF0aW9uIGFzIENvbnN0YW50UHJvcGVydHkpLnNldFZhbHVlKGN1c3RvbVN0YWdlT3JpZW50YXRpb24pO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hclNjZW5lKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2V0TWFya2VycygpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9hclNjZW5lLnByb2Nlc3MoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYXJTY2VuZS5yZW5kZXJPbih0aGlzLl9yZW5kZXJlcik7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc3QgY29udGV4dEZyYW1lU3RhdGUgPSBjaGlsZENvbnRleHRTZXJ2aWNlLmNyZWF0ZUZyYW1lU3RhdGUoXG4gICAgICAgICAgICAgICAgICAgIHRpbWUsXG4gICAgICAgICAgICAgICAgICAgIGZyYW1lU3RhdGUudmlld3BvcnQsXG4gICAgICAgICAgICAgICAgICAgIHN1YnZpZXdzLFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvdmVycmlkZVVzZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICBvdmVycmlkZVN0YWdlLFxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlclRyYWNraW5nOiB0aGlzLnVzZXJUcmFja2luZ1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBjaGlsZENvbnRleHRTZXJ2aWNlLnN1Ym1pdEZyYW1lU3RhdGUoY29udGV4dEZyYW1lU3RhdGUpO1xuXG4gICAgICAgICAgICAgICAgYWdncmVnYXRvciAmJiBhZ2dyZWdhdG9yLnJlc2V0KCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgY2hpbGRTZXNzaW9uU2VydmljZS5tYW5hZ2VyLmNsb3NlRXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoKT0+e1xuICAgICAgICAgICAgICAgIHJlbW92ZTEoKTtcbiAgICAgICAgICAgICAgICByZW1vdmUyKCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9KVxuXG5cbiAgICAgICAgY2hpbGRTZXNzaW9uU2VydmljZS5jb25uZWN0KCk7XG4gICAgfVxuXG5cbiAgICBwcml2YXRlIF9nZXRJZEZvck1hcmtlcihtYXJrZXJVSUQpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gXCJqc2FydG9vbGtpdF9tYXJrZXJfXCIgKyBtYXJrZXJVSUQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcmVzZXRNYXJrZXJzKCkge1xuICAgICAgICAvLyBqc2FydG9vbGtpdCBkb2VzIG5vdCBjdXJyZW50bHkgaGF2ZSBhIG1hcmtlciBsb3N0IGV2ZW50XG4gICAgICAgIC8vIGZvciBub3csIGNsZWFyIHBvc2VzIGVhY2ggZnJhbWUgYmVmb3JlIHByb2Nlc3NpbmdcbiAgICAgICAgdGhpcy5fbWFya2VyRW50aXRpZXMuZm9yRWFjaCgoZW50aXR5LCBpZCwgbWFwKSA9PiB7XG4gICAgICAgICAgICBlbnRpdHkucG9zaXRpb24gPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICBlbnRpdHkub3JpZW50YXRpb24gPSB1bmRlZmluZWQ7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBpbml0QVJUb29sS2l0KCk6UHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAvLyBmb3Igbm93IHdlJ3JlIGR5bmFtaWNhbGx5IGxvYWRpbmcgdGhlc2Ugc2NyaXB0c1xuICAgICAgICAgICAgdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xuICAgICAgICAgICAgc2NyaXB0LnNyYyA9ICdodHRwczovL3Jhd2dpdC5jb20vYmxhaXJtYWNpbnR5cmUvanNhcnRvb2xraXQ1L21hc3Rlci9idWlsZC9hcnRvb2xraXQubWluLmpzJztcbiAgICAgICAgICAgIHNjcmlwdC5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCIqKiogYXJ0b29sa2l0Lm1pbi5qcyBsb2FkZWQgKioqXCIpO1xuICAgICAgICAgICAgICAgIHZhciBzY3JpcHQyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XG4gICAgICAgICAgICAgICAgc2NyaXB0Mi5zcmMgPSAnaHR0cHM6Ly9yYXdnaXQuY29tL2JsYWlybWFjaW50eXJlL2pzYXJ0b29sa2l0NS9tYXN0ZXIvanMvYXJ0b29sa2l0LmFwaS5qcyc7XG4gICAgICAgICAgICAgICAgc2NyaXB0Mi5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiKioqIGFydG9vbGtpdC5hcGkuanMgbG9hZGVkICoqKlwiKTtcbiAgICAgICAgICAgICAgICAgICAgaW50ZWdyYXRlQ3VzdG9tQVJUb29sS2l0KCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5pdEFSQ29udHJvbGxlcigpLnRoZW4oKCk9PntcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGluaXRBUkNvbnRyb2xsZXIoKTpQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIEFSQ29udHJvbGxlci5nZXRVc2VyTWVkaWFUaHJlZVNjZW5lKHt3aWR0aDogMjQwLCBoZWlnaHQ6IDI0MCwgY2FtZXJhUGFyYW06IDQ1ICogTWF0aC5QSSAvIDE4MCxcbiAgICAgICAgICAgICAgICBvblN1Y2Nlc3M6IChhclNjZW5lLCBhckNvbnRyb2xsZXIsIGFyQ2FtZXJhKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiKioqIGdldFVzZXJNZWRpYVRocmVlU2NlbmUgc3VjY2VzcyAqKipcIik7XG5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYXJTY2VuZSA9IGFyU2NlbmU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2FyQ29udHJvbGxlciA9IGFyQ29udHJvbGxlcjtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVWaWV3cG9ydCg8YW55PnRoaXMudmlld1NlcnZpY2Uudmlld3BvcnQpO1xuXG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NOYW1lID0gYXJDb250cm9sbGVyLm9yaWVudGF0aW9uO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ29uQ2FudmFzO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy52aWV3U2VydmljZS5sYXllcnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgbGF5ZXIgb2YgdGhpcy52aWV3U2VydmljZS5sYXllcnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGF5ZXIuc291cmNlIGluc3RhbmNlb2YgSFRNTENhbnZhc0VsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnb25DYW52YXMgPSBsYXllci5zb3VyY2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNTaGFyZWRDYW52YXMgJiYgIWFyZ29uQ2FudmFzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInNoYXJlZENhbnZhcyBpcyB0cnVlIGJ1dCBubyBjYW52YXMgcmVnaXN0ZXJlZCB3aXRoIHNldExheWVyc1wiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vdGhpcy5fc2hhcmVkQ2FudmFzID0gZmFsc2U7IC8vIGN1cnJlbnRseSB0aGUgUmVhbGl0eVNlcnZpY2VQcm92aWRlciBvdmVyd3JpdGVzIHRoaXMgZWFjaCBmcmFtZVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNTaGFyZWRDYW52YXMgJiYgYXJnb25DYW52YXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZvdW5kIGFuIGV4aXN0aW5nIGNhbnZhcywgdXNlIGl0XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkZvdW5kIGFyZ29uIGNhbnZhcywgdmlkZW8gYmFja2dyb3VuZCBpcyBzaGFyaW5nIGl0cyBjb250ZXh0XCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVuZGVyZXIgPSBuZXcgVEhSRUUuV2ViR0xSZW5kZXJlcih7Y2FudmFzOiBhcmdvbkNhbnZhcywgYW50aWFsaWFzOiBmYWxzZX0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2hhcmVkQ2FudmFzRmluYWwgPSB0cnVlO1xuXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBubyBjYW52YXMsIGNyZWF0ZSBhIG5ldyBvbmVcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiTm8gYXJnb24gc2hhcmVkIGNhbnZhcywgY3JlYXRpbmcgb25lIGZvciB2aWRlbyBiYWNrZ3JvdW5kXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlbmRlcmVyID0gbmV3IFRIUkVFLldlYkdMUmVuZGVyZXIoe2FudGlhbGlhczogZmFsc2V9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyLnNldFNpemUodGhpcy52aWV3U2VydmljZS5yZW5kZXJXaWR0aCwgdGhpcy52aWV3U2VydmljZS5yZW5kZXJIZWlnaHQsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52aWV3U2VydmljZS5lbGVtZW50Lmluc2VydEJlZm9yZShyZW5kZXJlci5kb21FbGVtZW50LCB0aGlzLnZpZXdTZXJ2aWNlLmVsZW1lbnQuZmlyc3RDaGlsZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJlci5kb21FbGVtZW50LnN0eWxlLnpJbmRleCA9ICcwJztcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbmRlcmVyID0gcmVuZGVyZXI7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zaGFyZWRDYW52YXNGaW5hbCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgb25FcnJvcjogKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCB1cGRhdGVWaWV3cG9ydCh2aWV3cG9ydDpDYW52YXNWaWV3cG9ydCkge1xuICAgICAgICBpZiAoIXRoaXMuX2FyQ29udHJvbGxlcikgcmV0dXJuO1xuICAgICAgICBjb25zb2xlLmxvZyhcInVwZGF0ZVZpZXdwb3J0IHNpemU6IFwiICsgdmlld3BvcnQud2lkdGggKyBcIiwgXCIgKyB2aWV3cG9ydC5oZWlnaHQpO1xuICAgICAgICBjb25zb2xlLmxvZyhcImNhbWVyYSBpbWFnZSBzaXplOiBcIiArIHRoaXMuX2FyQ29udHJvbGxlci5pbWFnZS52aWRlb1dpZHRoICsgXCIsIFwiICsgdGhpcy5fYXJDb250cm9sbGVyLmltYWdlLnZpZGVvSGVpZ2h0KTtcbiAgICAgICAgbGV0IGNhbnZhc0FzcGVjdCA9IHZpZXdwb3J0LndpZHRoIC8gdmlld3BvcnQuaGVpZ2h0O1xuICAgICAgICBsZXQgY2FtZXJhQXNwZWN0ID0gdGhpcy5fYXJDb250cm9sbGVyLmltYWdlLnZpZGVvV2lkdGggLyB0aGlzLl9hckNvbnRyb2xsZXIuaW1hZ2UudmlkZW9IZWlnaHQ7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiY2FudmFzQXNwZWN0OiBcIiArIGNhbnZhc0FzcGVjdCk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiY2FtZXJhQXNwZWN0OiBcIiArIGNhbWVyYUFzcGVjdCk7XG4gICAgICAgIC8vIFNjYWxlIHRoZSB2aWRlbyBwbGFuZSB0byBhc3BlY3QgZmlsbCB0aGUgc2NyZWVuXG4gICAgICAgIGlmIChjYW52YXNBc3BlY3QgPiBjYW1lcmFBc3BlY3QpIHtcbiAgICAgICAgICAgIC8vIGNhbnZhcyBpcyB3aWRlciB0aGFuIGNhbWVyYSBpbWFnZVxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJjYW52YXMgaXMgd2lkZXIgdGhhbiBjYW1lcmEgaW1hZ2VcIik7XG4gICAgICAgICAgICB0aGlzLl9hclNjZW5lLnZpZGVvUGxhbmUuc2NhbGUueCA9IDE7XG4gICAgICAgICAgICB0aGlzLl9hclNjZW5lLnZpZGVvUGxhbmUuc2NhbGUueSA9IGNhbnZhc0FzcGVjdC9jYW1lcmFBc3BlY3Q7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBjYW1lcmEgaW1hZ2UgaXMgd2lkZXIgdGhhbiBjYW52YXNcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiY2FtZXJhIGltYWdlIGlzIHdpZGVyIHRoYW4gY2FudmFzXCIpO1xuICAgICAgICAgICAgdGhpcy5fYXJTY2VuZS52aWRlb1BsYW5lLnNjYWxlLnggPSBjYW1lcmFBc3BlY3QvY2FudmFzQXNwZWN0O1xuICAgICAgICAgICAgdGhpcy5fYXJTY2VuZS52aWRlb1BsYW5lLnNjYWxlLnkgPSAxO1xuICAgICAgICB9XG4gICAgICAgIC8vIFJlc2l6ZSB0aGUgY2FudmFzIGlmIHdlIG93biBpdFxuICAgICAgICBpZiAoIXRoaXMuX3NoYXJlZENhbnZhc0ZpbmFsICYmIHRoaXMuX3JlbmRlcmVyKSB7XG4gICAgICAgICAgICB0aGlzLl9yZW5kZXJlci5zZXRTaXplKHRoaXMudmlld1NlcnZpY2UucmVuZGVyV2lkdGgsIHRoaXMudmlld1NlcnZpY2UucmVuZGVySGVpZ2h0LCB0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnVwZGF0ZVByb2plY3Rpb24odmlld3BvcnQpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCB1cGRhdGVQcm9qZWN0aW9uKHZpZXdwb3J0OkNhbnZhc1ZpZXdwb3J0KSB7XG4gICAgICAgIGNvbnN0IHNjcmF0Y2hGcnVzdHVtID0gbmV3IFBlcnNwZWN0aXZlRnJ1c3R1bSgpO1xuICAgICAgICB2YXIgcHJvak1hdHJpeCA9IE1hdHJpeDQuZnJvbUFycmF5KHRoaXMuX2FyQ29udHJvbGxlci5nZXRDYW1lcmFNYXRyaXgoKSk7XG5cbiAgICAgICAgY29uc29sZS5sb2coXCJBUlRvb2xLaXQgcHJvamVjdGlvbjpcIilcbiAgICAgICAgY29uc29sZS5sb2coTWF0cml4NC50b0FycmF5KHByb2pNYXRyaXgpKTsgLy8gdG9TdHJpbmcgbWV0aG9kIGdpdmVzIGEgdHJhbnNwb3NlZCBtYXRyaXghIHRoaXMgaXMgYSBzYWZlciB3YXkgdG8gcHJpbnRcblxuICAgICAgICAvLyB0aGlzIGlzIHJlcXVpcmVkIGZvciBDZXNpdW0gdG8gYWNjZXB0IHRoaXMgbWF0cml4XG4gICAgICAgIHByb2pNYXRyaXhbNF0gKj0gLTE7IC8vIHhcbiAgICAgICAgcHJvak1hdHJpeFs1XSAqPSAtMTsgLy8geVxuICAgICAgICBwcm9qTWF0cml4WzZdICo9IC0xOyAvLyB6XG4gICAgICAgIHByb2pNYXRyaXhbN10gKj0gLTE7IC8vIHdcblxuICAgICAgICBwcm9qTWF0cml4WzhdICo9IC0xOyAgLy8geFxuICAgICAgICBwcm9qTWF0cml4WzldICo9IC0xOyAgLy8geVxuICAgICAgICBwcm9qTWF0cml4WzEwXSAqPSAtMTsgLy8gelxuICAgICAgICBwcm9qTWF0cml4WzExXSAqPSAtMTsgLy8gd1xuXG4gICAgICAgIGNvbnNvbGUubG9nKFwiQ2VzaXVtLXJlYWR5IHByb2plY3Rpb246XCIpO1xuICAgICAgICBjb25zb2xlLmxvZyhNYXRyaXg0LnRvQXJyYXkocHJvak1hdHJpeCkpO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkJFRk9SRTpcIik7XG4gICAgICAgICAgICBkZWNvbXBvc2VQZXJzcGVjdGl2ZVByb2plY3Rpb25NYXRyaXgocHJvak1hdHJpeCwgc2NyYXRjaEZydXN0dW0pO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJwcm9qTWF0cml4IGFzcGVjdDogXCIgKyBzY3JhdGNoRnJ1c3R1bS5hc3BlY3RSYXRpbyk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInByb2pNYXRyaXggZm92OiBcIiArIHNjcmF0Y2hGcnVzdHVtLmZvdik7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInByb2pNYXRyaXggbmVhcjogXCIgKyBzY3JhdGNoRnJ1c3R1bS5uZWFyKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicHJvak1hdHJpeCBmYXI6IFwiICsgc2NyYXRjaEZydXN0dW0uZmFyKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicHJvak1hdHJpeCBmb3Z5OiBcIiArIHNjcmF0Y2hGcnVzdHVtLmZvdnkpO1xuICAgICAgICB9IGNhdGNoKGUpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiKioqIGVycm9yOiBcIiArIGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVERPRDogYWRqdXN0IHRoZSBmb3YgaW4gY2FzZSB0aGUgY2FtZXJhIGltYWdlIGlzIG5vdCBzcXVhcmVcblxuICAgICAgICB2YXIgdmlld3BvcnRBc3BlY3QgPSB2aWV3cG9ydC53aWR0aCAvIHZpZXdwb3J0LmhlaWdodDtcbiAgICAgICAgc2NyYXRjaEZydXN0dW0uYXNwZWN0UmF0aW8gPSB2aWV3cG9ydEFzcGVjdDtcbiAgICAgICAgc2NyYXRjaEZydXN0dW0ubmVhciA9IERFRkFVTFRfTkVBUl9QTEFORTtcbiAgICAgICAgc2NyYXRjaEZydXN0dW0uZmFyID0gREVGQVVMVF9GQVJfUExBTkU7XG5cbiAgICAgICAgcHJvak1hdHJpeCA9IHNjcmF0Y2hGcnVzdHVtLnByb2plY3Rpb25NYXRyaXg7XG5cbiAgICAgICAgdGhpcy5fYXJ0b29sa2l0UHJvamVjdGlvbiA9IE1hdHJpeDQuY2xvbmUocHJvak1hdHJpeCk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQUZURVI6XCIpO1xuICAgICAgICAgICAgZGVjb21wb3NlUGVyc3BlY3RpdmVQcm9qZWN0aW9uTWF0cml4KHByb2pNYXRyaXgsIHNjcmF0Y2hGcnVzdHVtKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicHJvak1hdHJpeCBhc3BlY3Q6IFwiICsgc2NyYXRjaEZydXN0dW0uYXNwZWN0UmF0aW8pO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJwcm9qTWF0cml4IGZvdjogXCIgKyBzY3JhdGNoRnJ1c3R1bS5mb3YpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJwcm9qTWF0cml4IG5lYXI6IFwiICsgc2NyYXRjaEZydXN0dW0ubmVhcik7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInByb2pNYXRyaXggZmFyOiBcIiArIHNjcmF0Y2hGcnVzdHVtLmZhcik7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInByb2pNYXRyaXggZm92eTogXCIgKyBzY3JhdGNoRnJ1c3R1bS5mb3Z5KTtcbiAgICAgICAgfSBjYXRjaChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIioqKiBlcnJvcjogXCIgKyBlKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxudmFyIGludGVncmF0ZUN1c3RvbUFSVG9vbEtpdCA9IGZ1bmN0aW9uKCkge1xuXG4gICAgLyoqXG4gICAgICogIE92ZXJyaWRlIHRoZSBhcnRvb2xraXQuYXBpLmpzIGdldFVzZXJNZWRpYSBmdW5jdGlvbiAoaXQgaXMgb3V0IG9mIGRhdGUpXG4gICAgICogIFRoaXMgaXMgdGFrZW4gZnJvbSBBUi5qcyAoVEhSRUV4LkFyVG9vbGtpdFNvdXJjZS5wcm90b3R5cGUuX2luaXRTb3VyY2VXZWJjYW0pXG4gICAgICogKi9cbiAgICBBUkNvbnRyb2xsZXIuZ2V0VXNlck1lZGlhID0gZnVuY3Rpb24oY29uZmlndXJhdGlvbikge1xuXG5cdFx0dmFyIG9uU3VjY2VzcyA9IGNvbmZpZ3VyYXRpb24ub25TdWNjZXNzO1xuXHRcdHZhciBvbkVycm9yID0gY29uZmlndXJhdGlvbi5vbkVycm9yIHx8IGZ1bmN0aW9uKGVycikgeyBjb25zb2xlLmVycm9yKFwiQVJDb250cm9sbGVyLmdldFVzZXJNZWRpYVwiLCBlcnIpOyB9O1xuXG4gICAgICAgIC8vIFRPRE8gbWFrZSBpdCBzdGF0aWNcbiAgICAgICAgbmF2aWdhdG9yLmdldFVzZXJNZWRpYSAgPSBuYXZpZ2F0b3IuZ2V0VXNlck1lZGlhIHx8ICg8YW55Pm5hdmlnYXRvcikud2Via2l0R2V0VXNlck1lZGlhIHx8ICg8YW55Pm5hdmlnYXRvcikubW96R2V0VXNlck1lZGlhIHx8ICg8YW55Pm5hdmlnYXRvcikubXNHZXRVc2VyTWVkaWE7XG5cbiAgICAgICAgdmFyIGRvbUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd2aWRlbycpO1xuICAgICAgICBkb21FbGVtZW50LnN0eWxlLndpZHRoID0gY29uZmlndXJhdGlvbi53aWR0aCsncHgnXG4gICAgICAgIGRvbUVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gY29uZmlndXJhdGlvbi5oZWlnaHQrJ3B4J1xuXG5cbiAgICAgICAgaWYgKG5hdmlnYXRvci5nZXRVc2VyTWVkaWEgPT09IHVuZGVmaW5lZCApe1xuICAgICAgICAgICAgb25FcnJvcignYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IG5hdmlnYXRvci5nZXRVc2VyTWVkaWEnKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAobmF2aWdhdG9yLm1lZGlhRGV2aWNlcyA9PT0gdW5kZWZpbmVkIHx8IG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcyA9PT0gdW5kZWZpbmVkICl7XG4gICAgICAgICAgICBvbkVycm9yKCdicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzJyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmVudW1lcmF0ZURldmljZXMoKS50aGVuKGZ1bmN0aW9uKGRldmljZXMpIHtcbiAgICAgICAgICAgIC8vIGRlZmluZSBnZXRVc2VyTWVkaWEoKSBjb25zdHJhaW50c1xuICAgICAgICAgICAgdmFyIGNvbnN0cmFpbnRzID0ge1xuICAgICAgICAgICAgICAgIGF1ZGlvOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB2aWRlbzoge1xuICAgICAgICAgICAgICAgICAgICBtYW5kYXRvcnk6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1heFdpZHRoOiBjb25maWd1cmF0aW9uLndpZHRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgbWF4SGVpZ2h0OiBjb25maWd1cmF0aW9uLmhlaWdodFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZGV2aWNlcy5mb3JFYWNoKGZ1bmN0aW9uKGRldmljZSkge1xuICAgICAgICAgICAgICAgIGlmKCBkZXZpY2Uua2luZCAhPT0gJ3ZpZGVvaW5wdXQnIClcdHJldHVyblxuXG4gICAgICAgICAgICAgICAgLy8gVE9ETyBzdXBlciB1bmNsZWFyIGhvdyB0byBnZXQgdGhlIGJhY2t3YXJkIGZhY2luZyBjYW1lcmEuLi5cblxuICAgICAgICAgICAgICAgIC8vIE5vdGU6IHRoaXMgY29kZSBncmFicyB0aGUgbGFzdCBjYW1lcmEgaW4gdGhlIGxpc3QgKG5vdCBndWFyYW50ZWVkIHRvIGJlIHRoZSBiYWNrLWZhY2luZyBvbmUsIGJ1dCBpdCBzZWVtcyB0byB3b3JrKVxuXG4gICAgICAgICAgICAgICAgLy9pZiggY29uc3RyYWludHMudmlkZW8ub3B0aW9uYWwgIT09IHVuZGVmaW5lZCApXHRyZXR1cm5cbiAgICAgICAgICAgICAgICAoPGFueT5jb25zdHJhaW50cy52aWRlbykub3B0aW9uYWwgPSBbe3NvdXJjZUlkOiBkZXZpY2UuZGV2aWNlSWR9XVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIC8vIE9MRCBBUElcbiAgICAgICAgICAgICAgICAgICAgLy8gaXQgaXQgZmluZHMgdGhlIHZpZGVvU291cmNlICdlbnZpcm9ubWVudCcsIG1vZGlmeSBjb25zdHJhaW50cy52aWRlb1xuICAgICAgICAgICAgICAgICAgICAvLyBmb3IgKHZhciBpID0gMDsgaSAhPSBzb3VyY2VJbmZvcy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgIHZhciBzb3VyY2VJbmZvID0gc291cmNlSW5mb3NbaV07XG4gICAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgaWYoc291cmNlSW5mby5raW5kID09IFwidmlkZW9cIiAmJiBzb3VyY2VJbmZvLmZhY2luZyA9PSBcImVudmlyb25tZW50XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgIGNvbnN0cmFpbnRzLnZpZGVvLm9wdGlvbmFsID0gW3tzb3VyY2VJZDogc291cmNlSW5mby5pZH1dXG4gICAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvLyB9XG5cbiAgICAgICAgICAgIG5hdmlnYXRvci5nZXRVc2VyTWVkaWEoPGFueT5jb25zdHJhaW50cywgZnVuY3Rpb24gc3VjY2VzcyhzdHJlYW0pIHtcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnc3VjY2VzcycsIHN0cmVhbSk7XG4gICAgICAgICAgICAgICAgZG9tRWxlbWVudC5zcmMgPSB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChzdHJlYW0pO1xuICAgICAgICAgICAgICAgIC8vIHRvIHN0YXJ0IHRoZSB2aWRlbywgd2hlbiBpdCBpcyBwb3NzaWJsZSB0byBzdGFydCBpdCBvbmx5IG9uIHVzZXJldmVudC4gbGlrZSBpbiBhbmRyb2lkXG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAgICAgICAgIGRvbUVsZW1lbnQucGxheSgpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLy8gZG9tRWxlbWVudC5wbGF5KCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAvL3dhaXQgdW50aWwgdGhlIHZpZGVvIHN0cmVhbSBpcyByZWFkeVxuICAgICAgICAgICAgICAgIHZhciBpbnRlcnZhbCA9IHNldEludGVydmFsKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWRvbUVsZW1lbnQudmlkZW9XaWR0aClcdHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJ2aWRlbyBlbGVtZW50OiBcIiArIGRvbUVsZW1lbnQudmlkZW9XaWR0aCArIFwiLCBcIiArIGRvbUVsZW1lbnQudmlkZW9IZWlnaHQpO1xuICAgICAgICAgICAgICAgICAgICAvL29uUmVhZHkoKVxuICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3MoZG9tRWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWwpXG4gICAgICAgICAgICAgICAgfSwgMTAwMC81MCk7XG4gICAgICAgICAgICB9LCBmdW5jdGlvbihlcnJvcikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQ2FuJ3QgYWNjZXNzIHVzZXIgbWVkaWFcIiwgZXJyb3IpO1xuICAgICAgICAgICAgICAgIGFsZXJ0KFwiQ2FuJ3QgYWNjZXNzIHVzZXIgbWVkaWEgOigpXCIpO1xuICAgICAgICAgICAgICAgIG9uRXJyb3IoXCJDYW4ndCBhY2Nlc3MgdXNlciBtZWRpYVwiLCBlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIubmFtZSArIFwiOiBcIiArIGVyci5tZXNzYWdlKTtcbiAgICAgICAgICAgIG9uRXJyb3IoZXJyLm5hbWUgKyBcIjogXCIgKyBlcnIubWVzc2FnZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBkb21FbGVtZW50XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKiBUaGUgcmVzdCBvZiB0aGVzZSBmdW5jdGlvbnMgYXJlIHRha2VuIGRpcmVjdGx5IGZyb20gYXJ0b29sa2l0LnRocmVlLmpzXG4gICAgICogVGhpcyBpcyBhIHF1aWNrIHdheSB0byBwbGF5IHdpdGggdGhlIGNvZGUsIGJ1dCB3ZSBzaG91bGQgbW92ZSBpdCB3aGVuIGZpbmlzaGVkXG4gICAgICogQ2hhbmdlczpcbiAgICAgKiAgIC0gbWF0cml4LmVsZW1lbnRzLnNldCAtPiBtYXRyaXguZnJvbUFycmF5ICh0byBiZSBjb21wYXRpYmxlIHdpdGggbmV3ZXIgdmVyc2lvbnMgb2YgVEhSRUUpXG4gICAgICogICAtIEFkZGVkIHJlbmRlcmVyLnJlc2V0R0xTdGF0ZSgpIHRvIHRoZSBiZWdpbm5pbmcgb2YgdGhlIHJlbmRlciBwYXNzXG4gICAgICogICAtIENoYW5nZWQgdGhlIG9ydGhvZ3JhcGhpYyBjYW1lcmEgdG8gaGF2ZSBhIHVuaXQgc2l6ZWQgdmlld3BvcnRcbiAgICAgKiAgIC0gQ2hhbmdlZCB2aWRlbyBwbGFuZSB0byBhIHVuaXQgc2l6ZSBwbGFuZVxuICAgICAqL1xuXG4gICAgLyoqXG4gICAgICAgIEhlbHBlciBmb3Igc2V0dGluZyB1cCBhIFRocmVlLmpzIEFSIHNjZW5lIHVzaW5nIHRoZSBkZXZpY2UgY2FtZXJhIGFzIGlucHV0LlxuICAgICAgICBQYXNzIGluIHRoZSBtYXhpbXVtIGRpbWVuc2lvbnMgb2YgdGhlIHZpZGVvIHlvdSB3YW50IHRvIHByb2Nlc3MgYW5kIG9uU3VjY2VzcyBhbmQgb25FcnJvciBjYWxsYmFja3MuXG5cbiAgICAgICAgT24gYSBzdWNjZXNzZnVsIGluaXRpYWxpemF0aW9uLCB0aGUgb25TdWNjZXNzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIGFuIFRocmVlQVJTY2VuZSBvYmplY3QuXG4gICAgICAgIFRoZSBUaHJlZUFSU2NlbmUgb2JqZWN0IGNvbnRhaW5zIHR3byBUSFJFRS5qcyBzY2VuZXMgKG9uZSBmb3IgdGhlIHZpZGVvIGltYWdlIGFuZCBvdGhlciBmb3IgdGhlIDNEIHNjZW5lKVxuICAgICAgICBhbmQgYSBjb3VwbGUgb2YgaGVscGVyIGZ1bmN0aW9ucyBmb3IgZG9pbmcgdmlkZW8gZnJhbWUgcHJvY2Vzc2luZyBhbmQgQVIgcmVuZGVyaW5nLlxuXG4gICAgICAgIEhlcmUncyB0aGUgc3RydWN0dXJlIG9mIHRoZSBUaHJlZUFSU2NlbmUgb2JqZWN0OlxuICAgICAgICB7XG4gICAgICAgICAgICBzY2VuZTogVEhSRUUuU2NlbmUsIC8vIFRoZSAzRCBzY2VuZS4gUHV0IHlvdXIgQVIgb2JqZWN0cyBoZXJlLlxuICAgICAgICAgICAgY2FtZXJhOiBUSFJFRS5DYW1lcmEsIC8vIFRoZSAzRCBzY2VuZSBjYW1lcmEuXG5cbiAgICAgICAgICAgIGFyQ29udHJvbGxlcjogQVJDb250cm9sbGVyLFxuXG4gICAgICAgICAgICB2aWRlbzogSFRNTFZpZGVvRWxlbWVudCwgLy8gVGhlIHVzZXJNZWRpYSB2aWRlbyBlbGVtZW50LlxuXG4gICAgICAgICAgICB2aWRlb1NjZW5lOiBUSFJFRS5TY2VuZSwgLy8gVGhlIHVzZXJNZWRpYSB2aWRlbyBpbWFnZSBzY2VuZS4gU2hvd3MgdGhlIHZpZGVvIGZlZWQuXG4gICAgICAgICAgICB2aWRlb0NhbWVyYTogVEhSRUUuQ2FtZXJhLCAvLyBDYW1lcmEgZm9yIHRoZSB1c2VyTWVkaWEgdmlkZW8gc2NlbmUuXG5cbiAgICAgICAgICAgIHByb2Nlc3M6IGZ1bmN0aW9uKCksIC8vIFByb2Nlc3MgdGhlIGN1cnJlbnQgdmlkZW8gZnJhbWUgYW5kIHVwZGF0ZSB0aGUgbWFya2VycyBpbiB0aGUgc2NlbmUuXG4gICAgICAgICAgICByZW5kZXJPbjogZnVuY3Rpb24oIFRIUkVFLldlYkdMUmVuZGVyZXIgKSAvLyBSZW5kZXIgdGhlIEFSIHNjZW5lIGFuZCB2aWRlbyBiYWNrZ3JvdW5kIG9uIHRoZSBnaXZlbiBUaHJlZS5qcyByZW5kZXJlci5cbiAgICAgICAgfVxuXG4gICAgICAgIFlvdSBzaG91bGQgdXNlIHRoZSBhclNjZW5lLnZpZGVvLnZpZGVvV2lkdGggYW5kIGFyU2NlbmUudmlkZW8udmlkZW9IZWlnaHQgdG8gc2V0IHRoZSB3aWR0aCBhbmQgaGVpZ2h0IG9mIHlvdXIgcmVuZGVyZXIuXG5cbiAgICAgICAgSW4geW91ciBmcmFtZSBsb29wLCB1c2UgYXJTY2VuZS5wcm9jZXNzKCkgYW5kIGFyU2NlbmUucmVuZGVyT24ocmVuZGVyZXIpIHRvIGRvIGZyYW1lIHByb2Nlc3NpbmcgYW5kIDNEIHJlbmRlcmluZywgcmVzcGVjdGl2ZWx5LlxuXG4gICAgICAgIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSBtYXhpbXVtIHdpZHRoIG9mIHRoZSB1c2VyTWVkaWEgdmlkZW8gdG8gcmVxdWVzdC5cbiAgICAgICAgQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBtYXhpbXVtIGhlaWdodCBvZiB0aGUgdXNlck1lZGlhIHZpZGVvIHRvIHJlcXVlc3QuXG4gICAgICAgIEBwYXJhbSB7ZnVuY3Rpb259IG9uU3VjY2VzcyAtIENhbGxlZCBvbiBzdWNjZXNzZnVsIGluaXRpYWxpemF0aW9uIHdpdGggYW4gVGhyZWVBUlNjZW5lIG9iamVjdC5cbiAgICAgICAgQHBhcmFtIHtmdW5jdGlvbn0gb25FcnJvciAtIENhbGxlZCBpZiB0aGUgaW5pdGlhbGl6YXRpb24gZmFpbHMgd2l0aCB0aGUgZXJyb3IgZW5jb3VudGVyZWQuXG4gICAgKi9cbiAgICBBUkNvbnRyb2xsZXIuZ2V0VXNlck1lZGlhVGhyZWVTY2VuZSA9IGZ1bmN0aW9uKGNvbmZpZ3VyYXRpb24pIHtcbiAgICAgICAgdmFyIG9iaiA9IHt9O1xuICAgICAgICBmb3IgKHZhciBpIGluIGNvbmZpZ3VyYXRpb24pIHtcbiAgICAgICAgICAgIG9ialtpXSA9IGNvbmZpZ3VyYXRpb25baV07XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG9uU3VjY2VzcyA9IGNvbmZpZ3VyYXRpb24ub25TdWNjZXNzO1xuXG4gICAgICAgICg8YW55Pm9iaikub25TdWNjZXNzID0gZnVuY3Rpb24oYXJDb250cm9sbGVyLCBhckNhbWVyYVBhcmFtKSB7XG4gICAgICAgICAgICBhckNvbnRyb2xsZXIuc2V0UHJvamVjdGlvbk5lYXJQbGFuZSgwLjAxKTsgLy8gdGhpcyBkb2VzIG5vdGhpbmcuLi5cbiAgICAgICAgICAgIGFyQ29udHJvbGxlci5zZXRQcm9qZWN0aW9uRmFyUGxhbmUoMTAwMDAwKTsgLy8gdGhpcyBkb2VzIG5vdGhpbmcuLi5cbiAgICAgICAgICAgIHZhciBzY2VuZXMgPSBhckNvbnRyb2xsZXIuY3JlYXRlVGhyZWVTY2VuZSgpO1xuICAgICAgICAgICAgb25TdWNjZXNzKHNjZW5lcywgYXJDb250cm9sbGVyLCBhckNhbWVyYVBhcmFtKTtcbiAgICAgICAgfTtcblxuICAgICAgICB2YXIgdmlkZW8gPSB0aGlzLmdldFVzZXJNZWRpYUFSQ29udHJvbGxlcihvYmopOyAvLyB0aGlzIGlzIGluIGFydG9vbGtpdC5hcGkuanNcbiAgICAgICAgcmV0dXJuIHZpZGVvO1xuICAgIH07XG5cbiAgICAvKipcbiAgICAgICAgQ3JlYXRlcyBhIFRocmVlLmpzIHNjZW5lIGZvciB1c2Ugd2l0aCB0aGlzIEFSQ29udHJvbGxlci5cblxuICAgICAgICBSZXR1cm5zIGEgVGhyZWVBUlNjZW5lIG9iamVjdCB0aGF0IGNvbnRhaW5zIHR3byBUSFJFRS5qcyBzY2VuZXMgKG9uZSBmb3IgdGhlIHZpZGVvIGltYWdlIGFuZCBvdGhlciBmb3IgdGhlIDNEIHNjZW5lKVxuICAgICAgICBhbmQgYSBjb3VwbGUgb2YgaGVscGVyIGZ1bmN0aW9ucyBmb3IgZG9pbmcgdmlkZW8gZnJhbWUgcHJvY2Vzc2luZyBhbmQgQVIgcmVuZGVyaW5nLlxuXG4gICAgICAgIEhlcmUncyB0aGUgc3RydWN0dXJlIG9mIHRoZSBUaHJlZUFSU2NlbmUgb2JqZWN0OlxuICAgICAgICB7XG4gICAgICAgICAgICBzY2VuZTogVEhSRUUuU2NlbmUsIC8vIFRoZSAzRCBzY2VuZS4gUHV0IHlvdXIgQVIgb2JqZWN0cyBoZXJlLlxuICAgICAgICAgICAgY2FtZXJhOiBUSFJFRS5DYW1lcmEsIC8vIFRoZSAzRCBzY2VuZSBjYW1lcmEuXG5cbiAgICAgICAgICAgIGFyQ29udHJvbGxlcjogQVJDb250cm9sbGVyLFxuXG4gICAgICAgICAgICB2aWRlbzogSFRNTFZpZGVvRWxlbWVudCwgLy8gVGhlIHVzZXJNZWRpYSB2aWRlbyBlbGVtZW50LlxuXG4gICAgICAgICAgICB2aWRlb1NjZW5lOiBUSFJFRS5TY2VuZSwgLy8gVGhlIHVzZXJNZWRpYSB2aWRlbyBpbWFnZSBzY2VuZS4gU2hvd3MgdGhlIHZpZGVvIGZlZWQuXG4gICAgICAgICAgICB2aWRlb0NhbWVyYTogVEhSRUUuQ2FtZXJhLCAvLyBDYW1lcmEgZm9yIHRoZSB1c2VyTWVkaWEgdmlkZW8gc2NlbmUuXG5cbiAgICAgICAgICAgIHByb2Nlc3M6IGZ1bmN0aW9uKCksIC8vIFByb2Nlc3MgdGhlIGN1cnJlbnQgdmlkZW8gZnJhbWUgYW5kIHVwZGF0ZSB0aGUgbWFya2VycyBpbiB0aGUgc2NlbmUuXG4gICAgICAgICAgICByZW5kZXJPbjogZnVuY3Rpb24oIFRIUkVFLldlYkdMUmVuZGVyZXIgKSAvLyBSZW5kZXIgdGhlIEFSIHNjZW5lIGFuZCB2aWRlbyBiYWNrZ3JvdW5kIG9uIHRoZSBnaXZlbiBUaHJlZS5qcyByZW5kZXJlci5cbiAgICAgICAgfVxuXG4gICAgICAgIFlvdSBzaG91bGQgdXNlIHRoZSBhclNjZW5lLnZpZGVvLnZpZGVvV2lkdGggYW5kIGFyU2NlbmUudmlkZW8udmlkZW9IZWlnaHQgdG8gc2V0IHRoZSB3aWR0aCBhbmQgaGVpZ2h0IG9mIHlvdXIgcmVuZGVyZXIuXG5cbiAgICAgICAgSW4geW91ciBmcmFtZSBsb29wLCB1c2UgYXJTY2VuZS5wcm9jZXNzKCkgYW5kIGFyU2NlbmUucmVuZGVyT24ocmVuZGVyZXIpIHRvIGRvIGZyYW1lIHByb2Nlc3NpbmcgYW5kIDNEIHJlbmRlcmluZywgcmVzcGVjdGl2ZWx5LlxuXG4gICAgICAgIEBwYXJhbSB2aWRlbyBWaWRlbyBpbWFnZSB0byB1c2UgYXMgc2NlbmUgYmFja2dyb3VuZC4gRGVmYXVsdHMgdG8gdGhpcy5pbWFnZVxuICAgICovXG4gICAgQVJDb250cm9sbGVyLnByb3RvdHlwZS5jcmVhdGVUaHJlZVNjZW5lID0gZnVuY3Rpb24odmlkZW8pIHtcbiAgICAgICAgdmlkZW8gPSB2aWRlbyB8fCB0aGlzLmltYWdlOyAvLyB3ZSdyZSB1c2luZyB0aGlzLmltYWdlIChzZXQgaW4gQVJDb250cm9sbGVyLmdldFVzZXJNZWRpYUFSQ29udHJvbGxlcilcblxuICAgICAgICAvLyBUbyBkaXNwbGF5IHRoZSB2aWRlbywgZmlyc3QgY3JlYXRlIGEgdGV4dHVyZSBmcm9tIGl0LlxuICAgICAgICB2YXIgdmlkZW9UZXggPSBuZXcgVEhSRUUuVGV4dHVyZSh2aWRlbyk7XG5cbiAgICAgICAgdmlkZW9UZXgubWluRmlsdGVyID0gVEhSRUUuTGluZWFyRmlsdGVyO1xuICAgICAgICB2aWRlb1RleC5mbGlwWSA9IGZhbHNlO1xuXG4gICAgICAgIC8vIFRoZW4gY3JlYXRlIGEgcGxhbmUgdGV4dHVyZWQgd2l0aCB0aGUgdmlkZW8uXG4gICAgICAgIHZhciBwbGFuZSA9IG5ldyBUSFJFRS5NZXNoKFxuICAgICAgICAgICAgbmV3IFRIUkVFLlBsYW5lQnVmZmVyR2VvbWV0cnkoMSwgMSksXG4gICAgICAgICAgICBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoe21hcDogdmlkZW9UZXgsIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGV9KVxuICAgICAgICApO1xuXG4gICAgICAgIC8vIFRoZSB2aWRlbyBwbGFuZSBzaG91bGRuJ3QgY2FyZSBhYm91dCB0aGUgei1idWZmZXIuXG4gICAgICAgIHBsYW5lLm1hdGVyaWFsLmRlcHRoVGVzdCA9IGZhbHNlO1xuICAgICAgICBwbGFuZS5tYXRlcmlhbC5kZXB0aFdyaXRlID0gZmFsc2U7XG5cbiAgICAgICAgLy8gQ3JlYXRlIGEgY2FtZXJhIGFuZCBhIHNjZW5lIGZvciB0aGUgdmlkZW8gcGxhbmUgYW5kXG4gICAgICAgIC8vIGFkZCB0aGUgY2FtZXJhIGFuZCB0aGUgdmlkZW8gcGxhbmUgdG8gdGhlIHNjZW5lLlxuICAgICAgICB2YXIgdmlkZW9DYW1lcmEgPSBuZXcgVEhSRUUuT3J0aG9ncmFwaGljQ2FtZXJhKC0wLjUsIDAuNSwgLTAuNSwgMC41LCAtMC41LCAwLjUpO1xuICAgICAgICB2YXIgdmlkZW9TY2VuZSA9IG5ldyBUSFJFRS5TY2VuZSgpO1xuICAgICAgICB2aWRlb1NjZW5lLmFkZChwbGFuZSk7XG4gICAgICAgIHZpZGVvU2NlbmUuYWRkKHZpZGVvQ2FtZXJhKTtcblxuICAgICAgICBpZiAodGhpcy5vcmllbnRhdGlvbiA9PT0gJ3BvcnRyYWl0Jykge1xuICAgICAgICAgICAgcGxhbmUucm90YXRpb24ueiA9IE1hdGguUEkvMjtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBzY2VuZSA9IG5ldyBUSFJFRS5TY2VuZSgpO1xuICAgICAgICB2YXIgY2FtZXJhID0gbmV3IFRIUkVFLkNhbWVyYSgpO1xuICAgICAgICBjYW1lcmEubWF0cml4QXV0b1VwZGF0ZSA9IGZhbHNlO1xuICAgICAgICBjYW1lcmEucHJvamVjdGlvbk1hdHJpeC5mcm9tQXJyYXkodGhpcy5nZXRDYW1lcmFNYXRyaXgoKSk7XG5cbiAgICAgICAgc2NlbmUuYWRkKGNhbWVyYSk7XG5cblxuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHNjZW5lOiBzY2VuZSxcbiAgICAgICAgICAgIHZpZGVvU2NlbmU6IHZpZGVvU2NlbmUsXG4gICAgICAgICAgICBjYW1lcmE6IGNhbWVyYSxcbiAgICAgICAgICAgIHZpZGVvQ2FtZXJhOiB2aWRlb0NhbWVyYSxcblxuICAgICAgICAgICAgYXJDb250cm9sbGVyOiB0aGlzLFxuXG4gICAgICAgICAgICB2aWRlbzogdmlkZW8sXG4gICAgICAgICAgICB2aWRlb1BsYW5lOiBwbGFuZSxcblxuICAgICAgICAgICAgcHJvY2VzczogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgc2VsZi5wcm9jZXNzKHZpZGVvKTtcbiAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgIHJlbmRlck9uOiBmdW5jdGlvbihyZW5kZXJlcikge1xuICAgICAgICAgICAgICAgIGlmICghcmVuZGVyZXIpIHJldHVybjtcbiAgICAgICAgICAgICAgICByZW5kZXJlci5yZXNldEdMU3RhdGUoKTtcbiAgICAgICAgICAgICAgICB2aWRlb1RleC5uZWVkc1VwZGF0ZSA9IHRydWU7XG5cbiAgICAgICAgICAgICAgICB2YXIgYWMgPSByZW5kZXJlci5hdXRvQ2xlYXI7XG4gICAgICAgICAgICAgICAgcmVuZGVyZXIuYXV0b0NsZWFyID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgcmVuZGVyZXIuY2xlYXIoKTtcbiAgICAgICAgICAgICAgICByZW5kZXJlci5yZW5kZXIodGhpcy52aWRlb1NjZW5lLCB0aGlzLnZpZGVvQ2FtZXJhKTtcbiAgICAgICAgICAgICAgICByZW5kZXJlci5yZW5kZXIodGhpcy5zY2VuZSwgdGhpcy5jYW1lcmEpO1xuICAgICAgICAgICAgICAgIHJlbmRlcmVyLmF1dG9DbGVhciA9IGFjO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH07XG59O1xuIl19