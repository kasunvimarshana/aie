var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
import { inject } from 'aurelia-dependency-injection';
import { Role } from '../common';
import { SessionService } from '../session';
import { ViewService } from '../view';
import { ContextService } from '../context';
import { DeviceService } from '../device';
import { RealityViewer } from './base';
var LiveRealityViewer = (function (_super) {
    __extends(LiveRealityViewer, _super);
    function LiveRealityViewer(sessionService, viewService, contextService, deviceService, uri) {
        var _this = _super.call(this, uri) || this;
        _this.sessionService = sessionService;
        _this.viewService = viewService;
        _this.contextService = contextService;
        _this.deviceService = deviceService;
        _this.uri = uri;
        _this.userTracking = '3DOF';
        if (typeof document !== 'undefined') {
            _this.settingsIframe = document.createElement('iframe');
            _this.settingsIframe.width = '0';
            _this.settingsIframe.height = '0';
            _this.settingsIframe.src = 'https://argonjs.io/tools.argonjs.io/';
            _this.settingsIframe.style.display = 'none';
            _this.videoFov = Math.PI / 2;
            _this.videoElement = document.createElement('video');
            _this.videoElement.style.width = '100%';
            _this.videoElement.style.height = 'height:100%';
            _this.videoElement.controls = false;
            _this.videoElement.autoplay = true;
            _this.videoElement.style.display = 'none';
            var viewElement = _this.viewService.element;
            viewElement.insertBefore(_this.settingsIframe, viewElement.firstChild);
            viewElement.insertBefore(_this.videoElement, viewElement.firstChild);
            _this.canvas = document.createElement('canvas');
            _this.context = _this.canvas.getContext('2d');
            window.addEventListener('message', function (event) {
                var origin = event.origin;
                if (origin === 'http://argonjs.io') {
                    _this.videoFov = event.data; // TODO: this is not flexible. Should be passing an object with message type and data
                }
            });
        }
        _this.presentChangeEvent.addEventListener(function () {
            if (typeof document !== 'undefined') {
                _this.videoElement.style.display = _this.isPresenting ? 'initial' : 'none';
            }
        });
        return _this;
    }
    LiveRealityViewer.prototype.destroy = function () {
        _super.prototype.destroy.call(this);
        if (typeof document !== 'undefined') {
            this.settingsIframe.remove();
            this.videoElement.remove();
            this.canvas.remove();
        }
    };
    LiveRealityViewer.prototype.setupInternalSession = function (internalSession) {
        var _this = this;
        internalSession.connectEvent.addEventListener(function () {
            if (_this.videoElement) {
                var videoElement_1 = _this.videoElement;
                var mediaDevices = navigator.mediaDevices;
                var getUserMedia = (mediaDevices.getUserMedia || mediaDevices['mozGetUserMedia'] ||
                    mediaDevices['msGetUserMedia'] || mediaDevices['webkitGetUserMedia']).bind(mediaDevices);
                getUserMedia({ audio: false, video: true }).then(function (videoStream) {
                    var stopVideoStream = function () {
                        for (var _i = 0, _a = videoStream.getTracks(); _i < _a.length; _i++) {
                            var t = _a[_i];
                            t.stop();
                        }
                    };
                    if (internalSession.isConnected) {
                        videoElement_1.src = window.URL.createObjectURL(videoStream);
                        internalSession.closeEvent.addEventListener(stopVideoStream);
                    }
                    else {
                        stopVideoStream();
                    }
                }).catch(function (error) {
                    internalSession.errorEvent.raiseEvent(error);
                });
                // const viewService = this.viewService;
                var lastFrameTime_1 = -1;
                var remove1_1 = _this.deviceService.suggestedGeolocationSubscriptionChangeEvent.addEventListener(function () {
                    if (_this.deviceService.suggestedGeolocationSubscription) {
                        _this.deviceService.subscribeGeolocation(_this.deviceService.suggestedGeolocationSubscription, internalSession);
                    }
                    else {
                        _this.deviceService.unsubscribeGeolocation();
                    }
                });
                var remove2_1 = _this.deviceService.frameStateEvent.addEventListener(function (frameState) {
                    if (videoElement_1.currentTime != lastFrameTime_1) {
                        lastFrameTime_1 = videoElement_1.currentTime;
                        // const videoWidth = videoElement.videoWidth;
                        // const videoHeight = videoElement.videoHeight;
                        var contextFrameState = _this.contextService.createFrameState(frameState.time, frameState.viewport, frameState.subviews, {
                            userTracking: _this.userTracking
                        });
                        internalSession.send('ar.reality.frameState', contextFrameState);
                    }
                });
                internalSession.closeEvent.addEventListener(function () {
                    remove1_1();
                    remove2_1();
                });
            }
        });
    };
    LiveRealityViewer.prototype.load = function () {
        var _this = this;
        var session = this.sessionService.addManagedSessionPort(this.uri);
        session.connectEvent.addEventListener(function () {
            _this.connectEvent.raiseEvent(session);
        });
        var internalSession = this.sessionService.createSessionPort(this.uri);
        internalSession.suppressErrorOnUnknownTopic = true;
        this.setupInternalSession(internalSession);
        // Only connect after the caller is able to attach connectEvent handlers
        Promise.resolve().then(function () {
            if (_this.sessionService.manager.isClosed)
                return;
            var messageChannel = _this.sessionService.createSynchronousMessageChannel();
            session.open(messageChannel.port1, _this.sessionService.configuration);
            internalSession.open(messageChannel.port2, { role: Role.REALITY_VIEWER, title: 'Live', uri: _this.uri, version: _this.sessionService.configuration.version });
        });
    };
    LiveRealityViewer.isAvailable = function () {
        if (typeof navigator !== 'undefined' && navigator.mediaDevices) {
            var mediaDevices = navigator.mediaDevices;
            return !!(mediaDevices.getUserMedia || mediaDevices['mozGetUserMedia'] || mediaDevices['msGetUserMedia'] || mediaDevices['webkitGetUserMedia']);
        }
        else {
            return false;
        }
    };
    LiveRealityViewer.prototype.getVideoFrame = function (x, y, width, height) {
        this.canvas.width = this.videoElement.videoWidth;
        this.canvas.height = this.videoElement.videoHeight;
        this.context.drawImage(this.videoElement, 0, 0, this.canvas.width, this.canvas.height);
        return this.context.getImageData(x, y, width, height);
    };
    LiveRealityViewer = __decorate([
        inject(SessionService, ViewService, ContextService, DeviceService),
        __metadata("design:paramtypes", [SessionService,
            ViewService,
            ContextService,
            DeviceService, String])
    ], LiveRealityViewer);
    return LiveRealityViewer;
}(RealityViewer));
export { LiveRealityViewer };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImxpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQTtBQUNyRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFBO0FBQ2hDLE9BQU8sRUFBRSxjQUFjLEVBQWUsTUFBTSxZQUFZLENBQUE7QUFDeEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFNBQVMsQ0FBQTtBQUNyQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sWUFBWSxDQUFBO0FBQzNDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxXQUFXLENBQUE7QUFDekMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFFBQVEsQ0FBQTtBQUd0QztJQUF1QyxxQ0FBYTtJQVloRCwyQkFDWSxjQUE4QixFQUM5QixXQUF3QixFQUN4QixjQUE4QixFQUM5QixhQUE0QixFQUM3QixHQUFVO1FBTHJCLFlBTUksa0JBQU0sR0FBRyxDQUFDLFNBc0NiO1FBM0NXLG9CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5QixpQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixvQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDOUIsbUJBQWEsR0FBYixhQUFhLENBQWU7UUFDN0IsU0FBRyxHQUFILEdBQUcsQ0FBTztRQWRkLGtCQUFZLEdBQXlCLE1BQU0sQ0FBQztRQWlCL0MsRUFBRSxDQUFDLENBQUMsT0FBTyxRQUFRLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQztZQUNsQyxLQUFJLENBQUMsY0FBYyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDdkQsS0FBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDO1lBQ2hDLEtBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQztZQUNqQyxLQUFJLENB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QUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsWUFBWSxJQUFJLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLFlBQVksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUM7UUFDcEosQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osTUFBTSxDQUFDLEtBQUssQ0FBQztRQUNqQixDQUFDO0lBQ0wsQ0FBQztJQUVNLHlDQUFhLEdBQXBCLFVBQXFCLENBQVMsRUFBRSxDQUFTLEVBQUUsS0FBYSxFQUFFLE1BQWM7UUFDcEUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUM7UUFDakQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUM7UUFDbkQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdkYsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQzFELENBQUM7SUF6S1EsaUJBQWlCO1FBRDdCLE1BQU0sQ0FBQyxjQUFjLEVBQUUsV0FBVyxFQUFFLGNBQWMsRUFBRSxhQUFhLENBQUM7eUNBY25DLGNBQWM7WUFDakIsV0FBVztZQUNSLGNBQWM7WUFDZixhQUFhO09BaEIvQixpQkFBaUIsQ0EwSzdCO0lBQUQsd0JBQUM7Q0FBQSxBQTFLRCxDQUF1QyxhQUFhLEdBMEtuRDtTQTFLWSxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpbmplY3QgfSBmcm9tICdhdXJlbGlhLWRlcGVuZGVuY3ktaW5qZWN0aW9uJ1xuaW1wb3J0IHsgUm9sZSB9IGZyb20gJy4uL2NvbW1vbidcbmltcG9ydCB7IFNlc3Npb25TZXJ2aWNlLCBTZXNzaW9uUG9ydCB9IGZyb20gJy4uL3Nlc3Npb24nXG5pbXBvcnQgeyBWaWV3U2VydmljZSB9IGZyb20gJy4uL3ZpZXcnXG5pbXBvcnQgeyBDb250ZXh0U2VydmljZSB9IGZyb20gJy4uL2NvbnRleHQnXG5pbXBvcnQgeyBEZXZpY2VTZXJ2aWNlIH0gZnJvbSAnLi4vZGV2aWNlJ1xuaW1wb3J0IHsgUmVhbGl0eVZpZXdlciB9IGZyb20gJy4vYmFzZSdcblxuQGluamVjdChTZXNzaW9uU2VydmljZSwgVmlld1NlcnZpY2UsIENvbnRleHRTZXJ2aWNlLCBEZXZpY2VTZXJ2aWNlKVxuZXhwb3J0IGNsYXNzIExpdmVSZWFsaXR5Vmlld2VyIGV4dGVuZHMgUmVhbGl0eVZpZXdlciB7XG5cbiAgICBwdWJsaWMgdmlkZW9FbGVtZW50OiBIVE1MVmlkZW9FbGVtZW50O1xuICAgIHB1YmxpYyB1c2VyVHJhY2tpbmc6ICdub25lJ3wnM0RPRid8JzZET0YnID0gJzNET0YnO1xuXG4gICAgcHJpdmF0ZSBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50O1xuICAgIHByaXZhdGUgY29udGV4dDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEO1xuXG4gICAgcHJpdmF0ZSB2aWRlb0ZvdjogbnVtYmVyO1xuICAgIFxuICAgIHByaXZhdGUgc2V0dGluZ3NJZnJhbWU6IEhUTUxJRnJhbWVFbGVtZW50O1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgc2Vzc2lvblNlcnZpY2U6IFNlc3Npb25TZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHZpZXdTZXJ2aWNlOiBWaWV3U2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBjb250ZXh0U2VydmljZTogQ29udGV4dFNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgZGV2aWNlU2VydmljZTogRGV2aWNlU2VydmljZSxcbiAgICAgICAgcHVibGljIHVyaTpzdHJpbmcpIHtcbiAgICAgICAgc3VwZXIodXJpKTtcblxuICAgICAgICBpZiAodHlwZW9mIGRvY3VtZW50ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgdGhpcy5zZXR0aW5nc0lmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lmcmFtZScpO1xuICAgICAgICAgICAgdGhpcy5zZXR0aW5nc0lmcmFtZS53aWR0aCA9ICcwJztcbiAgICAgICAgICAgIHRoaXMuc2V0dGluZ3NJZnJhbWUuaGVpZ2h0ID0gJzAnO1xuICAgICAgICAgICAgdGhpcy5zZXR0aW5nc0lmcmFtZS5zcmMgPSAnaHR0cHM6Ly9hcmdvbmpzLmlvL3Rvb2xzLmFyZ29uanMuaW8vJztcbiAgICAgICAgICAgIHRoaXMuc2V0dGluZ3NJZnJhbWUuc3R5bGUuZGlzcGxheSA9ICdub25lJztcblxuICAgICAgICAgICAgdGhpcy52aWRlb0ZvdiA9IE1hdGguUEkgLyAyO1xuXG4gICAgICAgICAgICB0aGlzLnZpZGVvRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3ZpZGVvJyk7XG4gICAgICAgICAgICB0aGlzLnZpZGVvRWxlbWVudC5zdHlsZS53aWR0aCA9ICcxMDAlJztcbiAgICAgICAgICAgIHRoaXMudmlkZW9FbGVtZW50LnN0eWxlLmhlaWdodCA9ICdoZWlnaHQ6MTAwJSc7XG4gICAgICAgICAgICB0aGlzLnZpZGVvRWxlbWVudC5jb250cm9scyA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy52aWRlb0VsZW1lbnQuYXV0b3BsYXkgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy52aWRlb0VsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJztcblxuICAgICAgICAgICAgY29uc3Qgdmlld0VsZW1lbnQgPSB0aGlzLnZpZXdTZXJ2aWNlLmVsZW1lbnQ7XG4gICAgICAgICAgICB2aWV3RWxlbWVudC5pbnNlcnRCZWZvcmUodGhpcy5zZXR0aW5nc0lmcmFtZSwgdmlld0VsZW1lbnQuZmlyc3RDaGlsZCk7XG4gICAgICAgICAgICB2aWV3RWxlbWVudC5pbnNlcnRCZWZvcmUodGhpcy52aWRlb0VsZW1lbnQsIHZpZXdFbGVtZW50LmZpcnN0Q2hpbGQpO1xuXG4gICAgICAgICAgICB0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gdGhpcy5jYW52YXMuZ2V0Q29udGV4dCgnMmQnKSE7XG5cbiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luID0gZXZlbnQub3JpZ2luO1xuICAgICAgICAgICAgICAgIGlmIChvcmlnaW4gPT09ICdodHRwOi8vYXJnb25qcy5pbycpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy52aWRlb0ZvdiA9IGV2ZW50LmRhdGE7IC8vIFRPRE86IHRoaXMgaXMgbm90IGZsZXhpYmxlLiBTaG91bGQgYmUgcGFzc2luZyBhbiBvYmplY3Qgd2l0aCBtZXNzYWdlIHR5cGUgYW5kIGRhdGFcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucHJlc2VudENoYW5nZUV2ZW50LmFkZEV2ZW50TGlzdGVuZXIoKCk9PntcbiAgICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgdGhpcy52aWRlb0VsZW1lbnQuc3R5bGUuZGlzcGxheSA9IHRoaXMuaXNQcmVzZW50aW5nID8gJ2luaXRpYWwnIDogJ25vbmUnO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH1cblxuICAgIHB1YmxpYyBkZXN0cm95KCkge1xuICAgICAgICBzdXBlci5kZXN0cm95KCk7XG4gICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICB0aGlzLnNldHRpbmdzSWZyYW1lLnJlbW92ZSgpO1xuICAgICAgICAgICAgdGhpcy52aWRlb0VsZW1lbnQucmVtb3ZlKCk7XG4gICAgICAgICAgICB0aGlzLmNhbnZhcy5yZW1vdmUoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBzZXR1cEludGVybmFsU2Vzc2lvbihpbnRlcm5hbFNlc3Npb246U2Vzc2lvblBvcnQpIHtcblxuICAgICAgICBpbnRlcm5hbFNlc3Npb24uY29ubmVjdEV2ZW50LmFkZEV2ZW50TGlzdGVuZXIoKCkgPT4ge1xuXG4gICAgICAgICAgICBpZiAodGhpcy52aWRlb0VsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB2aWRlb0VsZW1lbnQgPSB0aGlzLnZpZGVvRWxlbWVudCE7XG4gICAgICAgICAgICAgICAgY29uc3QgbWVkaWFEZXZpY2VzID0gbmF2aWdhdG9yLm1lZGlhRGV2aWNlcztcbiAgICAgICAgICAgICAgICBjb25zdCBnZXRVc2VyTWVkaWEgPSAobWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSB8fCBtZWRpYURldmljZXNbJ21vekdldFVzZXJNZWRpYSddIHx8XG4gICAgICAgICAgICAgICAgICAgIG1lZGlhRGV2aWNlc1snbXNHZXRVc2VyTWVkaWEnXSB8fCBtZWRpYURldmljZXNbJ3dlYmtpdEdldFVzZXJNZWRpYSddKS5iaW5kKG1lZGlhRGV2aWNlcyk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgZ2V0VXNlck1lZGlhKHsgYXVkaW86IGZhbHNlLCB2aWRlbzogdHJ1ZSB9KS50aGVuKCh2aWRlb1N0cmVhbTogTWVkaWFTdHJlYW0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RvcFZpZGVvU3RyZWFtID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCB0IG9mIHZpZGVvU3RyZWFtLmdldFRyYWNrcygpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5zdG9wKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGludGVybmFsU2Vzc2lvbi5pc0Nvbm5lY3RlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmlkZW9FbGVtZW50LnNyYyA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKHZpZGVvU3RyZWFtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGludGVybmFsU2Vzc2lvbi5jbG9zZUV2ZW50LmFkZEV2ZW50TGlzdGVuZXIoc3RvcFZpZGVvU3RyZWFtKVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RvcFZpZGVvU3RyZWFtKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KS5jYXRjaCgoZXJyb3I6IERPTUV4Y2VwdGlvbikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpbnRlcm5hbFNlc3Npb24uZXJyb3JFdmVudC5yYWlzZUV2ZW50KGVycm9yKTsgIFxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgLy8gY29uc3Qgdmlld1NlcnZpY2UgPSB0aGlzLnZpZXdTZXJ2aWNlO1xuICAgICAgICAgICAgICAgIGxldCBsYXN0RnJhbWVUaW1lID0gLTE7XG5cbiAgICAgICAgICAgICAgICBjb25zdCByZW1vdmUxID0gdGhpcy5kZXZpY2VTZXJ2aWNlLnN1Z2dlc3RlZEdlb2xvY2F0aW9uU3Vic2NyaXB0aW9uQ2hhbmdlRXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoKT0+e1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGV2aWNlU2VydmljZS5zdWdnZXN0ZWRHZW9sb2NhdGlvblN1YnNjcmlwdGlvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZXZpY2VTZXJ2aWNlLnN1YnNjcmliZUdlb2xvY2F0aW9uKHRoaXMuZGV2aWNlU2VydmljZS5zdWdnZXN0ZWRHZW9sb2NhdGlvblN1YnNjcmlwdGlvbiwgaW50ZXJuYWxTZXNzaW9uKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGV2aWNlU2VydmljZS51bnN1YnNjcmliZUdlb2xvY2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgcmVtb3ZlMiA9dGhpcy5kZXZpY2VTZXJ2aWNlLmZyYW1lU3RhdGVFdmVudC5hZGRFdmVudExpc3RlbmVyKChmcmFtZVN0YXRlKT0+e1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICh2aWRlb0VsZW1lbnQuY3VycmVudFRpbWUgIT0gbGFzdEZyYW1lVGltZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEZyYW1lVGltZSA9IHZpZGVvRWxlbWVudC5jdXJyZW50VGltZTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc3QgdmlkZW9XaWR0aCA9IHZpZGVvRWxlbWVudC52aWRlb1dpZHRoO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc3QgdmlkZW9IZWlnaHQgPSB2aWRlb0VsZW1lbnQudmlkZW9IZWlnaHQ7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRleHRGcmFtZVN0YXRlID0gdGhpcy5jb250ZXh0U2VydmljZS5jcmVhdGVGcmFtZVN0YXRlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lU3RhdGUudGltZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFtZVN0YXRlLnZpZXdwb3J0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lU3RhdGUuc3Vidmlld3MsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VyVHJhY2tpbmc6IHRoaXMudXNlclRyYWNraW5nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJuYWxTZXNzaW9uLnNlbmQoJ2FyLnJlYWxpdHkuZnJhbWVTdGF0ZScsIGNvbnRleHRGcmFtZVN0YXRlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBpbnRlcm5hbFNlc3Npb24uY2xvc2VFdmVudC5hZGRFdmVudExpc3RlbmVyKCgpPT57XG4gICAgICAgICAgICAgICAgICAgIHJlbW92ZTEoKTtcbiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlMigpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBsb2FkKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5zZXNzaW9uU2VydmljZS5hZGRNYW5hZ2VkU2Vzc2lvblBvcnQodGhpcy51cmkpO1xuICAgICAgICBzZXNzaW9uLmNvbm5lY3RFdmVudC5hZGRFdmVudExpc3RlbmVyKCgpPT57XG4gICAgICAgICAgICB0aGlzLmNvbm5lY3RFdmVudC5yYWlzZUV2ZW50KHNlc3Npb24pO1xuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBpbnRlcm5hbFNlc3Npb24gPSB0aGlzLnNlc3Npb25TZXJ2aWNlLmNyZWF0ZVNlc3Npb25Qb3J0KHRoaXMudXJpKTtcbiAgICAgICAgaW50ZXJuYWxTZXNzaW9uLnN1cHByZXNzRXJyb3JPblVua25vd25Ub3BpYyA9IHRydWU7XG4gICAgICAgIHRoaXMuc2V0dXBJbnRlcm5hbFNlc3Npb24oaW50ZXJuYWxTZXNzaW9uKTtcbiAgICAgICAgXG4gICAgICAgIC8vIE9ubHkgY29ubmVjdCBhZnRlciB0aGUgY2FsbGVyIGlzIGFibGUgdG8gYXR0YWNoIGNvbm5lY3RFdmVudCBoYW5kbGVyc1xuICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpPT57XG4gICAgICAgICAgICBpZiAodGhpcy5zZXNzaW9uU2VydmljZS5tYW5hZ2VyLmlzQ2xvc2VkKSByZXR1cm47XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlQ2hhbm5lbCA9IHRoaXMuc2Vzc2lvblNlcnZpY2UuY3JlYXRlU3luY2hyb25vdXNNZXNzYWdlQ2hhbm5lbCgpO1xuICAgICAgICAgICAgc2Vzc2lvbi5vcGVuKG1lc3NhZ2VDaGFubmVsLnBvcnQxLCB0aGlzLnNlc3Npb25TZXJ2aWNlLmNvbmZpZ3VyYXRpb24pO1xuICAgICAgICAgICAgaW50ZXJuYWxTZXNzaW9uLm9wZW4obWVzc2FnZUNoYW5uZWwucG9ydDIsIHsgcm9sZTogUm9sZS5SRUFMSVRZX1ZJRVdFUiwgdGl0bGU6ICdMaXZlJywgdXJpOiB0aGlzLnVyaSwgdmVyc2lvbjogdGhpcy5zZXNzaW9uU2VydmljZS5jb25maWd1cmF0aW9uLnZlcnNpb24gfSk7XG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBpc0F2YWlsYWJsZSgpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHR5cGVvZiBuYXZpZ2F0b3IgIT09ICd1bmRlZmluZWQnICYmIG5hdmlnYXRvci5tZWRpYURldmljZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IG1lZGlhRGV2aWNlcyA9IG5hdmlnYXRvci5tZWRpYURldmljZXM7XG4gICAgICAgICAgICByZXR1cm4gISEobWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSB8fCBtZWRpYURldmljZXNbJ21vekdldFVzZXJNZWRpYSddIHx8IG1lZGlhRGV2aWNlc1snbXNHZXRVc2VyTWVkaWEnXSB8fCBtZWRpYURldmljZXNbJ3dlYmtpdEdldFVzZXJNZWRpYSddKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBnZXRWaWRlb0ZyYW1lKHg6IG51bWJlciwgeTogbnVtYmVyLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcik6IEltYWdlRGF0YSB7XG4gICAgICAgIHRoaXMuY2FudmFzLndpZHRoID0gdGhpcy52aWRlb0VsZW1lbnQudmlkZW9XaWR0aDtcbiAgICAgICAgdGhpcy5jYW52YXMuaGVpZ2h0ID0gdGhpcy52aWRlb0VsZW1lbnQudmlkZW9IZWlnaHQ7XG4gICAgICAgIHRoaXMuY29udGV4dC5kcmF3SW1hZ2UodGhpcy52aWRlb0VsZW1lbnQsIDAsIDAsIHRoaXMuY2FudmFzLndpZHRoLCB0aGlzLmNhbnZhcy5oZWlnaHQpO1xuICAgICAgICByZXR1cm4gdGhpcy5jb250ZXh0LmdldEltYWdlRGF0YSh4LCB5LCB3aWR0aCwgaGVpZ2h0KTtcbiAgICB9XG59XG4iXX0=