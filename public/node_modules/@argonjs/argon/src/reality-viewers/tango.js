var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
import { inject, Container } from 'aurelia-dependency-injection';
import { ConstantPositionProperty, ConstantProperty, ReferenceFrame, Cartesian3, Quaternion, Matrix3, Matrix4, 
// CesiumMath
Entity } from '../cesium/cesium-imports';
import { Configuration, Role, SerializedSubviewList } from '../common';
import { SessionService, ConnectService, SessionConnectService } from '../session';
import { eastUpSouthToFixedFrame, getEntityPosition, getEntityOrientation } from '../utils';
import { EntityService } from '../entity';
import { ContextService } from '../context';
import { DeviceService } from '../device';
import { ViewService } from '../view';
// import { PoseStatus } from '../entity'
import { RealityViewer } from './base';
import { RealityService } from '../reality';
import { VisibilityService } from '../visibility';
var TangoRealityViewer = (function (_super) {
    __extends(TangoRealityViewer, _super);
    function TangoRealityViewer(sessionService, viewService, contextService, container, deviceService, uri, vrDisplay) {
        var _this = _super.call(this, uri) || this;
        _this.sessionService = sessionService;
        _this.viewService = viewService;
        _this.contextService = contextService;
        _this.container = container;
        _this.deviceService = deviceService;
        _this.uri = uri;
        _this.vrDisplay = vrDisplay;
        _this.type = 'tango';
        _this.userTracking = '6DOF';
        _this._pointsToSkip = 0;
        _this._frameData = new VRFrameData();
        _this._renderPointCloud = false;
        _this._usePointCloudForOcclusion = false;
        _this._initFinished = false;
        _this._sharedCanvasFinal = false;
        _this._vrDisplay = undefined;
        _this._lastGeoHorizontalAccuracy = 999;
        _this._lastGeoHeadingAccuracy = 999;
        _this._tangoOriginLost = true;
        _this._scratchMatrix3 = new Matrix3;
        _this._scratchMatrix4 = new Matrix4;
        _this._scratchCartesian = new Cartesian3;
        _this._scratchQuaternion = new Quaternion;
        _this.points_vertexShader = "attribute vec3 position;\nuniform float size;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform vec4 plane;\nuniform float distance;\nuniform float cameraNear;\nuniform float cameraFar;\nvarying float v_discard;\nvarying vec3 color;\nvoid main(void) {\n    vec4 v4Position = vec4(position, 1.0);\n    float d = dot(plane, v4Position);\n    v_discard = 0.0;\n    if (abs(d) < distance) v_discard = 1.0;\n    gl_PointSize = size;\n    gl_Position = projectionMatrix * modelViewMatrix * v4Position;\n    float depth = 1.0 - ((gl_Position.z - cameraNear) / (cameraFar - cameraNear));\n    color = vec3(depth);\n}";
        _this.points_fragmentShader = "precision mediump float;\nvarying vec3 color;\nuniform float opacity;\nvarying float v_discard;\nvoid main(void) {\n    if (v_discard > 0.0) discard;\n    gl_FragColor = vec4( color, opacity );\n}";
        _this.viewService.viewportChangeEvent.addEventListener(function (viewport) {
            _this.updateViewport(viewport);
        });
        return _this;
    }
    TangoRealityViewer.prototype.load = function () {
        var _this = this;
        // Create a child container so that we can conveniently setup all the services
        // that would exist in a normal hosted reality viewer 
        var child = this.container.createChild();
        // Create the session instance that will be used by the managerÂ to talk to the reality 
        var session = this.sessionService.addManagedSessionPort(this.uri);
        session.connectEvent.addEventListener(function () {
            _this.connectEvent.raiseEvent(session); // let the manager know the session is ready
        });
        // use a SessionConnectService to create a connection via the session instance we created
        child.registerInstance(ConnectService, new SessionConnectService(session, this.sessionService.configuration));
        // setup the configuration for our tango reality
        child.registerInstance(Configuration, {
            role: Role.REALITY_VIEWER,
            uri: this.uri,
            title: 'Tango',
            version: this.sessionService.configuration.version,
            supportsCustomProtocols: true,
            protocols: ['ar.configureStage@v1', 'ar.tango'],
            sharedCanvas: true
        });
        // Create the basic services that we need to use. 
        child.autoRegisterAll([SessionService, EntityService, VisibilityService, ContextService, DeviceService, RealityService]);
        var childContextService = child.get(ContextService);
        var childDeviceService = child.get(DeviceService);
        var childSessionService = child.get(SessionService);
        var childRealityService = child.get(RealityService);
        // const childEntityService = child.get(EntityService) as EntityService;
        // const childViewService = child.get(ViewService) as ViewService;
        var tangoOrigin = new Entity({
            id: 'tango',
            position: new ConstantPositionProperty(undefined, childContextService.stage),
            orientation: new ConstantProperty(Quaternion.IDENTITY)
        });
        // the child device service should *not* submit frames to the vrdisplay. 
        childDeviceService.autoSubmitFrame = false;
        var customStagePosition;
        var customStageOrientation;
        // Create protocol handlers for `ar.configureStage` protocol
        childRealityService.connectEvent.addEventListener(function (session) {
            session.on['ar.configureStage.setStageGeolocation'] = function (_a) {
                var geolocation = _a.geolocation;
                customStagePosition = Cartesian3.fromRadians(geolocation.longitude, geolocation.latitude, geolocation.height, undefined, customStagePosition);
                var transformMatrix = eastUpSouthToFixedFrame(customStagePosition, undefined, _this._scratchMatrix4);
                var rotationMatrix = Matrix4.getRotation(transformMatrix, _this._scratchMatrix3);
                customStageOrientation = Quaternion.fromRotationMatrix(rotationMatrix, customStageOrientation);
            };
            session.on['ar.configureStage.resetStageGeolocation'] = function () {
                customStagePosition = undefined;
                customStageOrientation = undefined;
            };
            session.on['ar.tango.togglePointCloud'] = function () {
                _this._renderPointCloud = !_this._renderPointCloud;
                // if (this._renderPointCloud) this._scene.add(this._points); else this._scene.remove(this._points);
                return Promise.resolve({ result: _this._renderPointCloud });
            };
            session.on['ar.tango.getPickingPointAndPlaneInPointCloud'] = function (_a) {
                var x = _a.x, y = _a.y;
                if (_this._vrDisplay) {
                    // console.log("Get p&p on"+x +"," + y)
                    var pointAndPlane = _this._vrDisplay.getPickingPointAndPlaneInPointCloud(x, y);
                    if (pointAndPlane) {
                        return Promise.resolve({ point: pointAndPlane.point, plane: pointAndPlane.plane });
                    }
                    else {
                        return Promise.reject(new Error("Tango reality could not find a point and plane"));
                    }
                }
                else {
                    return Promise.reject(new Error("vrDisplay not configured yet"));
                }
            };
            session.on['ar.tango.toggleOcclusion'] = function () {
                _this._usePointCloudForOcclusion = !_this._usePointCloudForOcclusion;
                // if (this._usePointCloudForOcclusion) this._scene.add(this._points); else this._scene.remove(this._points);
                return Promise.resolve({ result: _this._usePointCloudForOcclusion });
            };
            // TODO: handle marker tracking for Tango
            session.on['ar.tango.addMarker'] = function (msg) {
                return new Promise(function (resolve, reject) {
                    // this._arController.loadMarker(msg.url, (markerId) => {
                    //     // TODO: handle size of markers
                    //     var id = this._getIdForMarker(markerId);
                    //     var entity = new Entity({id});
                    //     this.contextService.entities.add(entity);
                    //     this._markerEntities.set(id, entity);
                    //     resolve({id: id});
                    // }, (error) => {
                    //     console.log(error);
                    //     reject(error);
                    // });
                    console.log(_this.contextService); //dummy
                });
            };
        });
        // Setup everything after connected to the manager. The manager only connects once.
        childSessionService.manager.connectEvent.addEventListener(function () {
            // since we aren't create a child view service and viewport service, 
            // suppress any errors from not handling these messages
            childSessionService.manager.suppressErrorOnUnknownTopic = true;
            var subviews = [];
            var checkSuggestedGeolocationSubscription = function () {
                if (childDeviceService.suggestedGeolocationSubscription) {
                    childDeviceService.subscribeGeolocation(childDeviceService.suggestedGeolocationSubscription);
                }
                else {
                    childDeviceService.unsubscribeGeolocation();
                }
            };
            checkSuggestedGeolocationSubscription();
            var remove1 = childDeviceService.suggestedGeolocationSubscriptionChangeEvent.addEventListener(checkSuggestedGeolocationSubscription);
            var remove2 = childDeviceService.frameStateEvent.addEventListener(function (frameState) {
                if (childSessionService.manager.isClosed)
                    return;
                SerializedSubviewList.clone(frameState.subviews, subviews);
                var time = frameState.time;
                // override user pos to tango pos
                // Was originally used to provide control over userpose if the device does not have a physical pose
                var overrideUser = true; //!(deviceUserPose.status & PoseStatus.KNOWN);
                var contextUser = childContextService.user;
                var contextStage = childContextService.stage;
                var tangoUserPosition;
                var tangoUserOrientation;
                // Override user
                _this._vrDisplay['getFrameData'](_this._frameData);
                var tangoPos = _this._frameData.pose.position;
                tangoUserPosition = new Cartesian3(tangoPos[0], tangoPos[1], tangoPos[2]);
                // Check if tango tracking is lost
                _this._tangoOriginLostPreviousFrame = _this._tangoOriginLost;
                _this._tangoOriginLost = tangoUserPosition.equals(Cartesian3.ZERO) || tangoUserPosition.x === NaN;
                // If tango tracking is lost, set userPosition to undefined -> results in user pose status LOST
                if (_this._tangoOriginLost) {
                    tangoUserPosition = undefined;
                    tangoUserOrientation = undefined;
                }
                else {
                    var tangoRot = _this._frameData.pose.orientation;
                    tangoUserOrientation = new Quaternion(tangoRot[0], tangoRot[1], tangoRot[2], tangoRot[3]);
                }
                contextUser.position.setValue(tangoUserPosition, tangoOrigin);
                contextUser.orientation.setValue(tangoUserOrientation);
                // Update stage geopose when GPS accuracy improves or Tango origin is repositioned
                var currentGeoHorizontalAccuracy = _this.deviceService.geoHorizontalAccuracy || 999;
                var currentGeoHeadingAccuracy = _this.deviceService.geoHeadingAccuracy || 999;
                var gpsAccuracyHasImproved = _this._lastGeoHorizontalAccuracy > currentGeoHorizontalAccuracy;
                var compassAccuracyHasImproved = _this._lastGeoHeadingAccuracy > currentGeoHeadingAccuracy;
                var tangoOriginRepositioned = _this._tangoOriginLostPreviousFrame && !_this._tangoOriginLost;
                var tangoOriginNeedsUpdate = gpsAccuracyHasImproved || tangoOriginRepositioned || compassAccuracyHasImproved;
                var overrideStage = true;
                if (tangoUserPosition && tangoUserOrientation && tangoOriginNeedsUpdate) {
                    if (tangoOriginRepositioned) {
                        console.log("Tango origin has been reset.");
                        _this._lastGeoHeadingAccuracy = _this._lastGeoHorizontalAccuracy = 999;
                        _this._tangoOriginLost = false;
                    }
                    else if (gpsAccuracyHasImproved) {
                        console.log("Current horizontal accuracy has been inproved to:" + _this.deviceService.geoHorizontalAccuracy);
                        _this._lastGeoHorizontalAccuracy = currentGeoHorizontalAccuracy;
                    }
                    else if (compassAccuracyHasImproved) {
                        console.log("Current heading accuracy has been inproved to:" + _this.deviceService.geoHeadingAccuracy);
                        _this._lastGeoHeadingAccuracy = currentGeoHeadingAccuracy;
                    }
                    // Get tango origin relative to context user.
                    // First two lines should be removed after bugfix of not being able to get transform of an entity with an undefined position|orientation relative to one of it's children
                    tangoOrigin.position.setValue(Cartesian3.ZERO, ReferenceFrame.FIXED);
                    tangoOrigin.orientation.setValue(Quaternion.IDENTITY);
                    var tangoOriginPosition = getEntityPosition(tangoOrigin, time, contextUser, _this._scratchCartesian);
                    var tangoOriginOrientation = getEntityOrientation(tangoOrigin, time, contextUser, _this._scratchQuaternion);
                    // Set tango origin relative to device user (which has geopose)
                    tangoOrigin.position.setValue(tangoOriginPosition, _this.deviceService.user);
                    tangoOrigin.orientation.setValue(tangoOriginOrientation);
                    // Redefine tango origin relative to fixed
                    var tangoOriginPositionFixed = getEntityPosition(tangoOrigin, time, ReferenceFrame.FIXED, _this._scratchCartesian);
                    var tangoOriginOrientationFixed = getEntityOrientation(tangoOrigin, time, ReferenceFrame.FIXED, _this._scratchQuaternion);
                    tangoOrigin.position.setValue(tangoOriginPositionFixed, ReferenceFrame.FIXED);
                    tangoOrigin.orientation.setValue(tangoOriginOrientationFixed);
                    // convertEntityReferenceFrame(tangoOrigin, time, ReferenceFrame.FIXED);
                }
                // Set stage at floor of tango origin using user height assumption
                contextStage.position.setValue(Cartesian3.fromElements(0, -_this.deviceService.suggestedUserHeight, 0, _this._scratchCartesian), tangoOrigin);
                contextStage.orientation.setValue(Quaternion.IDENTITY);
                if (_this._initFinished && _this._vrDisplay) {
                    //update cameraPersp
                    var pose = _this._frameData.pose;
                    if (pose.orientation) {
                        _this._cameraPersp.quaternion.fromArray(pose.orientation);
                    }
                    if (pose.position) {
                        _this._cameraPersp.position.fromArray(pose.position);
                    }
                    else {
                        _this._cameraPersp.position.set(0, 0, 0);
                    }
                    _this._pointCloud.update(_this._renderPointCloud || _this._usePointCloudForOcclusion, _this._pointsToSkip, true);
                    // Make sure that the camera is correctly displayed depending on the
                    // device and camera orientations.
                    THREE.WebAR.updateCameraMeshOrientation(_this._vrDisplay, _this._cameraMesh);
                    // RENDER
                    _this._renderer.resetGLState();
                    _this._renderer.autoClear = false;
                    _this._renderer.clear();
                    _this._renderer.render(_this._cameraScene, _this._cameraOrtho);
                    _this._renderer.clearDepth();
                    if (!_this._renderPointCloud && _this._usePointCloudForOcclusion)
                        _this._renderer.context.colorMask(false, false, false, false);
                    if (_this._renderPointCloud || _this._usePointCloudForOcclusion) {
                        _this._renderer.render(_this._scene, _this._cameraPersp);
                        _this._renderer.context.colorMask(true, true, true, true);
                    }
                }
                var contextFrameState = childContextService.createFrameState(time, frameState.viewport, subviews, {
                    overrideUser: overrideUser,
                    overrideStage: overrideStage,
                    userTracking: _this.userTracking
                });
                childContextService.submitFrameState(contextFrameState);
            });
            childSessionService.manager.closeEvent.addEventListener(function () {
                remove1();
                remove2();
            });
        });
        // Check if the browser supports Tango    
        var remove = childDeviceService.vrDisplaysUpdatedEvent.addEventListener(function () {
            var vrDisplays = childDeviceService.vrDisplays;
            if (vrDisplays && vrDisplays.length > 0) {
                for (var i = 0; !_this._vrDisplay && i < vrDisplays.length; i++) {
                    _this._vrDisplay = vrDisplays[i];
                    if (_this._vrDisplay.displayName !== "Tango VR Device") {
                        _this._vrDisplay = undefined;
                    }
                }
            }
            if (!_this._vrDisplay) {
                console.error("This browser does not support Tango.");
                return;
            }
            else {
                remove();
                _this.initTango();
            }
        });
        childSessionService.connect();
    };
    TangoRealityViewer.prototype.initTango = function () {
        var _this = this;
        this.loadScripts().then(function () {
            _this.initCameraAndPointcloud();
            _this.initViewportAndCanvas();
            // alert("scripts loaded");
            _this._initFinished = true;
        });
    };
    TangoRealityViewer.prototype.loadScripts = function () {
        return new Promise(function (resolve, reject) {
            // for now we're dynamically loading these scripts
            var script = document.createElement('script');
            script.src = 'https://bionictk.github.io/website/resources/three.js';
            script.onload = function () {
                console.log("*** custom three.js loaded ***");
                var script2 = document.createElement('script');
                script2.src = 'https://bionictk.github.io/website/resources/THREE.WebAR.js';
                script2.onload = function () {
                    console.log("*** THREE.WebAR.js loaded ***");
                    resolve();
                };
                document.head.appendChild(script2);
            };
            document.head.appendChild(script);
        });
    };
    TangoRealityViewer.prototype.initCameraAndPointcloud = function () {
        this._scene = new THREE.Scene();
        this._cameraScene = new THREE.Scene();
        // Use an orthographic camera to render the video quad
        this._cameraOrtho = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 100);
        // Use the THREE.WebAR helper function to create a quad mesh for the
        // camera with the right geometry and material.
        this._cameraMesh = THREE.WebAR.createVRSeeThroughCameraMesh(this._vrDisplay);
        this._cameraScene.add(this._cameraMesh);
        this._cameraPersp = THREE.WebAR.createVRSeeThroughCamera(this._vrDisplay, 0.1, 100);
        var pointsMaterial = new THREE.RawShaderMaterial({
            uniforms: {
                size: { value: 30 },
                opacity: { value: 0.1 },
                // color: { value: new THREE.Color(0xffffff) },
                plane: { value: new THREE.Vector4() },
                distance: { value: 0.05 },
                cameraNear: { value: this._cameraPersp.near },
                cameraFar: { value: 3 }
            },
            vertexShader: this.points_vertexShader,
            fragmentShader: this.points_fragmentShader
        });
        // new THREE.PointsMaterial(
        //     { size: 0.01, vertexColors: THREE.VertexColors });
        // pointsMaterial.depthWrite = false;
        this._pointCloud = new THREE.WebAR.VRPointCloud(this._vrDisplay, true);
        this._points = new THREE.Points(this._pointCloud.getBufferGeometry(), pointsMaterial);
        // Points are changing all the time so calculating the frustum culling
        // volume is not very convenient.
        this._points.frustumCulled = false;
        // this._points.renderDepth = 0;
        this._scene.add(this._points);
    };
    TangoRealityViewer.prototype.initViewportAndCanvas = function () {
        this.updateViewport(this.viewService.viewport);
        var argonCanvas;
        if (this.viewService.layers) {
            for (var _i = 0, _a = this.viewService.layers; _i < _a.length; _i++) {
                var layer = _a[_i];
                if (layer.source instanceof HTMLCanvasElement) {
                    argonCanvas = layer.source;
                }
            }
        }
        if (this.isSharedCanvas && !argonCanvas) {
            console.log("sharedCanvas is true but no canvas registered with setLayers");
            //this._sharedCanvas = false; // currently the RealityServiceProvider overwrites this each frame
        }
        if (this.isSharedCanvas && argonCanvas) {
            // found an existing canvas, use it
            console.log("Found argon canvas, video background is sharing its context");
            this._renderer = new THREE.WebGLRenderer({ canvas: argonCanvas, antialias: false, alpha: true, logarithmicDepthBuffer: false });
            this._sharedCanvasFinal = true;
        }
        else {
            // no canvas, create a new one
            console.log("No argon shared canvas, creating one for video background");
            var renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(this.viewService.renderWidth, this.viewService.renderHeight, true);
            this.viewService.element.insertBefore(renderer.domElement, this.viewService.element.firstChild);
            renderer.domElement.style.zIndex = '0';
            this._renderer = renderer;
            this._sharedCanvasFinal = false;
        }
    };
    TangoRealityViewer.prototype.updateViewport = function (viewport) {
        if (!this._sharedCanvasFinal && this._renderer) {
            THREE.WebAR.resizeVRSeeThroughCamera(this._vrDisplay, this._cameraPersp);
            this._renderer.setSize(this.viewService.renderWidth, this.viewService.renderHeight, true);
        }
    };
    TangoRealityViewer = __decorate([
        inject(SessionService, ViewService, ContextService, Container, DeviceService),
        __metadata("design:paramtypes", [SessionService,
            ViewService,
            ContextService,
            Container,
            DeviceService, String, Object])
    ], TangoRealityViewer);
    return TangoRealityViewer;
}(RealityViewer));
export { TangoRealityViewer };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFuZ28uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0YW5nby50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQTtBQUNoRSxPQUFPLEVBQ0gsd0JBQXdCLEVBQ3hCLGdCQUFnQixFQUNoQixjQUFjLEVBRWQsVUFBVSxFQUNWLFVBQVUsRUFDVixPQUFPLEVBQ1AsT0FBTztBQUNQLGFBQWE7QUFDYixNQUFNLEVBQ1QsTUFBTSwwQkFBMEIsQ0FBQTtBQUNqQyxPQUFPLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxxQkFBcUIsRUFBa0IsTUFBTSxXQUFXLENBQUE7QUFDdEYsT0FBTyxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUscUJBQXFCLEVBQVcsTUFBTSxZQUFZLENBQUE7QUFDM0YsT0FBTyxFQUFFLHVCQUF1QixFQUFFLGlCQUFpQixFQUFFLG9CQUFvQixFQUFFLE1BQU0sVUFBVSxDQUFBO0FBQzNGLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxXQUFXLENBQUE7QUFDekMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLFlBQVksQ0FBQTtBQUMzQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sV0FBVyxDQUFBO0FBQ3pDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxTQUFTLENBQUE7QUFDckMseUNBQXlDO0FBQ3pDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxRQUFRLENBQUE7QUFDdEMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLFlBQVksQ0FBQTtBQUMzQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFLakQ7SUFBd0Msc0NBQWE7SUE4QmpELDRCQUNZLGNBQThCLEVBQzlCLFdBQXdCLEVBQ3hCLGNBQThCLEVBQzlCLFNBQW9CLEVBQ3BCLGFBQTRCLEVBQzdCLEdBQVUsRUFDVixTQUFTO1FBUHBC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QUFLLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQztZQUN2QyxJQUFJLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQztZQUMxQixJQUFJLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDO1FBQ3BDLENBQUM7SUFDTCxDQUFDO0lBRVMsMkNBQWMsR0FBeEIsVUFBeUIsUUFBdUI7UUFDNUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDNUMsS0FBYSxDQUFDLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNsRixJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM5RixDQUFDO0lBQ0wsQ0FBQztJQXRlUSxrQkFBa0I7UUFEOUIsTUFBTSxDQUFDLGNBQWMsRUFBRSxXQUFXLEVBQUUsY0FBYyxFQUFFLFNBQVMsRUFBRSxhQUFhLENBQUM7eUNBZ0M5QyxjQUFjO1lBQ2pCLFdBQVc7WUFDUixjQUFjO1lBQ25CLFNBQVM7WUFDTCxhQUFhO09BbkMvQixrQkFBa0IsQ0F3ZTlCO0lBQUQseUJBQUM7Q0FBQSxBQXhlRCxDQUF3QyxhQUFhLEdBd2VwRDtTQXhlWSxrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpbmplY3QsIENvbnRhaW5lciB9IGZyb20gJ2F1cmVsaWEtZGVwZW5kZW5jeS1pbmplY3Rpb24nXG5pbXBvcnQgeyBcbiAgICBDb25zdGFudFBvc2l0aW9uUHJvcGVydHksXG4gICAgQ29uc3RhbnRQcm9wZXJ0eSxcbiAgICBSZWZlcmVuY2VGcmFtZSxcbiAgICBDYXJ0b2dyYXBoaWMsXG4gICAgQ2FydGVzaWFuMyxcbiAgICBRdWF0ZXJuaW9uLFxuICAgIE1hdHJpeDMsXG4gICAgTWF0cml4NCxcbiAgICAvLyBDZXNpdW1NYXRoXG4gICAgRW50aXR5XG59IGZyb20gJy4uL2Nlc2l1bS9jZXNpdW0taW1wb3J0cydcbmltcG9ydCB7IENvbmZpZ3VyYXRpb24sIFJvbGUsIFNlcmlhbGl6ZWRTdWJ2aWV3TGlzdCwgQ2FudmFzVmlld3BvcnQgfSBmcm9tICcuLi9jb21tb24nXG5pbXBvcnQgeyBTZXNzaW9uU2VydmljZSwgQ29ubmVjdFNlcnZpY2UsIFNlc3Npb25Db25uZWN0U2VydmljZSwgTWVzc2FnZSB9IGZyb20gJy4uL3Nlc3Npb24nXG5pbXBvcnQgeyBlYXN0VXBTb3V0aFRvRml4ZWRGcmFtZSwgZ2V0RW50aXR5UG9zaXRpb24sIGdldEVudGl0eU9yaWVudGF0aW9uIH0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQgeyBFbnRpdHlTZXJ2aWNlIH0gZnJvbSAnLi4vZW50aXR5J1xuaW1wb3J0IHsgQ29udGV4dFNlcnZpY2UgfSBmcm9tICcuLi9jb250ZXh0J1xuaW1wb3J0IHsgRGV2aWNlU2VydmljZSB9IGZyb20gJy4uL2RldmljZSdcbmltcG9ydCB7IFZpZXdTZXJ2aWNlIH0gZnJvbSAnLi4vdmlldydcbi8vIGltcG9ydCB7IFBvc2VTdGF0dXMgfSBmcm9tICcuLi9lbnRpdHknXG5pbXBvcnQgeyBSZWFsaXR5Vmlld2VyIH0gZnJvbSAnLi9iYXNlJ1xuaW1wb3J0IHsgUmVhbGl0eVNlcnZpY2UgfSBmcm9tICcuLi9yZWFsaXR5J1xuaW1wb3J0IHsgVmlzaWJpbGl0eVNlcnZpY2UgfSBmcm9tICcuLi92aXNpYmlsaXR5J1xuXG5kZWNsYXJlIHZhciBUSFJFRTtcblxuQGluamVjdChTZXNzaW9uU2VydmljZSwgVmlld1NlcnZpY2UsIENvbnRleHRTZXJ2aWNlLCBDb250YWluZXIsIERldmljZVNlcnZpY2UpXG5leHBvcnQgY2xhc3MgVGFuZ29SZWFsaXR5Vmlld2VyIGV4dGVuZHMgUmVhbGl0eVZpZXdlciB7XG5cbiAgICBwdWJsaWMgdHlwZSA9ICd0YW5nbyc7XG4gICAgcHVibGljIHVzZXJUcmFja2luZzogJ25vbmUnfCczRE9GJ3wnNkRPRicgPSAnNkRPRic7XG5cbiAgICBwcml2YXRlIF9zY2VuZTtcbiAgICBwcml2YXRlIF9jYW1lcmFPcnRobztcbiAgICBwcml2YXRlIF9jYW1lcmFNZXNoO1xuICAgIHByaXZhdGUgX2NhbWVyYVBlcnNwO1xuICAgIHByaXZhdGUgX2NhbWVyYVNjZW5lO1xuICAgIC8vIHByaXZhdGUgX3ZyQ29udHJvbHM7XG4gICAgcHJpdmF0ZSBfcG9pbnRDbG91ZDtcbiAgICBwcml2YXRlIF9wb2ludHM7XG4gICAgcHJpdmF0ZSBfcG9pbnRzVG9Ta2lwID0gMDtcblxuICAgIHByaXZhdGUgX2ZyYW1lRGF0YSA9IG5ldyBWUkZyYW1lRGF0YSgpO1xuICAgIHByaXZhdGUgX3JlbmRlclBvaW50Q2xvdWQgPSBmYWxzZTtcbiAgICBwcml2YXRlIF91c2VQb2ludENsb3VkRm9yT2NjbHVzaW9uID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBfaW5pdEZpbmlzaGVkID0gZmFsc2U7XG5cbiAgICBwcml2YXRlIF9yZW5kZXJlcjtcbiAgICBwcml2YXRlIF9zaGFyZWRDYW52YXNGaW5hbCA9IGZhbHNlO1xuICAgIHByaXZhdGUgX3ZyRGlzcGxheSA6IFZSRGlzcGxheSB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcblxuICAgIHByaXZhdGUgX2xhc3RHZW9Ib3Jpem9udGFsQWNjdXJhY3k6IG51bWJlciA9IDk5OTtcbiAgICBwcml2YXRlIF9sYXN0R2VvSGVhZGluZ0FjY3VyYWN5OiBudW1iZXIgPSA5OTk7XG5cbiAgICBwcml2YXRlIF90YW5nb09yaWdpbkxvc3QgPSB0cnVlO1xuICAgIHByaXZhdGUgX3RhbmdvT3JpZ2luTG9zdFByZXZpb3VzRnJhbWU7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBzZXNzaW9uU2VydmljZTogU2Vzc2lvblNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgdmlld1NlcnZpY2U6IFZpZXdTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGNvbnRleHRTZXJ2aWNlOiBDb250ZXh0U2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBjb250YWluZXI6IENvbnRhaW5lcixcbiAgICAgICAgcHJpdmF0ZSBkZXZpY2VTZXJ2aWNlOiBEZXZpY2VTZXJ2aWNlLFxuICAgICAgICBwdWJsaWMgdXJpOnN0cmluZyxcbiAgICAgICAgcHVibGljIHZyRGlzcGxheSkge1xuICAgICAgICBzdXBlcih1cmkpO1xuICAgICAgICBcbiAgICAgICAgdGhpcy52aWV3U2VydmljZS52aWV3cG9ydENoYW5nZUV2ZW50LmFkZEV2ZW50TGlzdGVuZXIoKHZpZXdwb3J0OkNhbnZhc1ZpZXdwb3J0KT0+e1xuICAgICAgICAgICAgdGhpcy51cGRhdGVWaWV3cG9ydCh2aWV3cG9ydCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3NjcmF0Y2hNYXRyaXgzID0gbmV3IE1hdHJpeDM7XG4gICAgcHJpdmF0ZSBfc2NyYXRjaE1hdHJpeDQgPSBuZXcgTWF0cml4NDtcbiAgICBwcml2YXRlIF9zY3JhdGNoQ2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjM7XG4gICAgcHJpdmF0ZSBfc2NyYXRjaFF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbjtcblxuICAgIHB1YmxpYyBsb2FkKCk6IHZvaWQge1xuXG4gICAgICAgIC8vIENyZWF0ZSBhIGNoaWxkIGNvbnRhaW5lciBzbyB0aGF0IHdlIGNhbiBjb252ZW5pZW50bHkgc2V0dXAgYWxsIHRoZSBzZXJ2aWNlc1xuICAgICAgICAvLyB0aGF0IHdvdWxkIGV4aXN0IGluIGEgbm9ybWFsIGhvc3RlZCByZWFsaXR5IHZpZXdlciBcbiAgICAgICAgY29uc3QgY2hpbGQgPSB0aGlzLmNvbnRhaW5lci5jcmVhdGVDaGlsZCgpO1xuXG4gICAgICAgIC8vIENyZWF0ZSB0aGUgc2Vzc2lvbiBpbnN0YW5jZSB0aGF0IHdpbGwgYmUgdXNlZCBieSB0aGUgbWFuYWdlcsKgdG8gdGFsayB0byB0aGUgcmVhbGl0eSBcbiAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvblNlcnZpY2UuYWRkTWFuYWdlZFNlc3Npb25Qb3J0KHRoaXMudXJpKTtcbiAgICAgICAgc2Vzc2lvbi5jb25uZWN0RXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoKT0+e1xuICAgICAgICAgICAgdGhpcy5jb25uZWN0RXZlbnQucmFpc2VFdmVudChzZXNzaW9uKTsgLy8gbGV0IHRoZSBtYW5hZ2VyIGtub3cgdGhlIHNlc3Npb24gaXMgcmVhZHlcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gdXNlIGEgU2Vzc2lvbkNvbm5lY3RTZXJ2aWNlIHRvIGNyZWF0ZSBhIGNvbm5lY3Rpb24gdmlhIHRoZSBzZXNzaW9uIGluc3RhbmNlIHdlIGNyZWF0ZWRcbiAgICAgICAgY2hpbGQucmVnaXN0ZXJJbnN0YW5jZShDb25uZWN0U2VydmljZSwgXG4gICAgICAgICAgICBuZXcgU2Vzc2lvbkNvbm5lY3RTZXJ2aWNlKHNlc3Npb24sIHRoaXMuc2Vzc2lvblNlcnZpY2UuY29uZmlndXJhdGlvbilcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBzZXR1cCB0aGUgY29uZmlndXJhdGlvbiBmb3Igb3VyIHRhbmdvIHJlYWxpdHlcbiAgICAgICAgY2hpbGQucmVnaXN0ZXJJbnN0YW5jZShDb25maWd1cmF0aW9uLCB7IFxuICAgICAgICAgICAgcm9sZTogUm9sZS5SRUFMSVRZX1ZJRVdFUiwgXG4gICAgICAgICAgICB1cmk6IHRoaXMudXJpLFxuICAgICAgICAgICAgdGl0bGU6ICdUYW5nbycsXG4gICAgICAgICAgICB2ZXJzaW9uOiB0aGlzLnNlc3Npb25TZXJ2aWNlLmNvbmZpZ3VyYXRpb24udmVyc2lvbixcbiAgICAgICAgICAgIHN1cHBvcnRzQ3VzdG9tUHJvdG9jb2xzOiB0cnVlLFxuICAgICAgICAgICAgcHJvdG9jb2xzOiBbJ2FyLmNvbmZpZ3VyZVN0YWdlQHYxJywgJ2FyLnRhbmdvJ10sXG4gICAgICAgICAgICBzaGFyZWRDYW52YXM6IHRydWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIHRoZSBiYXNpYyBzZXJ2aWNlcyB0aGF0IHdlIG5lZWQgdG8gdXNlLiBcbiAgICAgICAgY2hpbGQuYXV0b1JlZ2lzdGVyQWxsKFtTZXNzaW9uU2VydmljZSwgRW50aXR5U2VydmljZSwgVmlzaWJpbGl0eVNlcnZpY2UsIENvbnRleHRTZXJ2aWNlLCBEZXZpY2VTZXJ2aWNlLCBSZWFsaXR5U2VydmljZV0pO1xuICAgICAgICBjb25zdCBjaGlsZENvbnRleHRTZXJ2aWNlID0gY2hpbGQuZ2V0KENvbnRleHRTZXJ2aWNlKSBhcyBDb250ZXh0U2VydmljZTtcbiAgICAgICAgY29uc3QgY2hpbGREZXZpY2VTZXJ2aWNlID0gY2hpbGQuZ2V0KERldmljZVNlcnZpY2UpIGFzIERldmljZVNlcnZpY2U7XG4gICAgICAgIGNvbnN0IGNoaWxkU2Vzc2lvblNlcnZpY2UgPSBjaGlsZC5nZXQoU2Vzc2lvblNlcnZpY2UpIGFzIFNlc3Npb25TZXJ2aWNlO1xuICAgICAgICBjb25zdCBjaGlsZFJlYWxpdHlTZXJ2aWNlID0gY2hpbGQuZ2V0KFJlYWxpdHlTZXJ2aWNlKSBhcyBSZWFsaXR5U2VydmljZTtcbiAgICAgICAgLy8gY29uc3QgY2hpbGRFbnRpdHlTZXJ2aWNlID0gY2hpbGQuZ2V0KEVudGl0eVNlcnZpY2UpIGFzIEVudGl0eVNlcnZpY2U7XG4gICAgICAgIC8vIGNvbnN0IGNoaWxkVmlld1NlcnZpY2UgPSBjaGlsZC5nZXQoVmlld1NlcnZpY2UpIGFzIFZpZXdTZXJ2aWNlO1xuXG4gICAgICAgIHZhciB0YW5nb09yaWdpbiA9IG5ldyBFbnRpdHkoe1xuICAgICAgICAgICAgaWQ6ICd0YW5nbycsXG4gICAgICAgICAgICBwb3NpdGlvbjogbmV3IENvbnN0YW50UG9zaXRpb25Qcm9wZXJ0eSh1bmRlZmluZWQsIGNoaWxkQ29udGV4dFNlcnZpY2Uuc3RhZ2UpLFxuICAgICAgICAgICAgb3JpZW50YXRpb246IG5ldyBDb25zdGFudFByb3BlcnR5KFF1YXRlcm5pb24uSURFTlRJVFkpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIHRoZSBjaGlsZCBkZXZpY2Ugc2VydmljZSBzaG91bGQgKm5vdCogc3VibWl0IGZyYW1lcyB0byB0aGUgdnJkaXNwbGF5LiBcbiAgICAgICAgY2hpbGREZXZpY2VTZXJ2aWNlLmF1dG9TdWJtaXRGcmFtZSA9IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgbGV0IGN1c3RvbVN0YWdlUG9zaXRpb246Q2FydGVzaWFuM3x1bmRlZmluZWQ7XG4gICAgICAgIGxldCBjdXN0b21TdGFnZU9yaWVudGF0aW9uOlF1YXRlcm5pb258dW5kZWZpbmVkO1xuXG4gICAgICAgIC8vIENyZWF0ZSBwcm90b2NvbCBoYW5kbGVycyBmb3IgYGFyLmNvbmZpZ3VyZVN0YWdlYCBwcm90b2NvbFxuICAgICAgICBjaGlsZFJlYWxpdHlTZXJ2aWNlLmNvbm5lY3RFdmVudC5hZGRFdmVudExpc3RlbmVyKChzZXNzaW9uKT0+e1xuXG4gICAgICAgICAgICBzZXNzaW9uLm9uWydhci5jb25maWd1cmVTdGFnZS5zZXRTdGFnZUdlb2xvY2F0aW9uJ10gPSAoe2dlb2xvY2F0aW9ufTp7Z2VvbG9jYXRpb246Q2FydG9ncmFwaGljfSkgPT4ge1xuICAgICAgICAgICAgICAgIGN1c3RvbVN0YWdlUG9zaXRpb24gPSBDYXJ0ZXNpYW4zLmZyb21SYWRpYW5zKGdlb2xvY2F0aW9uLmxvbmdpdHVkZSwgZ2VvbG9jYXRpb24ubGF0aXR1ZGUsIGdlb2xvY2F0aW9uLmhlaWdodCwgdW5kZWZpbmVkLCBjdXN0b21TdGFnZVBvc2l0aW9uKTtcbiAgICAgICAgICAgICAgICBjb25zdCB0cmFuc2Zvcm1NYXRyaXggPSBlYXN0VXBTb3V0aFRvRml4ZWRGcmFtZShjdXN0b21TdGFnZVBvc2l0aW9uLCB1bmRlZmluZWQsIHRoaXMuX3NjcmF0Y2hNYXRyaXg0KTtcbiAgICAgICAgICAgICAgICBjb25zdCByb3RhdGlvbk1hdHJpeCA9IE1hdHJpeDQuZ2V0Um90YXRpb24odHJhbnNmb3JtTWF0cml4LCB0aGlzLl9zY3JhdGNoTWF0cml4Myk7XG4gICAgICAgICAgICAgICAgY3VzdG9tU3RhZ2VPcmllbnRhdGlvbiA9IFF1YXRlcm5pb24uZnJvbVJvdGF0aW9uTWF0cml4KHJvdGF0aW9uTWF0cml4LCBjdXN0b21TdGFnZU9yaWVudGF0aW9uKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgc2Vzc2lvbi5vblsnYXIuY29uZmlndXJlU3RhZ2UucmVzZXRTdGFnZUdlb2xvY2F0aW9uJ10gPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgY3VzdG9tU3RhZ2VQb3NpdGlvbiA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICBjdXN0b21TdGFnZU9yaWVudGF0aW9uID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzZXNzaW9uLm9uWydhci50YW5nby50b2dnbGVQb2ludENsb3VkJ10gPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcmVuZGVyUG9pbnRDbG91ZCA9ICF0aGlzLl9yZW5kZXJQb2ludENsb3VkO1xuICAgICAgICAgICAgICAgIC8vIGlmICh0aGlzLl9yZW5kZXJQb2ludENsb3VkKSB0aGlzLl9zY2VuZS5hZGQodGhpcy5fcG9pbnRzKTsgZWxzZSB0aGlzLl9zY2VuZS5yZW1vdmUodGhpcy5fcG9pbnRzKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtyZXN1bHQ6IHRoaXMuX3JlbmRlclBvaW50Q2xvdWR9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgc2Vzc2lvbi5vblsnYXIudGFuZ28uZ2V0UGlja2luZ1BvaW50QW5kUGxhbmVJblBvaW50Q2xvdWQnXSA9ICh7eCwgeX0pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fdnJEaXNwbGF5KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiR2V0IHAmcCBvblwiK3ggK1wiLFwiICsgeSlcbiAgICAgICAgICAgICAgICAgICAgbGV0IHBvaW50QW5kUGxhbmUgPSAoPGFueT50aGlzLl92ckRpc3BsYXkpLmdldFBpY2tpbmdQb2ludEFuZFBsYW5lSW5Qb2ludENsb3VkKHgsIHkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocG9pbnRBbmRQbGFuZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7cG9pbnQ6IHBvaW50QW5kUGxhbmUucG9pbnQsIHBsYW5lOiBwb2ludEFuZFBsYW5lLnBsYW5lfSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKFwiVGFuZ28gcmVhbGl0eSBjb3VsZCBub3QgZmluZCBhIHBvaW50IGFuZCBwbGFuZVwiKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKFwidnJEaXNwbGF5IG5vdCBjb25maWd1cmVkIHlldFwiKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzZXNzaW9uLm9uWydhci50YW5nby50b2dnbGVPY2NsdXNpb24nXSA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl91c2VQb2ludENsb3VkRm9yT2NjbHVzaW9uID0gIXRoaXMuX3VzZVBvaW50Q2xvdWRGb3JPY2NsdXNpb247XG4gICAgICAgICAgICAgICAgLy8gaWYgKHRoaXMuX3VzZVBvaW50Q2xvdWRGb3JPY2NsdXNpb24pIHRoaXMuX3NjZW5lLmFkZCh0aGlzLl9wb2ludHMpOyBlbHNlIHRoaXMuX3NjZW5lLnJlbW92ZSh0aGlzLl9wb2ludHMpO1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe3Jlc3VsdDogdGhpcy5fdXNlUG9pbnRDbG91ZEZvck9jY2x1c2lvbn0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBUT0RPOiBoYW5kbGUgbWFya2VyIHRyYWNraW5nIGZvciBUYW5nb1xuICAgICAgICAgICAgc2Vzc2lvbi5vblsnYXIudGFuZ28uYWRkTWFya2VyJ10gPSAobXNnKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPE1lc3NhZ2U+KChyZXNvbHZlLCByZWplY3QpPT57XG4gICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuX2FyQ29udHJvbGxlci5sb2FkTWFya2VyKG1zZy51cmwsIChtYXJrZXJJZCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAvLyAgICAgLy8gVE9ETzogaGFuZGxlIHNpemUgb2YgbWFya2Vyc1xuICAgICAgICAgICAgICAgICAgICAvLyAgICAgdmFyIGlkID0gdGhpcy5fZ2V0SWRGb3JNYXJrZXIobWFya2VySWQpO1xuICAgICAgICAgICAgICAgICAgICAvLyAgICAgdmFyIGVudGl0eSA9IG5ldyBFbnRpdHkoe2lkfSk7XG4gICAgICAgICAgICAgICAgICAgIC8vICAgICB0aGlzLmNvbnRleHRTZXJ2aWNlLmVudGl0aWVzLmFkZChlbnRpdHkpO1xuICAgICAgICAgICAgICAgICAgICAvLyAgICAgdGhpcy5fbWFya2VyRW50aXRpZXMuc2V0KGlkLCBlbnRpdHkpO1xuICAgICAgICAgICAgICAgICAgICAvLyAgICAgcmVzb2x2ZSh7aWQ6IGlkfSk7XG4gICAgICAgICAgICAgICAgICAgIC8vIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAvLyAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICAvLyAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gfSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHRoaXMuY29udGV4dFNlcnZpY2UpOy8vZHVtbXlcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcblxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBTZXR1cCBldmVyeXRoaW5nIGFmdGVyIGNvbm5lY3RlZCB0byB0aGUgbWFuYWdlci4gVGhlIG1hbmFnZXIgb25seSBjb25uZWN0cyBvbmNlLlxuICAgICAgICBjaGlsZFNlc3Npb25TZXJ2aWNlLm1hbmFnZXIuY29ubmVjdEV2ZW50LmFkZEV2ZW50TGlzdGVuZXIoKCk9PntcblxuICAgICAgICAgICAgLy8gc2luY2Ugd2UgYXJlbid0IGNyZWF0ZSBhIGNoaWxkIHZpZXcgc2VydmljZSBhbmQgdmlld3BvcnQgc2VydmljZSwgXG4gICAgICAgICAgICAvLyBzdXBwcmVzcyBhbnkgZXJyb3JzIGZyb20gbm90IGhhbmRsaW5nIHRoZXNlIG1lc3NhZ2VzXG4gICAgICAgICAgICBjaGlsZFNlc3Npb25TZXJ2aWNlLm1hbmFnZXIuc3VwcHJlc3NFcnJvck9uVW5rbm93blRvcGljID0gdHJ1ZTtcblxuICAgICAgICAgICAgY29uc3Qgc3Vidmlld3M6U2VyaWFsaXplZFN1YnZpZXdMaXN0ID0gW107XG5cbiAgICAgICAgICAgIGNvbnN0IGNoZWNrU3VnZ2VzdGVkR2VvbG9jYXRpb25TdWJzY3JpcHRpb24gPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGNoaWxkRGV2aWNlU2VydmljZS5zdWdnZXN0ZWRHZW9sb2NhdGlvblN1YnNjcmlwdGlvbikge1xuICAgICAgICAgICAgICAgICAgICBjaGlsZERldmljZVNlcnZpY2Uuc3Vic2NyaWJlR2VvbG9jYXRpb24oY2hpbGREZXZpY2VTZXJ2aWNlLnN1Z2dlc3RlZEdlb2xvY2F0aW9uU3Vic2NyaXB0aW9uKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjaGlsZERldmljZVNlcnZpY2UudW5zdWJzY3JpYmVHZW9sb2NhdGlvbigpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY2hlY2tTdWdnZXN0ZWRHZW9sb2NhdGlvblN1YnNjcmlwdGlvbigpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCByZW1vdmUxID0gY2hpbGREZXZpY2VTZXJ2aWNlLnN1Z2dlc3RlZEdlb2xvY2F0aW9uU3Vic2NyaXB0aW9uQ2hhbmdlRXZlbnQuYWRkRXZlbnRMaXN0ZW5lcihjaGVja1N1Z2dlc3RlZEdlb2xvY2F0aW9uU3Vic2NyaXB0aW9uKTtcblxuICAgICAgICAgICAgY29uc3QgcmVtb3ZlMiA9IGNoaWxkRGV2aWNlU2VydmljZS5mcmFtZVN0YXRlRXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoZnJhbWVTdGF0ZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChjaGlsZFNlc3Npb25TZXJ2aWNlLm1hbmFnZXIuaXNDbG9zZWQpIHJldHVybjtcblxuICAgICAgICAgICAgICAgIFNlcmlhbGl6ZWRTdWJ2aWV3TGlzdC5jbG9uZShmcmFtZVN0YXRlLnN1YnZpZXdzLCBzdWJ2aWV3cyk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCB0aW1lID0gZnJhbWVTdGF0ZS50aW1lO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIG92ZXJyaWRlIHVzZXIgcG9zIHRvIHRhbmdvIHBvc1xuICAgICAgICAgICAgICAgIC8vIFdhcyBvcmlnaW5hbGx5IHVzZWQgdG8gcHJvdmlkZSBjb250cm9sIG92ZXIgdXNlcnBvc2UgaWYgdGhlIGRldmljZSBkb2VzIG5vdCBoYXZlIGEgcGh5c2ljYWwgcG9zZVxuICAgICAgICAgICAgICAgIGNvbnN0IG92ZXJyaWRlVXNlciA9IHRydWU7IC8vIShkZXZpY2VVc2VyUG9zZS5zdGF0dXMgJiBQb3NlU3RhdHVzLktOT1dOKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc3QgY29udGV4dFVzZXIgPSBjaGlsZENvbnRleHRTZXJ2aWNlLnVzZXI7XG4gICAgICAgICAgICAgICAgY29uc3QgY29udGV4dFN0YWdlID0gY2hpbGRDb250ZXh0U2VydmljZS5zdGFnZTtcblxuICAgICAgICAgICAgICAgIHZhciB0YW5nb1VzZXJQb3NpdGlvbjogQ2FydGVzaWFuMyB8IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB2YXIgdGFuZ29Vc2VyT3JpZW50YXRpb246IFF1YXRlcm5pb24gfCB1bmRlZmluZWQ7XG5cbiAgICAgICAgICAgICAgICAvLyBPdmVycmlkZSB1c2VyXG4gICAgICAgICAgICAgICAgKDxWUkRpc3BsYXk+dGhpcy5fdnJEaXNwbGF5KVsnZ2V0RnJhbWVEYXRhJ10odGhpcy5fZnJhbWVEYXRhKTtcbiAgICAgICAgICAgICAgICBjb25zdCB0YW5nb1BvcyA9IHRoaXMuX2ZyYW1lRGF0YS5wb3NlLnBvc2l0aW9uO1xuICAgICAgICAgICAgICAgIHRhbmdvVXNlclBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjModGFuZ29Qb3NbMF0sIHRhbmdvUG9zWzFdLCB0YW5nb1Bvc1syXSk7XG5cbiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0YW5nbyB0cmFja2luZyBpcyBsb3N0XG4gICAgICAgICAgICAgICAgdGhpcy5fdGFuZ29PcmlnaW5Mb3N0UHJldmlvdXNGcmFtZSA9IHRoaXMuX3RhbmdvT3JpZ2luTG9zdDtcbiAgICAgICAgICAgICAgICB0aGlzLl90YW5nb09yaWdpbkxvc3QgPSB0YW5nb1VzZXJQb3NpdGlvbi5lcXVhbHMoQ2FydGVzaWFuMy5aRVJPKSB8fCB0YW5nb1VzZXJQb3NpdGlvbi54ID09PSBOYU47XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gSWYgdGFuZ28gdHJhY2tpbmcgaXMgbG9zdCwgc2V0IHVzZXJQb3NpdGlvbiB0byB1bmRlZmluZWQgLT4gcmVzdWx0cyBpbiB1c2VyIHBvc2Ugc3RhdHVzIExPU1RcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fdGFuZ29PcmlnaW5Mb3N0KSB7XG4gICAgICAgICAgICAgICAgICAgIHRhbmdvVXNlclBvc2l0aW9uID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICB0YW5nb1VzZXJPcmllbnRhdGlvbiA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0YW5nb1JvdCA9IHRoaXMuX2ZyYW1lRGF0YS5wb3NlLm9yaWVudGF0aW9uO1xuICAgICAgICAgICAgICAgICAgICB0YW5nb1VzZXJPcmllbnRhdGlvbiA9IG5ldyBRdWF0ZXJuaW9uKHRhbmdvUm90WzBdLCB0YW5nb1JvdFsxXSwgdGFuZ29Sb3RbMl0sIHRhbmdvUm90WzNdKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAoY29udGV4dFVzZXIucG9zaXRpb24gYXMgQ29uc3RhbnRQb3NpdGlvblByb3BlcnR5KS5zZXRWYWx1ZSh0YW5nb1VzZXJQb3NpdGlvbiwgdGFuZ29PcmlnaW4pO1xuICAgICAgICAgICAgICAgIChjb250ZXh0VXNlci5vcmllbnRhdGlvbiBhcyBDb25zdGFudFByb3BlcnR5KS5zZXRWYWx1ZSh0YW5nb1VzZXJPcmllbnRhdGlvbik7XG5cbiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgc3RhZ2UgZ2VvcG9zZSB3aGVuIEdQUyBhY2N1cmFjeSBpbXByb3ZlcyBvciBUYW5nbyBvcmlnaW4gaXMgcmVwb3NpdGlvbmVkXG4gICAgICAgICAgICAgICAgY29uc3QgY3VycmVudEdlb0hvcml6b250YWxBY2N1cmFjeSA9IHRoaXMuZGV2aWNlU2VydmljZS5nZW9Ib3Jpem9udGFsQWNjdXJhY3kgfHwgOTk5O1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRHZW9IZWFkaW5nQWNjdXJhY3kgPSB0aGlzLmRldmljZVNlcnZpY2UuZ2VvSGVhZGluZ0FjY3VyYWN5IHx8IDk5OTtcbiAgICAgICAgICAgICAgICBjb25zdCBncHNBY2N1cmFjeUhhc0ltcHJvdmVkID0gdGhpcy5fbGFzdEdlb0hvcml6b250YWxBY2N1cmFjeSA+IGN1cnJlbnRHZW9Ib3Jpem9udGFsQWNjdXJhY3k7XG4gICAgICAgICAgICAgICAgY29uc3QgY29tcGFzc0FjY3VyYWN5SGFzSW1wcm92ZWQgPSB0aGlzLl9sYXN0R2VvSGVhZGluZ0FjY3VyYWN5ID4gY3VycmVudEdlb0hlYWRpbmdBY2N1cmFjeTtcbiAgICAgICAgICAgICAgICBjb25zdCB0YW5nb09yaWdpblJlcG9zaXRpb25lZCA9IHRoaXMuX3RhbmdvT3JpZ2luTG9zdFByZXZpb3VzRnJhbWUgJiYgIXRoaXMuX3RhbmdvT3JpZ2luTG9zdDtcbiAgICAgICAgICAgICAgICBjb25zdCB0YW5nb09yaWdpbk5lZWRzVXBkYXRlID0gZ3BzQWNjdXJhY3lIYXNJbXByb3ZlZCB8fCB0YW5nb09yaWdpblJlcG9zaXRpb25lZCB8fCBjb21wYXNzQWNjdXJhY3lIYXNJbXByb3ZlZDtcbiAgICAgICAgICAgICAgICBjb25zdCBvdmVycmlkZVN0YWdlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAodGFuZ29Vc2VyUG9zaXRpb24gJiYgdGFuZ29Vc2VyT3JpZW50YXRpb24gJiYgdGFuZ29PcmlnaW5OZWVkc1VwZGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGFuZ29PcmlnaW5SZXBvc2l0aW9uZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVGFuZ28gb3JpZ2luIGhhcyBiZWVuIHJlc2V0LlwiKVxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbGFzdEdlb0hlYWRpbmdBY2N1cmFjeSA9IHRoaXMuX2xhc3RHZW9Ib3Jpem9udGFsQWNjdXJhY3kgPSA5OTk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl90YW5nb09yaWdpbkxvc3QgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChncHNBY2N1cmFjeUhhc0ltcHJvdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkN1cnJlbnQgaG9yaXpvbnRhbCBhY2N1cmFjeSBoYXMgYmVlbiBpbnByb3ZlZCB0bzpcIiArIHRoaXMuZGV2aWNlU2VydmljZS5nZW9Ib3Jpem9udGFsQWNjdXJhY3kpXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sYXN0R2VvSG9yaXpvbnRhbEFjY3VyYWN5ID0gY3VycmVudEdlb0hvcml6b250YWxBY2N1cmFjeTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChjb21wYXNzQWNjdXJhY3lIYXNJbXByb3ZlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJDdXJyZW50IGhlYWRpbmcgYWNjdXJhY3kgaGFzIGJlZW4gaW5wcm92ZWQgdG86XCIgKyB0aGlzLmRldmljZVNlcnZpY2UuZ2VvSGVhZGluZ0FjY3VyYWN5KVxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbGFzdEdlb0hlYWRpbmdBY2N1cmFjeSA9IGN1cnJlbnRHZW9IZWFkaW5nQWNjdXJhY3k7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBHZXQgdGFuZ28gb3JpZ2luIHJlbGF0aXZlIHRvIGNvbnRleHQgdXNlci5cbiAgICAgICAgICAgICAgICAgICAgLy8gRmlyc3QgdHdvIGxpbmVzIHNob3VsZCBiZSByZW1vdmVkIGFmdGVyIGJ1Z2ZpeCBvZiBub3QgYmVpbmcgYWJsZSB0byBnZXQgdHJhbnNmb3JtIG9mIGFuIGVudGl0eSB3aXRoIGFuIHVuZGVmaW5lZCBwb3NpdGlvbnxvcmllbnRhdGlvbiByZWxhdGl2ZSB0byBvbmUgb2YgaXQncyBjaGlsZHJlblxuICAgICAgICAgICAgICAgICAgICAodGFuZ29PcmlnaW4ucG9zaXRpb24gYXMgQ29uc3RhbnRQb3NpdGlvblByb3BlcnR5KS5zZXRWYWx1ZShDYXJ0ZXNpYW4zLlpFUk8sIFJlZmVyZW5jZUZyYW1lLkZJWEVEKTtcbiAgICAgICAgICAgICAgICAgICAgKHRhbmdvT3JpZ2luLm9yaWVudGF0aW9uIGFzIENvbnN0YW50UHJvcGVydHkpLnNldFZhbHVlKFF1YXRlcm5pb24uSURFTlRJVFkpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0YW5nb09yaWdpblBvc2l0aW9uID0gZ2V0RW50aXR5UG9zaXRpb24odGFuZ29PcmlnaW4sIHRpbWUsIGNvbnRleHRVc2VyLCB0aGlzLl9zY3JhdGNoQ2FydGVzaWFuKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFuZ29PcmlnaW5PcmllbnRhdGlvbiA9IGdldEVudGl0eU9yaWVudGF0aW9uKHRhbmdvT3JpZ2luLCB0aW1lLCBjb250ZXh0VXNlciwgdGhpcy5fc2NyYXRjaFF1YXRlcm5pb24pO1xuICAgICAgICAgICAgICAgICAgICAvLyBTZXQgdGFuZ28gb3JpZ2luIHJlbGF0aXZlIHRvIGRldmljZSB1c2VyICh3aGljaCBoYXMgZ2VvcG9zZSlcbiAgICAgICAgICAgICAgICAgICAgKHRhbmdvT3JpZ2luLnBvc2l0aW9uIGFzIENvbnN0YW50UG9zaXRpb25Qcm9wZXJ0eSkuc2V0VmFsdWUodGFuZ29PcmlnaW5Qb3NpdGlvbiwgdGhpcy5kZXZpY2VTZXJ2aWNlLnVzZXIpO1xuICAgICAgICAgICAgICAgICAgICAodGFuZ29PcmlnaW4ub3JpZW50YXRpb24gYXMgQ29uc3RhbnRQcm9wZXJ0eSkuc2V0VmFsdWUodGFuZ29PcmlnaW5PcmllbnRhdGlvbik7XG4gICAgICAgICAgICAgICAgICAgIC8vIFJlZGVmaW5lIHRhbmdvIG9yaWdpbiByZWxhdGl2ZSB0byBmaXhlZFxuICAgICAgICAgICAgICAgICAgICBjb25zdCB0YW5nb09yaWdpblBvc2l0aW9uRml4ZWQgPSBnZXRFbnRpdHlQb3NpdGlvbih0YW5nb09yaWdpbiwgdGltZSwgUmVmZXJlbmNlRnJhbWUuRklYRUQsIHRoaXMuX3NjcmF0Y2hDYXJ0ZXNpYW4pO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0YW5nb09yaWdpbk9yaWVudGF0aW9uRml4ZWQgPSBnZXRFbnRpdHlPcmllbnRhdGlvbih0YW5nb09yaWdpbiwgdGltZSwgUmVmZXJlbmNlRnJhbWUuRklYRUQsIHRoaXMuX3NjcmF0Y2hRdWF0ZXJuaW9uKTtcbiAgICAgICAgICAgICAgICAgICAgKHRhbmdvT3JpZ2luLnBvc2l0aW9uIGFzIENvbnN0YW50UG9zaXRpb25Qcm9wZXJ0eSkuc2V0VmFsdWUodGFuZ29PcmlnaW5Qb3NpdGlvbkZpeGVkLCBSZWZlcmVuY2VGcmFtZS5GSVhFRCk7XG4gICAgICAgICAgICAgICAgICAgICh0YW5nb09yaWdpbi5vcmllbnRhdGlvbiBhcyBDb25zdGFudFByb3BlcnR5KS5zZXRWYWx1ZSh0YW5nb09yaWdpbk9yaWVudGF0aW9uRml4ZWQpO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnZlcnRFbnRpdHlSZWZlcmVuY2VGcmFtZSh0YW5nb09yaWdpbiwgdGltZSwgUmVmZXJlbmNlRnJhbWUuRklYRUQpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIFNldCBzdGFnZSBhdCBmbG9vciBvZiB0YW5nbyBvcmlnaW4gdXNpbmcgdXNlciBoZWlnaHQgYXNzdW1wdGlvblxuICAgICAgICAgICAgICAgIChjb250ZXh0U3RhZ2UucG9zaXRpb24gYXMgQ29uc3RhbnRQb3NpdGlvblByb3BlcnR5KS5zZXRWYWx1ZShDYXJ0ZXNpYW4zLmZyb21FbGVtZW50cygwLCAtdGhpcy5kZXZpY2VTZXJ2aWNlLnN1Z2dlc3RlZFVzZXJIZWlnaHQsIDAsIHRoaXMuX3NjcmF0Y2hDYXJ0ZXNpYW4pLCB0YW5nb09yaWdpbik7XG4gICAgICAgICAgICAgICAgKGNvbnRleHRTdGFnZS5vcmllbnRhdGlvbiBhcyBDb25zdGFudFByb3BlcnR5KS5zZXRWYWx1ZShRdWF0ZXJuaW9uLklERU5USVRZKTsgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5faW5pdEZpbmlzaGVkICYmIHRoaXMuX3ZyRGlzcGxheSkge1xuICAgICAgICAgICAgICAgICAgICAvL3VwZGF0ZSBjYW1lcmFQZXJzcFxuICAgICAgICAgICAgICAgICAgICBsZXQgcG9zZSA9IHRoaXMuX2ZyYW1lRGF0YS5wb3NlO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKCBwb3NlLm9yaWVudGF0aW9uICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2FtZXJhUGVyc3AucXVhdGVybmlvbi5mcm9tQXJyYXkoIHBvc2Uub3JpZW50YXRpb24gKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmICggcG9zZS5wb3NpdGlvbiApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2NhbWVyYVBlcnNwLnBvc2l0aW9uLmZyb21BcnJheSggcG9zZS5wb3NpdGlvbiApO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2FtZXJhUGVyc3AucG9zaXRpb24uc2V0KCAwLCAwLCAwICk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3BvaW50Q2xvdWQudXBkYXRlKHRoaXMuX3JlbmRlclBvaW50Q2xvdWQgfHwgdGhpcy5fdXNlUG9pbnRDbG91ZEZvck9jY2x1c2lvbiwgdGhpcy5fcG9pbnRzVG9Ta2lwLCB0cnVlKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgY2FtZXJhIGlzIGNvcnJlY3RseSBkaXNwbGF5ZWQgZGVwZW5kaW5nIG9uIHRoZVxuICAgICAgICAgICAgICAgICAgICAvLyBkZXZpY2UgYW5kIGNhbWVyYSBvcmllbnRhdGlvbnMuXG4gICAgICAgICAgICAgICAgICAgIChUSFJFRSBhcyBhbnkpLldlYkFSLnVwZGF0ZUNhbWVyYU1lc2hPcmllbnRhdGlvbih0aGlzLl92ckRpc3BsYXksIHRoaXMuX2NhbWVyYU1lc2gpO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIFJFTkRFUlxuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbmRlcmVyLnJlc2V0R0xTdGF0ZSgpO1xuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbmRlcmVyLmF1dG9DbGVhciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW5kZXJlci5jbGVhcigpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW5kZXJlci5yZW5kZXIodGhpcy5fY2FtZXJhU2NlbmUsIHRoaXMuX2NhbWVyYU9ydGhvKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVuZGVyZXIuY2xlYXJEZXB0aCgpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5fcmVuZGVyUG9pbnRDbG91ZCAmJiB0aGlzLl91c2VQb2ludENsb3VkRm9yT2NjbHVzaW9uKSB0aGlzLl9yZW5kZXJlci5jb250ZXh0LmNvbG9yTWFzayggZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UgKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX3JlbmRlclBvaW50Q2xvdWQgfHwgdGhpcy5fdXNlUG9pbnRDbG91ZEZvck9jY2x1c2lvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVuZGVyZXIucmVuZGVyKHRoaXMuX3NjZW5lLCB0aGlzLl9jYW1lcmFQZXJzcCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW5kZXJlci5jb250ZXh0LmNvbG9yTWFzayggdHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc3QgY29udGV4dEZyYW1lU3RhdGUgPSBjaGlsZENvbnRleHRTZXJ2aWNlLmNyZWF0ZUZyYW1lU3RhdGUoXG4gICAgICAgICAgICAgICAgICAgIHRpbWUsXG4gICAgICAgICAgICAgICAgICAgIGZyYW1lU3RhdGUudmlld3BvcnQsXG4gICAgICAgICAgICAgICAgICAgIHN1YnZpZXdzLFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvdmVycmlkZVVzZXIsICBcbiAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJyaWRlU3RhZ2UsXG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VyVHJhY2tpbmc6IHRoaXMudXNlclRyYWNraW5nXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIGNoaWxkQ29udGV4dFNlcnZpY2Uuc3VibWl0RnJhbWVTdGF0ZShjb250ZXh0RnJhbWVTdGF0ZSk7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBjaGlsZFNlc3Npb25TZXJ2aWNlLm1hbmFnZXIuY2xvc2VFdmVudC5hZGRFdmVudExpc3RlbmVyKCgpPT57XG4gICAgICAgICAgICAgICAgcmVtb3ZlMSgpO1xuICAgICAgICAgICAgICAgIHJlbW92ZTIoKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pXG5cbiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgVGFuZ28gICAgXG4gICAgICAgIGxldCByZW1vdmUgPSBjaGlsZERldmljZVNlcnZpY2UudnJEaXNwbGF5c1VwZGF0ZWRFdmVudC5hZGRFdmVudExpc3RlbmVyKCgpID0+IHtcbiAgICAgICAgICAgIGxldCB2ckRpc3BsYXlzID0gY2hpbGREZXZpY2VTZXJ2aWNlLnZyRGlzcGxheXM7XG4gICAgICAgICAgICBpZiAodnJEaXNwbGF5cyAmJiB2ckRpc3BsYXlzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgIXRoaXMuX3ZyRGlzcGxheSAmJiBpIDwgdnJEaXNwbGF5cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl92ckRpc3BsYXkgPSB2ckRpc3BsYXlzW2ldO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fdnJEaXNwbGF5LmRpc3BsYXlOYW1lICE9PSBcIlRhbmdvIFZSIERldmljZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl92ckRpc3BsYXkgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXRoaXMuX3ZyRGlzcGxheSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJUaGlzIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBUYW5nby5cIik7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZW1vdmUoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmluaXRUYW5nbygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBjaGlsZFNlc3Npb25TZXJ2aWNlLmNvbm5lY3QoKTtcblxuICAgIH1cblxuICAgIHByb3RlY3RlZCBpbml0VGFuZ28oKSB7XG4gICAgICAgIHRoaXMubG9hZFNjcmlwdHMoKS50aGVuKCgpPT4ge1xuICAgICAgICAgICAgdGhpcy5pbml0Q2FtZXJhQW5kUG9pbnRjbG91ZCgpO1xuICAgICAgICAgICAgdGhpcy5pbml0Vmlld3BvcnRBbmRDYW52YXMoKTtcbiAgICAgICAgICAgIC8vIGFsZXJ0KFwic2NyaXB0cyBsb2FkZWRcIik7XG4gICAgICAgICAgICB0aGlzLl9pbml0RmluaXNoZWQgPSB0cnVlO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgbG9hZFNjcmlwdHMoKTpQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIC8vIGZvciBub3cgd2UncmUgZHluYW1pY2FsbHkgbG9hZGluZyB0aGVzZSBzY3JpcHRzXG4gICAgICAgICAgICB2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XG4gICAgICAgICAgICBzY3JpcHQuc3JjID0gJ2h0dHBzOi8vYmlvbmljdGsuZ2l0aHViLmlvL3dlYnNpdGUvcmVzb3VyY2VzL3RocmVlLmpzJztcbiAgICAgICAgICAgIHNjcmlwdC5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCIqKiogY3VzdG9tIHRocmVlLmpzIGxvYWRlZCAqKipcIik7XG4gICAgICAgICAgICAgICAgdmFyIHNjcmlwdDIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICAgICAgICAgICAgICBzY3JpcHQyLnNyYyA9ICdodHRwczovL2Jpb25pY3RrLmdpdGh1Yi5pby93ZWJzaXRlL3Jlc291cmNlcy9USFJFRS5XZWJBUi5qcyc7XG4gICAgICAgICAgICAgICAgc2NyaXB0Mi5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiKioqIFRIUkVFLldlYkFSLmpzIGxvYWRlZCAqKipcIik7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0Mik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgcG9pbnRzX3ZlcnRleFNoYWRlciA9XG5gYXR0cmlidXRlIHZlYzMgcG9zaXRpb247XG51bmlmb3JtIGZsb2F0IHNpemU7XG51bmlmb3JtIG1hdDQgbW9kZWxWaWV3TWF0cml4O1xudW5pZm9ybSBtYXQ0IHByb2plY3Rpb25NYXRyaXg7XG51bmlmb3JtIHZlYzQgcGxhbmU7XG51bmlmb3JtIGZsb2F0IGRpc3RhbmNlO1xudW5pZm9ybSBmbG9hdCBjYW1lcmFOZWFyO1xudW5pZm9ybSBmbG9hdCBjYW1lcmFGYXI7XG52YXJ5aW5nIGZsb2F0IHZfZGlzY2FyZDtcbnZhcnlpbmcgdmVjMyBjb2xvcjtcbnZvaWQgbWFpbih2b2lkKSB7XG4gICAgdmVjNCB2NFBvc2l0aW9uID0gdmVjNChwb3NpdGlvbiwgMS4wKTtcbiAgICBmbG9hdCBkID0gZG90KHBsYW5lLCB2NFBvc2l0aW9uKTtcbiAgICB2X2Rpc2NhcmQgPSAwLjA7XG4gICAgaWYgKGFicyhkKSA8IGRpc3RhbmNlKSB2X2Rpc2NhcmQgPSAxLjA7XG4gICAgZ2xfUG9pbnRTaXplID0gc2l6ZTtcbiAgICBnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtb2RlbFZpZXdNYXRyaXggKiB2NFBvc2l0aW9uO1xuICAgIGZsb2F0IGRlcHRoID0gMS4wIC0gKChnbF9Qb3NpdGlvbi56IC0gY2FtZXJhTmVhcikgLyAoY2FtZXJhRmFyIC0gY2FtZXJhTmVhcikpO1xuICAgIGNvbG9yID0gdmVjMyhkZXB0aCk7XG59YDtcblxuICAgIHByaXZhdGUgcG9pbnRzX2ZyYWdtZW50U2hhZGVyID1cbmBwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDtcbnZhcnlpbmcgdmVjMyBjb2xvcjtcbnVuaWZvcm0gZmxvYXQgb3BhY2l0eTtcbnZhcnlpbmcgZmxvYXQgdl9kaXNjYXJkO1xudm9pZCBtYWluKHZvaWQpIHtcbiAgICBpZiAodl9kaXNjYXJkID4gMC4wKSBkaXNjYXJkO1xuICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoIGNvbG9yLCBvcGFjaXR5ICk7XG59YDtcbiAgICBcbiAgICBwcm90ZWN0ZWQgaW5pdENhbWVyYUFuZFBvaW50Y2xvdWQoKSB7XG4gICAgICAgIHRoaXMuX3NjZW5lID0gbmV3IFRIUkVFLlNjZW5lKCk7XG4gICAgICAgIHRoaXMuX2NhbWVyYVNjZW5lID0gbmV3IFRIUkVFLlNjZW5lKCk7XG4gICAgICAgIC8vIFVzZSBhbiBvcnRob2dyYXBoaWMgY2FtZXJhIHRvIHJlbmRlciB0aGUgdmlkZW8gcXVhZFxuICAgICAgICB0aGlzLl9jYW1lcmFPcnRobyA9IG5ldyBUSFJFRS5PcnRob2dyYXBoaWNDYW1lcmEoIC0xLCAxLCAxLCAtMSwgMCwgMTAwICk7XG4gICAgICAgIC8vIFVzZSB0aGUgVEhSRUUuV2ViQVIgaGVscGVyIGZ1bmN0aW9uIHRvIGNyZWF0ZSBhIHF1YWQgbWVzaCBmb3IgdGhlXG4gICAgICAgIC8vIGNhbWVyYSB3aXRoIHRoZSByaWdodCBnZW9tZXRyeSBhbmQgbWF0ZXJpYWwuXG4gICAgICAgIHRoaXMuX2NhbWVyYU1lc2ggPSAoVEhSRUUgYXMgYW55KS5XZWJBUi5jcmVhdGVWUlNlZVRocm91Z2hDYW1lcmFNZXNoKHRoaXMuX3ZyRGlzcGxheSk7XG4gICAgICAgIHRoaXMuX2NhbWVyYVNjZW5lLmFkZCh0aGlzLl9jYW1lcmFNZXNoKTtcblxuICAgICAgICB0aGlzLl9jYW1lcmFQZXJzcCA9IChUSFJFRSBhcyBhbnkpLldlYkFSLmNyZWF0ZVZSU2VlVGhyb3VnaENhbWVyYSh0aGlzLl92ckRpc3BsYXksIDAuMSwgMTAwKTtcblxuICAgICAgICBsZXQgcG9pbnRzTWF0ZXJpYWwgPSBuZXcgVEhSRUUuUmF3U2hhZGVyTWF0ZXJpYWwoe1xuICAgICAgICAgIHVuaWZvcm1zOiB7XG4gICAgICAgICAgICBzaXplOiB7IHZhbHVlOiAzMCB9LFxuICAgICAgICAgICAgb3BhY2l0eTogeyB2YWx1ZTogMC4xIH0sXG4gICAgICAgICAgICAvLyBjb2xvcjogeyB2YWx1ZTogbmV3IFRIUkVFLkNvbG9yKDB4ZmZmZmZmKSB9LFxuICAgICAgICAgICAgcGxhbmU6IHsgdmFsdWU6IG5ldyBUSFJFRS5WZWN0b3I0KCkgfSxcbiAgICAgICAgICAgIGRpc3RhbmNlOiB7IHZhbHVlOiAwLjA1IH0sXG4gICAgICAgICAgICBjYW1lcmFOZWFyOiB7IHZhbHVlOiB0aGlzLl9jYW1lcmFQZXJzcC5uZWFyIH0sXG4gICAgICAgICAgICBjYW1lcmFGYXI6ICB7IHZhbHVlOiAzIH1cbiAgICAgICAgICB9LFxuICAgICAgICAgIHZlcnRleFNoYWRlcjogdGhpcy5wb2ludHNfdmVydGV4U2hhZGVyLFxuICAgICAgICAgIGZyYWdtZW50U2hhZGVyOiB0aGlzLnBvaW50c19mcmFnbWVudFNoYWRlclxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIC8vIG5ldyBUSFJFRS5Qb2ludHNNYXRlcmlhbChcbiAgICAgICAgLy8gICAgIHsgc2l6ZTogMC4wMSwgdmVydGV4Q29sb3JzOiBUSFJFRS5WZXJ0ZXhDb2xvcnMgfSk7XG4gICAgICAgIC8vIHBvaW50c01hdGVyaWFsLmRlcHRoV3JpdGUgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5fcG9pbnRDbG91ZCA9IG5ldyAoVEhSRUUgYXMgYW55KS5XZWJBUi5WUlBvaW50Q2xvdWQodGhpcy5fdnJEaXNwbGF5LCB0cnVlKTtcbiAgICAgICAgdGhpcy5fcG9pbnRzID0gbmV3IFRIUkVFLlBvaW50cyh0aGlzLl9wb2ludENsb3VkLmdldEJ1ZmZlckdlb21ldHJ5KCksXG4gICAgICAgIHBvaW50c01hdGVyaWFsKTtcbiAgICAgICAgLy8gUG9pbnRzIGFyZSBjaGFuZ2luZyBhbGwgdGhlIHRpbWUgc28gY2FsY3VsYXRpbmcgdGhlIGZydXN0dW0gY3VsbGluZ1xuICAgICAgICAvLyB2b2x1bWUgaXMgbm90IHZlcnkgY29udmVuaWVudC5cbiAgICAgICAgdGhpcy5fcG9pbnRzLmZydXN0dW1DdWxsZWQgPSBmYWxzZTtcbiAgICAgICAgLy8gdGhpcy5fcG9pbnRzLnJlbmRlckRlcHRoID0gMDtcbiAgICAgICAgdGhpcy5fc2NlbmUuYWRkKHRoaXMuX3BvaW50cyk7XG4gICAgfVxuICAgIFxuICAgIHByb3RlY3RlZCBpbml0Vmlld3BvcnRBbmRDYW52YXMoKSB7XG4gICAgICAgdGhpcy51cGRhdGVWaWV3cG9ydCg8YW55PnRoaXMudmlld1NlcnZpY2Uudmlld3BvcnQpO1xuXG4gICAgICAgIHZhciBhcmdvbkNhbnZhcztcbiAgICAgICAgaWYgKHRoaXMudmlld1NlcnZpY2UubGF5ZXJzKSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGxheWVyIG9mIHRoaXMudmlld1NlcnZpY2UubGF5ZXJzKSB7XG4gICAgICAgICAgICAgICAgaWYgKGxheWVyLnNvdXJjZSBpbnN0YW5jZW9mIEhUTUxDYW52YXNFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIGFyZ29uQ2FudmFzID0gbGF5ZXIuc291cmNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmlzU2hhcmVkQ2FudmFzICYmICFhcmdvbkNhbnZhcykge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJzaGFyZWRDYW52YXMgaXMgdHJ1ZSBidXQgbm8gY2FudmFzIHJlZ2lzdGVyZWQgd2l0aCBzZXRMYXllcnNcIik7XG4gICAgICAgICAgICAvL3RoaXMuX3NoYXJlZENhbnZhcyA9IGZhbHNlOyAvLyBjdXJyZW50bHkgdGhlIFJlYWxpdHlTZXJ2aWNlUHJvdmlkZXIgb3ZlcndyaXRlcyB0aGlzIGVhY2ggZnJhbWVcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmlzU2hhcmVkQ2FudmFzICYmIGFyZ29uQ2FudmFzKSB7XG4gICAgICAgICAgICAvLyBmb3VuZCBhbiBleGlzdGluZyBjYW52YXMsIHVzZSBpdFxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJGb3VuZCBhcmdvbiBjYW52YXMsIHZpZGVvIGJhY2tncm91bmQgaXMgc2hhcmluZyBpdHMgY29udGV4dFwiKTtcbiAgICAgICAgICAgIHRoaXMuX3JlbmRlcmVyID0gbmV3IFRIUkVFLldlYkdMUmVuZGVyZXIoe2NhbnZhczogYXJnb25DYW52YXMsIGFudGlhbGlhczogZmFsc2UsIGFscGhhOiB0cnVlLCBsb2dhcml0aG1pY0RlcHRoQnVmZmVyOiBmYWxzZX0pO1xuICAgICAgICAgICAgdGhpcy5fc2hhcmVkQ2FudmFzRmluYWwgPSB0cnVlO1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBubyBjYW52YXMsIGNyZWF0ZSBhIG5ldyBvbmVcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiTm8gYXJnb24gc2hhcmVkIGNhbnZhcywgY3JlYXRpbmcgb25lIGZvciB2aWRlbyBiYWNrZ3JvdW5kXCIpO1xuICAgICAgICAgICAgdmFyIHJlbmRlcmVyID0gbmV3IFRIUkVFLldlYkdMUmVuZGVyZXIoe2FudGlhbGlhczogZmFsc2V9KTtcbiAgICAgICAgICAgIHJlbmRlcmVyLnNldFNpemUodGhpcy52aWV3U2VydmljZS5yZW5kZXJXaWR0aCwgdGhpcy52aWV3U2VydmljZS5yZW5kZXJIZWlnaHQsIHRydWUpO1xuICAgICAgICAgICAgdGhpcy52aWV3U2VydmljZS5lbGVtZW50Lmluc2VydEJlZm9yZShyZW5kZXJlci5kb21FbGVtZW50LCB0aGlzLnZpZXdTZXJ2aWNlLmVsZW1lbnQuZmlyc3RDaGlsZCk7XG4gICAgICAgICAgICByZW5kZXJlci5kb21FbGVtZW50LnN0eWxlLnpJbmRleCA9ICcwJztcbiAgICAgICAgICAgIHRoaXMuX3JlbmRlcmVyID0gcmVuZGVyZXI7XG4gICAgICAgICAgICB0aGlzLl9zaGFyZWRDYW52YXNGaW5hbCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHVwZGF0ZVZpZXdwb3J0KHZpZXdwb3J0OkNhbnZhc1ZpZXdwb3J0KSB7XG4gICAgICAgIGlmICghdGhpcy5fc2hhcmVkQ2FudmFzRmluYWwgJiYgdGhpcy5fcmVuZGVyZXIpIHtcbiAgICAgICAgICAgIChUSFJFRSBhcyBhbnkpLldlYkFSLnJlc2l6ZVZSU2VlVGhyb3VnaENhbWVyYSh0aGlzLl92ckRpc3BsYXksIHRoaXMuX2NhbWVyYVBlcnNwKTtcbiAgICAgICAgICAgIHRoaXMuX3JlbmRlcmVyLnNldFNpemUodGhpcy52aWV3U2VydmljZS5yZW5kZXJXaWR0aCwgdGhpcy52aWV3U2VydmljZS5yZW5kZXJIZWlnaHQsIHRydWUpO1xuICAgICAgICB9XG4gICAgfVxuXG59XG5cbmRlY2xhcmUgY2xhc3MgVlJGcmFtZURhdGEge1xuICAgIHRpbWVzdGFtcDpudW1iZXI7XG5cbiAgICBsZWZ0UHJvamVjdGlvbk1hdHJpeDpGbG9hdDMyQXJyYXk7XG4gICAgbGVmdFZpZXdNYXRyaXg6RmxvYXQzMkFycmF5O1xuXG4gICAgcmlnaHRQcm9qZWN0aW9uTWF0cml4OkZsb2F0MzJBcnJheTtcbiAgICByaWdodFZpZXdNYXRyaXg6RmxvYXQzMkFycmF5O1xuXG4gICAgcG9zZTpWUlBvc2U7XG59Il19