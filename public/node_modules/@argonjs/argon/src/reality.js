var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
import { autoinject } from 'aurelia-dependency-injection';
import { createGuid, PerspectiveFrustum, Matrix4 } from './cesium/cesium-imports';
import { Role, CanvasViewport, Viewport, SerializedSubviewList } from './common';
import { SessionService } from './session';
import { Event, deprecated, decomposePerspectiveProjectionMatrix } from './utils';
import { EntityService } from './entity';
import { FocusServiceProvider } from './focus';
import { VisibilityServiceProvider } from './visibility';
import { RealityViewer } from './reality-viewers/base';
import { ViewServiceProvider } from './view';
import { DeviceService } from './device';
import * as utils from './utils';
var RealityFactory = (function () {
    function RealityFactory() {
    }
    return RealityFactory;
}());
export { RealityFactory };
/**
* A service which makes requests to manage the reality viewer.
*/
var RealityService = (function () {
    // private _scratchFrustum = new PerspectiveFrustum();
    function RealityService(sessionService) {
        var _this = this;
        this.sessionService = sessionService;
        this._connectEvent = new Event();
        this._sessions = [];
        this._changeEvent = new Event();
        /**
         * The default Reality Viewer.
         */
        this.default = RealityViewer.EMPTY;
        if ((utils.isIOS || utils.isAndroid) && navigator.getUserMedia && navigator.mediaDevices) {
            var vrDisplay_1 = null;
            if (navigator.getVRDisplays) {
                navigator.getVRDisplays().then(function (vrDisplays) {
                    if (vrDisplays && vrDisplays.length > 0) {
                        for (var i = 0; !vrDisplay_1 && i < vrDisplays.length; i++) {
                            vrDisplay_1 = vrDisplays[i];
                            if (vrDisplay_1.displayName !== "Tango VR Device") {
                                vrDisplay_1 = null;
                            }
                        }
                    }
                }).then(function () {
                    _this.default = vrDisplay_1 ? RealityViewer.TANGO : RealityViewer.WEBRTC;
                });
            }
        }
        sessionService.manager.on['ar.reality.connect'] = function (_a) {
            var id = _a.id;
            var realityControlSession = _this.sessionService.createSessionPort(id);
            var messageChannel = _this.sessionService.createSynchronousMessageChannel();
            var ROUTE_MESSAGE_KEY = 'ar.reality.message.route.' + id;
            var SEND_MESSAGE_KEY = 'ar.reality.message.send.' + id;
            var CLOSE_SESSION_KEY = 'ar.reality.close.' + id;
            messageChannel.port1.onmessage = function (msg) {
                _this.sessionService.manager.send(ROUTE_MESSAGE_KEY, msg.data);
            };
            _this.sessionService.manager.on[SEND_MESSAGE_KEY] = function (message) {
                messageChannel.port1.postMessage(message);
            };
            _this.sessionService.manager.on[CLOSE_SESSION_KEY] = function () {
                realityControlSession.close();
            };
            realityControlSession.connectEvent.addEventListener(function () {
                _this.sessions.push(realityControlSession);
                _this.connectEvent.raiseEvent(realityControlSession);
                realityControlSession.closeEvent.addEventListener(function () {
                    var idx = _this.sessions.indexOf(realityControlSession);
                    _this.sessions.splice(idx, 1);
                });
            });
            _this.sessionService.manager.closeEvent.addEventListener(function () {
                realityControlSession.close();
                delete _this.sessionService.manager.on[SEND_MESSAGE_KEY];
                delete _this.sessionService.manager.on[CLOSE_SESSION_KEY];
            });
            setTimeout(function () {
                realityControlSession.open(messageChannel.port2, _this.sessionService.configuration);
            });
        };
        // let i = 0;
    }
    Object.defineProperty(RealityService.prototype, "connectEvent", {
        /**
         * An event that provides a session for sending / receiving
         * commands to / from a reality.
         *
         * The session passed via this event can represent either endpoint of
         * a connection between RealityViewer <--> RealityAugmenter/RealityManager.
         *
         * If running in a RealityAugmenter, the session
         * represents a connection to a RealityViewer.
         *
         * If running in a RealityViewer, the session
         * represents a connection to a RealityAugmenter.
         */
        get: function () { return this._connectEvent; },
        enumerable: true,
        configurable: true
    });
    ;
    Object.defineProperty(RealityService.prototype, "sessions", {
        /**
         * A collection of connected sessions.
         *
         * If running in a RealityAugmenter, this collection
         * represents connections to any loaded RealityViewers.
         *
         * If running in a RealityViewer, this collection
         * represents connections to any RealityAugmenters.
         */
        get: function () { return this._sessions; },
        enumerable: true,
        configurable: true
    });
    ;
    Object.defineProperty(RealityService.prototype, "changeEvent", {
        /**
         * An event that is raised when the presenting reality viewer is changed.
         */
        get: function () {
            return this._changeEvent;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RealityService.prototype, "current", {
        /**
         * The URI for the currently presenting Reality Viewer.
         */
        get: function () {
            return this._current;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RealityService.prototype, "isSharedCanvas", {
        /**
         * Whether the current reality viewer shares a canvas with the reality augmenter.
         */
        get: function () { return this._sharedCanvas; },
        enumerable: true,
        configurable: true
    });
    ;
    /**
     * @private
     */
    RealityService.prototype._processContextFrameState = function (frameState) {
        var current = frameState.reality;
        var previous = this._current;
        if (previous !== current) {
            this._current = current;
            this.changeEvent.raiseEvent({ previous: previous, current: current });
        }
    };
    /**
     * @private
     */
    RealityService.prototype._publishContextFrameState = function (frameState) {
        var sessionService = this.sessionService;
        if (sessionService.isRealityViewer && sessionService.manager.isConnected) {
            // backwards compatability
            if (sessionService.manager.isConnected && sessionService.manager.version[0] === 0) {
                var eye = frameState['eye'] = frameState['eye'] || {};
                eye.pose = frameState.entities['ar.user'];
                eye.viewport = Viewport.clone(frameState.subviews[0].viewport, eye.viewport);
                delete frameState.entities['ar.user'];
                // throttle for 30fps
                // i++ % 2 === 0 && 
                sessionService.manager.send('ar.reality.frameState', frameState);
                frameState.entities['ar.user'] = eye.pose;
            }
            else {
                sessionService.manager.send('ar.reality.frameState', frameState);
            }
        }
    };
    /**
     * Install the specified reality viewer
     */
    RealityService.prototype.install = function (uri) {
        var _this = this;
        return this.sessionService.manager.whenConnected().then(function () {
            if (_this.sessionService.manager.version[0] >= 1 !== true)
                return Promise.reject(new Error('Not supported'));
            return _this.sessionService.manager.request('ar.reality.install', { uri: uri });
        });
    };
    /**
     * Uninstall the specified reality viewer
     */
    RealityService.prototype.uninstall = function (uri) {
        var _this = this;
        return this.sessionService.manager.whenConnected().then(function () {
            if (_this.sessionService.manager.version[0] >= 1 !== true)
                return Promise.reject(new Error('Not supported'));
            return _this.sessionService.manager.request('ar.reality.uninstall', { uri: uri });
        });
    };
    /**
     * Request a reality viewer to be presented.
     * - Pass a url to request a (custum) hosted reality viewer
     * - [[RealityViewer.DEFAULT]] to request the system default reality viewer
     * - [[RealityViewer.LIVE]] to request a live reality viewer
     * - [[RealityViewer.WEBTRC]] to request a webrtc reality viewer
     * - [[RealityViewer.EMPTY]] to request an empty reality viewer
     * - [[RealityViewer.TANGO]] to request a Tango reality viewer
     */
    RealityService.prototype.request = function (uri) {
        var _this = this;
        return this.sessionService.manager.whenConnected().then(function () {
            if (_this.sessionService.manager.version[0] >= 1 !== true)
                return _this.sessionService.manager.request('ar.reality.desired', { reality: { uri: uri } });
            return _this.sessionService.manager.request('ar.reality.request', { uri: uri });
        });
    };
    /**
     * Deprecated. Use [[RealityService#request]]
     * @deprecated
     */
    RealityService.prototype.setDesired = function (reality) {
        this.request(reality ? reality.uri : RealityViewer.DEFAULT);
    };
    /**
     * Ask a reality to move the stage to the given geolocation
     */
    RealityService.prototype.setStageGeolocation = function (realitySession, geolocation) {
        if (!realitySession.supportsProtocol('ar.configureStage'))
            return Promise.reject('Protocol `ar.configureStage` is not supported');
        return realitySession.request('ar.configureStage.setStageGeolocation', { geolocation: geolocation });
    };
    /**
     * Ask a reality to move the stage to the given geolocation
     */
    RealityService.prototype.resetStageGeolocation = function (realitySession) {
        if (!realitySession.supportsProtocol('ar.configureStage'))
            return Promise.reject('Protocol `ar.configureStage` is not supported');
        return realitySession.request('ar.configureStage.resetStageGeolocation');
    };
    __decorate([
        deprecated('request'),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", [Object]),
        __metadata("design:returntype", void 0)
    ], RealityService.prototype, "setDesired", null);
    RealityService = __decorate([
        autoinject(),
        __metadata("design:paramtypes", [SessionService])
    ], RealityService);
    return RealityService;
}());
export { RealityService };
var RealityServiceProvider = (function () {
    function RealityServiceProvider(sessionService, realityService, entityService, deviceService, viewServiceProvider, visibilityServiceProvider, focusServiceProvider, realityViewerFactory) {
        var _this = this;
        this.sessionService = sessionService;
        this.realityService = realityService;
        this.entityService = entityService;
        this.deviceService = deviceService;
        this.viewServiceProvider = viewServiceProvider;
        this.visibilityServiceProvider = visibilityServiceProvider;
        this.focusServiceProvider = focusServiceProvider;
        this.realityViewerFactory = realityViewerFactory;
        /**
         * An event that is raised when a reality viewer is installed.
         */
        this.installedEvent = new Event();
        /**
         * An event that is raised when a reality viewer is uninstalled.
         */
        this.uninstalledEvent = new Event();
        /**
         * An event that is raised when the presenting viewer has changed
         */
        this.presentingRealityViewerChangeEvent = new Event();
        /**
         * An event that is raised when the next frame state is published
         */
        this.nextFrameStateEvent = new Event();
        this._viewerByURI = new Map();
        this._installersByURI = new Map();
        this._scratchFrustum = new PerspectiveFrustum;
        sessionService.ensureIsRealityManager();
        sessionService.manager.connectEvent.addEventListener(function () {
            setTimeout(function () {
                if (_this.sessionService.manager.isConnected &&
                    !_this._presentingRealityViewer &&
                    _this.realityService.default) {
                    _this._handleRequest(_this.sessionService.manager, {
                        uri: _this.realityService.default
                    });
                }
            }, 0);
        });
        sessionService.manager.closeEvent.addEventListener(function () {
            _this._viewerByURI.forEach(function (v) {
                v.destroy();
            });
        });
        sessionService.connectEvent.addEventListener(function (session) {
            if (!Role.isRealityViewer(session.info.role)) {
                session.on['ar.reality.install'] = function (_a) {
                    var uri = _a.uri;
                    return _this._handleInstall(session, uri);
                };
                session.on['ar.reality.uninstall'] = function (_a) {
                    var uri = _a.uri;
                    return _this._handleUninstall(session, uri);
                };
                session.on['ar.reality.request'] = function (message) {
                    return _this._handleRequest(session, message);
                };
                // For backwards compatability. 
                session.on['ar.reality.desired'] = function (message) {
                    var reality = message.reality;
                    if (reality) {
                        if (reality['type']) {
                            var type = reality['type'];
                            reality.uri = reality.uri || 'reality:' + type;
                            if (type === 'hosted')
                                reality.uri = reality['url'];
                        }
                    }
                    _this._handleRequest(session, { uri: reality.uri });
                };
            }
        });
        this.viewServiceProvider.forwardedUIEvent.addEventListener(function (uievent) {
            var session = _this._presentingRealityViewer && _this._presentingRealityViewer.session;
            if (session)
                _this.viewServiceProvider.sendUIEventToSession(uievent, session);
        });
    }
    Object.defineProperty(RealityServiceProvider.prototype, "presentingRealityViewer", {
        get: function () { return this._presentingRealityViewer; },
        enumerable: true,
        configurable: true
    });
    RealityServiceProvider.prototype._handleInstall = function (session, uri) {
        var _this = this;
        var installers = this._installersByURI.get(uri);
        if (installers) {
            installers.add(session);
        }
        else {
            var viewer_1 = this.realityViewerFactory.createRealityViewer(uri);
            this._viewerByURI.set(uri, viewer_1);
            installers = new Set();
            installers.add(session);
            this._installersByURI.set(uri, installers);
            viewer_1.connectEvent.addEventListener(function (viewerSession) {
                if (!Role.isRealityViewer(viewerSession.info.role)) {
                    viewerSession.sendError({ message: "Expected a reality viewer" });
                    viewerSession.close();
                    throw new Error('The application "' + viewerSession.uri + '" does not support being loaded as a reality viewer');
                }
                viewerSession.on['ar.reality.frameState'] = function (frame) {
                    if (_this._presentingRealityViewer === viewer_1) {
                        if (viewerSession.version[0] === 0) {
                            var deviceState = _this.deviceService.frameState;
                            if (!deviceState)
                                return;
                            frame.viewport = CanvasViewport.clone(deviceState.viewport, frame.viewport);
                            frame.subviews = SerializedSubviewList.clone(deviceState.subviews, frame.subviews);
                            var eye = frame['eye'];
                            var eyePose = eye.pose;
                            var eyeFov = eye.fov;
                            frame.entities = frame.entities || {};
                            frame.entities['ar.user'] = eyePose;
                            for (var _i = 0, _a = frame.subviews; _i < _a.length; _i++) {
                                var s = _a[_i];
                                var f = decomposePerspectiveProjectionMatrix(s.projectionMatrix, s['frustum'] || {});
                                f.fov = eyeFov;
                                _this._scratchFrustum.clone(f);
                                s.projectionMatrix = Matrix4.clone(_this._scratchFrustum.projectionMatrix, s.projectionMatrix);
                            }
                        }
                        frame.reality = viewer_1.uri;
                        _this.realityService._sharedCanvas = !!(_this.sessionService.configuration['sharedCanvas'] && viewer_1.session.info['sharedCanvas']);
                        viewer_1._sharedCanvas = _this.realityService._sharedCanvas;
                        _this.nextFrameStateEvent.raiseEvent(frame);
                    }
                };
                if (viewerSession.info['supportsCustomProtocols']) {
                    _this._connectViewerWithSession(viewerSession, _this.sessionService.manager);
                    for (var _i = 0, _a = _this.sessionService.managedSessions; _i < _a.length; _i++) {
                        session = _a[_i];
                        _this._connectViewerWithSession(viewerSession, session);
                    }
                    var remove_1 = _this.sessionService.connectEvent.addEventListener(function (session) {
                        if (session === _this.sessionService.manager)
                            return;
                        _this._connectViewerWithSession(viewerSession, session);
                    });
                    viewerSession.closeEvent.addEventListener(function () { return remove_1(); });
                }
                var removePresentChangeListener = viewer_1.presentChangeEvent.addEventListener(function () {
                    _this.visibilityServiceProvider.set(viewerSession, viewer_1.isPresenting);
                });
                _this.visibilityServiceProvider.set(viewerSession, viewer_1.isPresenting);
                console.log('set visibile : ' + viewer_1.uri);
                viewerSession.closeEvent.addEventListener(function () {
                    removePresentChangeListener();
                    _this.entityService.collection.removeById(viewerSession.uri);
                    console.log('Reality session closed: ' + uri);
                });
            });
            this.installedEvent.raiseEvent({ viewer: viewer_1 });
            viewer_1.load();
        }
    };
    RealityServiceProvider.prototype._connectViewerWithSession = function (viewerSession, session) {
        if (Role.isRealityViewer(session.info.role))
            return;
        var id = createGuid();
        var ROUTE_MESSAGE_KEY = 'ar.reality.message.route.' + id;
        var SEND_MESSAGE_KEY = 'ar.reality.message.send.' + id;
        var CLOSE_SESSION_KEY = 'ar.reality.close.' + id;
        viewerSession.on[ROUTE_MESSAGE_KEY] = function (message) {
            session.send(SEND_MESSAGE_KEY, message);
        };
        session.on[ROUTE_MESSAGE_KEY] = function (message) {
            viewerSession.send(SEND_MESSAGE_KEY, message);
        };
        session.send('ar.reality.connect', { id: id });
        viewerSession.send('ar.reality.connect', { id: id });
        viewerSession.closeEvent.addEventListener(function () {
            session.send(CLOSE_SESSION_KEY);
        });
        session.closeEvent.addEventListener(function () {
            viewerSession.send(CLOSE_SESSION_KEY);
        });
    };
    RealityServiceProvider.prototype._handleUninstall = function (session, uri) {
        var installers = this._installersByURI.get(uri);
        if (installers) {
            if (installers.size === 0) {
                var viewer = this._viewerByURI.get(uri);
                this._viewerByURI.delete(uri);
                viewer.destroy();
                this.uninstalledEvent.raiseEvent({ viewer: viewer });
            }
        }
        else {
            return Promise.reject(new Error("Unable to uninstall a reality viewer which is not installed"));
        }
    };
    RealityServiceProvider.prototype._handleRequest = function (session, options) {
        if (this.focusServiceProvider.session === session || session === this.sessionService.manager) {
            var uri = options && options.uri || RealityViewer.DEFAULT;
            switch (uri) {
                case RealityViewer.DEFAULT:
                    uri = this.realityService.default;
            }
            this._handleInstall(session, uri);
            this._setPresentingRealityViewer(this._viewerByURI.get(uri));
            return Promise.resolve();
        }
        throw new Error('Request Denied');
    };
    RealityServiceProvider.prototype._setPresentingRealityViewer = function (viewer) {
        if (!viewer)
            throw new Error('Invalid State. Expected a RealityViewer instance');
        if (this._presentingRealityViewer === viewer)
            return;
        this._presentingRealityViewer = viewer;
        this.presentingRealityViewerChangeEvent.raiseEvent({ viewer: viewer });
        this._viewerByURI.forEach(function (v) {
            v.setPresenting(v === viewer);
        });
        console.log('Presenting reality viewer changed to: ' + viewer.uri);
    };
    RealityServiceProvider.prototype.getViewerByURI = function (uri) {
        return this._viewerByURI.get(uri);
    };
    RealityServiceProvider.prototype.removeInstaller = function (installerSession) {
        var _this = this;
        this._viewerByURI.forEach(function (viewer, realityUri, map) {
            var installers = _this._installersByURI.get(realityUri);
            if (installers && installers.has(installerSession)) {
                installers.delete(installerSession);
                if (installers.size === 0 && viewer.session) {
                    _this._handleUninstall(viewer.session, realityUri);
                    _this._installersByURI.delete(realityUri);
                }
            }
        });
    };
    RealityServiceProvider = __decorate([
        autoinject,
        __metadata("design:paramtypes", [SessionService,
            RealityService,
            EntityService,
            DeviceService,
            ViewServiceProvider,
            VisibilityServiceProvider,
            FocusServiceProvider,
            RealityFactory])
    ], RealityServiceProvider);
    return RealityServiceProvider;
}());
export { RealityServiceProvider };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhbGl0eS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJlYWxpdHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDhCQUE4QixDQUFBO0FBQ3pELE9BQU8sRUFDSCxVQUFVLEVBQ1Ysa0JBQWtCLEVBQ2xCLE9BQU8sRUFFVixNQUFNLHlCQUF5QixDQUFBO0FBQ2hDLE9BQU8sRUFDSCxJQUFJLEVBRUosY0FBYyxFQUNkLFFBQVEsRUFDUixxQkFBcUIsRUFDeEIsTUFBTSxVQUFVLENBQUE7QUFDakIsT0FBTyxFQUFlLGNBQWMsRUFBRSxNQUFNLFdBQVcsQ0FBQTtBQUN2RCxPQUFPLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxvQ0FBb0MsRUFBRSxNQUFNLFNBQVMsQ0FBQTtBQUNqRixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sVUFBVSxDQUFBO0FBQ3hDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLFNBQVMsQ0FBQTtBQUM5QyxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSxjQUFjLENBQUE7QUFFeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHdCQUF3QixDQUFBO0FBRXRELE9BQU8sRUFBQyxtQkFBbUIsRUFBQyxNQUFNLFFBQVEsQ0FBQTtBQUMxQyxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sVUFBVSxDQUFBO0FBRXRDLE9BQU8sS0FBSyxLQUFLLE1BQU0sU0FBUyxDQUFBO0FBRWhDO0lBQUE7SUFFQSxDQUFDO0lBQUQscUJBQUM7QUFBRCxDQUFDLEFBRkQsSUFFQzs7QUFFRDs7RUFFRTtBQUVGO0lBeURJLHNEQUFzRDtJQUV0RCx3QkFDWSxjQUE4QjtRQUQxQyxpQkE4REM7UUE3RFcsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBNUNsQyxrQkFBYSxHQUFHLElBQUksS0FBSyxFQUFlLENBQUM7UUFZekMsY0FBUyxHQUFpQixFQUFFLENBQUM7UUFRN0IsaUJBQVks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QUMsQ0FBQztvQkFDMUMsS0FBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLENBQUM7b0JBQ2xELEtBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQzdDLENBQUM7WUFDTCxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBdFFRLHNCQUFzQjtRQURsQyxVQUFVO3lDQThCb0IsY0FBYztZQUNkLGNBQWM7WUFDZixhQUFhO1lBQ2IsYUFBYTtZQUNQLG1CQUFtQjtZQUNiLHlCQUF5QjtZQUM3QixvQkFBb0I7WUFDckIsY0FBYztPQXBDdEMsc0JBQXNCLENBdVFsQztJQUFELDZCQUFDO0NBQUEsQUF2UUQsSUF1UUM7U0F2UVksc0JBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXV0b2luamVjdCB9IGZyb20gJ2F1cmVsaWEtZGVwZW5kZW5jeS1pbmplY3Rpb24nXG5pbXBvcnQge1xuICAgIGNyZWF0ZUd1aWQsXG4gICAgUGVyc3BlY3RpdmVGcnVzdHVtLFxuICAgIE1hdHJpeDQsXG4gICAgQ2FydG9ncmFwaGljXG59IGZyb20gJy4vY2VzaXVtL2Nlc2l1bS1pbXBvcnRzJ1xuaW1wb3J0IHtcbiAgICBSb2xlLFxuICAgIENvbnRleHRGcmFtZVN0YXRlLFxuICAgIENhbnZhc1ZpZXdwb3J0LFxuICAgIFZpZXdwb3J0LFxuICAgIFNlcmlhbGl6ZWRTdWJ2aWV3TGlzdFxufSBmcm9tICcuL2NvbW1vbidcbmltcG9ydCB7IFNlc3Npb25Qb3J0LCBTZXNzaW9uU2VydmljZSB9IGZyb20gJy4vc2Vzc2lvbidcbmltcG9ydCB7IEV2ZW50LCBkZXByZWNhdGVkLCBkZWNvbXBvc2VQZXJzcGVjdGl2ZVByb2plY3Rpb25NYXRyaXggfSBmcm9tICcuL3V0aWxzJ1xuaW1wb3J0IHsgRW50aXR5U2VydmljZSB9IGZyb20gJy4vZW50aXR5J1xuaW1wb3J0IHsgRm9jdXNTZXJ2aWNlUHJvdmlkZXIgfSBmcm9tICcuL2ZvY3VzJ1xuaW1wb3J0IHsgVmlzaWJpbGl0eVNlcnZpY2VQcm92aWRlciB9IGZyb20gJy4vdmlzaWJpbGl0eSdcblxuaW1wb3J0IHsgUmVhbGl0eVZpZXdlciB9IGZyb20gJy4vcmVhbGl0eS12aWV3ZXJzL2Jhc2UnXG5cbmltcG9ydCB7Vmlld1NlcnZpY2VQcm92aWRlcn0gZnJvbSAnLi92aWV3J1xuaW1wb3J0IHtEZXZpY2VTZXJ2aWNlfSBmcm9tICcuL2RldmljZSdcblxuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSAnLi91dGlscydcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFJlYWxpdHlGYWN0b3J5IHtcbiAgICBhYnN0cmFjdCBjcmVhdGVSZWFsaXR5Vmlld2VyKHVyaTpzdHJpbmcpIDogUmVhbGl0eVZpZXdlcjtcbn1cblxuLyoqXG4qIEEgc2VydmljZSB3aGljaCBtYWtlcyByZXF1ZXN0cyB0byBtYW5hZ2UgdGhlIHJlYWxpdHkgdmlld2VyLlxuKi9cbkBhdXRvaW5qZWN0KClcbmV4cG9ydCBjbGFzcyBSZWFsaXR5U2VydmljZSB7XG5cbiAgICAvKipcbiAgICAgKiBBbiBldmVudCB0aGF0IHByb3ZpZGVzIGEgc2Vzc2lvbiBmb3Igc2VuZGluZyAvIHJlY2VpdmluZyBcbiAgICAgKiBjb21tYW5kcyB0byAvIGZyb20gYSByZWFsaXR5LiBcbiAgICAgKiBcbiAgICAgKiBUaGUgc2Vzc2lvbiBwYXNzZWQgdmlhIHRoaXMgZXZlbnQgY2FuIHJlcHJlc2VudCBlaXRoZXIgZW5kcG9pbnQgb2ZcbiAgICAgKiBhIGNvbm5lY3Rpb24gYmV0d2VlbiBSZWFsaXR5Vmlld2VyIDwtLT4gUmVhbGl0eUF1Z21lbnRlci9SZWFsaXR5TWFuYWdlci5cbiAgICAgKiBcbiAgICAgKiBJZiBydW5uaW5nIGluIGEgUmVhbGl0eUF1Z21lbnRlciwgdGhlIHNlc3Npb25cbiAgICAgKiByZXByZXNlbnRzIGEgY29ubmVjdGlvbiB0byBhIFJlYWxpdHlWaWV3ZXIuXG4gICAgICogXG4gICAgICogSWYgcnVubmluZyBpbiBhIFJlYWxpdHlWaWV3ZXIsIHRoZSBzZXNzaW9uXG4gICAgICogcmVwcmVzZW50cyBhIGNvbm5lY3Rpb24gdG8gYSBSZWFsaXR5QXVnbWVudGVyLlxuICAgICAqL1xuICAgIHB1YmxpYyBnZXQgY29ubmVjdEV2ZW50KCkgeyByZXR1cm4gdGhpcy5fY29ubmVjdEV2ZW50IH07XG4gICAgcHJpdmF0ZSBfY29ubmVjdEV2ZW50ID0gbmV3IEV2ZW50PFNlc3Npb25Qb3J0PigpO1xuXG4gICAgLyoqXG4gICAgICogQSBjb2xsZWN0aW9uIG9mIGNvbm5lY3RlZCBzZXNzaW9ucy4gXG4gICAgICogXG4gICAgICogSWYgcnVubmluZyBpbiBhIFJlYWxpdHlBdWdtZW50ZXIsIHRoaXMgY29sbGVjdGlvblxuICAgICAqIHJlcHJlc2VudHMgY29ubmVjdGlvbnMgdG8gYW55IGxvYWRlZCBSZWFsaXR5Vmlld2Vycy5cbiAgICAgKiBcbiAgICAgKiBJZiBydW5uaW5nIGluIGEgUmVhbGl0eVZpZXdlciwgdGhpcyBjb2xsZWN0aW9uXG4gICAgICogcmVwcmVzZW50cyBjb25uZWN0aW9ucyB0byBhbnkgUmVhbGl0eUF1Z21lbnRlcnMuXG4gICAgICovXG4gICAgcHVibGljIGdldCBzZXNzaW9ucygpIHsgcmV0dXJuIHRoaXMuX3Nlc3Npb25zIH07XG4gICAgcHJpdmF0ZSBfc2Vzc2lvbnM6U2Vzc2lvblBvcnRbXSA9IFtdO1xuXG4gICAgLyoqXG4gICAgICogQW4gZXZlbnQgdGhhdCBpcyByYWlzZWQgd2hlbiB0aGUgcHJlc2VudGluZyByZWFsaXR5IHZpZXdlciBpcyBjaGFuZ2VkLlxuICAgICAqL1xuICAgIHB1YmxpYyBnZXQgY2hhbmdlRXZlbnQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jaGFuZ2VFdmVudDtcbiAgICB9XG4gICAgcHJpdmF0ZSBfY2hhbmdlRXZlbnQgPSBuZXcgRXZlbnQ8eyBwcmV2aW91cz86IHN0cmluZywgY3VycmVudDogc3RyaW5nIH0+KCk7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgVVJJIGZvciB0aGUgY3VycmVudGx5IHByZXNlbnRpbmcgUmVhbGl0eSBWaWV3ZXIuIFxuICAgICAqL1xuICAgIHB1YmxpYyBnZXQgY3VycmVudCgpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgICAgICByZXR1cm4gdGhpcy5fY3VycmVudDtcbiAgICB9XG4gICAgcHJpdmF0ZSBfY3VycmVudD86IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIFRoZSBkZWZhdWx0IFJlYWxpdHkgVmlld2VyLlxuICAgICAqL1xuICAgIHB1YmxpYyBkZWZhdWx0ID0gUmVhbGl0eVZpZXdlci5FTVBUWTtcblxuICAgIC8qKlxuICAgICAqIFdoZXRoZXIgdGhlIGN1cnJlbnQgcmVhbGl0eSB2aWV3ZXIgc2hhcmVzIGEgY2FudmFzIHdpdGggdGhlIHJlYWxpdHkgYXVnbWVudGVyLlxuICAgICAqL1xuICAgIHB1YmxpYyBnZXQgaXNTaGFyZWRDYW52YXMoKSB7IHJldHVybiB0aGlzLl9zaGFyZWRDYW52YXMgfTtcbiAgICBwdWJsaWMgX3NoYXJlZENhbnZhczogYm9vbGVhbjtcblxuICAgIC8vIHByaXZhdGUgX3NjcmF0Y2hGcnVzdHVtID0gbmV3IFBlcnNwZWN0aXZlRnJ1c3R1bSgpO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgc2Vzc2lvblNlcnZpY2U6IFNlc3Npb25TZXJ2aWNlXG4gICAgKSB7XG4gICAgICAgIGlmICgodXRpbHMuaXNJT1MgfHwgdXRpbHMuaXNBbmRyb2lkKSAmJiBuYXZpZ2F0b3IuZ2V0VXNlck1lZGlhICYmIG5hdmlnYXRvci5tZWRpYURldmljZXMpIHtcbiAgICAgICAgICAgIGxldCB2ckRpc3BsYXk6YW55ID0gbnVsbDtcbiAgICAgICAgICAgIGlmIChuYXZpZ2F0b3IuZ2V0VlJEaXNwbGF5cykge1xuICAgICAgICAgICAgICAgIG5hdmlnYXRvci5nZXRWUkRpc3BsYXlzKCkudGhlbihmdW5jdGlvbih2ckRpc3BsYXlzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2ckRpc3BsYXlzICYmIHZyRGlzcGxheXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7ICF2ckRpc3BsYXkgJiYgaSA8IHZyRGlzcGxheXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ckRpc3BsYXkgPSB2ckRpc3BsYXlzW2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2ckRpc3BsYXkuZGlzcGxheU5hbWUgIT09IFwiVGFuZ28gVlIgRGV2aWNlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdnJEaXNwbGF5ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0ID0gdnJEaXNwbGF5ID8gUmVhbGl0eVZpZXdlci5UQU5HTyA6IFJlYWxpdHlWaWV3ZXIuV0VCUlRDO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgc2Vzc2lvblNlcnZpY2UubWFuYWdlci5vblsnYXIucmVhbGl0eS5jb25uZWN0J10gPSAoe2lkfTogeyBpZDogc3RyaW5nIH0pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlYWxpdHlDb250cm9sU2Vzc2lvbiA9IHRoaXMuc2Vzc2lvblNlcnZpY2UuY3JlYXRlU2Vzc2lvblBvcnQoaWQpO1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZUNoYW5uZWwgPSB0aGlzLnNlc3Npb25TZXJ2aWNlLmNyZWF0ZVN5bmNocm9ub3VzTWVzc2FnZUNoYW5uZWwoKTtcblxuICAgICAgICAgICAgY29uc3QgUk9VVEVfTUVTU0FHRV9LRVkgPSAnYXIucmVhbGl0eS5tZXNzYWdlLnJvdXRlLicgKyBpZDtcbiAgICAgICAgICAgIGNvbnN0IFNFTkRfTUVTU0FHRV9LRVkgPSAnYXIucmVhbGl0eS5tZXNzYWdlLnNlbmQuJyArIGlkO1xuICAgICAgICAgICAgY29uc3QgQ0xPU0VfU0VTU0lPTl9LRVkgPSAnYXIucmVhbGl0eS5jbG9zZS4nICsgaWQ7XG5cbiAgICAgICAgICAgIG1lc3NhZ2VDaGFubmVsLnBvcnQxLm9ubWVzc2FnZSA9IChtc2c6IE1lc3NhZ2VFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc2Vzc2lvblNlcnZpY2UubWFuYWdlci5zZW5kKFJPVVRFX01FU1NBR0VfS0VZLCBtc2cuZGF0YSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuc2Vzc2lvblNlcnZpY2UubWFuYWdlci5vbltTRU5EX01FU1NBR0VfS0VZXSA9IChtZXNzYWdlKSA9PiB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZUNoYW5uZWwucG9ydDEucG9zdE1lc3NhZ2UobWVzc2FnZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuc2Vzc2lvblNlcnZpY2UubWFuYWdlci5vbltDTE9TRV9TRVNTSU9OX0tFWV0gPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVhbGl0eUNvbnRyb2xTZXNzaW9uLmNsb3NlKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJlYWxpdHlDb250cm9sU2Vzc2lvbi5jb25uZWN0RXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXNzaW9ucy5wdXNoKHJlYWxpdHlDb250cm9sU2Vzc2lvbik7XG4gICAgICAgICAgICAgICAgdGhpcy5jb25uZWN0RXZlbnQucmFpc2VFdmVudChyZWFsaXR5Q29udHJvbFNlc3Npb24pO1xuICAgICAgICAgICAgICAgIHJlYWxpdHlDb250cm9sU2Vzc2lvbi5jbG9zZUV2ZW50LmFkZEV2ZW50TGlzdGVuZXIoKCk9PntcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaWR4ID0gdGhpcy5zZXNzaW9ucy5pbmRleE9mKHJlYWxpdHlDb250cm9sU2Vzc2lvbik7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2Vzc2lvbnMuc3BsaWNlKGlkeCwxKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIHRoaXMuc2Vzc2lvblNlcnZpY2UubWFuYWdlci5jbG9zZUV2ZW50LmFkZEV2ZW50TGlzdGVuZXIoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlYWxpdHlDb250cm9sU2Vzc2lvbi5jbG9zZSgpO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnNlc3Npb25TZXJ2aWNlLm1hbmFnZXIub25bU0VORF9NRVNTQUdFX0tFWV07XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuc2Vzc2lvblNlcnZpY2UubWFuYWdlci5vbltDTE9TRV9TRVNTSU9OX0tFWV07XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgc2V0VGltZW91dCgoKT0+e1xuICAgICAgICAgICAgICAgIHJlYWxpdHlDb250cm9sU2Vzc2lvbi5vcGVuKG1lc3NhZ2VDaGFubmVsLnBvcnQyLCB0aGlzLnNlc3Npb25TZXJ2aWNlLmNvbmZpZ3VyYXRpb24pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvLyBsZXQgaSA9IDA7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBwdWJsaWMgX3Byb2Nlc3NDb250ZXh0RnJhbWVTdGF0ZShmcmFtZVN0YXRlOiBDb250ZXh0RnJhbWVTdGF0ZSkge1xuICAgICAgICBjb25zdCBjdXJyZW50ID0gZnJhbWVTdGF0ZS5yZWFsaXR5ITtcbiAgICAgICAgY29uc3QgcHJldmlvdXMgPSB0aGlzLl9jdXJyZW50O1xuICAgICAgICBpZiAocHJldmlvdXMgIT09IGN1cnJlbnQpIHtcbiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQgPSBjdXJyZW50O1xuICAgICAgICAgICAgdGhpcy5jaGFuZ2VFdmVudC5yYWlzZUV2ZW50KHsgcHJldmlvdXMsIGN1cnJlbnQgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHB1YmxpYyBfcHVibGlzaENvbnRleHRGcmFtZVN0YXRlKGZyYW1lU3RhdGU6IENvbnRleHRGcmFtZVN0YXRlICkge1xuICAgICAgICBjb25zdCBzZXNzaW9uU2VydmljZSA9IHRoaXMuc2Vzc2lvblNlcnZpY2U7XG4gICAgICAgIGlmIChzZXNzaW9uU2VydmljZS5pc1JlYWxpdHlWaWV3ZXIgJiYgc2Vzc2lvblNlcnZpY2UubWFuYWdlci5pc0Nvbm5lY3RlZCkge1xuICAgICAgICAgICAgLy8gYmFja3dhcmRzIGNvbXBhdGFiaWxpdHlcbiAgICAgICAgICAgIGlmIChzZXNzaW9uU2VydmljZS5tYW5hZ2VyLmlzQ29ubmVjdGVkICYmIHNlc3Npb25TZXJ2aWNlLm1hbmFnZXIudmVyc2lvblswXSA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGV5ZSA9IGZyYW1lU3RhdGVbJ2V5ZSddID0gZnJhbWVTdGF0ZVsnZXllJ10gfHwge307XG4gICAgICAgICAgICAgICAgZXllLnBvc2UgPSBmcmFtZVN0YXRlLmVudGl0aWVzWydhci51c2VyJ107XG4gICAgICAgICAgICAgICAgZXllLnZpZXdwb3J0ID0gVmlld3BvcnQuY2xvbmUoZnJhbWVTdGF0ZS5zdWJ2aWV3c1swXS52aWV3cG9ydCwgZXllLnZpZXdwb3J0KTtcbiAgICAgICAgICAgICAgICBkZWxldGUgZnJhbWVTdGF0ZS5lbnRpdGllc1snYXIudXNlciddO1xuICAgICAgICAgICAgICAgIC8vIHRocm90dGxlIGZvciAzMGZwc1xuICAgICAgICAgICAgICAgIC8vIGkrKyAlIDIgPT09IDAgJiYgXG4gICAgICAgICAgICAgICAgc2Vzc2lvblNlcnZpY2UubWFuYWdlci5zZW5kKCdhci5yZWFsaXR5LmZyYW1lU3RhdGUnLCBmcmFtZVN0YXRlKTtcbiAgICAgICAgICAgICAgICBmcmFtZVN0YXRlLmVudGl0aWVzWydhci51c2VyJ10gPSBleWUucG9zZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgc2Vzc2lvblNlcnZpY2UubWFuYWdlci5zZW5kKCdhci5yZWFsaXR5LmZyYW1lU3RhdGUnLCBmcmFtZVN0YXRlKTtcbiAgICAgICAgICAgIH0gICBcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEluc3RhbGwgdGhlIHNwZWNpZmllZCByZWFsaXR5IHZpZXdlclxuICAgICAqL1xuICAgIHB1YmxpYyBpbnN0YWxsKHVyaTogc3RyaW5nKSA6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zZXNzaW9uU2VydmljZS5tYW5hZ2VyLndoZW5Db25uZWN0ZWQoKS50aGVuKCgpPT57XG4gICAgICAgICAgICBpZiAodGhpcy5zZXNzaW9uU2VydmljZS5tYW5hZ2VyLnZlcnNpb25bMF0gPj0gMSAhPT0gdHJ1ZSlcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdOb3Qgc3VwcG9ydGVkJykpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZXNzaW9uU2VydmljZS5tYW5hZ2VyLnJlcXVlc3QoJ2FyLnJlYWxpdHkuaW5zdGFsbCcsIHt1cml9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIFVuaW5zdGFsbCB0aGUgc3BlY2lmaWVkIHJlYWxpdHkgdmlld2VyXG4gICAgICovXG4gICAgcHVibGljIHVuaW5zdGFsbCh1cmk6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zZXNzaW9uU2VydmljZS5tYW5hZ2VyLndoZW5Db25uZWN0ZWQoKS50aGVuKCgpPT57XG4gICAgICAgICAgICBpZiAodGhpcy5zZXNzaW9uU2VydmljZS5tYW5hZ2VyLnZlcnNpb25bMF0gPj0gMSAhPT0gdHJ1ZSlcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdOb3Qgc3VwcG9ydGVkJykpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZXNzaW9uU2VydmljZS5tYW5hZ2VyLnJlcXVlc3QoJ2FyLnJlYWxpdHkudW5pbnN0YWxsJywge3VyaX0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXF1ZXN0IGEgcmVhbGl0eSB2aWV3ZXIgdG8gYmUgcHJlc2VudGVkLiBcbiAgICAgKiAtIFBhc3MgYSB1cmwgdG8gcmVxdWVzdCBhIChjdXN0dW0pIGhvc3RlZCByZWFsaXR5IHZpZXdlclxuICAgICAqIC0gW1tSZWFsaXR5Vmlld2VyLkRFRkFVTFRdXSB0byByZXF1ZXN0IHRoZSBzeXN0ZW0gZGVmYXVsdCByZWFsaXR5IHZpZXdlclxuICAgICAqIC0gW1tSZWFsaXR5Vmlld2VyLkxJVkVdXSB0byByZXF1ZXN0IGEgbGl2ZSByZWFsaXR5IHZpZXdlciBcbiAgICAgKiAtIFtbUmVhbGl0eVZpZXdlci5XRUJUUkNdXSB0byByZXF1ZXN0IGEgd2VicnRjIHJlYWxpdHkgdmlld2VyXG4gICAgICogLSBbW1JlYWxpdHlWaWV3ZXIuRU1QVFldXSB0byByZXF1ZXN0IGFuIGVtcHR5IHJlYWxpdHkgdmlld2VyXG4gICAgICogLSBbW1JlYWxpdHlWaWV3ZXIuVEFOR09dXSB0byByZXF1ZXN0IGEgVGFuZ28gcmVhbGl0eSB2aWV3ZXJcbiAgICAgKi9cbiAgICBwdWJsaWMgcmVxdWVzdCh1cmk6c3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnNlc3Npb25TZXJ2aWNlLm1hbmFnZXIud2hlbkNvbm5lY3RlZCgpLnRoZW4oKCk9PntcbiAgICAgICAgICAgIGlmICh0aGlzLnNlc3Npb25TZXJ2aWNlLm1hbmFnZXIudmVyc2lvblswXSA+PSAxICE9PSB0cnVlKVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNlc3Npb25TZXJ2aWNlLm1hbmFnZXIucmVxdWVzdCgnYXIucmVhbGl0eS5kZXNpcmVkJywge3JlYWxpdHk6e3VyaX19KTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNlc3Npb25TZXJ2aWNlLm1hbmFnZXIucmVxdWVzdCgnYXIucmVhbGl0eS5yZXF1ZXN0Jywge3VyaX0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZXByZWNhdGVkLiBVc2UgW1tSZWFsaXR5U2VydmljZSNyZXF1ZXN0XV1cbiAgICAgKiBAZGVwcmVjYXRlZFxuICAgICAqL1xuICAgIEBkZXByZWNhdGVkKCdyZXF1ZXN0JylcbiAgICBwdWJsaWMgc2V0RGVzaXJlZChyZWFsaXR5OiB7dXJpOnN0cmluZ30gfCB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5yZXF1ZXN0KHJlYWxpdHkgPyByZWFsaXR5LnVyaSA6IFJlYWxpdHlWaWV3ZXIuREVGQVVMVCk7XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKiBBc2sgYSByZWFsaXR5IHRvIG1vdmUgdGhlIHN0YWdlIHRvIHRoZSBnaXZlbiBnZW9sb2NhdGlvblxuICAgICAqL1xuICAgIHB1YmxpYyBzZXRTdGFnZUdlb2xvY2F0aW9uKHJlYWxpdHlTZXNzaW9uOlNlc3Npb25Qb3J0LCBnZW9sb2NhdGlvbjpDYXJ0b2dyYXBoaWMpIDogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGlmICghcmVhbGl0eVNlc3Npb24uc3VwcG9ydHNQcm90b2NvbCgnYXIuY29uZmlndXJlU3RhZ2UnKSkgXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoJ1Byb3RvY29sIGBhci5jb25maWd1cmVTdGFnZWAgaXMgbm90IHN1cHBvcnRlZCcpOyBcbiAgICAgICAgcmV0dXJuIHJlYWxpdHlTZXNzaW9uLnJlcXVlc3QoJ2FyLmNvbmZpZ3VyZVN0YWdlLnNldFN0YWdlR2VvbG9jYXRpb24nLCB7Z2VvbG9jYXRpb259KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBc2sgYSByZWFsaXR5IHRvIG1vdmUgdGhlIHN0YWdlIHRvIHRoZSBnaXZlbiBnZW9sb2NhdGlvblxuICAgICAqL1xuICAgIHB1YmxpYyByZXNldFN0YWdlR2VvbG9jYXRpb24ocmVhbGl0eVNlc3Npb246U2Vzc2lvblBvcnQpIDogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGlmICghcmVhbGl0eVNlc3Npb24uc3VwcG9ydHNQcm90b2NvbCgnYXIuY29uZmlndXJlU3RhZ2UnKSkgXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoJ1Byb3RvY29sIGBhci5jb25maWd1cmVTdGFnZWAgaXMgbm90IHN1cHBvcnRlZCcpOyBcbiAgICAgICAgcmV0dXJuIHJlYWxpdHlTZXNzaW9uLnJlcXVlc3QoJ2FyLmNvbmZpZ3VyZVN0YWdlLnJlc2V0U3RhZ2VHZW9sb2NhdGlvbicpO1xuICAgIH1cblxufVxuXG5AYXV0b2luamVjdFxuZXhwb3J0IGNsYXNzIFJlYWxpdHlTZXJ2aWNlUHJvdmlkZXIge1xuXG4gICAgLyoqXG4gICAgICogQW4gZXZlbnQgdGhhdCBpcyByYWlzZWQgd2hlbiBhIHJlYWxpdHkgdmlld2VyIGlzIGluc3RhbGxlZC5cbiAgICAgKi9cbiAgICBwdWJsaWMgaW5zdGFsbGVkRXZlbnQgPSBuZXcgRXZlbnQ8eyB2aWV3ZXI6UmVhbGl0eVZpZXdlciB9PigpO1xuXG4gICAgLyoqXG4gICAgICogQW4gZXZlbnQgdGhhdCBpcyByYWlzZWQgd2hlbiBhIHJlYWxpdHkgdmlld2VyIGlzIHVuaW5zdGFsbGVkLlxuICAgICAqL1xuICAgIHB1YmxpYyB1bmluc3RhbGxlZEV2ZW50ID0gbmV3IEV2ZW50PHsgdmlld2VyOlJlYWxpdHlWaWV3ZXIgfT4oKTtcbiAgICBcbiAgICAvKipcbiAgICAgKiBBbiBldmVudCB0aGF0IGlzIHJhaXNlZCB3aGVuIHRoZSBwcmVzZW50aW5nIHZpZXdlciBoYXMgY2hhbmdlZFxuICAgICAqL1xuICAgIHB1YmxpYyBwcmVzZW50aW5nUmVhbGl0eVZpZXdlckNoYW5nZUV2ZW50ID0gbmV3IEV2ZW50PHsgdmlld2VyOiBSZWFsaXR5Vmlld2VyIH0+KCk7XG5cbiAgICAvKipcbiAgICAgKiBBbiBldmVudCB0aGF0IGlzIHJhaXNlZCB3aGVuIHRoZSBuZXh0IGZyYW1lIHN0YXRlIGlzIHB1Ymxpc2hlZFxuICAgICAqL1xuICAgIHB1YmxpYyBuZXh0RnJhbWVTdGF0ZUV2ZW50ID0gbmV3IEV2ZW50PENvbnRleHRGcmFtZVN0YXRlPigpO1xuXG4gICAgcHVibGljIGdldCBwcmVzZW50aW5nUmVhbGl0eVZpZXdlcigpIHsgcmV0dXJuIHRoaXMuX3ByZXNlbnRpbmdSZWFsaXR5Vmlld2VyIH1cbiAgICBwcml2YXRlIF9wcmVzZW50aW5nUmVhbGl0eVZpZXdlcjpSZWFsaXR5Vmlld2VyfHVuZGVmaW5lZDtcblxuICAgIHByaXZhdGUgX3ZpZXdlckJ5VVJJID0gbmV3IE1hcDxzdHJpbmcsIFJlYWxpdHlWaWV3ZXI+KCk7XG4gICAgcHJpdmF0ZSBfaW5zdGFsbGVyc0J5VVJJID0gbmV3IE1hcDxzdHJpbmcsIFNldDxTZXNzaW9uUG9ydD4+KCk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBzZXNzaW9uU2VydmljZTpTZXNzaW9uU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSByZWFsaXR5U2VydmljZTpSZWFsaXR5U2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBlbnRpdHlTZXJ2aWNlOkVudGl0eVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgZGV2aWNlU2VydmljZTpEZXZpY2VTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHZpZXdTZXJ2aWNlUHJvdmlkZXI6Vmlld1NlcnZpY2VQcm92aWRlcixcbiAgICAgICAgcHJpdmF0ZSB2aXNpYmlsaXR5U2VydmljZVByb3ZpZGVyOlZpc2liaWxpdHlTZXJ2aWNlUHJvdmlkZXIsXG4gICAgICAgIHByaXZhdGUgZm9jdXNTZXJ2aWNlUHJvdmlkZXI6IEZvY3VzU2VydmljZVByb3ZpZGVyLFxuICAgICAgICBwcml2YXRlIHJlYWxpdHlWaWV3ZXJGYWN0b3J5OlJlYWxpdHlGYWN0b3J5LFxuICAgICkge1xuICAgICAgICBzZXNzaW9uU2VydmljZS5lbnN1cmVJc1JlYWxpdHlNYW5hZ2VyKCk7XG4gICAgICAgIFxuICAgICAgICBzZXNzaW9uU2VydmljZS5tYW5hZ2VyLmNvbm5lY3RFdmVudC5hZGRFdmVudExpc3RlbmVyKCgpID0+IHtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PntcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zZXNzaW9uU2VydmljZS5tYW5hZ2VyLmlzQ29ubmVjdGVkICYmXG4gICAgICAgICAgICAgICAgICAgICF0aGlzLl9wcmVzZW50aW5nUmVhbGl0eVZpZXdlciAmJiBcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWFsaXR5U2VydmljZS5kZWZhdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhbmRsZVJlcXVlc3QodGhpcy5zZXNzaW9uU2VydmljZS5tYW5hZ2VyLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1cmk6dGhpcy5yZWFsaXR5U2VydmljZS5kZWZhdWx0XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIDApO1xuICAgICAgICB9KTtcblxuICAgICAgICBzZXNzaW9uU2VydmljZS5tYW5hZ2VyLmNsb3NlRXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoKT0+e1xuICAgICAgICAgICAgdGhpcy5fdmlld2VyQnlVUkkuZm9yRWFjaCgodik9PntcbiAgICAgICAgICAgICAgICB2LmRlc3Ryb3koKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBzZXNzaW9uU2VydmljZS5jb25uZWN0RXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoc2Vzc2lvbikgPT4ge1xuICAgICAgICAgICAgaWYgKCFSb2xlLmlzUmVhbGl0eVZpZXdlcihzZXNzaW9uLmluZm8ucm9sZSkpIHtcbiAgICAgICAgICAgICAgICBzZXNzaW9uLm9uWydhci5yZWFsaXR5Lmluc3RhbGwnXSA9ICh7dXJpfTp7dXJpOnN0cmluZ30pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZUluc3RhbGwoc2Vzc2lvbiwgdXJpKTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHNlc3Npb24ub25bJ2FyLnJlYWxpdHkudW5pbnN0YWxsJ10gPSAoe3VyaX06e3VyaTpzdHJpbmd9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9oYW5kbGVVbmluc3RhbGwoc2Vzc2lvbiwgdXJpKTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHNlc3Npb24ub25bJ2FyLnJlYWxpdHkucmVxdWVzdCddID0gKG1lc3NhZ2U6e3VyaTpzdHJpbmd9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9oYW5kbGVSZXF1ZXN0KHNlc3Npb24sIG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgLy8gRm9yIGJhY2t3YXJkcyBjb21wYXRhYmlsaXR5LiBcbiAgICAgICAgICAgICAgICBzZXNzaW9uLm9uWydhci5yZWFsaXR5LmRlc2lyZWQnXSA9IChtZXNzYWdlOntyZWFsaXR5Ont1cmk6c3RyaW5nfX0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qge3JlYWxpdHl9ID0gbWVzc2FnZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlYWxpdHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWFsaXR5Wyd0eXBlJ10pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0eXBlID0gcmVhbGl0eVsndHlwZSddIGFzIHN0cmluZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFsaXR5LnVyaSA9IHJlYWxpdHkudXJpIHx8ICdyZWFsaXR5OicgKyB0eXBlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnaG9zdGVkJykgcmVhbGl0eS51cmkgPSByZWFsaXR5Wyd1cmwnXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9oYW5kbGVSZXF1ZXN0KHNlc3Npb24sIHt1cmk6cmVhbGl0eS51cml9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgdGhpcy52aWV3U2VydmljZVByb3ZpZGVyLmZvcndhcmRlZFVJRXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigodWlldmVudCk9PntcbiAgICAgICAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLl9wcmVzZW50aW5nUmVhbGl0eVZpZXdlciAmJiB0aGlzLl9wcmVzZW50aW5nUmVhbGl0eVZpZXdlci5zZXNzaW9uO1xuICAgICAgICAgICAgaWYgKHNlc3Npb24pIHRoaXMudmlld1NlcnZpY2VQcm92aWRlci5zZW5kVUlFdmVudFRvU2Vzc2lvbih1aWV2ZW50LCBzZXNzaW9uKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc2NyYXRjaEZydXN0dW0gPSBuZXcgUGVyc3BlY3RpdmVGcnVzdHVtO1xuXG4gICAgcHJpdmF0ZSBfaGFuZGxlSW5zdGFsbChzZXNzaW9uOlNlc3Npb25Qb3J0LCB1cmk6c3RyaW5nKSB7XG4gICAgICAgIGxldCBpbnN0YWxsZXJzID0gdGhpcy5faW5zdGFsbGVyc0J5VVJJLmdldCh1cmkpO1xuXG4gICAgICAgIGlmIChpbnN0YWxsZXJzKSB7XG4gICAgICAgICAgICBpbnN0YWxsZXJzLmFkZChzZXNzaW9uKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHZpZXdlciA9IHRoaXMucmVhbGl0eVZpZXdlckZhY3RvcnkuY3JlYXRlUmVhbGl0eVZpZXdlcih1cmkpO1xuICAgICAgICAgICAgdGhpcy5fdmlld2VyQnlVUkkuc2V0KHVyaSwgdmlld2VyKTtcblxuICAgICAgICAgICAgaW5zdGFsbGVycyA9IG5ldyBTZXQ8U2Vzc2lvblBvcnQ+KCk7XG4gICAgICAgICAgICBpbnN0YWxsZXJzLmFkZChzZXNzaW9uKTtcbiAgICAgICAgICAgIHRoaXMuX2luc3RhbGxlcnNCeVVSSS5zZXQodXJpLCBpbnN0YWxsZXJzKTtcblxuICAgICAgICAgICAgdmlld2VyLmNvbm5lY3RFdmVudC5hZGRFdmVudExpc3RlbmVyKCh2aWV3ZXJTZXNzaW9uKT0+e1xuXG4gICAgICAgICAgICAgICAgaWYgKCFSb2xlLmlzUmVhbGl0eVZpZXdlcih2aWV3ZXJTZXNzaW9uLmluZm8ucm9sZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdmlld2VyU2Vzc2lvbi5zZW5kRXJyb3IoeyBtZXNzYWdlOiBcIkV4cGVjdGVkIGEgcmVhbGl0eSB2aWV3ZXJcIiB9KTtcbiAgICAgICAgICAgICAgICAgICAgdmlld2VyU2Vzc2lvbi5jbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBhcHBsaWNhdGlvbiBcIicgKyB2aWV3ZXJTZXNzaW9uLnVyaSArICdcIiBkb2VzIG5vdCBzdXBwb3J0IGJlaW5nIGxvYWRlZCBhcyBhIHJlYWxpdHkgdmlld2VyJyk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdmlld2VyU2Vzc2lvbi5vblsnYXIucmVhbGl0eS5mcmFtZVN0YXRlJ10gPSAoZnJhbWU6IENvbnRleHRGcmFtZVN0YXRlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wcmVzZW50aW5nUmVhbGl0eVZpZXdlciA9PT0gdmlld2VyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmlld2VyU2Vzc2lvbi52ZXJzaW9uWzBdID09PSAwKSB7IC8vIGJhY2t3YXJkcyBjb21wYXRhYmlsaXR5XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGV2aWNlU3RhdGUgPSB0aGlzLmRldmljZVNlcnZpY2UuZnJhbWVTdGF0ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWRldmljZVN0YXRlKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUudmlld3BvcnQgPSBDYW52YXNWaWV3cG9ydC5jbG9uZShkZXZpY2VTdGF0ZS52aWV3cG9ydCwgZnJhbWUudmlld3BvcnQpITtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFtZS5zdWJ2aWV3cyA9IFNlcmlhbGl6ZWRTdWJ2aWV3TGlzdC5jbG9uZShkZXZpY2VTdGF0ZS5zdWJ2aWV3cywgZnJhbWUuc3Vidmlld3MpITtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBleWUgPSBmcmFtZVsnZXllJ107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXllUG9zZSA9IGV5ZS5wb3NlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGV5ZUZvdiA9IGV5ZS5mb3Y7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUuZW50aXRpZXMgPSBmcmFtZS5lbnRpdGllcyB8fCB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFtZS5lbnRpdGllc1snYXIudXNlciddID0gZXllUG9zZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHMgb2YgZnJhbWUuc3Vidmlld3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZjpQZXJzcGVjdGl2ZUZydXN0dW0gPSBkZWNvbXBvc2VQZXJzcGVjdGl2ZVByb2plY3Rpb25NYXRyaXgocy5wcm9qZWN0aW9uTWF0cml4LCBzWydmcnVzdHVtJ10gfHwge30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmLmZvdiA9IGV5ZUZvdjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2NyYXRjaEZydXN0dW0uY2xvbmUoZik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMucHJvamVjdGlvbk1hdHJpeCA9IE1hdHJpeDQuY2xvbmUodGhpcy5fc2NyYXRjaEZydXN0dW0ucHJvamVjdGlvbk1hdHJpeCwgcy5wcm9qZWN0aW9uTWF0cml4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBmcmFtZS5yZWFsaXR5ID0gdmlld2VyLnVyaTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVhbGl0eVNlcnZpY2UuX3NoYXJlZENhbnZhcyA9ICEhKHRoaXMuc2Vzc2lvblNlcnZpY2UuY29uZmlndXJhdGlvblsnc2hhcmVkQ2FudmFzJ10gJiYgdmlld2VyLnNlc3Npb24hLmluZm9bJ3NoYXJlZENhbnZhcyddKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZpZXdlci5fc2hhcmVkQ2FudmFzID0gdGhpcy5yZWFsaXR5U2VydmljZS5fc2hhcmVkQ2FudmFzO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5uZXh0RnJhbWVTdGF0ZUV2ZW50LnJhaXNlRXZlbnQoZnJhbWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHZpZXdlclNlc3Npb24uaW5mb1snc3VwcG9ydHNDdXN0b21Qcm90b2NvbHMnXSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9jb25uZWN0Vmlld2VyV2l0aFNlc3Npb24odmlld2VyU2Vzc2lvbiwgdGhpcy5zZXNzaW9uU2VydmljZS5tYW5hZ2VyKTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGZvciAoc2Vzc2lvbiBvZiB0aGlzLnNlc3Npb25TZXJ2aWNlLm1hbmFnZWRTZXNzaW9ucykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY29ubmVjdFZpZXdlcldpdGhTZXNzaW9uKHZpZXdlclNlc3Npb24sIHNlc3Npb24pO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVtb3ZlID0gdGhpcy5zZXNzaW9uU2VydmljZS5jb25uZWN0RXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoc2Vzc2lvbik9PntcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZXNzaW9uID09PSB0aGlzLnNlc3Npb25TZXJ2aWNlLm1hbmFnZXIpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2Nvbm5lY3RWaWV3ZXJXaXRoU2Vzc2lvbih2aWV3ZXJTZXNzaW9uLCBzZXNzaW9uKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHZpZXdlclNlc3Npb24uY2xvc2VFdmVudC5hZGRFdmVudExpc3RlbmVyKCgpPT5yZW1vdmUoKSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc3QgcmVtb3ZlUHJlc2VudENoYW5nZUxpc3RlbmVyID0gdmlld2VyLnByZXNlbnRDaGFuZ2VFdmVudC5hZGRFdmVudExpc3RlbmVyKCgpPT57XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudmlzaWJpbGl0eVNlcnZpY2VQcm92aWRlci5zZXQodmlld2VyU2Vzc2lvbiwgdmlld2VyLmlzUHJlc2VudGluZyk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLnZpc2liaWxpdHlTZXJ2aWNlUHJvdmlkZXIuc2V0KHZpZXdlclNlc3Npb24sIHZpZXdlci5pc1ByZXNlbnRpbmcpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdzZXQgdmlzaWJpbGUgOiAnICsgdmlld2VyLnVyaSlcblxuICAgICAgICAgICAgICAgIHZpZXdlclNlc3Npb24uY2xvc2VFdmVudC5hZGRFdmVudExpc3RlbmVyKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlUHJlc2VudENoYW5nZUxpc3RlbmVyKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZW50aXR5U2VydmljZS5jb2xsZWN0aW9uLnJlbW92ZUJ5SWQodmlld2VyU2Vzc2lvbi51cmkpO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnUmVhbGl0eSBzZXNzaW9uIGNsb3NlZDogJyArIHVyaSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy5pbnN0YWxsZWRFdmVudC5yYWlzZUV2ZW50KHt2aWV3ZXJ9KTtcbiAgICAgICAgICAgIHZpZXdlci5sb2FkKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9jb25uZWN0Vmlld2VyV2l0aFNlc3Npb24odmlld2VyU2Vzc2lvbjpTZXNzaW9uUG9ydCwgc2Vzc2lvbjpTZXNzaW9uUG9ydCkge1xuICAgICAgICBpZiAoUm9sZS5pc1JlYWxpdHlWaWV3ZXIoc2Vzc2lvbi5pbmZvLnJvbGUpKSByZXR1cm47XG5cbiAgICAgICAgY29uc3QgaWQgPSBjcmVhdGVHdWlkKCk7XG4gICAgICAgIGNvbnN0IFJPVVRFX01FU1NBR0VfS0VZID0gJ2FyLnJlYWxpdHkubWVzc2FnZS5yb3V0ZS4nICsgaWQ7XG4gICAgICAgIGNvbnN0IFNFTkRfTUVTU0FHRV9LRVkgPSAnYXIucmVhbGl0eS5tZXNzYWdlLnNlbmQuJyArIGlkO1xuICAgICAgICBjb25zdCBDTE9TRV9TRVNTSU9OX0tFWSA9ICdhci5yZWFsaXR5LmNsb3NlLicgKyBpZDtcblxuICAgICAgICB2aWV3ZXJTZXNzaW9uLm9uW1JPVVRFX01FU1NBR0VfS0VZXSA9IChtZXNzYWdlKSA9PiB7XG4gICAgICAgICAgICBzZXNzaW9uLnNlbmQoU0VORF9NRVNTQUdFX0tFWSwgbWVzc2FnZSk7XG4gICAgICAgIH1cblxuICAgICAgICBzZXNzaW9uLm9uW1JPVVRFX01FU1NBR0VfS0VZXSA9IChtZXNzYWdlKSA9PiB7XG4gICAgICAgICAgICB2aWV3ZXJTZXNzaW9uLnNlbmQoU0VORF9NRVNTQUdFX0tFWSwgbWVzc2FnZSk7XG4gICAgICAgIH1cblxuICAgICAgICBzZXNzaW9uLnNlbmQoJ2FyLnJlYWxpdHkuY29ubmVjdCcsIHsgaWQgfSk7XG4gICAgICAgIHZpZXdlclNlc3Npb24uc2VuZCgnYXIucmVhbGl0eS5jb25uZWN0JywgeyBpZCB9KTtcblxuICAgICAgICB2aWV3ZXJTZXNzaW9uLmNsb3NlRXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoKSA9PiB7XG4gICAgICAgICAgICBzZXNzaW9uLnNlbmQoQ0xPU0VfU0VTU0lPTl9LRVkpO1xuICAgICAgICB9KTtcblxuICAgICAgICBzZXNzaW9uLmNsb3NlRXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoKSA9PiB7XG4gICAgICAgICAgICB2aWV3ZXJTZXNzaW9uLnNlbmQoQ0xPU0VfU0VTU0lPTl9LRVkpO1xuICAgICAgICB9KVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBfaGFuZGxlVW5pbnN0YWxsKHNlc3Npb246IFNlc3Npb25Qb3J0LCB1cmk6c3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGluc3RhbGxlcnMgPSB0aGlzLl9pbnN0YWxsZXJzQnlVUkkuZ2V0KHVyaSk7XG4gICAgICAgIGlmIChpbnN0YWxsZXJzKSB7XG4gICAgICAgICAgICBpZiAoaW5zdGFsbGVycy5zaXplID09PSAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgdmlld2VyID0gdGhpcy5fdmlld2VyQnlVUkkuZ2V0KHVyaSkhO1xuICAgICAgICAgICAgICAgIHRoaXMuX3ZpZXdlckJ5VVJJLmRlbGV0ZSh1cmkpO1xuICAgICAgICAgICAgICAgIHZpZXdlci5kZXN0cm95KCk7XG4gICAgICAgICAgICAgICAgdGhpcy51bmluc3RhbGxlZEV2ZW50LnJhaXNlRXZlbnQoe3ZpZXdlcn0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcihcIlVuYWJsZSB0byB1bmluc3RhbGwgYSByZWFsaXR5IHZpZXdlciB3aGljaCBpcyBub3QgaW5zdGFsbGVkXCIpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBfaGFuZGxlUmVxdWVzdChzZXNzaW9uOiBTZXNzaW9uUG9ydCwgb3B0aW9uczp7dXJpOnN0cmluZ30pIDogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGlmICh0aGlzLmZvY3VzU2VydmljZVByb3ZpZGVyLnNlc3Npb24gPT09IHNlc3Npb24gfHwgc2Vzc2lvbiA9PT0gdGhpcy5zZXNzaW9uU2VydmljZS5tYW5hZ2VyKSB7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCB1cmkgPSBvcHRpb25zICYmIG9wdGlvbnMudXJpIHx8IFJlYWxpdHlWaWV3ZXIuREVGQVVMVDtcblxuICAgICAgICAgICAgc3dpdGNoICh1cmkpIHtcbiAgICAgICAgICAgICAgICBjYXNlIFJlYWxpdHlWaWV3ZXIuREVGQVVMVDogXG4gICAgICAgICAgICAgICAgICAgIHVyaSA9IHRoaXMucmVhbGl0eVNlcnZpY2UuZGVmYXVsdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5faGFuZGxlSW5zdGFsbChzZXNzaW9uLCB1cmkpO1xuICAgICAgICAgICAgdGhpcy5fc2V0UHJlc2VudGluZ1JlYWxpdHlWaWV3ZXIodGhpcy5fdmlld2VyQnlVUkkuZ2V0KHVyaSkhKTtcblxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IERlbmllZCcpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3NldFByZXNlbnRpbmdSZWFsaXR5Vmlld2VyKHZpZXdlcjogUmVhbGl0eVZpZXdlcikge1xuICAgICAgICBpZiAoIXZpZXdlcikgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIFN0YXRlLiBFeHBlY3RlZCBhIFJlYWxpdHlWaWV3ZXIgaW5zdGFuY2UnKTtcbiAgICAgICAgaWYgKHRoaXMuX3ByZXNlbnRpbmdSZWFsaXR5Vmlld2VyID09PSB2aWV3ZXIpIHJldHVybjtcblxuICAgICAgICB0aGlzLl9wcmVzZW50aW5nUmVhbGl0eVZpZXdlciA9IHZpZXdlcjtcbiAgICAgICAgdGhpcy5wcmVzZW50aW5nUmVhbGl0eVZpZXdlckNoYW5nZUV2ZW50LnJhaXNlRXZlbnQoe3ZpZXdlcn0pXG4gICAgICAgIHRoaXMuX3ZpZXdlckJ5VVJJLmZvckVhY2goKHYpPT57XG4gICAgICAgICAgICB2LnNldFByZXNlbnRpbmcodiA9PT0gdmlld2VyKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc29sZS5sb2coJ1ByZXNlbnRpbmcgcmVhbGl0eSB2aWV3ZXIgY2hhbmdlZCB0bzogJyArIHZpZXdlci51cmkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRWaWV3ZXJCeVVSSSh1cmk6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gdGhpcy5fdmlld2VyQnlVUkkuZ2V0KHVyaSk7XG4gICAgfVxuXG4gICAgcHVibGljIHJlbW92ZUluc3RhbGxlcihpbnN0YWxsZXJTZXNzaW9uOiBTZXNzaW9uUG9ydCkge1xuICAgICAgICB0aGlzLl92aWV3ZXJCeVVSSS5mb3JFYWNoKCh2aWV3ZXIsIHJlYWxpdHlVcmksIG1hcCk9PntcbiAgICAgICAgICAgIGNvbnN0IGluc3RhbGxlcnMgPSB0aGlzLl9pbnN0YWxsZXJzQnlVUkkuZ2V0KHJlYWxpdHlVcmkpO1xuICAgICAgICAgICAgaWYgKGluc3RhbGxlcnMgJiYgaW5zdGFsbGVycy5oYXMoaW5zdGFsbGVyU2Vzc2lvbikpIHtcbiAgICAgICAgICAgICAgICBpbnN0YWxsZXJzLmRlbGV0ZShpbnN0YWxsZXJTZXNzaW9uKTtcbiAgICAgICAgICAgICAgICBpZiAoaW5zdGFsbGVycy5zaXplID09PSAwICYmIHZpZXdlci5zZXNzaW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhbmRsZVVuaW5zdGFsbCh2aWV3ZXIuc2Vzc2lvbiwgcmVhbGl0eVVyaSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbGxlcnNCeVVSSS5kZWxldGUocmVhbGl0eVVyaSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59Il19